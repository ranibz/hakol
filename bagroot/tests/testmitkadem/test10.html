<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××—×•×œ×œ ××‘×—× ×™× - ×’×¨×¡×” ××ª×•×§× ×ª (×›×¤×ª×•×¨ ××•×¨×”)</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- ×¢×™×¦×•×‘ ×›×œ×œ×™ --- */
        :root { --primary: #2c3e50; --secondary: #34495e; --accent: #3498db; --success: #27ae60; --danger: #e74c3c; --light: #ecf0f1; --border: #bdc3c7; }
        body { margin: 0; font-family: 'Rubik', sans-serif; height: 100vh; overflow: hidden; display: flex; background-color: #fdfdfd; }

        /* Layout */
        .container { display: flex; width: 100%; height: 100%; }
        .col { padding: 20px; overflow-y: auto; border-left: 1px solid var(--border); display: flex; flex-direction: column; }
        .col-right { width: 25%; background-color: #f8f9fa; }
        .col-middle { width: 55%; background-color: white; box-shadow: 0 0 15px rgba(0,0,0,0.05); z-index: 10; }
        .col-left { width: 20%; background-color: var(--primary); color: white; align-items: center; border-left: none; }

        /* Elements */
        h2, h3 { margin-top: 0; color: var(--primary); font-weight: 700; }
        .col-left h2, .col-left h3 { color: white; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.95rem; }
        input[type="text"], input[type="number"], select, textarea, input[type="file"] { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; font-family: inherit; }
        textarea { resize: vertical; }
        button { cursor: pointer; padding: 10px 20px; border: none; border-radius: 6px; font-size: 1rem; transition: background 0.2s; width: 100%; font-family: 'Rubik', sans-serif; font-weight: 500; }
        .btn-add { background-color: var(--accent); color: white; margin-top: 10px; }
        .btn-download { background-color: var(--success); color: white; padding: 15px; font-weight: bold; font-size: 1.1rem; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .stats-box { margin-top: auto; background: white; padding: 15px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; }
        .total-row { border-top: 2px solid var(--light); margin-top: 10px; padding-top: 10px; font-weight: bold; }
        .tabs { display: flex; border-bottom: 2px solid var(--light); margin-bottom: 20px; }
        .tab { padding: 10px 20px; cursor: pointer; color: #7f8c8d; font-weight: 500; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        .question-card { background: #fff; border: 1px solid var(--light); border-radius: 8px; padding: 15px; margin-bottom: 20px; position: relative; }
        .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; background: var(--light); font-size: 0.8rem; color: #666; margin-bottom: 10px; font-weight: 500; }
        .q-text { font-size: 1.1rem; margin-bottom: 15px; line-height: 1.5; white-space: pre-wrap; }
        .preview-input { width: 100%; height: 80px; background: #f9f9f9; border: 1px dashed #ccc; border-radius: 4px; padding: 10px; color: #999; font-size: 0.9rem; }
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; margin-bottom: 15px; background: #000; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        .btn-delete { position: absolute; top: 10px; left: 10px; background-color: white; color: var(--danger); border: 1px solid var(--danger); padding: 4px 8px; font-size: 0.8rem; width: auto; border-radius: 4px; }
        .file-info { text-align: center; opacity: 0.8; font-size: 0.85rem; margin-top: 10px; }
        .part-instructions-area { font-size: 0.85rem; border: 1px solid #d6eaf8; background: #f4faff; padding: 8px; border-radius: 4px; margin-top: 5px; }
        #previewHeader { text-align: center; margin-bottom: 20px; }
        #previewLogo { max-height: 80px; margin-bottom: 10px; display: none; }
        #previewExamTitle { margin: 0; color: var(--primary); font-size: 1.8rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="col col-right">
        <h2>âœï¸ ×¢×¨×™×›×ª ×©××œ×•×ª</h2>
        <div class="form-group" style="background: #fff; padding: 10px; border-radius: 5px; border: 1px solid #e0e0e0; margin-bottom: 15px;">
             <label>×¢×™×¦×•×‘ ×›×•×ª×¨×ª ×”××‘×—×Ÿ</label>
             <input type="text" id="examTitleInput" placeholder="×›×•×ª×¨×ª ×”××‘×—×Ÿ" oninput="updateExamTitle()" style="margin-bottom: 10px;">
             <label for="schoolLogoInput" style="font-size: 0.85rem; color: #7f8c8d;">×œ×•×’×• ×‘×™×ª ×”×¡×¤×¨:</label>
             <input type="file" id="schoolLogoInput" accept="image/*" onchange="handleLogoUpload(event)">
        </div>
        <div class="form-group" style="background: #e8f8f5; padding: 10px; border-radius: 5px; border: 1px solid #d1f2eb; margin-bottom: 15px;">
            <label>×”×’×“×¨×•×ª ×‘×—×™× ×”</label>
            <label for="examDurationInput" style="font-weight: normal; font-size: 0.9em; margin-top: 5px;">××©×š ×”×‘×—×™× ×” (×“×§×•×ª):</label>
            <input type="number" id="examDurationInput" value="90" min="1" placeholder="×œ×“×•×’××”: 90" style="margin-bottom: 10px;">
            <label for="unlockCodeInput" style="font-weight: normal; font-size: 0.9em;">×§×•×“ ××•×¨×” ×œ×©×—×¨×•×¨/×‘×“×™×§×”:</label>
            <input type="text" id="unlockCodeInput" value="1234" placeholder="×§×•×“ (×‘×¨×™×¨×ª ××—×“×œ: 1234)">
        </div>
        <div class="form-group" style="background: #eaf2f8; padding: 10px; border-radius: 5px; border: 1px solid #d6eaf8;">
            <label for="examInstructions">×”× ×—×™×•×ª ×›×œ×œ×™×•×ª</label>
            <textarea id="examInstructions" rows="3" placeholder="×”× ×—×™×•×ª ×›×œ×œ×™×•×ª ×œ××‘×—×Ÿ..." oninput="updateInstructionsPreview()"></textarea>
        </div>
        <hr style="border: 0; border-top: 1px solid #e0e0e0; margin: 20px 0;">
        <div class="form-group">
            <label for="qPart">×‘×—×¨ ×—×œ×§ ×œ×¢×¨×™×›×”</label>
            <select id="qPart" onchange="onPartSelectChange()">
                <option value="A">×—×œ×§ ×¨××©×•×Ÿ</option>
                <option value="B">×—×œ×§ ×©× ×™</option>
                <option value="C">×—×œ×§ ×©×œ×™×©×™</option>
            </select>
            <div class="part-instructions-area">
                <label for="partInstructions" style="font-weight:normal; color:#3498db;">×”× ×—×™×•×ª ×œ<span id="partNameLabel">×—×œ×§ ×¨××©×•×Ÿ</span>:</label>
                <textarea id="partInstructions" rows="2" placeholder="×œ××©×œ: ×¢× ×” ×¢×œ 2 ××ª×•×š 3 ×©××œ×•×ª..." oninput="savePartInstructions()"></textarea>
            </div>
        </div>
        <div class="form-group">
            <label for="qPoints">× ×™×§×•×“ ×œ×©××œ×”</label>
            <input type="number" id="qPoints" value="10" min="1" max="100">
        </div>
        <div class="form-group">
            <label for="qText">×ª×•×›×Ÿ ×”×©××œ×”</label>
            <textarea id="qText" rows="4" placeholder="×”×§×œ×“ ××ª ×”×©××œ×” ×›××Ÿ..."></textarea>
        </div>
        <div class="form-group">
            <label for="qVideo">×§×™×©×•×¨ ×œ×¡×¨×˜×•×Ÿ (Drive / YouTube)</label>
            <input type="text" id="qVideo" placeholder="×”×“×‘×§ ×§×™×©×•×¨...">
        </div>
        <button class="btn-add" onclick="addQuestion()">â• ×”×•×¡×£ ×©××œ×”</button>
        <div class="stats-box">
            <h3>×¡×™×›×•× ××‘×—×Ÿ</h3>
            <div class="stat-row"><span>×—×œ×§ ×¨××©×•×Ÿ:</span> <span id="countA">0</span></div>
            <div class="stat-row"><span>×—×œ×§ ×©× ×™:</span> <span id="countB">0</span></div>
            <div class="stat-row"><span>×—×œ×§ ×©×œ×™×©×™:</span> <span id="countC">0</span></div>
            <div class="stat-row total-row"><span>×¡×”"×› × ×™×§×•×“:</span> <span id="totalPoints">0</span></div>
        </div>
    </div>

    <div class="col col-middle">
        <div id="previewHeader">
            <img id="previewLogo" src="" alt="School Logo">
            <h1 id="previewExamTitle">××‘×—×Ÿ ×‘×’×¨×•×ª</h1>
            <input type="text" id="studentNameInput" placeholder="×©× ×”×ª×œ××™×“" 
                   style="max-width: 300px; text-align: center; font-size: 1.1rem; margin-top: 10px;" oninput="updateFilenamePreview()">
        </div>
        <div id="previewInstructionsBox" style="background: #fffde7; padding: 15px; border-right: 4px solid #f1c40f; margin-bottom: 20px; display: none; white-space: pre-wrap; color: #555;"></div>
        <div class="tabs">
            <div class="tab active" onclick="setTab('A')">×—×œ×§ ×¨××©×•×Ÿ</div>
            <div class="tab" onclick="setTab('B')">×—×œ×§ ×©× ×™</div>
            <div class="tab" onclick="setTab('C')">×—×œ×§ ×©×œ×™×©×™</div>
        </div>
        <div id="questionsList">
            <div style="text-align: center; color: #999; margin-top: 50px;">××™×Ÿ ×©××œ×•×ª ×‘×—×œ×§ ×–×” ×¢×“×™×™×Ÿ.</div>
        </div>
    </div>

    <div class="col col-left">
        <div style="text-align: center; margin-top: 20px;">
            <h2>ğŸ“¤ ×¡×™×•× ×•×”×¤×¦×”</h2>
            <p>×œ××—×¨ ×¡×™×•× ×¢×¨×™×›×ª ×”××‘×—×Ÿ, ×”×•×¨×“ ××ª ×”×§×•×‘×¥ ×•×©×œ×— ××•×ª×• ×œ×ª×œ××™×“×™×.</p>
            <button class="btn-download" onclick="generateAndDownload()">×”×•×¨×“ ××‘×—×Ÿ (HTML)</button>
            <div class="file-info">×©× ×”×§×•×‘×¥:<br><strong id="filenamePreview" style="color: #ffd700;">××‘×—×Ÿ - ×ª×œ××™×“.html</strong></div>
            <hr style="border-color: rgba(255,255,255,0.2); width: 80%; margin: 30px auto;">
        </div>
    </div>
</div>

<script>
    const state = {
        questions: [],
        currentTab: 'A',
        studentName: '',
        examTitle: '××‘×—×Ÿ ×‘×’×¨×•×ª',
        logoData: null,
        instructions: { general: '', parts: { A: '', B: '', C: '' } }
    };

    const els = {
        qPart: document.getElementById('qPart'),
        partInstructions: document.getElementById('partInstructions'),
        partNameLabel: document.getElementById('partNameLabel'),
        qPoints: document.getElementById('qPoints'),
        qText: document.getElementById('qText'),
        qVideo: document.getElementById('qVideo'), 
        questionsList: document.getElementById('questionsList'),
        countA: document.getElementById('countA'), countB: document.getElementById('countB'), countC: document.getElementById('countC'), totalPoints: document.getElementById('totalPoints'),
        studentNameInput: document.getElementById('studentNameInput'),
        filenamePreview: document.getElementById('filenamePreview'),
        tabs: document.querySelectorAll('.tab'),
        examInstructions: document.getElementById('examInstructions'),
        previewInstructionsBox: document.getElementById('previewInstructionsBox'),
        examTitleInput: document.getElementById('examTitleInput'),
        previewExamTitle: document.getElementById('previewExamTitle'),
        previewLogo: document.getElementById('previewLogo'),
        examDurationInput: document.getElementById('examDurationInput'),
        unlockCodeInput: document.getElementById('unlockCodeInput')
    };

    function getVideoEmbedUrl(url) {
        if (!url) return null;
        const driveMatch = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/) || url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
        if (driveMatch && url.includes('drive.google.com')) return `https://drive.google.com/file/d/${driveMatch[1]}/preview`;
        const iframeMatch = url.match(/src=["'](.*?)["']/);
        const link = iframeMatch ? iframeMatch[1] : url;
        const ytRegExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=|shorts\/)([^#&?"]*).*/;
        const ytMatch = link.match(ytRegExp);
        if (ytMatch && ytMatch[2].length === 11) return `https://www.youtube-nocookie.com/embed/${ytMatch[2]}?rel=0&modestbranding=1&showinfo=0`;
        return null;
    }

    function simpleHash(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = (hash << 5) - hash + char;
            hash |= 0;
        }
        return hash.toString();
    }

    function updateExamTitle() {
        const title = els.examTitleInput.value.trim();
        state.examTitle = title || '××‘×—×Ÿ ×‘×’×¨×•×ª';
        els.previewExamTitle.textContent = state.examTitle;
    }

    function handleLogoUpload(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                state.logoData = e.target.result;
                els.previewLogo.src = state.logoData;
                els.previewLogo.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    }

    function onPartSelectChange() {
        const selectedPart = els.qPart.value;
        const partName = els.qPart.options[els.qPart.selectedIndex].text;
        els.partNameLabel.textContent = partName;
        els.partInstructions.value = state.instructions.parts[selectedPart] || '';
    }

    function savePartInstructions() {
        state.instructions.parts[els.qPart.value] = els.partInstructions.value;
    }

    function addQuestion() {
        const text = els.qText.value.trim();
        const points = parseInt(els.qPoints.value) || 0;
        if (!text) { alert('×× × ×”×›× ×¡ ×ª×•×›×Ÿ ×œ×©××œ×”'); return; }
        const question = { id: Date.now(), part: els.qPart.value, points, text, videoUrl: els.qVideo.value.trim() };
        state.questions.push(question);
        els.qText.value = ''; els.qPoints.value = '10'; els.qVideo.value = ''; els.qText.focus();
        updateStats(); renderPreview();
    }
    
    function deleteQuestion(id) {
        if(!confirm('×œ××—×•×§ ×©××œ×”?')) return;
        state.questions = state.questions.filter(q => q.id !== id);
        updateStats(); renderPreview();
    }

    function updateInstructionsPreview() {
        const text = els.examInstructions.value;
        state.instructions.general = text;
        els.previewInstructionsBox.style.display = text.trim() ? 'block' : 'none';
        els.previewInstructionsBox.textContent = text;
    }

    function updateStats() {
        const counts = { A: 0, B: 0, C: 0 }; let total = 0;
        state.questions.forEach(q => { counts[q.part]++; total += q.points; });
        els.countA.textContent = counts.A; els.countB.textContent = counts.B; els.countC.textContent = counts.C; els.totalPoints.textContent = total;
    }

    function setTab(part) {
        state.currentTab = part;
        els.tabs.forEach((t, index) => {
            const parts = ['A', 'B', 'C'];
            t.classList.toggle('active', parts[index] === part);
        });
        renderPreview();
    }

    function renderPreview() {
        const filtered = state.questions.filter(q => q.part === state.currentTab);
        if (filtered.length === 0) {
            els.questionsList.innerHTML = `<div style="text-align: center; color: #999; margin-top: 50px;">××™×Ÿ ×©××œ×•×ª ×‘×—×œ×§ ×–×” ×¢×“×™×™×Ÿ.</div>`;
            return;
        }

        els.questionsList.innerHTML = filtered.map((q, idx) => {
            let videoHTML = '';
            const embedSrc = getVideoEmbedUrl(q.videoUrl);
            if (embedSrc) videoHTML = `<div class="video-wrapper"><iframe src="${embedSrc}" allowfullscreen></iframe></div>`;

            return `
            <div class="question-card">
                <button class="btn-delete" onclick="deleteQuestion(${q.id})">ğŸ—‘ï¸ ×”×¡×¨</button>
                <div class="badge">×©××œ×” ${idx + 1} â€¢ ${q.points} × ×§×•×“×•×ª</div>
                <div class="q-text">${q.text}</div>
                ${videoHTML}
                <div class="preview-input">×ª×™×‘×ª ×˜×§×¡×˜ ×œ×ª×©×•×‘×ª ×”×ª×œ××™×“...</div>
            </div>`;
        }).join('');
    }

    function updateFilenamePreview() {
        const name = els.studentNameInput.value.trim() || '×ª×œ××™×“';
        state.studentName = name;
        els.filenamePreview.textContent = `${name} - ××‘×—×Ÿ.html`;
    }

    function generateAndDownload() {
        const name = state.studentName || '×ª×œ××™×“';
        const duration = els.examDurationInput.value || 90;
        const unlockCodeHash = simpleHash(els.unlockCodeInput.value || '1234');
        const htmlContent = buildStudentHTML(name, state.questions, state.instructions, state.examTitle, state.logoData, duration, unlockCodeHash);
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${name} - ××‘×—×Ÿ.html`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    function buildStudentHTML(studentName, questions, instructions, examTitle, logoData, duration, unlockCodeHash) {
        
        // Essential JS for the student file
        const scriptContent = `
        const TEACHER_CODE_HASH = "${unlockCodeHash}";
        let totalTime = ${duration} * 60;
        let examStarted = false;
        let timerInterval;
        let ignoreLock = false;

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = (hash << 5) - hash + char;
                hash |= 0;
            }
            return hash.toString();
        }

        function showPart(partId) {
            document.querySelectorAll('.exam-section').forEach(el => el.classList.remove('active'));
            document.getElementById('part-' + partId).classList.add('active');
            const btns = document.querySelectorAll('.tab-btn');
            btns.forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        function enableGrading() {
            ignoreLock = true;
            setTimeout(() => {
                var code = prompt("×”×›× ×¡ ×§×•×“ ××•×¨×” ×œ×‘×“×™×§×ª ×”××‘×—×Ÿ:");
                ignoreLock = false;
                
                if (code && simpleHash(code) === TEACHER_CODE_HASH) {
                    var inputs = document.querySelectorAll(".grade-input, .teacher-comment");
                    inputs.forEach(function(el) { 
                        el.removeAttribute("disabled"); 
                        el.style.backgroundColor = "white"; 
                    });
                    
                    alert("××¦×‘ ×‘×“×™×§×” ×”×•×¤×¢×œ.\\n×›×¢×ª × ×™×ª×Ÿ ×œ×”×–×™×Ÿ ×¦×™×•× ×™× ×•×”×¢×¨×•×ª.");
                    
                    // THIS IS THE FIX: Explicitly get the button and change it
                    const btn = document.getElementById('mainSubmitBtn');
                    if(btn) {
                        btn.innerText = "ğŸ’¾ ×©××™×¨×” ×•×”×—×–×¨×” ×œ×ª×œ××™×“";
                        btn.onclick = saveCheckedExam; // Change the function binding
                    }
                    
                    calcTotal();
                    document.querySelector('.teacher-controls').style.display = 'none';
                } else {
                    if (code !== null) alert("×§×•×“ ×©×’×•×™.");
                }
            }, 100);
        }

        function calcTotal() {
            let total = 0;
            const inputs = document.querySelectorAll('.grade-input');
            inputs.forEach(inp => { if(inp.value) total += parseFloat(inp.value); });
            document.getElementById('finalScore').textContent = total;
        }

        function startExamTimer() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) elem.requestFullscreen().catch(err => console.log(err));
            
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('mainContainer').style.filter = 'none';
            document.getElementById('timerBadge').style.display = 'block';
            examStarted = true;

            timerInterval = setInterval(() => {
                totalTime--;
                updateTimerDisplay();
                if (totalTime === 600) document.getElementById('timerBadge').classList.add('urgent');
                if (totalTime <= 0) {
                    clearInterval(timerInterval);
                    document.getElementById('timesUpModal').style.display = 'flex';
                }
            }, 1000);
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const m = Math.floor(totalTime / 60);
            const s = totalTime % 60;
            document.getElementById('timerText').textContent = (m < 10 ? '0' + m : m) + ':' + (s < 10 ? '0' + s : s);
        }

        function checkSecurityViolation() {
            if (!examStarted || document.body.getAttribute('data-status') === 'submitted' || ignoreLock || document.body.getAttribute('data-status') === 'checked') return;
            document.getElementById('securityModal').style.display = 'flex';
        }

        function unlockExam() {
            const code = document.getElementById('teacherCodeInput').value;
            if(simpleHash(code) === TEACHER_CODE_HASH) {
                document.getElementById('securityModal').style.display = 'none';
                document.getElementById('teacherCodeInput').value = '';
            } else {
                alert('×§×•×“ ×©×’×•×™!');
            }
        }

        document.addEventListener('visibilitychange', function() {
            if (document.hidden) checkSecurityViolation();
        });
        
        window.addEventListener('blur', function() { 
             setTimeout(function() { 
                 if (document.activeElement && document.activeElement.tagName === 'IFRAME') return; 
                 if (!document.hidden) checkSecurityViolation();
             }, 200);
        });

        // --- 1. Student Submit ---
        function submitExam() {
            if(!confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×’×™×© ××ª ×”××‘×—×Ÿ?")) return;
            
            const textareas = document.querySelectorAll('textarea');
            textareas.forEach(ta => { 
                ta.innerHTML = ta.value; 
                ta.setAttribute('readonly', 'true');
            });
            
            const nameField = document.getElementById('studentNameField');
            nameField.setAttribute('value', nameField.value);
            nameField.setAttribute('readonly', 'true');

            document.body.setAttribute('data-status', 'submitted');
            
            downloadFile("××‘×—×Ÿ ×¤×ª×•×¨ - " + nameField.value + ".html");
        }

        // --- 2. Teacher Save & Return ---
        function saveCheckedExam() {
            // Lock grading fields
            const gradeInputs = document.querySelectorAll('.grade-input, .teacher-comment');
            gradeInputs.forEach(el => {
                el.setAttribute('value', el.value); 
                el.setAttribute('disabled', 'disabled'); 
                el.style.backgroundColor = '#f0f0f0'; 
            });

            // Update Total Score Text
            const finalScore = document.getElementById('finalScore').textContent;
            document.getElementById('finalScore').innerHTML = finalScore;

            // Mark as checked to prevent security checks on open
            document.body.setAttribute('data-status', 'checked');

            // Cleanup UI
            const controls = document.querySelector('.teacher-controls');
            if(controls) controls.remove();
            
            const btn = document.getElementById('mainSubmitBtn');
            btn.innerText = "×”×‘×—×™× ×” × ×‘×“×§×” âœ…";
            btn.onclick = null;
            btn.style.background = "#95a5a6";
            btn.style.cursor = "default";

            const studentName = document.getElementById('studentNameField').value;
            downloadFile("××‘×—×Ÿ ×‘×“×•×§ - " + studentName + ".html");
        }

        function downloadFile(filename) {
            const htmlContent = "<!DOCTYPE html>" + document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        window.onload = function() { 
            calcTotal(); 
            const status = document.body.getAttribute('data-status');
            
            if(status === 'submitted') {
                // Teacher view of student submission
                document.getElementById('startScreen').style.display = 'none';
                document.getElementById('mainContainer').style.filter = 'none';
                document.querySelector('.teacher-controls').style.display = 'block';
                // Hide student button initially, will be repurposed by enableGrading
                // Actually keep it but update text via JS if needed, or hide and show
            } else if (status === 'checked') {
                // Student view of checked exam
                document.getElementById('startScreen').style.display = 'none';
                document.getElementById('mainContainer').style.filter = 'none';
                document.querySelector('.teacher-controls').style.display = 'none';
                document.getElementById('mainSubmitBtn').style.display = 'none';
                document.getElementById('timerBadge').style.display = 'none';
            }
        };
        
        // Prevent Paste
        const txts = document.querySelectorAll('textarea');
        txts.forEach(ta => {
            ta.addEventListener('paste', e => { e.preventDefault(); alert('×”×“×‘×§×ª ×˜×§×¡×˜ ××¡×•×¨×”!'); });
        });

        `;

        let partsHTML = { A: '', B: '', C: '' };
        questions.forEach((q, idx) => {
            const embedSrc = getVideoEmbedUrl(q.videoUrl);
            let videoHTML = embedSrc ? `<div class="video-wrapper"><iframe src="${embedSrc}" allowfullscreen></iframe></div>` : '';
            
            partsHTML[q.part] += `
            <div class="q-block">
                <div class="q-header"><span class="q-points">(${q.points} × ×§')</span><strong>×©××œ×” ${idx+1}:</strong></div>
                <div class="q-content">${q.text}</div>
                ${videoHTML}
                <div class="answer-area">
                    <label>×ª×©×•×‘×”:</label>
                    <textarea class="student-ans" placeholder="×›×ª×•×‘ ××ª ×ª×©×•×‘×ª×š ×›××Ÿ..." onpaste="return false;"></textarea>
                </div>
                <div class="grading-area">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <label>× ×™×§×•×“:</label>
                        <input type="number" class="grade-input" min="0" max="${q.points}" oninput="calcTotal()" disabled>
                        <span class="grade-max">××ª×•×š ${q.points}</span>
                    </div>
                    <input type="text" class="teacher-comment" placeholder="×”×¢×¨×” ××™×œ×•×œ×™×ª..." disabled>
                </div>
            </div>`;
        });

        const globalInstr = instructions.general ? `<div class="instructions-box"><h3>×”× ×—×™×•×ª ×›×œ×œ×™×•×ª</h3><div class="instructions-text">${instructions.general}</div></div>` : '';
        const getPartInstr = (p) => instructions.parts[p] ? `<div class="part-instructions">${instructions.parts[p]}</div>` : '';
        const logoHTML = logoData ? `<img src="${logoData}" alt="Logo" class="school-logo">` : '';

        return `<!DOCTYPE html><html lang="he" dir="rtl"><head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>××‘×—×Ÿ - ${studentName}</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Rubik', sans-serif; background: #f4f6f7; margin: 0; padding: 20px; color: #333; -webkit-user-select: none; user-select: none; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-top: 40px; }
        h1 { color: #2c3e50; text-align: center; } .exam-header { text-align: center; } .school-logo { max-height: 100px; }
        .student-details { background: #fff; padding: 20px; border: 2px solid #3498db; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; }
        .student-details input { font-size: 1.1em; padding: 8px; flex-grow: 1; font-family: 'Rubik', sans-serif; }
        .instructions-box { background: #fffde7; padding: 20px; border-right: 5px solid #f1c40f; margin-bottom: 30px; }
        .part-instructions { background-color: #e8f6f3; border-right: 4px solid #1abc9c; padding: 15px; margin-bottom: 20px; }
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; margin-bottom: 20px; background: #000; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        .tabs { display: flex; justify-content: center; margin-bottom: 30px; gap: 10px; }
        .tab-btn { background: #ecf0f1; border: none; padding: 10px 25px; cursor: pointer; border-radius: 20px; font-weight: bold; color: #7f8c8d; }
        .tab-btn.active { background: #3498db; color: white; }
        .exam-section { display: none; } .exam-section.active { display: block; animation: fadeIn 0.3s; }
        .q-block { margin-bottom: 30px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background: #fff; }
        .q-header { margin-bottom: 10px; color: #2980b9; } .q-content { font-size: 1.1em; margin-bottom: 15px; }
        textarea { width: 100%; height: 150px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-family: inherit; font-size: 1rem; resize: vertical; }
        .grading-area { margin-top: 15px; padding: 10px; background: #fff8e1; border: 1px solid #ffe082; border-radius: 5px; display: flex; flex-wrap: wrap; align-items: center; gap: 15px; }
        .grade-input { width: 70px; padding: 5px; text-align: center; } .teacher-comment { flex-grow: 1; padding: 8px; }
        input:disabled { background-color: #f0f0f0; cursor: not-allowed; }
        .teacher-controls { display: none; margin-bottom: 20px; text-align: center; border-bottom: 2px dashed #ccc; padding-bottom: 15px; }
        .btn-teacher-login { background: #e67e22; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 2px solid #eee; }
        .btn-submit { background: #27ae60; color: white; border: none; padding: 15px 40px; font-size: 1.2rem; border-radius: 50px; cursor: pointer; }
        .total-score { font-size: 1.5rem; color: #d35400; font-weight: bold; margin-top: 15px; }
        
        #startScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        #startBtn { padding: 20px 40px; font-size: 2rem; background: #27ae60; color: white; border: none; border-radius: 10px; cursor: pointer; font-family: 'Rubik', sans-serif; font-weight: 700; }
        #timerBadge { position: fixed; top: 10px; left: 20px; background: #2c3e50; color: white; padding: 10px 20px; border-radius: 20px; font-weight: bold; z-index: 5000; display: none; }
        #timerBadge.urgent { background: #e74c3c; animation: pulse 1s infinite; }
        #timesUpModal, #securityModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(231, 76, 60, 0.98); z-index: 11000; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; }
        #teacherCodeInput { padding: 15px; font-size: 1.5rem; text-align: center; border-radius: 8px; border: none; margin-bottom: 20px; width: 200px; color: #333; }
        #unlockBtn { background: white; color: #c0392b; border: none; padding: 15px 30px; font-size: 1.2rem; border-radius: 8px; cursor: pointer; font-weight: bold; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        @media print { #startScreen, #timerBadge, .teacher-controls, .student-nav, .btn-submit { display: none !important; } .exam-section { display: block !important; } }
    </style></head><body oncontextmenu="return false;">

    <div id="startScreen">
        <h1>${examTitle}</h1>
        <p style="font-size: 1.2rem; margin-bottom: 30px;">××©×š ×”×‘×—×™× ×”: ${duration} ×“×§×•×ª</p>
        <button id="startBtn" onclick="startExamTimer()">×”×ª×—×œ ×‘×—×™× ×”</button>
    </div>

    <div id="timerBadge">×–××Ÿ × ×•×ª×¨: <span id="timerText">--:--</span></div>

    <div id="timesUpModal">
        <h2>âŒ› ×”×–××Ÿ × ×’××¨!</h2>
        <p>×–××Ÿ ×”×‘×—×™× ×” ×ª×. ×¢×œ×™×š ×œ×”×’×™×© ××ª ×”××‘×—×Ÿ ×›×¢×ª.</p>
        <button class="btn-submit" onclick="submitExam()" style="background: white; color: #c0392b;">×©××•×¨ ×•×”×’×© ×‘×—×™× ×”</button>
    </div>

    <div id="securityModal">
        <h2>âš ï¸ ×”××‘×—×Ÿ × × ×¢×œ!</h2>
        <p>×–×•×”×ª×” ×™×¦×™××” ×××¡×š ×”××‘×—×Ÿ.</p>
        <input type="password" id="teacherCodeInput" placeholder="×§×•×“ ××•×¨×”">
        <br><br>
        <button id="unlockBtn" onclick="unlockExam()">×©×—×¨×¨ × ×¢×™×œ×”</button>
    </div>

    <div class="container" id="mainContainer" style="filter: blur(5px);">
        <div class="exam-header">${logoHTML}<h1>${examTitle}</h1></div>
        
        <div class="teacher-controls">
            <button class="btn-teacher-login" onclick="enableGrading()">ğŸ”“ ×›× ×™×¡×ª ××•×¨×” (×œ××ª×Ÿ ×¦×™×•× ×™×)</button>
        </div>

        <div class="student-details">
            <label>×©× ×”×ª×œ××™×“:</label>
            <input type="text" id="studentNameField" value="${studentName}" placeholder="×”×§×œ×“ ×©× ××œ×">
        </div>
        ${globalInstr}
        <div class="tabs">
            <button class="tab-btn active" onclick="showPart('A')">×—×œ×§ ×¨××©×•×Ÿ</button>
            <button class="tab-btn" onclick="showPart('B')">×—×œ×§ ×©× ×™</button>
            <button class="tab-btn" onclick="showPart('C')">×—×œ×§ ×©×œ×™×©×™</button>
        </div>

        <form id="examForm">
            <div id="part-A" class="exam-section active">
                <h2 style="color:#7f8c8d; border-bottom:1px solid #ddd;">×—×œ×§ ×¨××©×•×Ÿ</h2>${getPartInstr('A')}${partsHTML.A || '<p>××™×Ÿ ×©××œ×•×ª</p>'}
            </div>
            <div id="part-B" class="exam-section">
                <h2 style="color:#7f8c8d; border-bottom:1px solid #ddd;">×—×œ×§ ×©× ×™</h2>${getPartInstr('B')}${partsHTML.B || '<p>××™×Ÿ ×©××œ×•×ª</p>'}
            </div>
            <div id="part-C" class="exam-section">
                <h2 style="color:#7f8c8d; border-bottom:1px solid #ddd;">×—×œ×§ ×©×œ×™×©×™</h2>${getPartInstr('C')}${partsHTML.C || '<p>××™×Ÿ ×©××œ×•×ª</p>'}
            </div>
        </form>

        <div class="footer">
            <div class="total-score">×¦×™×•×Ÿ ×¡×•×¤×™: <span id="finalScore">--</span></div>
            <br>
            <button id="mainSubmitBtn" class="btn-submit" onclick="submitExam()">ğŸ’¾ ×©××™×¨×” ×•×”×’×©×” ×œ××•×¨×”</button>
        </div>
    </div>
    <script>${scriptContent}<\/script></body></html>`;
        return htmlSource;
    }
</script>
</body>
</html>