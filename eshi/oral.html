<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>×¡×™××•×œ×¦×™×™×ª ×‘×—×™× ×” ×‘×¢"×¤ â€“ ×›×™×•×œ ×‘×•×—× ×™×</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import{getDatabase,ref,set,get,onValue,remove}from"https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
const firebaseConfig = {
  apiKey: "AIzaSyCddIvPAb56veDasZ6GH0osk2KaZBR_j2s",
  authDomain: "tester-2e95d.firebaseapp.com",
  databaseURL: "https://tester-2e95d-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "tester-2e95d",
  storageBucket: "tester-2e95d.firebasestorage.app",
  messagingSenderId: "661933853539",
  appId: "1:661933853539:web:2124884fb69c94099d2156"
};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);
window.DB={ref:function(p){return ref(db,p)},set:set,get:get,onValue:onValue,remove:remove};
window.firebaseReady=true;
document.dispatchEvent(new Event('fb-ready'));
</script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0c0c14;--sf:#14141f;--sf2:#1c1c2e;--sf3:#222238;--bd:#2a2a40;--t:#f0f0f5;--t2:#c8c8d8;--t3:#9898b0;--t4:#686880;--t5:#484860;--pr:#7c6cf0;--pr2:#a78bfa;--pbg:#7c6cf015;--gn:#34d399;--gbg:#34d39915;--yw:#fbbf24;--ybg:#fbbf2415;--rd:#f87171;--rbg:#f8717115;--bl:#60a5fa;--bbg:#60a5fa15}
body{font-family:'Heebo',sans-serif;background:var(--bg);color:var(--t);min-height:100vh;direction:rtl}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.ctn{max-width:900px;margin:0 auto;padding:24px 20px}
.ph{text-align:center;margin-bottom:32px;animation:fadeUp .5s ease-out}
.ph .tag{font-size:12px;letter-spacing:3px;color:var(--pr);text-transform:uppercase;font-weight:600;margin-bottom:8px}
.ph h1{font-size:28px;font-weight:800;margin-bottom:6px}.ph p{color:var(--t4);font-size:14px;line-height:1.6}
button{font-family:inherit;cursor:pointer;transition:all .2s}
.bp{background:linear-gradient(135deg,var(--pr),var(--pr2));color:#fff;border:none;border-radius:12px;padding:15px 28px;font-size:16px;font-weight:700;width:100%}.bp:hover{filter:brightness(1.1)}
.bs{background:var(--sf3);color:var(--t);border:1px solid var(--bd);border-radius:10px;padding:10px 20px;font-size:14px;font-weight:600}.bs:hover{border-color:var(--pr)}
.bsm{background:var(--sf2);color:var(--t2);border:1px solid var(--bd);border-radius:8px;padding:6px 14px;font-size:13px;font-weight:500}
.btn-back{background:none;border:1px solid var(--bd);color:var(--t3);border-radius:10px;padding:8px 18px;font-size:13px;font-weight:600;display:inline-flex;align-items:center;gap:6px;margin-bottom:20px}.btn-back:hover{border-color:var(--pr);color:var(--pr2)}
label{display:block;font-size:14px;font-weight:600;color:var(--t2);margin-bottom:6px}
textarea,input[type=text],input[type=number],input[type=password]{width:100%;background:var(--sf2);color:var(--t);border:1px solid var(--bd);border-radius:10px;padding:11px 14px;font-size:14px;font-family:inherit;resize:vertical}
textarea:focus,input:focus{outline:none;border-color:var(--pr)}
.hidden{display:none!important}
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:12px;font-weight:600}
.bg{background:var(--gbg);color:var(--gn)}.by{background:var(--ybg);color:var(--yw)}.br{background:var(--rbg);color:var(--rd)}
.lb{display:flex;flex-direction:column;gap:12px;max-width:400px;margin:32px auto 0}
.lbtn{background:var(--sf);border:2px solid var(--bd);border-radius:16px;padding:24px;text-align:center;cursor:pointer;transition:all .25s}.lbtn:hover{border-color:var(--pr);transform:scale(1.02)}
.ss{margin-bottom:22px}.ss h3{font-size:16px;margin-bottom:10px}
.live-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--gn);margin-left:6px;animation:pulse 1.5s infinite}
.card{background:var(--sf);border:1px solid var(--bd);border-radius:14px;padding:20px;margin-bottom:14px}

/* Scoring sections */
.score-section{background:var(--sf);border:1px solid var(--bd);border-radius:14px;margin-bottom:14px;overflow:hidden;animation:fadeUp .4s ease-out both}
.score-section-header{padding:16px 18px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--bd)}
.score-section-header h3{font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px}
.score-section-header .s-num{font-size:12px;font-weight:800;color:#fff;background:var(--pr);border-radius:50%;min-width:26px;height:26px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.score-section-body{padding:16px 18px}
.score-section .sv{min-width:50px;text-align:center;font-size:24px;font-weight:900;font-family:'Courier New',monospace}
.sr2{display:flex;align-items:center;gap:12px;margin-bottom:6px}
.sr2 input[type=range]{flex:1;-webkit-appearance:none;height:7px;border-radius:4px;background:var(--bd);outline:none}
.sr2 input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:26px;height:26px;border-radius:50%;background:var(--pr);cursor:pointer;border:3px solid var(--bg)}
.range-labels{display:flex;justify-content:space-between;font-size:11px;color:var(--t5);margin-bottom:12px}

/* General impression */
.general-section{border-color:var(--pr);border-width:2px}
.general-section .score-section-header{background:linear-gradient(135deg,var(--pr),var(--pr2));border-bottom:none}
.general-section .score-section-header h3{color:#fff}
.general-section .sv{color:var(--pr)}

/* Weight info */
.weight-info{background:var(--sf2);border:1px solid var(--bd);border-radius:10px;padding:12px 16px;margin-bottom:18px;font-size:13px;color:var(--t3);display:flex;gap:16px;justify-content:center;flex-wrap:wrap;text-align:center}
.weight-info span{display:flex;align-items:center;gap:6px}
.weight-info strong{color:var(--pr2);font-size:15px}

/* Total score */
.total-score-bar{background:var(--sf);border:2px solid var(--pr);border-radius:14px;padding:20px;text-align:center;margin-bottom:18px}
.total-score-val{font-size:56px;font-weight:900;font-family:'Courier New',monospace;line-height:1}
.total-score-label{font-size:13px;color:var(--t4);margin-top:4px}

/* Stats */
.str{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px}
.stc{flex:1;min-width:100px;background:var(--sf);border:1px solid var(--bd);border-radius:12px;padding:14px;text-align:center}
.stv{font-size:22px;font-weight:800;font-family:'Courier New',monospace}.stl{font-size:11px;color:var(--t4);margin-top:4px;line-height:1.4}
.cc{background:var(--sf);border:1px solid var(--bd);border-radius:14px;padding:20px;margin-bottom:16px}.cc h3{font-size:16px;margin-bottom:14px}

/* Result cards */
.res-card{background:var(--sf);border:1px solid var(--bd);border-radius:14px;padding:18px;margin-bottom:12px;animation:fadeUp .4s ease-out}
.res-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.res-name{font-weight:700;font-size:16px;color:var(--pr2)}
.res-score{font-size:28px;font-weight:900;font-family:'Courier New',monospace}
.res-sections{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
.res-sec-chip{background:var(--sf2);border:1px solid var(--bd);border-radius:8px;padding:6px 10px;font-size:12px;display:flex;align-items:center;gap:6px}
.res-sec-chip .chip-score{font-weight:800;font-family:'Courier New',monospace;font-size:13px}
.res-note-block{margin-top:8px}
.res-note-title{font-size:12px;font-weight:700;color:var(--t4);margin-bottom:4px}
.res-note{font-size:13px;color:var(--t2);line-height:1.7;background:var(--sf2);border-radius:8px;padding:10px 12px;border:1px solid var(--bd)}

.wp{background:var(--sf2);border:1px solid var(--bd);border-radius:10px;padding:16px;max-height:350px;overflow-y:auto;font-size:14px;line-height:1.8;color:var(--t2)}
.mo{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.75);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px}
.mc{background:var(--bg);border:1px solid var(--bd);border-radius:20px;max-width:720px;width:100%;max-height:85vh;overflow-y:auto}
.mh{position:sticky;top:0;background:var(--sf);padding:18px 24px;border-bottom:1px solid var(--bd);display:flex;justify-content:space-between;align-items:center;border-radius:20px 20px 0 0;z-index:1}.mh h2{font-size:20px}
.mx{background:var(--sf2);border:1px solid var(--bd);color:var(--t);width:36px;height:36px;border-radius:10px;font-size:18px;display:flex;align-items:center;justify-content:center}
.mb2{padding:24px}
.fb{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.fbtn{padding:7px 14px;border-radius:8px;font-size:13px;font-weight:600;background:var(--sf2);color:var(--t4);border:1px solid var(--bd)}.fbtn.active{background:var(--pr);color:#fff;border-color:var(--pr)}

.ct{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--bd);border-radius:12px;overflow:hidden;margin-bottom:20px;font-size:13px}
.ct th{background:var(--sf2);padding:10px;font-size:12px;font-weight:700;color:var(--t3);text-align:center;border-bottom:1px solid var(--bd)}
.ct td{padding:9px 10px;text-align:center;border-bottom:1px solid var(--bd);background:var(--sf)}.ct td:first-child{text-align:right;font-weight:600}.ct tr:last-child td{border-bottom:none}
.ttr td{background:var(--sf2)!important;font-weight:800!important;font-size:14px!important}

@media(max-width:640px){.ctn{padding:16px 12px}.ph h1{font-size:22px}.stc{min-width:85px;padding:10px}.stv{font-size:17px}.total-score-val{font-size:42px}.ct{font-size:11px}.ct th,.ct td{padding:6px 5px}}
</style>
</head>
<body>

<!-- S0 LANDING -->
<div id="S0" class="ctn"><div class="ph"><div class="tag">×¡×™××•×œ×¦×™×™×ª ×‘×—×™× ×” ×‘×¢"×¤</div><h1>×›×™×•×œ ×‘×•×—× ×™× â€“ ×¤×¨×•×™×§×˜ ×œ×"×“</h1><p>×›×œ ×‘×•×—×Ÿ/×ª ×¦×•×¤×” ×‘×‘×—×™× ×” ×•× ×•×ª× /×ª ×¦×™×•×Ÿ ×•×”×¢×¨×•×ª.<br>×”×× ×—×” ×¨×•××” ××ª ×›×œ ×”×”×¢×¨×›×•×ª ×‘×–××Ÿ ×××ª.<span class="live-dot"></span></p></div>
<div class="lb">
<div class="lbtn" onclick="goEx()"><div style="font-size:36px;margin-bottom:8px">ğŸ¤</div><div style="font-size:18px;font-weight:700;margin-bottom:4px">×›× ×™×¡×ª ×‘×•×—×Ÿ/×ª</div><div style="font-size:13px;color:var(--t4)">×¦×¤×™×™×” ×‘×‘×—×™× ×”, ×¦×™×•×Ÿ ×•×”×¢×¨×•×ª</div></div>
<div class="lbtn" onclick="goAd()"><div style="font-size:36px;margin-bottom:8px">ğŸ“Š</div><div style="font-size:18px;font-weight:700;margin-bottom:4px">×›× ×™×¡×ª ×× ×—×”</div><div style="font-size:13px;color:var(--t4)">×”×’×“×¨×”, ×¡×™××•×œ×¦×™×” ×•×ª×•×¦××•×ª</div></div>
</div>
<div id="lSt" style="text-align:center;margin-top:20px;font-size:13px;color:var(--t4)"></div></div>

<!-- S1 SETUP -->
<div id="S1" class="ctn hidden">
<button class="btn-back" onclick="show('S0')">â†’ ×—×–×¨×” ×œ×“×£ ×”×¨××©×™</button>
<div class="ph"><div class="tag">×”×’×“×¨×•×ª ×× ×—×”</div><h1>×”×’×“×¨×ª ×”×¡×™××•×œ×¦×™×”</h1></div>
<div class="ss"><h3>ğŸ”‘ ×¡×™×¡××ª ×× ×—×”</h3><input type="password" id="sP" placeholder="×‘×—×¨×• ×¡×™×¡××”"></div>
<div class="ss"><h3>ğŸ“„ ×”× ×—×™×•×ª ×œ×‘×•×—× ×™×</h3><p style="font-size:13px;color:var(--t4);margin-bottom:8px">×ª×™××•×¨ ×”×‘×—×™× ×”, ×§×™×©×•×¨ ×œ×•×•×™×“××•, ××• ×›×œ ××™×“×¢ ×¨×œ×•×•× ×˜×™</p><textarea id="sW" rows="5" placeholder="×”×§×œ×™×“×• ×”× ×—×™×•×ª, ×§×™×©×•×¨ ×œ×•×•×™×“××• ×•×›×•×³..."></textarea></div>
<div class="ss"><h3>ğŸ“ ×¡×¢×™×¤×™ ×”×¢×¨×›×”</h3><p style="font-size:13px;color:var(--t4);margin-bottom:8px">×›×œ ×©×•×¨×” = ×¡×¢×™×£ × ×¤×¨×“. ×”×‘×•×—× ×™× ×™×™×ª× ×• ×œ×›×œ ×¡×¢×™×£ ×¦×™×•×Ÿ (0â€“100) ×•×”×¢×¨×”.<br>×”×¦×™×•×Ÿ ×”×¡×•×¤×™ = <strong style="color:var(--pr2)">×××•×¦×¢ ×”×¦×™×•× ×™× ×©×œ ×›×œ ×”×¡×¢×™×¤×™×</strong>.<br>×× ×œ× ×ª×’×“×™×¨×• ×¡×¢×™×¤×™×, ×ª×•×¤×™×¢ ×ª×™×‘×ª ×”×¢×¨×›×” ×›×œ×œ×™×ª ××—×ª.</p><textarea id="sCrit" rows="8" placeholder="×©×œ×™×˜×” ×‘×—×•××¨ ×”××§×¦×•×¢×™&#10;×™×›×•×œ×ª ×”×¡×‘×¨ ×•×”×¢×‘×¨×”&#10;×©×™××•×© ×‘××•×©×’×™ ××¤×ª×—&#10;×‘×™×˜×—×•×Ÿ ×¢×¦××™ ×•× ×•×›×—×•×ª&#10;×”×ª××•×“×“×•×ª ×¢× ×©××œ×•×ª&#10;×—×©×™×‘×” ×‘×™×§×•×¨×ª×™×ª"></textarea></div>
<button class="bp" onclick="saveCfg()">×©××•×¨ ×•×”×¤×¢×œ âœ“</button>
<div style="margin-top:16px;text-align:center"><button class="bsm" style="color:var(--rd)" onclick="resetSc()">ğŸ—‘ï¸ ××¤×¡ ×”×¢×¨×›×•×ª</button></div>
</div>

<!-- S2 ADMIN LOGIN -->
<div id="S2" class="ctn hidden">
<button class="btn-back" onclick="show('S0')">â†’ ×—×–×¨×” ×œ×“×£ ×”×¨××©×™</button>
<div class="ph"><div class="tag">×›× ×™×¡×ª ×× ×—×”</div><h1>×¡×™×¡××”</h1></div>
<div style="max-width:400px;margin:0 auto;text-align:center">
<input type="password" id="lP" placeholder="×¡×™×¡××ª ×× ×—×”" onkeydown="if(event.key==='Enter')aLog()" style="text-align:center;font-size:18px;padding:14px">
<button class="bp" style="margin-top:14px" onclick="aLog()">×›× ×™×¡×” â†’</button>
<div id="lE" class="hidden" style="color:var(--rd);font-size:13px;margin-top:10px">×¡×™×¡××” ×©×’×•×™×”</div>
</div></div>

<!-- S3 RESULTS -->
<div id="S3" class="ctn hidden">
<button class="btn-back" onclick="show('S0')">â†’ ×—×–×¨×” ×œ×“×£ ×”×¨××©×™</button>
<div class="ph"><div class="tag">×¡×‘×™×‘×ª ×× ×—×” <span class="live-dot"></span> ×–××Ÿ ×××ª</div><h1>×”×©×•×•××ª ×”×¢×¨×›×•×ª ×‘×•×—× ×™×</h1><p id="rSb"></p></div>
<div id="nS" class="hidden" style="text-align:center;padding:40px;color:var(--t4)"><div style="font-size:48px;margin-bottom:12px">ğŸ“­</div><div style="font-size:18px;font-weight:600;color:var(--t3)">××™×Ÿ ×¢×“×™×™×Ÿ ×”×¢×¨×›×•×ª</div><p style="margin-top:8px;font-size:14px">×©×œ×—×• ××ª ×”×§×™×©×•×¨ ×œ×‘×•×—× ×™×.<br>×”×”×¢×¨×›×•×ª ×™×•×¤×™×¢×• ×›××Ÿ ××•×˜×•××˜×™×ª.</p></div>
<div id="rC" class="hidden">
<div id="viewTog" class="fb" style="margin-bottom:16px;display:none"><span style="font-size:13px;color:var(--t4)">×ª×¦×•×’×”:</span><button class="fbtn active" id="vR" onclick="setV('real')">ğŸ‘¥ ×××™×ª×™×™×</button><button class="fbtn" id="vS" onclick="setV('sim')">ğŸ¤– ×¡×™××•×œ×¦×™×”</button><button class="fbtn" id="vB" onclick="setV('both')">ğŸ“Š ×”×›×œ</button></div>
<div class="str" id="stR"></div>
<div class="cc"><h3>ğŸ“Š ×¦×™×•×Ÿ ×¡×•×¤×™ ×œ×¤×™ ×‘×•×—×Ÿ</h3><canvas id="barC"></canvas></div>
<div id="compTable"></div>
<div id="resList"></div>
</div>
<div style="margin-top:24px;display:flex;gap:12px;flex-wrap:wrap">
<button class="bs" style="flex:1" onclick="goToSetup()">âš™ï¸ ×”×’×“×¨×•×ª</button>
<button class="bs" style="flex:1" onclick="expRes()">ğŸ“‹ ×”×¢×ª×§ ×ª×•×¦××•×ª</button>
</div>
<div style="margin-top:14px;display:flex;gap:12px;flex-wrap:wrap">
<button class="bs" style="flex:1;border-color:var(--pr);color:var(--pr2)" onclick="runSim()">ğŸ¤– ×¡×™××•×œ×¦×™×” (5 ×‘×•×—× ×™×)</button>
<button class="bs" style="flex:1;border-color:var(--rd);color:var(--rd)" onclick="resetSc()">ğŸ—‘ï¸ ××¤×¡ ×”×¢×¨×›×•×ª</button>
</div>
<div id="simSt" style="margin-top:12px;text-align:center;font-size:14px;display:none"></div>
</div>

<!-- S4 EXAMINER NAME -->
<div id="S4" class="ctn hidden">
<button class="btn-back" onclick="show('S0')">â†’ ×—×–×¨×” ×œ×“×£ ×”×¨××©×™</button>
<div class="ph"><div class="tag">×‘×—×™× ×” ×‘×¢"×¤</div><h1>×©×œ×•×! ××” ×©××š?</h1></div>
<div style="max-width:400px;margin:0 auto">
<input type="text" id="eN" placeholder="×”×©× ×©×œ×™" onkeydown="if(event.key==='Enter')startSc()" style="font-size:18px;padding:14px;text-align:center">
<button class="bp" style="margin-top:14px" onclick="startSc()">×”××©×š â†’</button>
</div></div>

<!-- S5 NOT READY -->
<div id="S5" class="ctn hidden">
<button class="btn-back" onclick="show('S0')">â†’ ×—×–×¨×” ×œ×“×£ ×”×¨××©×™</button>
<div style="text-align:center;padding:60px"><div style="font-size:64px;margin-bottom:16px">â³</div><h1 style="font-size:24px">×”×¡×™××•×œ×¦×™×” ×¢×“×™×™×Ÿ ×œ× ×”×•×’×“×¨×”</h1></div></div>

<!-- S6 SCORING -->
<div id="S6" class="ctn hidden">
<button class="btn-back" onclick="if(confirm('×œ×¦××ª? ×”×”×¢×¨×›×” ×œ× ×ª×™×©××¨'))show('S0')">â†’ ×—×–×¨×” ×œ×“×£ ×”×¨××©×™</button>
<div class="ph"><div class="tag" id="scN"></div><h1>×”×¢×¨×›×ª ×‘×—×™× ×” ×‘×¢"×¤</h1><p>×¦×¤×• ×‘×‘×—×™× ×”, ×”×¢×¨×™×›×• ×›×œ ×¡×¢×™×£ ×•×ª× ×• ×”×ª×¨×©××•×ª ×›×œ×œ×™×ª.</p></div>
<div style="display:flex;gap:10px;margin-bottom:16px">
<button class="bs" style="flex:1" id="togWB" onclick="togWork()">ğŸ“„ ×”×¡×ª×¨ ×”× ×—×™×•×ª</button>
</div>
<div class="card" id="wCd"><div class="wp" id="wP"></div></div>
<div id="weightInfo"></div>
<div id="scoreSections"></div>
<div id="totalBar"></div>
<button class="bp" style="margin-top:16px" onclick="submitSc()">×©×œ×— ×”×¢×¨×›×” âœ“</button>
</div>

<!-- S7 SUCCESS -->
<div id="S7" class="ctn hidden">
<button class="btn-back" onclick="show('S0')">â†’ ×—×–×¨×” ×œ×“×£ ×”×¨××©×™</button>
<div style="text-align:center;padding:60px;animation:fadeUp .5s ease-out"><div style="font-size:64px;margin-bottom:16px">âœ…</div><h1 style="font-size:28px;margin-bottom:10px">×”×”×¢×¨×›×” × ×©×œ×—×”!</h1><p style="color:var(--t4)">×ª×•×“×”. ×”×× ×—×” ×¨×•××” ××ª ×”×”×¢×¨×›×” ×©×œ×š ×‘×–××Ÿ ×××ª.</p></div></div>

<!-- MODAL -->
<div id="modal" class="mo hidden" onclick="if(event.target===this)closeModal()"><div class="mc"><div class="mh"><h2>ğŸ“‹ ×¡×¢×™×¤×™ ×”×¢×¨×›×”</h2><button class="mx" onclick="closeModal()">âœ•</button></div><div class="mb2" id="mBody"></div></div></div>

<script>
var COL=['#7c6cf0','#34d399','#fbbf24','#f87171','#60a5fa','#f472b6','#a78bfa','#fb923c'];
var cachedReal={},cachedSim={},cachedCfg=null;
var viewMode='real';
var liveUnsub=null;
var barChart=null;

function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function show(id){['S0','S1','S2','S3','S4','S5','S6','S7'].forEach(function(s){document.getElementById(s).classList.toggle('hidden',s!==id)});window.scrollTo(0,0);if(id!=='S3'&&liveUnsub){liveUnsub();liveUnsub=null}}

function dbSet(path,data){return DB.set(DB.ref(path),data)}
function dbGet(path){return DB.get(DB.ref(path)).then(function(snap){return snap.exists()?snap.val():null})}
function dbRemove(path){return DB.remove(DB.ref(path))}
function dbListen(path,cb){return DB.onValue(DB.ref(path),function(snap){cb(snap.exists()?snap.val():null)})}

function initApp(){loadCfgAndUpdate()}
if(window.firebaseReady)initApp();else document.addEventListener('fb-ready',initApp);

function loadCfgAndUpdate(){dbGet('oral_config').then(function(cfg){cachedCfg=cfg;updLand()})}

function updLand(){
  var el=document.getElementById('lSt');
  if(!cachedCfg){el.innerHTML='';return}
  Promise.all([dbGet('oral_scores'),dbGet('oral_sim')]).then(function(res){
    var real=res[0]||{},sim=res[1]||{};
    var rn=Object.keys(real).length,sn=Object.keys(sim).length;
    var cr=(cachedCfg.criteria||[]);
    var info=cr.length?cr.length+' ×¡×¢×™×¤×™×':'×œ×œ× ×¡×¢×™×¤×™×';
    if(rn)info+=' Â· '+rn+' ×”×¢×¨×›×•×ª';if(sn)info+=' Â· '+sn+' ×¡×™××•×œ×¦×™×”';
    el.innerHTML='<span class="badge bg">âœ“ ××•×’×“×¨</span> '+info;
  });
}

function goEx(){dbGet('oral_config').then(function(c){if(!c||!c.instructions){show('S5');return}cachedCfg=c;show('S4')})}
function goAd(){dbGet('oral_config').then(function(c){if(!c||!c.pass){goToSetup();return}cachedCfg=c;show('S2')})}
function goToSetup(){dbGet('oral_config').then(function(c){if(c){cachedCfg=c;document.getElementById('sW').value=c.instructions||'';document.getElementById('sP').value=c.pass||'';document.getElementById('sCrit').value=(c.criteria||[]).join('\n')}show('S1')})}

function saveCfg(){
  var w=document.getElementById('sW').value.trim();
  if(!w){alert('× × ×”× ×—×™×•×ª');return}
  var p=document.getElementById('sP').value.trim();
  if(!p){alert('× × ×¡×™×¡××”');return}
  var crit=document.getElementById('sCrit').value.split('\n').map(function(l){return l.trim()}).filter(function(l){return l.length>1});
  var cfg={instructions:w,pass:p,criteria:crit};
  dbSet('oral_config',cfg).then(function(){cachedCfg=cfg;alert('âœ“ ×”×•×’×“×¨!\n×©×œ×—×• ××ª ×”×§×™×©×•×¨ ×œ×‘×•×—× ×™×.');updLand();show('S0')});
}

function aLog(){dbGet('oral_config').then(function(c){if(!c||document.getElementById('lP').value.trim()!==c.pass){document.getElementById('lE').classList.remove('hidden');return}document.getElementById('lE').classList.add('hidden');document.getElementById('lP').value='';cachedCfg=c;showRes()})}

function resetSc(){
  var choice=prompt('××” ×œ××—×•×§?\n1 = ×”×¢×¨×›×•×ª ×××™×ª×™×•×ª\n2 = ×¡×™××•×œ×¦×™×”\n3 = ×”×›×œ');
  if(!choice)return;var p=[];
  if(choice.indexOf('1')>=0||choice.indexOf('3')>=0)p.push(dbRemove('oral_scores'));
  if(choice.indexOf('2')>=0||choice.indexOf('3')>=0)p.push(dbRemove('oral_sim'));
  Promise.all(p).then(function(){alert('× ××—×§.');if(!document.getElementById('S3').classList.contains('hidden'))showRes()});
}

function closeModal(){document.getElementById('modal').classList.add('hidden')}

// ====== SCORE HELPERS ======
function scoreColor(v){return v>=80?'var(--gn)':v>=60?'var(--bl)':v>=40?'var(--yw)':'var(--rd)'}

function calcTotal(data,criteria){
  var hasCrit=criteria&&criteria.length>0;
  if(!hasCrit)return data.generalScore||0;
  // Final score = average of all criteria scores
  var secs=data.sections||[];
  var sum=0;
  for(var i=0;i<criteria.length;i++){sum+=(secs[i]?secs[i].score:0)||0}
  return Math.round(sum/criteria.length*10)/10;
}

function updTotalDisplay(){
  var crit=(cachedCfg&&cachedCfg.criteria)||[];
  var hasCrit=crit.length>0;
  if(!hasCrit){
    var gv=parseInt(document.getElementById('gen_slider').value)||0;
    document.getElementById('totalVal').textContent=gv;
    document.getElementById('totalVal').style.color=scoreColor(gv);
    return;
  }
  var sum=0;
  for(var i=0;i<crit.length;i++){sum+=(parseInt(document.getElementById('cs_'+i).value)||0)}
  var total=Math.round(sum/crit.length*10)/10;
  document.getElementById('totalVal').textContent=total;
  document.getElementById('totalVal').style.color=scoreColor(total);
}

function updSliderVal(id,valId){
  var v=document.getElementById(id).value;
  var el=document.getElementById(valId);
  el.textContent=v;
  el.style.color=scoreColor(parseInt(v));
  updTotalDisplay();
}

// ====== EXAMINER ======
function startSc(){
  var nm=document.getElementById('eN').value.trim();
  if(!nm){alert('× × ×©×');return}
  dbGet('oral_scores/'+nm).then(function(existing){
    if(existing&&!confirm(nm+' ×›×‘×¨ ×”×’×™×©/×”. ×œ×”×—×œ×™×£?'))return;
    document.getElementById('scN').textContent='×‘×•×—×Ÿ/×ª: '+nm;
    var c=cachedCfg;

    // Instructions
    var urlRe=/(https?:\/\/[^\s]+)/g;
    var wh=esc(c.instructions).replace(/\n/g,'<br>');
    var urls=c.instructions.match(urlRe);
    if(urls)urls.forEach(function(u){wh=wh.replace(esc(u),'<a href="'+u+'" target="_blank" style="display:inline-flex;align-items:center;gap:6px;background:var(--pbg);color:var(--pr2);padding:8px 16px;border-radius:8px;border:1px solid var(--pr);text-decoration:none;font-weight:600;font-size:14px;margin:6px 0">ğŸ”— ×¤×ª×— ×§×™×©×•×¨</a>')});
    document.getElementById('wP').innerHTML=wh;
    document.getElementById('wCd').classList.remove('hidden');
    document.getElementById('togWB').textContent='ğŸ“„ ×”×¡×ª×¨ ×”× ×—×™×•×ª';

    var crit=c.criteria||[];
    var hasCrit=crit.length>0;
    var html='';

    if(hasCrit){
      document.getElementById('weightInfo').innerHTML='<div class="weight-info"><span>ğŸ“ ×”×¦×™×•×Ÿ ×”×¡×•×¤×™ = ×××•×¦×¢ ×”×¦×™×•× ×™× ×©×œ <strong>'+crit.length+'</strong> ×”×¡×¢×™×¤×™×</span></div>';

      // Criteria sections â€” each with score slider + note
      crit.forEach(function(cr,i){
        var col=COL[i%COL.length];
        html+='<div class="score-section" style="animation-delay:'+(i*0.05)+'s;border-right:4px solid '+col+'">'+
          '<div class="score-section-header"><h3><span class="s-num" style="background:'+col+'">'+String.fromCharCode(1488+i)+'</span>'+esc(cr)+'</h3><div class="sv" id="cv_'+i+'" style="color:'+col+'">50</div></div>'+
          '<div class="score-section-body">'+
          '<div class="sr2"><span style="font-size:12px;color:var(--t5)">0</span><input type="range" min="0" max="100" step="1" value="50" id="cs_'+i+'" oninput="updSliderVal(\'cs_'+i+'\',\'cv_'+i+'\')"><span style="font-size:12px;color:var(--t5)">100</span></div>'+
          '<textarea id="cn_'+i+'" rows="2" placeholder="×”×¢×¨×•×ª ×¢×œ '+esc(cr)+'..." style="font-size:13px"></textarea>'+
          '</div></div>';
      });
    }else{
      // No criteria â€” single general box
      document.getElementById('weightInfo').innerHTML='';
      html+='<div class="score-section general-section">'+
        '<div class="score-section-header"><h3>ğŸ¤ ×”×¢×¨×›×” ×›×œ×œ×™×ª</h3><div class="sv" id="gen_val" style="color:#fff">50</div></div>'+
        '<div class="score-section-body">'+
        '<div class="sr2"><span style="font-size:12px;color:var(--t5)">0</span><input type="range" min="0" max="100" step="1" value="50" id="gen_slider" oninput="updSliderVal(\'gen_slider\',\'gen_val\')"><span style="font-size:12px;color:var(--t5)">100</span></div>'+
        '<div class="range-labels"><span>×—×œ×© ×××•×“</span><span>×—×œ×©</span><span>×‘×™× ×•× ×™</span><span>×˜×•×‘</span><span>××¦×•×™×Ÿ</span></div>'+
        '<textarea id="gen_note" rows="4" placeholder="×”×ª×¨×©××•×ª ×›×œ×œ×™×ª ××”×‘×—×™× ×”..."></textarea>'+
        '</div></div>';
    }

    document.getElementById('scoreSections').innerHTML=html;

    // Total bar
    document.getElementById('totalBar').innerHTML='<div class="total-score-bar"><div style="font-size:13px;color:var(--t4);margin-bottom:4px">×¦×™×•×Ÿ ×¡×•×¤×™</div><div class="total-score-val" id="totalVal" style="color:var(--pr)">50</div><div class="total-score-label">××ª×•×š 100</div></div>';
    updTotalDisplay();
    show('S6');
  });
}

function togWork(){var e=document.getElementById('wCd'),b=document.getElementById('togWB');e.classList.toggle('hidden');b.textContent=e.classList.contains('hidden')?'ğŸ“„ ×”×¦×’ ×”× ×—×™×•×ª':'ğŸ“„ ×”×¡×ª×¨ ×”× ×—×™×•×ª'}

function submitSc(){
  var nm=document.getElementById('eN').value.trim();
  var crit=(cachedCfg&&cachedCfg.criteria)||[];
  var hasCrit=crit.length>0;
  var data={ts:new Date().toISOString()};

  if(hasCrit){
    var secs=[];
    var hasAnyNote=false;
    crit.forEach(function(cr,i){
      var note=(document.getElementById('cn_'+i).value||'').trim();
      if(note)hasAnyNote=true;
      secs.push({score:parseInt(document.getElementById('cs_'+i).value),note:note});
    });
    data.sections=secs;
    data.total=calcTotal(data,crit);
    if(!hasAnyNote&&!confirm('×œ× ×›×ª×‘×ª ×”×¢×¨×•×ª ×‘××£ ×¡×¢×™×£. ×œ×”×’×™×© ×‘×›×œ ×–××ª?'))return;
  }else{
    data.generalScore=parseInt(document.getElementById('gen_slider').value);
    data.generalNote=(document.getElementById('gen_note').value||'').trim();
    data.total=data.generalScore;
    if(!data.generalNote&&!confirm('×œ× ×›×ª×‘×ª ×”×¢×¨×•×ª. ×œ×”×’×™×© ×‘×›×œ ×–××ª?'))return;
  }

  dbSet('oral_scores/'+nm,data).then(function(){document.getElementById('eN').value='';show('S7')});
}

// ====== SIMULATION ======
function runSim(){
  if(!cachedCfg){alert('×”×’×“×™×¨×• ×§×•×“×');return}
  var el=document.getElementById('simSt');el.style.display='block';
  var crit=(cachedCfg.criteria||[]);

  var profiles=[
    {name:'×“× ×” ×›×”×Ÿ',bias:-12,style:'××—××™×¨×”'},
    {name:'×™×•×¡×™ ×œ×•×™',bias:14,style:'××§×œ'},
    {name:'××™×›×œ ××‘×¨×”×',bias:0,style:'×××•×–× ×ª'},
    {name:'××•×¨×™ ×©××©',bias:-6,style:'××ª××§×“ ×‘×ª×•×›×Ÿ'},
    {name:'× ×¢××” ×¨×•×Ÿ',bias:4,style:'××ª××§×“×ª ×‘×‘×™×˜×•×™'}
  ];
  var idx=0;
  function next(){
    if(idx>=profiles.length){
      el.innerHTML='âœ… × ×•×¦×¨×• 5 ×”×¢×¨×›×•×ª!';setTimeout(function(){el.style.display='none'},3000);viewMode='sim';showRes();return;
    }
    var prof=profiles[idx];
    el.innerHTML='ğŸ¤– '+prof.name+' ('+prof.style+')... <span style="animation:pulse 1s infinite">â³</span>';
    setTimeout(function(){
      var data={ts:new Date().toISOString()};

      if(crit.length>0){
        var secs=[];
        crit.forEach(function(cr){
          var s=Math.max(15,Math.min(95,65+prof.bias+Math.round((Math.random()-0.5)*24)));
          var note='';
          var shortC=cr.length>30?cr.substring(0,30)+'...':cr;
          if(Math.random()<0.7){
            if(s>=70){var pn=['×‘×¨××” ×˜×•×‘×”','×‘×™×¦×•×¢ ×ª×§×™×Ÿ ×•××©×›× ×¢','×©×œ×™×˜×” ×˜×•×‘×”'];note=pn[Math.floor(Math.random()*pn.length)]}
            else{var nn=['× ×“×¨×© ×©×™×¤×•×¨','×‘×™×¦×•×¢ ×—×œ×§×™','×—×¡×¨, ×œ× ××¡×¤×™×§'];note=nn[Math.floor(Math.random()*nn.length)]}
          }
          secs.push({score:s,note:note});
        });
        data.sections=secs;
      }else{
        var genScore=Math.max(20,Math.min(95,65+prof.bias+Math.round((Math.random()-0.5)*18)));
        data.generalScore=genScore;
        var genNotes=genScore>=75?['×‘×™×¦×•×¢ ××¨×©×™×, ×©×œ×™×˜×” ×‘×¨××” ×’×‘×•×”×”','×”×¦×’×” ××©×›× ×¢×ª']:genScore>=55?['×‘×™×¦×•×¢ ×¡×‘×™×¨, ×™×© ××§×•× ×œ×©×™×¤×•×¨','×©×œ×™×˜×” ×‘×¡×™×¡×™×ª']:['×‘×™×¦×•×¢ ×—×œ×©, ×—×•×¡×¨ ×©×œ×™×˜×”','× ×“×¨×©×ª ×”×›× ×” ×˜×•×‘×” ×™×•×ª×¨'];
        data.generalNote=genNotes[Math.floor(Math.random()*genNotes.length)];
      }
      data.total=calcTotal(data,crit);

      dbSet('oral_sim/'+prof.name,data).then(function(){idx++;next()});
    },400);
  }
  next();
}

// ====== RESULTS ======
function showRes(){
  if(liveUnsub)liveUnsub();
  var unsub1=dbListen('oral_scores',function(d){cachedReal=d||{};renderResults()});
  var unsub2=dbListen('oral_sim',function(d){cachedSim=d||{};renderResults()});
  liveUnsub=function(){unsub1();unsub2()};
  show('S3');
}

function getViewData(){if(viewMode==='real')return cachedReal;if(viewMode==='sim')return cachedSim;var out={};var k;for(k in cachedReal)out[k]=cachedReal[k];for(k in cachedSim)out[k]=cachedSim[k];return out}

function renderResults(){
  var hasR=Object.keys(cachedReal).length>0,hasS=Object.keys(cachedSim).length>0;
  if(!hasR&&hasS)viewMode='sim';else if(hasR&&!hasS)viewMode='real';
  document.getElementById('viewTog').style.display=(hasR&&hasS)?'flex':'none';
  updVB();
  var a=getViewData(),names=Object.keys(a);
  document.getElementById('rSb').textContent=names.length+' ×‘×•×—× ×™×'+(viewMode==='sim'?' (×¡×™××•×œ×¦×™×”)':viewMode==='both'?' (×”×›×œ)':'');
  if(!names.length){document.getElementById('nS').classList.remove('hidden');document.getElementById('rC').classList.add('hidden')}
  else{document.getElementById('nS').classList.add('hidden');document.getElementById('rC').classList.remove('hidden');rendAll(a,names)}
}
function setV(m){viewMode=m;updVB();renderResults()}
function updVB(){document.getElementById('vR').classList.toggle('active',viewMode==='real');document.getElementById('vS').classList.toggle('active',viewMode==='sim');document.getElementById('vB').classList.toggle('active',viewMode==='both')}

function rendAll(a,names){
  var crit=(cachedCfg&&cachedCfg.criteria)||[];
  var hasCrit=crit.length>0;
  var tots=names.map(function(n){return a[n].total!=null?a[n].total:calcTotal(a[n],crit)});
  var avg=(tots.reduce(function(x,b){return x+b},0)/tots.length).toFixed(1);
  var gap=Math.max.apply(null,tots)-Math.min.apply(null,tots);
  var mn=tots.reduce(function(x,b){return x+b},0)/tots.length;
  var std=Math.sqrt(tots.reduce(function(x,v){return x+(v-mn)*(v-mn)},0)/tots.length).toFixed(1);

  // Stats
  document.getElementById('stR').innerHTML=
    '<div class="stc"><div class="stv" style="color:var(--pr)">'+avg+'</div><div class="stl">×××•×¦×¢ ×¡×•×¤×™</div></div>'+
    '<div class="stc"><div class="stv" style="color:'+(gap>20?'var(--rd)':gap>10?'var(--yw)':'var(--gn)')+'">'+gap.toFixed(1)+'</div><div class="stl">×¤×¢×¨ ××§×¡×™××œ×™</div></div>'+
    '<div class="stc"><div class="stv" style="color:var(--bl)">'+std+'</div><div class="stl">×¡×˜×™×™×ª ×ª×§×Ÿ</div></div>'+
    '<div class="stc"><div class="stv" style="color:var(--pr2)">'+names.length+'</div><div class="stl">×‘×•×—× ×™×</div></div>';

  // Bar chart
  var avgN=parseFloat(avg);
  if(barChart)barChart.destroy();
  barChart=new Chart(document.getElementById('barC'),{type:'bar',data:{labels:names,datasets:[{label:'×¦×™×•×Ÿ ×¡×•×¤×™',data:tots,backgroundColor:tots.map(function(t){return Math.abs(t-avgN)>15?'#f87171':'#7c6cf0'}),borderRadius:6,barPercentage:0.5},{label:'×××•×¦×¢',data:names.map(function(){return avgN}),type:'line',borderColor:'#fbbf24',borderDash:[6,4],pointRadius:0,borderWidth:2,fill:false}]},options:{responsive:true,scales:{y:{min:0,max:100,grid:{color:'#2a2a4040'},ticks:{color:'#686880'}},x:{grid:{display:false},ticks:{color:'#c8c8d8',font:{size:12,family:'Heebo'}}}},plugins:{legend:{labels:{color:'#c8c8d8',font:{family:'Heebo'}}}}}});

  // Comparison table (if criteria exist)
  if(hasCrit){
    var h='<table class="ct"><thead><tr><th>×¡×¢×™×£</th>'+names.map(function(n){return'<th>'+esc(n)+'</th>'}).join('')+'<th>×××•×¦×¢</th><th>×¤×¢×¨</th></tr></thead><tbody>';
    crit.forEach(function(cr,i){
      var vals=names.map(function(n){var s=a[n].sections;return s&&s[i]?s[i].score:0});
      var cavg=(vals.reduce(function(x,b){return x+b},0)/vals.length).toFixed(0);
      var cgap=Math.max.apply(null,vals)-Math.min.apply(null,vals);
      h+='<tr><td>'+esc(cr)+'</td>'+vals.map(function(v){return'<td style="color:'+scoreColor(v)+'">'+v+'</td>'}).join('')+'<td style="font-weight:700">'+cavg+'</td><td style="font-weight:700;color:'+(cgap>20?'var(--rd)':cgap>10?'var(--yw)':'var(--gn)')+'">'+cgap+'</td></tr>';
    });
    // General row â€” only if no criteria
    if(!hasCrit){
      var gvals=names.map(function(n){return a[n].generalScore||0});
      var gavg=(gvals.reduce(function(x,b){return x+b},0)/gvals.length).toFixed(0);
      var ggap=Math.max.apply(null,gvals)-Math.min.apply(null,gvals);
      h+='<tr><td>ğŸ¤ ×”×¢×¨×›×” ×›×œ×œ×™×ª</td>'+gvals.map(function(v){return'<td style="color:'+scoreColor(v)+'">'+v+'</td>'}).join('')+'<td style="font-weight:700">'+gavg+'</td><td style="font-weight:700">'+ggap+'</td></tr>';
    }
    // Total row
    h+='<tr class="ttr"><td>×¦×™×•×Ÿ ×¡×•×¤×™</td>'+tots.map(function(t){return'<td style="color:'+scoreColor(t)+'">'+t+'</td>'}).join('')+'<td>'+avg+'</td><td>'+gap.toFixed(1)+'</td></tr>';
    h+='</tbody></table>';
    document.getElementById('compTable').innerHTML=h;
  }else{
    document.getElementById('compTable').innerHTML='';
  }

  // Cards
  var sorted=names.slice().sort(function(a2,b2){var ta=a[b2].total!=null?a[b2].total:calcTotal(a[b2],crit);var tb=a[a2].total!=null?a[a2].total:calcTotal(a[a2],crit);return ta-tb});
  var cardsHtml='<h3 style="font-size:17px;margin:20px 0 14px">ğŸ“ ×¤×™×¨×•×˜ ×”×¢×¨×›×•×ª</h3>';
  sorted.forEach(function(nm,idx){
    var d=a[nm];
    var total=d.total!=null?d.total:calcTotal(d,crit);
    cardsHtml+='<div class="res-card" style="animation-delay:'+(idx*0.04)+'s"><div class="res-header"><span class="res-name">'+esc(nm)+'</span><span class="res-score" style="color:'+scoreColor(total)+'">'+total+'</span></div>';

    if(hasCrit&&d.sections){
      cardsHtml+='<div class="res-sections">';
      crit.forEach(function(cr,i){
        var sc=(d.sections[i]?d.sections[i].score:0);
        cardsHtml+='<div class="res-sec-chip"><span style="color:var(--t4)">'+esc(cr.length>20?cr.substring(0,20)+'..':cr)+':</span> <span class="chip-score" style="color:'+scoreColor(sc)+'">'+sc+'</span></div>';
      });
      cardsHtml+='</div>';

      // Section notes
      crit.forEach(function(cr,i){
        if(d.sections[i]&&d.sections[i].note){
          cardsHtml+='<div class="res-note-block"><div class="res-note-title">'+esc(cr)+':</div><div class="res-note">'+esc(d.sections[i].note)+'</div></div>';
        }
      });
    }
    if(!hasCrit&&d.generalNote){
      cardsHtml+='<div class="res-note-block"><div class="res-note-title">ğŸ¤ ×”×¢×¨×›×” ×›×œ×œ×™×ª:</div><div class="res-note">'+esc(d.generalNote)+'</div></div>';
    }
    cardsHtml+='</div>';
  });
  document.getElementById('resList').innerHTML=cardsHtml;
}

function expRes(){
  var a=getViewData(),names=Object.keys(a);
  var crit=(cachedCfg&&cachedCfg.criteria)||[];
  var t='=== ×”×©×•×•××ª ×”×¢×¨×›×•×ª ×‘×—×™× ×” ×‘×¢"×¤ ===\n\n';
  names.forEach(function(n){
    var d=a[n];var total=d.total!=null?d.total:calcTotal(d,crit);
    t+=n+' â€” ×¦×™×•×Ÿ ×¡×•×¤×™: '+total+'/100\n';
    if(crit.length&&d.sections){
      crit.forEach(function(cr,i){
        var s=d.sections[i]||{};
        t+='  '+cr+': '+(s.score||0)+(s.note?' | '+s.note:'')+'\n';
      });
    }else{
      t+='  ×¦×™×•×Ÿ: '+(d.generalScore||0)+(d.generalNote?' | '+d.generalNote:'')+'\n';
    }
    t+='\n';
  });
  navigator.clipboard.writeText(t).then(function(){alert('×”×•×¢×ª×§!')});
}
</script>
</body>
</html>
