<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>× ×•×›×—×•×ª ××™×¨×•×¢ ×¤×•×¨×™× - ×‘×™×ª ×—×™× ×•×š ×’×œ×™×œ ××¢×¨×‘×™</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary: #6c3483;
            --primary-light: #a569bd;
            --primary-dark: #4a235a;
            --success: #27ae60;
            --danger: #c0392b;
            --warning: #f39c12;
            --bg: #fdf2f8;
            --white: #ffffff;
            --orange: #e67e22;
            --teal: #1abc9c;
            --blue: #2980b9;
            --gold: #f1c40f;
        }
        
        * { box-sizing: border-box; font-family: 'Rubik', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background-color: var(--bg); color: #333; min-height: 100vh; }
        
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                radial-gradient(circle at 10% 20%, #f39c1220 2px, transparent 2px),
                radial-gradient(circle at 80% 10%, #e74c3c20 3px, transparent 3px),
                radial-gradient(circle at 50% 50%, #9b59b620 2px, transparent 2px),
                radial-gradient(circle at 20% 80%, #3498db20 3px, transparent 3px),
                radial-gradient(circle at 90% 70%, #27ae6020 2px, transparent 2px),
                radial-gradient(circle at 40% 30%, #f1c40f20 3px, transparent 3px);
            background-size: 200px 200px;
            z-index: -1;
            pointer-events: none;
        }

        .header { 
            background: linear-gradient(135deg, var(--primary-dark), var(--primary), var(--primary-light));
            color: var(--white); padding: 15px 20px; display: flex; justify-content: center; align-items: center; 
            position: sticky; top: 0; z-index: 100; 
            box-shadow: 0 4px 20px rgba(108,52,131,0.4);
        }
        .header-titles { display: flex; flex-direction: column; align-items: center; text-align: center; }
        .header h1 { margin: 0; font-size: 1.4rem; font-weight: 900; }
        .header-credit { font-size: 0.95rem; font-weight: 700; color: var(--gold); margin-top: 5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        
        #userInfo { position: absolute; left: 15px; display: flex; align-items: center; gap: 10px; }
        .btn-logout { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: bold; transition: 0.2s; font-family: inherit; font-size: 0.9rem; }
        .btn-logout:hover { background: rgba(255,255,255,0.35); }

        @media (max-width: 600px) {
            .header h1 { font-size: 1.1rem; }
            .header-credit { font-size: 0.8rem; }
            #userName { display: none; }
            #userInfo { left: 10px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr) !important; }
            .summary-cards { grid-template-columns: 1fr !important; }
        }

        .container { padding: 20px; max-width: 850px; margin: 0 auto; }
        
        .screen { display: none; animation: fadeIn 0.3s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .login-box { background: var(--white); padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 8px 30px rgba(108,52,131,0.12); margin-top: 30px; border: 1px solid #f0e6f6; }
        .login-emoji { font-size: 70px; margin-bottom: 10px; display: block; }
        .role-btn { width: 100%; padding: 18px; margin: 8px 0; border: none; border-radius: 12px; font-size: 1.15rem; font-weight: 700; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; transition: transform 0.2s; font-family: inherit; }
        .role-btn:active { transform: scale(0.97); }
        .btn-teacher { background: linear-gradient(135deg, #3498db, #2980b9); }
        .btn-summary { background: linear-gradient(135deg, var(--primary), var(--primary-light)); }
        .btn-cities { background: linear-gradient(135deg, var(--teal), #16a085); }
        .role-note { font-size: 0.85rem; color: #7f8c8d; margin: 0 0 12px 0; text-align: right; padding: 0 5px; line-height: 1.5; }

        .toggle-excel-btn { display: inline-block; margin-top: 25px; font-size: 0.9rem; color: #7f8c8d; text-decoration: underline; cursor: pointer; }
        .excel-upload-zone { display: none; margin-top: 15px; padding: 20px; background: #f8f9fa; border: 2px dashed #bdc3c7; border-radius: 12px; text-align: center; }
        .excel-upload-zone input[type="file"] { display: none; }
        .btn-excel { background: var(--success); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; display: inline-flex; align-items: center; gap: 8px; font-family: inherit; }

        .class-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 14px; }
        .class-card { background: var(--white); padding: 22px 10px; border-radius: 14px; text-align: center; cursor: pointer; font-weight: 900; font-size: 1.3rem; box-shadow: 0 3px 12px rgba(0,0,0,0.06); transition: 0.2s; color: var(--primary); border: 2px solid transparent; border-right-width: 7px; }
        .class-card:hover, .class-card:active { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
        .class-attendance-info { font-size: 0.82rem; font-weight: 500; color: #7f8c8d; margin-top: 5px; }

        .student-row { display: flex; justify-content: space-between; align-items: center; background: var(--white); padding: 14px 16px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border-right: 5px solid #d5d8dc; transition: all 0.3s; cursor: pointer; }
        .student-row.present { border-right-color: var(--success); background: #eafaf1; }
        .student-info { display: flex; flex-direction: column; gap: 3px; }
        .student-name { font-weight: 700; font-size: 1.1rem; }
        .student-meta { font-size: 0.82rem; color: #95a5a6; }
        
        .btn-mark { padding: 11px 22px; border: none; border-radius: 25px; font-weight: 700; cursor: pointer; font-size: 0.95rem; transition: 0.3s; min-width: 115px; font-family: inherit; }
        .btn-mark.missing { background: #f5f6fa; color: #95a5a6; border: 1px solid #d5d8dc; }
        .btn-mark.present { background: var(--success); color: white; box-shadow: 0 4px 15px rgba(39,174,96,0.35); }

        .btn-back { background: none; border: none; color: var(--primary); font-weight: bold; font-size: 1.05rem; cursor: pointer; margin-bottom: 18px; display: flex; align-items: center; padding: 0; font-family: inherit; }

        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px; }
        .stat-box { background: white; padding: 16px 10px; border-radius: 14px; text-align: center; box-shadow: 0 3px 12px rgba(0,0,0,0.06); }
        .stat-num { font-size: 2.2rem; font-weight: 900; margin-bottom: 4px; }
        .stat-label { font-size: 0.85rem; font-weight: 500; color: #666; }

        .summary-cards { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px; }
        .summary-card { background: white; border-radius: 14px; overflow: hidden; box-shadow: 0 3px 12px rgba(0,0,0,0.06); }
        .summary-card-header { padding: 14px 18px; font-weight: 900; font-size: 1.1rem; color: white; display: flex; justify-content: space-between; align-items: center; }
        .summary-card-body { padding: 12px 16px; }
        .summary-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .summary-row:last-child { border-bottom: none; }
        .summary-row-name { font-weight: 600; font-size: 0.95rem; }
        .summary-row-count { font-weight: 900; font-size: 1.1rem; color: var(--primary); background: #f5eef8; padding: 2px 12px; border-radius: 20px; }
        .summary-total { display: flex; justify-content: space-between; align-items: center; padding: 12px 18px; background: #f8f4fc; font-weight: 900; font-size: 1.05rem; color: var(--primary); border-top: 2px solid #e8daef; }

        .division-group { margin-bottom: 14px; }
        .division-header { background: white; padding: 16px 18px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-right: 7px solid; transition: background 0.2s; }
        .division-header:active { background: #f8f4fc; }
        .division-body { display: none; padding: 12px 5px 5px 5px; animation: fadeIn 0.3s ease; }
        .division-body.active { display: block; }
        .division-class-row { background: white; padding: 14px 18px; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 5px rgba(0,0,0,0.04); border-right: 4px solid; }
        .division-class-name { font-weight: 700; font-size: 1rem; }
        .division-class-count { font-weight: 900; font-size: 1.15rem; padding: 3px 14px; border-radius: 20px; }

        .city-row { background: white; padding: 16px 20px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-right: 5px solid var(--teal); transition: 0.2s; }
        .city-name { font-weight: 700; font-size: 1.05rem; }
        .city-count { font-weight: 900; font-size: 1.3rem; color: var(--teal); background: #e8f8f5; padding: 4px 16px; border-radius: 20px; }
        .city-percent { font-size: 0.8rem; color: #95a5a6; margin-top: 2px; }

        .admin-actions { display: flex; gap: 10px; margin-bottom: 22px; flex-wrap: wrap; }
        .btn-action { border: none; padding: 12px 10px; border-radius: 10px; cursor: pointer; font-weight: bold; flex: 1; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; font-family: inherit; color: white; min-width: 130px; }
        .btn-action:hover { transform: scale(0.98); }

        .section-title { color: var(--primary); margin: 28px 0 14px 0; font-size: 1.1rem; border-bottom: 2px solid #e8daef; padding-bottom: 10px; display: flex; align-items: center; gap: 8px; }

        .progress-bar-wrap { background: #e8daef; border-radius: 20px; height: 10px; margin: 8px 0 16px 0; overflow: hidden; }
        .progress-bar-fill { height: 100%; border-radius: 20px; background: linear-gradient(90deg, var(--success), #2ecc71); transition: width 0.5s ease; }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-titles">
            <h1>ğŸ­ × ×•×›×—×•×ª ××™×¨×•×¢ ×¤×•×¨×™× â€“ ×’×œ×™×œ ××¢×¨×‘×™</h1>
            <span class="header-credit">×¤×™×ª×•×— ××¤×œ×™×§×¦×™×” â€“ ×¨× ×™ ×‘×Ÿ ×–××‘</span>
        </div>
        <div id="userInfo" style="display:none;">
            <span id="userName" style="font-size:0.9rem; font-weight: 500;"></span>
            <button class="btn-logout" onclick="logout()">×™×¦×™××”</button>
        </div>
    </div>

    <div class="container">

        <div id="screen-login" class="screen active">
            <div class="login-box">
                <span class="login-emoji">ğŸ‰</span>
                <h2 style="margin-top: 0; font-size: 1.6rem; color: var(--primary);">××¢×¨×›×ª × ×•×›×—×•×ª â€“ ××¡×™×‘×ª ×¤×•×¨×™×</h2>
                <p style="color: #7f8c8d; margin-bottom: 25px; font-size: 1rem;">×‘×—×¨×• ××ª ×¡×•×’ ×”×›× ×™×¡×”:</p>
                
                <button class="role-btn btn-teacher" onclick="login('teacher')">
                    <span class="material-icons-round">groups</span> ×¡×™××•×Ÿ × ×•×›×—×•×ª ×œ×¤×™ ×›×™×ª×”
                </button>
                <p class="role-note">××—× ×›×™ ×›×™×ª×•×ª â€“ ×¡×× ×• ××™ ××”×ª×œ××™×“×™× ×”×’×™×¢ ×œ××™×¨×•×¢</p>
                
                <button class="role-btn btn-summary" onclick="login('summary')">
                    <span class="material-icons-round">bar_chart</span> ×¡×™×›×•× ×œ×¤×™ ×—×˜×™×‘×•×ª ×•×›×™×ª×•×ª
                </button>
                <p class="role-note">×ª××•× ×ª ××¦×‘ ××¡×¤×¨×™×ª: ×›××” ×ª×œ××™×“×™× ×‘××™×¨×•×¢ ×œ×¤×™ ×—×˜×™×‘×•×ª ×•×›×™×ª×•×ª</p>

                <button class="role-btn btn-cities" onclick="login('cities')">
                    <span class="material-icons-round">location_city</span> ×¡×™×›×•× ×œ×¤×™ ×™×™×©×•×‘×™×
                </button>
                <p class="role-note">×›××” ×ª×œ××™×“×™× ××›×œ ×™×™×©×•×‘ ×”×’×™×¢×• ×œ××™×¨×•×¢</p>
                
                <div class="toggle-excel-btn" onclick="document.getElementById('excelZone').style.display='block'; this.style.display='none';">
                    âš™ï¸ ×”×’×“×¨×•×ª: ×¢×“×›×•×Ÿ ××¦×‘×ª ×ª×œ××™×“×™× (Excel)
                </div>

                <div class="excel-upload-zone" id="excelZone">
                    <h3 style="margin-top:0; font-size: 1.05rem; color: #555;">×”×¢×œ××ª × ×ª×•× ×™ ×‘×™×ª ×¡×¤×¨</h3>
                    <p style="font-size: 0.83rem; color: #777; line-height: 1.6;">×”×¢×œ×• ×§×•×‘×¥ Excel. ×”××¢×¨×›×ª ×ª×–×”×” ××•×˜×•××˜×™×ª ××ª ×”×¢××•×“×•×ª:<br><b>×©× ××©×¤×—×”, ×©× ×¤×¨×˜×™, ×©×›×‘×”, ××§×‘×™×œ×”, ×™×™×©×•×‘</b><br>×’× ×§×‘×¦×™× ×¢× ×ª.×– ×•×˜×œ×¤×•×Ÿ ×™×–×•×”×• ××•×˜×•××˜×™×ª</p>
                    <input type="file" id="excelFile" accept=".xlsx, .xls" onchange="handleExcelUpload(event)">
                    <button class="btn-excel" onclick="document.getElementById('excelFile').click()">
                        <span class="material-icons-round">upload_file</span> ×‘×—×¨ ×§×•×‘×¥ ××§×¡×œ
                    </button>
                    <div id="uploadStatus" style="margin-top: 10px; font-weight: bold; font-size: 0.9rem;"></div>
                </div>
            </div>
        </div>

        <div id="screen-teacher-lobby" class="screen">
            <button class="btn-back" onclick="logout()">
                <span class="material-icons-round">arrow_forward</span> ×—×–×¨×” ×œ×“×£ ×”×¨××©×™
            </button>
            <h2 style="margin-bottom: 5px; color: var(--primary); font-size: 1.4rem;">ğŸ­ ×‘×—×¨×• ×›×™×ª×” ×œ×¡×™××•×Ÿ × ×•×›×—×•×ª:</h2>
            <p style="color: #7f8c8d; font-size: 0.95rem; margin-bottom: 22px;">×¡×× ×• ××ª ×”×ª×œ××™×“×™× ×©× ××¦××™× ×‘××™×¨×•×¢ ×”×¤×•×¨×™×</p>
            <div class="class-grid" id="classGrid"></div>
        </div>

        <div id="screen-teacher-class" class="screen">
            <button class="btn-back" id="btnBackToLobby" onclick="goBackToLobby()">
                <span class="material-icons-round">arrow_forward</span> ×—×–×•×¨ ×œ×¨×©×™××ª ×”×›×™×ª×•×ª
            </button>
            
            <div style="background: white; padding: 14px 18px; border-radius: 12px; margin-bottom: 18px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); display: flex; justify-content: space-between; align-items: center; border-right: 7px solid var(--primary);" id="classHeaderColor">
                <h2 id="currentClassTitle" style="margin: 0; color: var(--primary); font-size: 1.2rem;">×›×™×ª×”</h2>
                <div style="background: #eafaf1; color: var(--success); padding: 5px 14px; border-radius: 20px; font-weight: bold; font-size: 0.95rem;" id="classProgress">0/0</div>
            </div>

            <div id="classStudentsList"></div>
        </div>

        <div id="screen-summary" class="screen">
            <button class="btn-back" onclick="logout()">
                <span class="material-icons-round">arrow_forward</span> ×—×–×¨×” ×œ×“×£ ×”×¨××©×™
            </button>

            <div class="admin-actions">
                <button class="btn-action" style="background: var(--blue);" onclick="exportSummary()">
                    <span class="material-icons-round">download</span> ×”×•×¨×“×ª ××§×¡×œ
                </button>
                <button class="btn-action" style="background: var(--orange);" onclick="generateDemoScenario()">
                    <span class="material-icons-round">shuffle</span> ×“××•
                </button>
                <button class="btn-action" style="background: var(--danger);" onclick="resetDrill()">
                    <span class="material-icons-round">restart_alt</span> ××™×¤×•×¡
                </button>
            </div>

            <div class="stats-grid" id="summaryStats"></div>
            
            <div class="progress-bar-wrap">
                <div class="progress-bar-fill" id="progressBar" style="width: 0%"></div>
            </div>

            <div class="section-title">
                <span class="material-icons-round">school</span> ×¤×™×¨×•×˜ ×œ×¤×™ ×—×˜×™×‘×•×ª ×•×›×™×ª×•×ª
            </div>
            <div id="summaryByDivision"></div>
        </div>

        <div id="screen-cities" class="screen">
            <button class="btn-back" onclick="logout()">
                <span class="material-icons-round">arrow_forward</span> ×—×–×¨×” ×œ×“×£ ×”×¨××©×™
            </button>

            <div class="stats-grid" id="citiesStats"></div>

            <div class="progress-bar-wrap">
                <div class="progress-bar-fill" id="progressBarCities" style="width: 0%"></div>
            </div>

            <div class="section-title">
                <span class="material-icons-round">location_city</span> × ×•×›×—×•×ª ×œ×¤×™ ×™×™×©×•×‘×™×
            </div>
            <div id="citiesList"></div>
        </div>

    </div>

    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyDwzeZUUWZNgZE9_gYkwPwKBx2qryqp494",
            authDomain: "purim-event-4defb.firebaseapp.com",
            databaseURL: "https://purim-event-4defb-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "purim-event-4defb",
            storageBucket: "purim-event-4defb.firebasestorage.app",
            messagingSenderId: "283889256606",
            appId: "1:283889256606:web:c2d59f2b43479825fc138f"
        };
        
        firebase.initializeApp(firebaseConfig);
        var db = firebase.database();

        var currentRole = null;
        var allStudents = {};
        var attendance = {};
        var activeClass = null;
        var openDivisions = new Set();
        var listenersAttached = false;

        var DIVISIONS = {
            '×—×˜"×‘': { prefix: ['×–','×—','×˜'], color: '#3498db', icon: 'ğŸ“˜' },
            '×—×˜"×¢': { prefix: ['×™','×™×','×™×‘'], color: '#9b59b6', icon: 'ğŸ“—' }
        };

        function getShichvaColor(clsName) {
            var name = (clsName || '').trim();
            if (name.indexOf('×–') === 0) return '#3498db';
            if (name.indexOf('×—') === 0) return '#9b59b6';
            if (name.indexOf('×˜') === 0) return '#e67e22';
            if (name.indexOf('×™×') === 0) return '#27ae60';
            if (name.indexOf('×™×‘') === 0) return '#f1c40f';
            if (name.indexOf('×™') === 0) return '#e74c3c';
            return '#7f8c8d';
        }

        function getDivision(clsName) {
            var name = (clsName || '').trim();
            if (name.indexOf('×–') === 0 || name.indexOf('×—') === 0 || name.indexOf('×˜') === 0) return '×—×˜"×‘';
            if (name.indexOf('×™') === 0) return '×—×˜"×¢';
            return '××—×¨';
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(function(s) { s.classList.remove('active'); });
            document.getElementById(screenId).classList.add('active');
        }

        function login(role) {
            currentRole = role;
            document.getElementById('userInfo').style.display = 'flex';
            var labels = { teacher: 'ğŸ‘©â€ğŸ« ×¡×™××•×Ÿ × ×•×›×—×•×ª', summary: 'ğŸ“Š ×¡×™×›×•× ×—×˜×™×‘×•×ª', cities: 'ğŸ˜ï¸ ×¡×™×›×•× ×™×™×©×•×‘×™×' };
            document.getElementById('userName').textContent = labels[role] || '';
            if (role === 'teacher') showScreen('screen-teacher-lobby');
            else if (role === 'summary') showScreen('screen-summary');
            else if (role === 'cities') showScreen('screen-cities');
            attachListeners();
        }

        function logout() {
            currentRole = null;
            activeClass = null;
            document.getElementById('userInfo').style.display = 'none';
            showScreen('screen-login');
        }

        function goBackToLobby() {
            activeClass = null;
            showScreen('screen-teacher-lobby');
            renderClassLobby();
        }

        function attachListeners() {
            if (listenersAttached) { routeDataToUI(); return; }
            listenersAttached = true;
            db.ref('students').on('value', function(snap) {
                allStudents = snap.val() || {};
                db.ref('purim_attendance').on('value', function(attSnap) {
                    attendance = attSnap.val() || {};
                    routeDataToUI();
                });
            });
        }

        function routeDataToUI() {
            if (currentRole === 'teacher') {
                if (activeClass) openClass(activeClass);
                else renderClassLobby();
            } else if (currentRole === 'summary') {
                renderSummary();
            } else if (currentRole === 'cities') {
                renderCities();
            }
        }

        // ====== TEACHER ======

        function renderClassLobby() {
            var grid = document.getElementById('classGrid');
            grid.innerHTML = '';
            var classesSet = {};
            Object.entries(allStudents).forEach(function(entry) {
                var s = entry[1];
                var cls = (s.class || '').trim();
                if (cls && cls !== '×œ×œ× ×›×™×ª×”') {
                    if (!classesSet[cls]) classesSet[cls] = { total: 0, present: 0 };
                    classesSet[cls].total++;
                    if (attendance[entry[0]] === 'present') classesSet[cls].present++;
                }
            });
            var sortedClasses = Object.keys(classesSet).sort();
            if (sortedClasses.length === 0) {
                grid.innerHTML = '<p style="color:#7f8c8d;">×¢×“×™×™×Ÿ ×œ× ×”×•×¢×œ×• ×ª×œ××™×“×™×. ×”×¢×œ×• ×§×•×‘×¥ ××§×¡×œ ×‘××¡×š ×”×¨××©×™.</p>';
                return;
            }
            sortedClasses.forEach(function(cls) {
                var data = classesSet[cls];
                var card = document.createElement('div');
                card.className = 'class-card';
                card.style.borderRightColor = getShichvaColor(cls);
                card.addEventListener('click', function() { activeClass = cls; openClass(cls); });
                card.innerHTML = '<div>' + cls + '</div><div class="class-attendance-info">' + data.present + '/' + data.total + ' × ×•×›×—×™×</div>';
                grid.appendChild(card);
            });
        }

        // ==========================================
        // ×ª×™×§×•×Ÿ ×§×¨×™×˜×™: ×©×™××•×© ×‘-DOM API + addEventListener
        // ×‘××§×•× onclick inline - ×¤×•×ª×¨ ×‘×¢×™×™×ª ×’×¨×© ×‘×©××•×ª
        // ×›××• ×¦'×¨×œ×™, ×× ×’'×œ, ×§×•×¦'×¨×• ×•×›×•'
        // ==========================================
        function togglePresence(studentId, currentlyPresent) {
            db.ref('purim_attendance/' + studentId).set(currentlyPresent ? null : 'present');
        }

        function openClass(className) {
            document.getElementById('currentClassTitle').textContent = '×›×™×ª×”: ' + className;
            document.getElementById('currentClassTitle').style.color = getShichvaColor(className);
            document.getElementById('classHeaderColor').style.borderRightColor = getShichvaColor(className);
            
            var list = document.getElementById('classStudentsList');
            list.innerHTML = '';

            var classStudents = Object.entries(allStudents)
                .filter(function(e) { return e[1].class && e[1].class.trim() === className; })
                .sort(function(a, b) { return a[1].name.localeCompare(b[1].name); });

            var presentInClass = 0;

            classStudents.forEach(function(entry) {
                var id = entry[0], student = entry[1];
                var isPresent = attendance[id] === 'present';
                if (isPresent) presentInClass++;
                
                // ×‘× ×™×™×ª ×©×•×¨×” ×¢× DOM API - ×‘×˜×•×— ×œ×’××¨×™ ××ª×•×•×™× ××™×•×—×“×™×
                var row = document.createElement('div');
                row.className = 'student-row' + (isPresent ? ' present' : '');

                var infoDiv = document.createElement('div');
                infoDiv.className = 'student-info';

                var nameSpan = document.createElement('span');
                nameSpan.className = 'student-name';
                nameSpan.textContent = student.name;

                var metaSpan = document.createElement('span');
                metaSpan.className = 'student-meta';
                metaSpan.textContent = student.class + (student.city ? ' Â· ğŸ˜ï¸ ' + student.city : '');

                infoDiv.appendChild(nameSpan);
                infoDiv.appendChild(metaSpan);

                var btn = document.createElement('button');
                btn.className = 'btn-mark ' + (isPresent ? 'present' : 'missing');
                btn.textContent = isPresent ? 'âœ“ × ×•×›×—/×ª' : '×¡××Ÿ × ×•×›×—×•×ª';
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    togglePresence(id, isPresent);
                });

                // ×œ×—×™×¦×” ×¢×œ ×›×œ ×”×©×•×¨×” ×’× ×ª×¡××Ÿ
                row.addEventListener('click', function() {
                    togglePresence(id, isPresent);
                });

                row.appendChild(infoDiv);
                row.appendChild(btn);
                list.appendChild(row);
            });

            document.getElementById('classProgress').textContent = presentInClass + '/' + classStudents.length + ' × ×•×›×—×™×';
            showScreen('screen-teacher-class');
        }

        // ====== SUMMARY ======

        function renderSummary() {
            var total = 0, presentCount = 0;
            var divisionData = {};

            Object.entries(allStudents).forEach(function(entry) {
                var id = entry[0], student = entry[1];
                total++;
                var cls = (student.class || '×œ×œ× ×›×™×ª×”').trim();
                var div = getDivision(cls);
                var isPresent = attendance[id] === 'present';
                if (isPresent) presentCount++;

                if (!divisionData[div]) divisionData[div] = {};
                if (!divisionData[div][cls]) divisionData[div][cls] = { total: 0, present: 0 };
                divisionData[div][cls].total++;
                if (isPresent) divisionData[div][cls].present++;
            });

            var missingCount = total - presentCount;
            var pct = total > 0 ? Math.round(presentCount / total * 100) : 0;

            document.getElementById('summaryStats').innerHTML = 
                '<div class="stat-box" style="border-bottom: 5px solid var(--primary);"><div class="stat-num" style="color: var(--primary);">' + total + '</div><div class="stat-label">×¡×”"×› ×ª×œ××™×“×™×</div></div>' +
                '<div class="stat-box" style="border-bottom: 5px solid var(--success); background: #eafaf1;"><div class="stat-num" style="color: var(--success);">' + presentCount + '</div><div class="stat-label">× ×•×›×—×™× ×‘××™×¨×•×¢ ğŸ­</div></div>' +
                '<div class="stat-box" style="border-bottom: 5px solid var(--danger);"><div class="stat-num" style="color: var(--danger);">' + missingCount + '</div><div class="stat-label">×œ× ×”×’×™×¢×•</div></div>';

            document.getElementById('progressBar').style.width = pct + '%';

            var container = document.getElementById('summaryByDivision');
            container.innerHTML = '';

            var divOrder = ['×—×˜"×‘', '×—×˜"×¢', '××—×¨'];
            var divColors = { '×—×˜"×‘': '#3498db', '×—×˜"×¢': '#9b59b6', '××—×¨': '#7f8c8d' };
            var divIcons = { '×—×˜"×‘': 'ğŸ“˜', '×—×˜"×¢': 'ğŸ“—', '××—×¨': 'ğŸ“' };

            divOrder.forEach(function(div) {
                if (!divisionData[div]) return;
                var classes = divisionData[div];
                var sortedCls = Object.keys(classes).sort();
                var divTotal = 0, divPresent = 0;
                sortedCls.forEach(function(cls) { divTotal += classes[cls].total; divPresent += classes[cls].present; });

                var color = divColors[div] || '#7f8c8d';
                var isOpen = openDivisions.has(div);

                var group = document.createElement('div');
                group.className = 'division-group';

                // Header - using addEventListener
                var header = document.createElement('div');
                header.className = 'division-header';
                header.style.borderRightColor = color;
                header.addEventListener('click', (function(d) { return function() { toggleDivision(d); }; })(div));
                header.innerHTML = '<div><span style="font-weight:900; font-size:1.2rem; color:' + color + ';">' + (divIcons[div] || '') + ' ' + div + '</span><br><span style="font-size:0.83rem; color:#95a5a6;">×¡×”"×› ' + divTotal + ' ×ª×œ××™×“×™× Â· ' + sortedCls.length + ' ×›×™×ª×•×ª</span></div>' +
                    '<div style="text-align:center;"><span style="font-weight:900; font-size:1.5rem; color:var(--success);">' + divPresent + '</span><br><span style="font-size:0.75rem; color:#95a5a6;">× ×•×›×—×™×</span></div>';

                var body = document.createElement('div');
                body.className = 'division-body' + (isOpen ? ' active' : '');

                sortedCls.forEach(function(cls) {
                    var d = classes[cls];
                    var clsColor = getShichvaColor(cls);
                    var clsRow = document.createElement('div');
                    clsRow.className = 'division-class-row';
                    clsRow.style.borderRightColor = clsColor;
                    clsRow.innerHTML = '<div class="division-class-name">' + cls + ' <span style="color:#aaa;font-size:0.8rem;">(' + d.total + ' ×ª×œ××™×“×™×)</span></div>' +
                        '<div class="division-class-count" style="color: ' + (d.present > 0 ? 'var(--success)' : 'var(--danger)') + '; background: ' + (d.present > 0 ? '#eafaf1' : '#fdedec') + ';">' + d.present + '/' + d.total + '</div>';
                    body.appendChild(clsRow);
                });

                group.appendChild(header);
                group.appendChild(body);
                container.appendChild(group);
            });
        }

        function toggleDivision(div) {
            if (openDivisions.has(div)) openDivisions.delete(div);
            else openDivisions.add(div);
            renderSummary();
        }

        // ====== CITIES ======

        function renderCities() {
            var total = 0, presentCount = 0;
            var cityData = {};

            Object.entries(allStudents).forEach(function(entry) {
                var id = entry[0], student = entry[1];
                total++;
                var city = (student.city || '×œ× ×¦×•×™×Ÿ').trim();
                if (!city) city = '×œ× ×¦×•×™×Ÿ';
                var isPresent = attendance[id] === 'present';
                if (isPresent) presentCount++;

                if (!cityData[city]) cityData[city] = { total: 0, present: 0 };
                cityData[city].total++;
                if (isPresent) cityData[city].present++;
            });

            var pct = total > 0 ? Math.round(presentCount / total * 100) : 0;
            var cityCount = Object.keys(cityData).length;

            document.getElementById('citiesStats').innerHTML = 
                '<div class="stat-box" style="border-bottom: 5px solid var(--teal);"><div class="stat-num" style="color: var(--teal);">' + cityCount + '</div><div class="stat-label">×™×™×©×•×‘×™×</div></div>' +
                '<div class="stat-box" style="border-bottom: 5px solid var(--success); background: #eafaf1;"><div class="stat-num" style="color: var(--success);">' + presentCount + '</div><div class="stat-label">× ×•×›×—×™× ×‘××™×¨×•×¢</div></div>' +
                '<div class="stat-box" style="border-bottom: 5px solid var(--primary);"><div class="stat-num" style="color: var(--primary);">' + total + '</div><div class="stat-label">×¡×”"×› ×ª×œ××™×“×™×</div></div>';

            document.getElementById('progressBarCities').style.width = pct + '%';

            var container = document.getElementById('citiesList');
            container.innerHTML = '';

            var sortedCities = Object.keys(cityData).sort(function(a, b) {
                return cityData[b].present - cityData[a].present;
            });

            sortedCities.forEach(function(city) {
                var d = cityData[city];
                var cityPct = d.total > 0 ? Math.round(d.present / d.total * 100) : 0;
                var row = document.createElement('div');
                row.className = 'city-row';
                row.innerHTML = '<div><div class="city-name">ğŸ˜ï¸ ' + city + '</div><div class="city-percent">' + d.total + ' ×ª×œ××™×“×™× ×¨×©×•××™× Â· ' + cityPct + '% × ×•×›×—×•×ª</div></div>' +
                    '<div class="city-count">' + d.present + '/' + d.total + '</div>';
                container.appendChild(row);
            });
        }

        // ====== EXCEL UPLOAD ======

        function handleExcelUpload(event) {
            var file = event.target.files[0];
            if (!file) return;
            var statusDiv = document.getElementById('uploadStatus');
            statusDiv.style.color = 'var(--primary)';
            statusDiv.textContent = 'â³ ×¡×•×¨×§ ××ª ×”×§×•×‘×¥...';

            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var data = new Uint8Array(e.target.result);
                    var workbook = XLSX.read(data, { type: 'array' });
                    var worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    var rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    var headerRowIndex = -1;
                    var colIndices = { id: -1, name: -1, firstName: -1, lastName: -1, shihva: -1, classNum: -1, phone: -1, city: -1 };

                    for (var i = 0; i < Math.min(rows.length, 15); i++) {
                        var row = rows[i];
                        if (!row || row.length === 0) continue;
                        var tempId = -1, tempName = -1, tempFirstName = -1, tempLastName = -1;
                        var tempShihva = -1, tempClassNum = -1, tempPhone = -1, tempCity = -1;

                        for (var j = 0; j < row.length; j++) {
                            var raw = String(row[j] || '').trim();
                            var cellValue = raw.replace(/\s+/g, '').replace(/[\u200B-\u200D\uFEFF]/g, '').toLowerCase();

                            if (cellValue.includes('×ª.×–') || cellValue === '×ª×–' || cellValue.includes('×ª×–×ª×œ××™×“') || cellValue === 'id') tempId = j;
                            else if (cellValue === '×©×××©×¤×—×”' || cellValue.includes('××©×¤×—×”')) tempLastName = j;
                            else if (cellValue === '×©××¤×¨×˜×™' || cellValue.includes('×¤×¨×˜×™')) tempFirstName = j;
                            else if (cellValue.includes('×©××”×ª×œ××™×“') || cellValue === '×©×' || cellValue.includes('×©×××œ×')) tempName = j;
                            else if (cellValue.includes('×©×›×‘×”')) tempShihva = j;
                            else if (cellValue.includes('××§×‘×™×œ×”') || cellValue === '×›×™×ª×”') tempClassNum = j;
                            else if (cellValue.includes('×¡×•×œ×œ×¨') || cellValue.includes('×¡×œ×•×œ×¨') || cellValue.includes('×˜×œ×¤×•×Ÿ') || cellValue.includes('× ×™×™×“')) tempPhone = j;
                            else if (cellValue.includes('×™×©×•×‘') || cellValue.includes('×™×™×©×•×‘') || cellValue.includes('×¢×™×¨') || cellValue.includes('××§×•×××’×•×¨×™×')) tempCity = j;
                        }

                        var hasName = (tempName !== -1) || (tempFirstName !== -1 && tempLastName !== -1);
                        var hasShichva = tempShihva !== -1;
                        if (hasName && hasShichva) {
                            headerRowIndex = i;
                            colIndices = { id: tempId, name: tempName, firstName: tempFirstName, lastName: tempLastName, shihva: tempShihva, classNum: tempClassNum, phone: tempPhone, city: tempCity };
                            break;
                        }
                    }

                    if (headerRowIndex === -1) {
                        statusDiv.style.color = 'var(--danger)';
                        statusDiv.textContent = 'âŒ ×©×’×™××”: ×œ× ××¦×× ×• ××ª ×¢××•×“×•×ª ×”× ×ª×•× ×™× ×”× ×“×¨×©×•×ª.';
                        return;
                    }

                    var updates = {};
                    var count = 0;
                    var cityFound = colIndices.city !== -1;
                    var usedKeys = {};

                    for (var ri = headerRowIndex + 1; ri < rows.length; ri++) {
                        var row2 = rows[ri];
                        if (!row2 || row2.length === 0) continue;
                        var fullName = '';
                        if (colIndices.name !== -1) {
                            fullName = String(row2[colIndices.name] || '').trim();
                        } else if (colIndices.firstName !== -1 && colIndices.lastName !== -1) {
                            var first = String(row2[colIndices.firstName] || '').trim();
                            var last = String(row2[colIndices.lastName] || '').trim();
                            fullName = (first + ' ' + last).trim();
                        }
                        if (!fullName) continue;

                        var studentKey = '';
                        if (colIndices.id !== -1 && row2[colIndices.id]) {
                            studentKey = String(row2[colIndices.id]).trim();
                        } else {
                            studentKey = fullName.replace(/[.#$\[\]\/\s'"`]/g, '_');
                            if (usedKeys[studentKey]) {
                                usedKeys[studentKey]++;
                                studentKey = studentKey + '_' + usedKeys[studentKey];
                            } else {
                                usedKeys[studentKey] = 1;
                            }
                        }

                        var shihvaVal = colIndices.shihva !== -1 ? (row2[colIndices.shihva] || '') : '';
                        var classNumVal = colIndices.classNum !== -1 ? (row2[colIndices.classNum] || '') : '';
                        var phoneVal = colIndices.phone !== -1 ? (row2[colIndices.phone] || '') : '';
                        var cityVal = colIndices.city !== -1 ? (row2[colIndices.city] || '') : '';
                        var cls = (String(shihvaVal).trim() + ' ' + String(classNumVal).trim()).trim() || '×œ×œ× ×›×™×ª×”';
                        var finalPhone = String(phoneVal).trim();
                        if (finalPhone.length === 9 && finalPhone.charAt(0) !== '0') finalPhone = '0' + finalPhone;

                        var studentData = { name: fullName, class: cls };
                        if (finalPhone) studentData.phone = finalPhone;
                        var cityTrimmed = String(cityVal).trim();
                        if (cityTrimmed) studentData.city = cityTrimmed;
                        updates[studentKey] = studentData;
                        count++;
                    }

                    if (count > 0) {
                        db.ref('students').set(updates).then(function() {
                            statusDiv.style.color = 'var(--success)';
                            var cityMsg = cityFound ? ' (×›×•×œ×œ ×™×™×©×•×‘×™× âœ“)' : ' (×œ×œ× ×¢××•×“×ª ×™×™×©×•×‘)';
                            statusDiv.textContent = 'âœ… × ×•×¡×¤×• ' + count + ' ×ª×œ××™×“×™×' + cityMsg;
                            setTimeout(function() { 
                                document.getElementById('excelZone').style.display = 'none'; 
                                document.querySelector('.toggle-excel-btn').style.display = 'inline-block'; 
                            }, 3000);
                        }).catch(function(err) {
                            statusDiv.style.color = 'var(--danger)';
                            statusDiv.textContent = 'âŒ ×©×’×™××”: ' + err.message;
                        });
                    } else {
                        statusDiv.style.color = 'var(--danger)';
                        statusDiv.textContent = 'âŒ ×œ× × ××¦××• ×ª×œ××™×“×™× ×‘×§×•×‘×¥.';
                    }
                } catch (error) {
                    statusDiv.style.color = 'var(--danger)';
                    statusDiv.textContent = 'âŒ ×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥.';
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // ====== DEMO ======

        function generateDemoScenario() {
            if (Object.keys(allStudents).length === 0) {
                alert("××™×Ÿ ×ª×œ××™×“×™× ×‘××¢×¨×›×ª! ×”×¢×œ×• ×§×•×‘×¥ ××§×¡×œ ×§×•×“×.");
                return;
            }
            var pass = prompt("×”×–×Ÿ ×¡×™×¡××”:");
            if (pass !== '1234') { alert("âŒ ×¡×™×¡××” ×©×’×•×™×”!"); return; }
            if (!confirm("âš ï¸ ×¤×¢×•×œ×” ×–×• ×ª×™×™×¦×¨ × ×•×›×—×•×ª ××§×¨××™×ª. ×œ×”××©×™×š?")) return;
            var updates = {};
            Object.keys(allStudents).forEach(function(id) {
                if (Math.random() < 0.72) updates[id] = 'present';
            });
            db.ref('purim_attendance').set(updates).then(function() {
                alert("âœ… ×“××• ×”×•×¤×¢×œ â€“ × ×•×›×—×•×ª ××§×¨××™×ª × ×•×¦×¨×”!");
            });
        }

        function resetDrill() {
            var pass = prompt("×”×–×Ÿ ×¡×™×¡××”:");
            if (pass !== '1234') { alert("âŒ ×¡×™×¡××” ×©×’×•×™×”!"); return; }
            if (confirm("âš ï¸ ×œ××—×•×§ ××ª ×›×œ × ×ª×•× ×™ ×”× ×•×›×—×•×ª?")) {
                db.ref('purim_attendance').remove().then(function() {
                    alert('âœ… ×”× ×•×›×—×•×ª ××•×¤×¡×”.');
                });
            }
        }

        // ====== EXPORT ======

        function exportSummary() {
            var wsData = [['×—×˜×™×‘×”', '×›×™×ª×”', '×¡×”"×› ×ª×œ××™×“×™×', '× ×•×›×—×™× ×‘××™×¨×•×¢', '×œ× ×”×’×™×¢×•', '××—×•×– × ×•×›×—×•×ª']];
            var divisionData = {};
            Object.entries(allStudents).forEach(function(entry) {
                var id = entry[0], student = entry[1];
                var cls = (student.class || '×œ×œ× ×›×™×ª×”').trim();
                var div = getDivision(cls);
                var isPresent = attendance[id] === 'present';
                if (!divisionData[div]) divisionData[div] = {};
                if (!divisionData[div][cls]) divisionData[div][cls] = { total: 0, present: 0 };
                divisionData[div][cls].total++;
                if (isPresent) divisionData[div][cls].present++;
            });

            ['×—×˜"×‘', '×—×˜"×¢', '××—×¨'].forEach(function(div) {
                if (!divisionData[div]) return;
                var sortedCls = Object.keys(divisionData[div]).sort();
                var divTotal = 0, divPresent = 0;
                sortedCls.forEach(function(cls) {
                    var d = divisionData[div][cls];
                    divTotal += d.total; divPresent += d.present;
                    var pct = d.total > 0 ? Math.round(d.present / d.total * 100) + '%' : '0%';
                    wsData.push([div, cls, d.total, d.present, d.total - d.present, pct]);
                });
                var divPct = divTotal > 0 ? Math.round(divPresent / divTotal * 100) + '%' : '0%';
                wsData.push([div + ' - ×¡×”"×›', '', divTotal, divPresent, divTotal - divPresent, divPct]);
            });

            var cityWsData = [['×™×™×©×•×‘', '×¡×”"×› ×ª×œ××™×“×™×', '× ×•×›×—×™×', '×œ× ×”×’×™×¢×•', '××—×•×– × ×•×›×—×•×ª']];
            var cityData = {};
            Object.entries(allStudents).forEach(function(entry) {
                var id = entry[0], student = entry[1];
                var city = (student.city || '×œ× ×¦×•×™×Ÿ').trim() || '×œ× ×¦×•×™×Ÿ';
                var isPresent = attendance[id] === 'present';
                if (!cityData[city]) cityData[city] = { total: 0, present: 0 };
                cityData[city].total++;
                if (isPresent) cityData[city].present++;
            });
            Object.keys(cityData).sort().forEach(function(city) {
                var d = cityData[city];
                var pct = d.total > 0 ? Math.round(d.present / d.total * 100) + '%' : '0%';
                cityWsData.push([city, d.total, d.present, d.total - d.present, pct]);
            });

            var wb = XLSX.utils.book_new();
            var ws1 = XLSX.utils.aoa_to_sheet(wsData);
            ws1['!cols'] = [{ wch: 15 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 12 }];
            XLSX.utils.book_append_sheet(wb, ws1, '×¡×™×›×•× ×—×˜×™×‘×•×ª');
            var ws2 = XLSX.utils.aoa_to_sheet(cityWsData);
            ws2['!cols'] = [{ wch: 20 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 12 }];
            XLSX.utils.book_append_sheet(wb, ws2, '×¡×™×›×•× ×™×™×©×•×‘×™×');

            var now = new Date();
            var dateStr = now.toLocaleDateString('he-IL').replace(/\./g, '-');
            var timeStr = now.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }).replace(':', '-');
            XLSX.writeFile(wb, '× ×•×›×—×•×ª_×¤×•×¨×™×_' + dateStr + '_' + timeStr + '.xlsx');
        }
    </script>
</body>
</html>
