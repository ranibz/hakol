<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>×ª×§×©×•×¨×ª ×•×—×‘×¨×” â€“ ××¡×œ×•×œ ×œ×"×“</title>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<style>
:root{--primary:#4a69bd;--text-dark:#2d3436;--glass-bg:rgba(255,255,255,0.96);--c-al:#6c5ce7;--c-1:#0984e3;--c-2:#00cec9;--c-3:#d63031;--c-4:#e1b12c;--c-5:#00b894;--c-6:#e17055;--c-7:#be2edd;--c-8:#4834d4;--c-9:#e84393;}
*{box-sizing:border-box;outline:none;-webkit-tap-highlight-color:transparent;}
body{font-family:'Rubik',sans-serif;margin:0;padding:0;min-height:100vh;color:var(--text-dark);}
#loginScreen{background:linear-gradient(145deg,#1a1a2e,#16213e,#0f3460);min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;gap:24px;}
.login-hero{text-align:center;color:white;}
.login-hero h1{font-size:2rem;font-weight:900;margin:12px 0 6px;background:linear-gradient(135deg,#a29bfe,#74b9ff,#fd79a8);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.login-hero p{color:rgba(255,255,255,0.6);font-size:0.95rem;margin:0;}
.login-hero-icon{width:80px;height:80px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:24px;display:flex;align-items:center;justify-content:center;margin:0 auto;box-shadow:0 10px 40px rgba(102,126,234,0.5);}
.role-cards{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;width:100%;max-width:480px;}
.role-card{flex:1;min-width:120px;max-width:140px;border:none;border-radius:20px;padding:20px 10px;cursor:pointer;font-family:inherit;font-weight:800;font-size:0.9rem;color:white;transition:all 0.3s;position:relative;overflow:hidden;box-shadow:0 8px 25px rgba(0,0,0,0.3);}
.role-card::before{content:'';position:absolute;inset:0;background:rgba(255,255,255,0.12);border-radius:20px;opacity:0;transition:0.3s;}
.role-card:hover::before,.role-card.active::before{opacity:1;}
.role-card:hover,.role-card.active{transform:translateY(-6px) scale(1.04);box-shadow:0 16px 40px rgba(0,0,0,0.4);}
.role-card-student{background:linear-gradient(145deg,#0984e3,#6c5ce7);}
.role-card-teacher{background:linear-gradient(145deg,#00b894,#00cec9);}
.role-card-admin{background:linear-gradient(145deg,#e17055,#d63031);}
.role-card-icon{font-size:2.2rem;display:block;margin-bottom:8px;}
.role-card-label{display:block;font-size:0.85rem;opacity:0.9;}
.login-box{background:rgba(255,255,255,0.05);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.12);border-radius:24px;padding:30px;width:100%;max-width:380px;box-shadow:0 20px 60px rgba(0,0,0,0.4);}
.login-field{margin-bottom:15px;}
.login-field label{display:block;font-weight:700;margin-bottom:6px;font-size:0.9rem;color:rgba(255,255,255,0.8);}
.login-field input{width:100%;padding:13px 15px;border:2px solid rgba(255,255,255,0.15);border-radius:12px;font-family:inherit;font-size:1rem;transition:0.3s;background:rgba(255,255,255,0.08);color:white;}
.login-field input::placeholder{color:rgba(255,255,255,0.35);}
.login-field input:focus{border-color:rgba(255,255,255,0.5);background:rgba(255,255,255,0.12);}
#studentId{background:rgba(255,255,255,0.15);color:white;}
.btn-login{width:100%;padding:14px;background:linear-gradient(45deg,#667eea,#764ba2);color:white;border:none;border-radius:15px;font-family:inherit;font-size:1.1rem;font-weight:700;cursor:pointer;transition:0.3s;margin-top:10px;box-shadow:0 6px 20px rgba(102,126,234,0.4);}
.btn-login:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(102,126,234,0.6);}
.login-error{color:#ff7675;font-size:0.9rem;text-align:center;margin-top:10px;display:none;}
#studentScreen,#teacherScreen,#adminScreen{display:none;}
.topbar{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;box-shadow:0 4px 15px rgba(0,0,0,0.2);}
.topbar-title{font-weight:900;font-size:1.1rem;}.topbar-user{font-size:0.85rem;opacity:0.9;}
.btn-logout{background:rgba(255,255,255,0.2);border:none;color:white;padding:7px 15px;border-radius:20px;cursor:pointer;font-family:inherit;font-size:0.85rem;font-weight:600;transition:0.3s;}
.btn-logout:hover{background:rgba(255,255,255,0.35);}
#studentScreen{background:linear-gradient(135deg,#a29bfe,#74b9ff);min-height:100vh;padding-bottom:80px;}
.nav-container{position:sticky;top:60px;z-index:99;display:flex;justify-content:center;padding:10px;}
.nav-bar{background:var(--glass-bg);padding:8px;border-radius:50px;display:flex;gap:5px;box-shadow:0 10px 20px rgba(0,0,0,0.1);overflow-x:auto;max-width:100%;}
.nav-btn{background:none;border:none;padding:10px 15px;border-radius:30px;font-weight:500;cursor:pointer;display:flex;align-items:center;gap:6px;font-family:inherit;color:#555;white-space:nowrap;}.nav-btn.active{background:var(--primary);color:white;}
.glass-container{width:95%;max-width:900px;margin:20px auto;background:var(--glass-bg);border-radius:20px;padding:5px 20px 30px;box-shadow:0 20px 60px rgba(0,0,0,0.15);}
.page{display:none;animation:fadeIn 0.5s ease;}.page.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(15px);}to{opacity:1;transform:translateY(0);}}
@keyframes slideIn{from{opacity:0;transform:translateX(-30px);}to{opacity:1;transform:translateX(0);}}
@keyframes bounceIn{0%{transform:scale(0);}50%{transform:scale(1.2);}100%{transform:scale(1);}}
h1{text-align:center;margin:0 0 30px;font-size:2rem;color:var(--text-dark);}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:15px;}
.card{background:white;padding:15px;border-radius:15px;text-align:center;cursor:pointer;box-shadow:0 5px 10px rgba(0,0,0,0.05);transition:all 0.3s;border-bottom:5px solid #ccc;height:140px;display:flex;flex-direction:column;justify-content:center;align-items:center;position:relative;}
.card:hover{transform:translateY(-5px) scale(1.02);box-shadow:0 15px 35px rgba(0,0,0,0.15);}
.card .icon{font-size:35px;margin-bottom:10px;}.card .name{font-weight:700;font-size:1rem;line-height:1.2;}
.c-al{border-color:var(--c-al);color:var(--c-al);}.c-1{border-color:var(--c-1);color:var(--c-1);}.c-2{border-color:var(--c-2);color:var(--c-2);}.c-3{border-color:var(--c-3);color:var(--c-3);}.c-4{border-color:var(--c-4);color:var(--c-4);}.c-5{border-color:var(--c-5);color:var(--c-5);}.c-6{border-color:var(--c-6);color:var(--c-6);}.c-7{border-color:var(--c-7);color:var(--c-7);}.c-8{border-color:var(--c-8);color:var(--c-8);}.c-9{border-color:var(--c-9);color:var(--c-9);}
.chapter-box{border-radius:20px;margin-bottom:25px;background:white;overflow:hidden;border:1px solid #eee;border-right:6px solid #ccc;box-shadow:0 5px 15px rgba(0,0,0,0.03);}
.chapter-header{padding:20px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
.chapter-title{font-weight:800;font-size:1.2rem;display:flex;align-items:center;gap:10px;}
.chapter-content{display:none;padding:25px;border-top:1px solid #eee;animation:slideIn 0.4s ease;}
.btn-open-chapter{background:white;border:1px solid rgba(0,0,0,0.1);padding:6px 15px;border-radius:20px;font-size:0.85rem;font-weight:bold;}
.full-concept-card{padding:20px;border-radius:15px;margin-bottom:20px;border:1px solid rgba(0,0,0,0.05);background:#f9f9f9;}
.card-num{font-size:1.5rem;font-weight:900;opacity:0.2;display:block;margin-bottom:10px;}
.form-group{margin-bottom:15px;}
label{display:block;font-weight:700;margin-bottom:5px;font-size:0.95rem;color:#444;}
input[type="text"],textarea,select{width:100%;padding:12px;border:2px solid #eee;border-radius:10px;background:#fafafa;font-family:inherit;font-size:1rem;}
input[type="text"]:focus,textarea:focus{border-color:var(--primary);background:white;}
textarea{resize:none;min-height:60px;line-height:1.6;overflow-y:hidden;transition:height 0.1s ease;}
.vs-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;}.vs-box{background:white;padding:15px;border:1px solid #eee;border-radius:12px;}
@media(max-width:600px){.vs-grid{grid-template-columns:1fr;}}
.gain{background:#e8f5e9;padding:10px;border-radius:8px;margin-top:10px;border:1px solid #c8e6c9;font-size:0.9rem;}
.cost{background:#ffebee;padding:10px;border-radius:8px;margin-top:10px;border:1px solid #ffcdd2;font-size:0.9rem;}
.btn-back-lobby{background:transparent;border:2px solid #ccc;padding:8px 20px;border-radius:20px;cursor:pointer;font-weight:bold;color:#555;}
.btn-save-changes{background:linear-gradient(45deg,#00b894,#00cec9);color:white;padding:12px 25px;border:none;border-radius:25px;cursor:pointer;font-weight:bold;transition:0.3s;}
.btn-save-all{width:100%;background:linear-gradient(45deg,#00b894,#00cec9);color:white;padding:15px;font-size:1.2rem;border:none;border-radius:50px;font-weight:bold;cursor:pointer;margin-top:20px;}
.teacher-notes-section{background:linear-gradient(135deg,#fff9e6,#fff3cd);border:2px solid #ffc107;border-radius:15px;padding:20px;margin-top:30px;margin-bottom:20px;}
.teacher-notes-title{color:#f57f17;font-size:1.1rem;font-weight:800;margin:0 0 10px;display:flex;align-items:center;gap:8px;}
.teacher-notes-textarea{width:100%;min-height:100px;padding:12px;border:2px solid #ffe082;border-radius:10px;background:white;font-family:inherit;font-size:1rem;resize:vertical;}
.footer-action{display:flex;gap:15px;justify-content:space-between;margin-top:30px;}
.home-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-top:30px;}
.home-card{background:white;padding:25px;border-radius:20px;text-align:center;cursor:pointer;box-shadow:0 10px 20px rgba(0,0,0,0.05);transition:0.3s;border:2px solid transparent;}.home-card:hover{transform:translateY(-5px);border-color:var(--primary);}
.home-icon{font-size:45px;padding:12px;border-radius:50%;margin-bottom:8px;display:inline-block;}
.progress-indicator{position:absolute;top:10px;left:10px;width:35px;height:35px;border-radius:50%;background:conic-gradient(#4cd137 var(--progress),#f0f0f0 0);display:flex;align-items:center;justify-content:center;font-size:0.65rem;font-weight:bold;z-index:10;}
.progress-indicator::before{content:'';position:absolute;width:28px;height:28px;border-radius:50%;background:white;z-index:1;}
.progress-indicator span{position:relative;z-index:2;color:#2d3436;}
.completion-badge{position:absolute;top:-8px;right:-8px;background:linear-gradient(135deg,#00b894,#00cec9);color:white;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem;animation:bounceIn 0.5s ease;z-index:10;}
.dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px;}
.stat-card{background:white;padding:20px;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,0.08);border-right:6px solid;position:relative;overflow:hidden;}
.stat-icon{font-size:3rem;opacity:0.1;position:absolute;left:15px;top:15px;}
.stat-number{font-size:2.2rem;font-weight:900;margin-bottom:5px;}.stat-label{color:#666;font-size:0.9rem;}
.progress-bar{background:#f0f0f0;height:10px;border-radius:10px;overflow:hidden;margin:12px 0;}
.progress-fill{height:100%;background:linear-gradient(90deg,#00b894,#00cec9);border-radius:10px;transition:width 0.6s ease;}
.arena-status{background:white;padding:12px 18px;border-radius:12px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 3px 10px rgba(0,0,0,0.05);border-right:4px solid;}
.arena-name{font-weight:700;}.arena-progress{display:flex;align-items:center;gap:12px;}
.badge{padding:4px 10px;border-radius:20px;font-size:0.8rem;font-weight:bold;}
.badge-complete{background:#d4edda;color:#155724;}.badge-partial{background:#fff3cd;color:#856404;}.badge-empty{background:#f8d7da;color:#721c24;}
.mini-progress{width:70px;height:7px;background:#e0e0e0;border-radius:10px;overflow:hidden;}.mini-progress-fill{height:100%;border-radius:10px;}
.save-toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#00b894,#00cec9);color:white;padding:13px 28px;border-radius:50px;font-weight:bold;z-index:9999;display:none;box-shadow:0 10px 30px rgba(0,184,148,0.4);}
.save-toast.error{background:linear-gradient(135deg,#e74c3c,#c0392b);}
.input-mic-wrapper{display:flex;align-items:flex-start;gap:8px;width:100%;}.input-mic-wrapper input,.input-mic-wrapper textarea{flex:1;min-width:0;}
.mic-btn{background:#f0f0f0;border:none;cursor:pointer;color:#888;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:0.2s;flex-shrink:0;margin-top:4px;}
.mic-btn:hover{color:var(--primary);background:#e0e8ff;}
.mic-btn.listening{color:white;background:#e74c3c;animation:micPulse 1s infinite;}
@keyframes micPulse{0%,100%{box-shadow:0 0 0 0 rgba(231,76,60,0.4);}50%{box-shadow:0 0 0 10px rgba(231,76,60,0);}}
#teacherScreen{background:#f0f4ff;min-height:100vh;padding-bottom:40px;}
.teacher-container{max-width:1100px;margin:0 auto;padding:20px;}
.class-selector-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;margin-top:20px;}
.class-card{background:white;border-radius:18px;padding:24px 20px;cursor:pointer;box-shadow:0 6px 20px rgba(0,0,0,0.08);border-right:6px solid #667eea;transition:0.3s;text-align:center;}.class-card:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(102,126,234,0.2);}
.class-card-name{font-size:1.3rem;font-weight:900;color:#667eea;margin-bottom:6px;}.class-card-count{font-size:0.9rem;color:#aaa;font-weight:600;}
.class-card-avg{font-size:2rem;font-weight:900;color:#2d3436;margin:10px 0 4px;}.class-card-avg-lbl{font-size:0.75rem;color:#aaa;}
.class-card-bar{background:#f0f0f0;height:8px;border-radius:8px;overflow:hidden;margin-top:10px;}.class-card-bar-fill{height:100%;background:linear-gradient(90deg,#667eea,#764ba2);border-radius:8px;}
.class-detail-header{display:flex;align-items:center;gap:12px;margin-bottom:20px;}
.btn-back-classes{background:white;border:2px solid #667eea;color:#667eea;padding:9px 20px;border-radius:20px;cursor:pointer;font-family:inherit;font-weight:700;font-size:0.9rem;transition:0.2s;}.btn-back-classes:hover{background:#667eea;color:white;}
.class-detail-title{font-size:1.4rem;font-weight:900;color:#667eea;}
.student-list-scroll{display:flex;flex-direction:column;gap:10px;}
.student-list-item{background:white;border-radius:14px;padding:16px 20px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.06);border-right:5px solid #667eea;display:flex;justify-content:space-between;align-items:center;transition:0.25s;}.student-list-item:hover{transform:translateX(-4px);box-shadow:0 8px 22px rgba(102,126,234,0.15);}
.sli-name{font-weight:800;font-size:1.05rem;color:#2d3436;margin-bottom:3px;}.sli-meta{font-size:0.8rem;color:#aaa;}
.sli-right{display:flex;align-items:center;gap:12px;}.sli-pct{font-size:1.5rem;font-weight:900;min-width:54px;text-align:center;}
.sli-bar-wrap{width:80px;}.sli-bar{background:#f0f0f0;height:7px;border-radius:7px;overflow:hidden;}.sli-bar-fill{height:100%;background:linear-gradient(90deg,#667eea,#764ba2);border-radius:7px;}
.tik-modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:400;overflow-y:auto;backdrop-filter:blur(4px);}
.tik-modal-inner{background:linear-gradient(135deg,#a29bfe,#74b9ff);min-height:100%;padding-bottom:60px;}
.tik-modal-topbar{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:13px 20px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10;box-shadow:0 4px 15px rgba(0,0,0,0.2);}
.tik-modal-topbar h2{margin:0;font-size:1.05rem;font-weight:900;}.tik-modal-topbar p{margin:2px 0 0;font-size:0.8rem;opacity:0.85;}
.btn-close-tik{background:rgba(255,255,255,0.2);border:none;color:white;padding:8px 18px;border-radius:20px;cursor:pointer;font-family:inherit;font-weight:700;font-size:0.9rem;}
.readonly-banner{background:linear-gradient(135deg,#fff3cd,#fff9e6);border:2px solid #ffc107;border-radius:12px;padding:12px 18px;margin:16px auto;width:95%;max-width:900px;font-weight:700;color:#856404;display:flex;align-items:center;gap:8px;}
.tik-progress-bar{background:white;border-radius:18px;padding:20px 24px;width:95%;max-width:900px;margin:16px auto 0;box-shadow:0 8px 24px rgba(0,0,0,0.1);}
.tik-progress-bar h3{margin:0 0 10px;font-size:1.05rem;color:var(--primary);}
.tik-pb-track{background:#f0f0f0;height:14px;border-radius:10px;overflow:hidden;}.tik-pb-fill{height:100%;background:linear-gradient(90deg,#667eea,#764ba2);border-radius:10px;transition:width 0.6s;}
.tik-pb-meta{font-size:0.8rem;color:#aaa;margin-top:6px;}
.tik-tab-btns{display:flex;gap:10px;width:95%;max-width:900px;margin:14px auto 0;}
.tik-tab-btn{flex:1;padding:11px;border:none;border-radius:12px;font-family:inherit;font-weight:800;font-size:0.95rem;cursor:pointer;transition:0.2s;}
.tik-tab-btn.active{background:linear-gradient(45deg,#667eea,#764ba2);color:white;box-shadow:0 4px 12px rgba(102,126,234,0.3);}
.tik-tab-btn:not(.active){background:white;color:#667eea;box-shadow:0 4px 12px rgba(0,0,0,0.08);}
#adminScreen{background:#f5f7ff;min-height:100vh;padding-bottom:40px;}
.admin-container{max-width:1000px;margin:0 auto;padding:20px;}
.admin-tabs{display:flex;gap:10px;margin-bottom:25px;flex-wrap:wrap;}
.admin-tab-btn{padding:12px 25px;border:none;border-radius:15px;font-family:inherit;font-size:1rem;font-weight:700;cursor:pointer;background:white;color:#555;box-shadow:0 3px 10px rgba(0,0,0,0.08);transition:0.3s;}.admin-tab-btn.active{background:linear-gradient(45deg,#667eea,#764ba2);color:white;}
.admin-panel{display:none;}.admin-panel.active{display:block;}
.admin-card{background:white;border-radius:20px;padding:25px;box-shadow:0 5px 20px rgba(0,0,0,0.08);margin-bottom:20px;}.admin-card h2{margin-top:0;color:var(--primary);}
.admin-table{width:100%;border-collapse:collapse;}.admin-table th{background:#f0f4ff;padding:12px 15px;text-align:right;font-weight:700;border-bottom:2px solid #e0e0e0;}
.admin-table td{padding:12px 15px;border-bottom:1px solid #f0f0f0;}.admin-table tr:hover td{background:#f8f9ff;}
.btn-admin{padding:10px 20px;border:none;border-radius:10px;font-family:inherit;font-weight:700;cursor:pointer;transition:0.3s;}
.btn-primary{background:linear-gradient(45deg,#667eea,#764ba2);color:white;}.btn-danger{background:#fee2e2;color:#c0392b;}
.admin-form input{width:100%;padding:11px 15px;border:2px solid #eee;border-radius:10px;font-family:inherit;font-size:1rem;margin-bottom:12px;}.admin-form input:focus{border-color:var(--primary);}
.excel-drop{border:3px dashed #c0c0c0;border-radius:15px;padding:40px;text-align:center;margin-bottom:15px;cursor:pointer;transition:0.3s;}.excel-drop:hover{border-color:var(--primary);background:#f0f4ff;}
.excel-preview{max-height:300px;overflow-y:auto;}
</style>
</head>
<body>

<div id="loginScreen">
  <div class="login-hero">
    <div class="login-hero-icon"><span class="material-icons-round" style="font-size:40px;color:white;">auto_stories</span></div>
    <h1>×ª×§×©×•×¨×ª ×•×—×‘×¨×”</h1><p>××¡×œ×•×œ ×œ×"×“ | ×ª×™×§ ×“×™×’×™×˜×œ×™</p>
    <p style="color:rgba(255,255,255,0.4);font-size:0.75rem;margin-top:12px;">×¤×™×ª×•×— ×¡×‘×™×‘×ª ×”×œ××™×“×”: ×¨× ×™ ×‘×Ÿ ×–××‘</p>
  </div>
  <div class="role-cards">
    <button class="role-card role-card-student active" onclick="switchLoginTab('student',this)"><span class="role-card-icon">ğŸ“</span><span class="role-card-label">×ª×œ××™×“</span></button>
    <button class="role-card role-card-teacher" onclick="switchLoginTab('teacher',this)"><span class="role-card-icon">ğŸ‘©â€ğŸ«</span><span class="role-card-label">××•×¨×”</span></button>
    <button class="role-card role-card-admin" onclick="switchLoginTab('admin',this)"><span class="role-card-icon">âš™ï¸</span><span class="role-card-label">×× ×”×œ</span></button>
  </div>
  <div class="login-box">
    <div id="loginStudent"><div class="login-field"><label>×ª×¢×•×“×ª ×–×”×•×ª</label><input type="text" id="studentId" placeholder="×”×–×Ÿ ×ª.×–." maxlength="9"></div><button class="btn-login" onclick="loginStudent()">×›× ×™×¡×” â†</button></div>
    <div id="loginTeacher" style="display:none"><div class="login-field"><label>×©× ××©×ª××©</label><input type="text" id="teacherUsername" placeholder="×©× ××©×ª××©"></div><div class="login-field"><label>×¡×™×¡××”</label><input type="password" id="teacherPassword" placeholder="×¡×™×¡××”"></div><button class="btn-login" onclick="loginTeacher()">×›× ×™×¡×” â†</button></div>
    <div id="loginAdmin" style="display:none"><div class="login-field"><label>×©× ××©×ª××©</label><input type="text" id="adminUsername" placeholder="×©× ××©×ª××©"></div><div class="login-field"><label>×¡×™×¡××”</label><input type="password" id="adminPassword" placeholder="×¡×™×¡××”"></div><button class="btn-login" onclick="loginAdmin()">×›× ×™×¡×” â†</button></div>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<div id="studentScreen">
  <div class="topbar"><div><div class="topbar-title">×ª×§×©×•×¨×ª ×•×—×‘×¨×” â€“ ×œ×"×“</div><div class="topbar-user" id="studentTopbarName"></div></div><button class="btn-logout" onclick="logout()">×™×¦×™××”</button></div>
  <div class="nav-container"><div class="nav-bar">
    <button class="nav-btn active" onclick="showPage('home',this)"><span class="material-icons-round">home</span> ×©×¢×¨</button>
    <button class="nav-btn" onclick="showPage('dashboard',this)"><span class="material-icons-round">analytics</span> ××¦×‘</button>
    <button class="nav-btn" onclick="showPage('lobby-zirot',this)"><span class="material-icons-round">apps</span> ×–×™×¨×•×ª</button>
    <button class="nav-btn" onclick="showPage('finish',this)"><span class="material-icons-round">cloud_upload</span> ×©××™×¨×”</button>
  </div></div>
  <div class="glass-container" id="studentGlass"></div>
</div>

<div id="teacherScreen">
  <div class="topbar"><div><div class="topbar-title">×ª×§×©×•×¨×ª ×•×—×‘×¨×” â€“ ×œ×"×“</div><div class="topbar-user" id="teacherTopbarName"></div></div><button class="btn-logout" onclick="logout()">×™×¦×™××”</button></div>
  <div class="teacher-container">
    <div id="teacherClassView"><div style="margin-bottom:20px;"><h2 style="color:var(--primary);margin:0 0 6px;">ğŸ‘©â€ğŸ« ×”×›×™×ª×•×ª ×©×œ×™</h2></div><div class="class-selector-grid" id="classSelectorGrid"></div></div>
    <div id="teacherStudentListView" style="display:none"><div class="class-detail-header"><button class="btn-back-classes" onclick="showTeacherView('classes')">â† ×—×–×¨×”</button><div class="class-detail-title" id="classDetailTitle"></div></div><div class="student-list-scroll" id="studentListScroll"></div></div>
  </div>
  <div class="tik-modal-overlay" id="tikModal">
    <div class="tik-modal-inner">
      <div class="tik-modal-topbar"><div><h2 id="tikModalName"></h2><p id="tikModalClass"></p></div><button class="btn-close-tik" onclick="closeTikModal()">âœ• ×¡×’×™×¨×”</button></div>
      <div class="readonly-banner"><span class="material-icons-round" style="font-size:20px;">visibility</span> ××¦×‘ ×¦×¤×™×™×” ×‘×œ×‘×“. × ×™×ª×Ÿ ×œ×›×ª×•×‘ ×”×¢×¨×•×ª ×‘×¦×”×•×‘.</div>
      <div class="tik-progress-bar"><h3 id="tikProgressTitle">0%</h3><div class="tik-pb-track"><div class="tik-pb-fill" id="tikPbFill" style="width:0%"></div></div><div class="tik-pb-meta" id="tikPbMeta"></div></div>
      <div class="tik-tab-btns"><button class="tik-tab-btn active" id="tabSummaryBtn" onclick="switchTikTab('summary')">ğŸ“‹ ×¡×™×›×•×</button><button class="tik-tab-btn" id="tabFullBtn" onclick="switchTikTab('full')">ğŸ“‚ ×ª×™×§ ××œ×</button></div>
      <div id="tikSummaryView" style="width:95%;max-width:900px;margin:16px auto 0;"></div>
      <div id="tikContent" style="display:none;width:95%;max-width:900px;margin:16px auto 0;"></div>
    </div>
  </div>
</div>

<div id="adminScreen">
  <div class="topbar"><div><div class="topbar-title">×ª×§×©×•×¨×ª ×•×—×‘×¨×” â€“ ×œ×"×“</div><div class="topbar-user">âš™ï¸ × ×™×”×•×œ</div></div><button class="btn-logout" onclick="logout()">×™×¦×™××”</button></div>
  <div class="admin-container">
    <div class="admin-tabs">
      <button class="admin-tab-btn active" onclick="switchAdminTab('students',this)">ğŸ‘¥ ×ª×œ××™×“×™×</button>
      <button class="admin-tab-btn" onclick="switchAdminTab('teachers',this)">ğŸ‘©â€ğŸ« ××•×¨×™×</button>
      <button class="admin-tab-btn" onclick="switchAdminTab('overview',this)">ğŸ“Š ×¡×§×™×¨×”</button>
    </div>
    <div id="adminStudents" class="admin-panel active">
      <div class="admin-card"><h2>ğŸ“¤ ×™×™×‘×•× Excel</h2><p style="color:#666;margin-top:-10px;">×¢××•×“×•×ª: ×ª×– | ×©× | ×›×™×ª×”</p><div class="excel-drop" onclick="document.getElementById('excelFile').click()"><span class="material-icons-round" style="font-size:40px;color:#aaa;display:block;margin-bottom:10px;">upload_file</span><div style="font-weight:700;color:#555;">×‘×—×¨ ×§×•×‘×¥</div></div><input type="file" id="excelFile" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleExcelUpload(this)"><div id="excelPreview" style="display:none"><div style="background:#f0f9ff;border:2px solid #00b894;border-radius:12px;padding:15px;margin-bottom:15px;"><div style="font-weight:700;color:#00b894;margin-bottom:10px;" id="excelSummary"></div><div class="excel-preview" id="excelTable"></div></div><button class="btn-admin btn-primary" onclick="importAllStudents()" style="width:100%;padding:14px;">âœ… ×™×™×‘×•×</button></div></div>
      <div class="admin-card"><h2>â• ×”×•×¡×¤×” ×™×“× ×™×ª</h2><div class="admin-form"><input type="text" id="newStudentId" placeholder="×ª.×–."><input type="text" id="newStudentName" placeholder="×©× ××œ×"><input type="text" id="newStudentClass" placeholder="×›×™×ª×”"><button class="btn-admin btn-primary" onclick="addStudent()">×”×•×¡×¤×”</button></div></div>
      <div class="admin-card"><h2>ğŸ“‹ ×ª×œ××™×“×™×</h2><input type="text" id="searchStudent" placeholder="×—×™×¤×•×©..." onkeyup="filterStudents()" style="padding:10px 15px;border:2px solid #eee;border-radius:10px;width:100%;font-family:inherit;margin-bottom:15px;"><div style="overflow-x:auto;"><table class="admin-table"><thead><tr><th>×ª×–</th><th>×©×</th><th>×›×™×ª×”</th><th>%</th><th>×¤×¢×•×œ×•×ª</th></tr></thead><tbody id="studentsTableBody"></tbody></table></div></div>
    </div>
    <div id="adminTeachers" class="admin-panel">
      <div class="admin-card"><h2>â• ×”×•×¡×¤×ª ××•×¨×”</h2><div class="admin-form"><input type="text" id="newTeacherUsername" placeholder="×©× ××©×ª××©"><input type="password" id="newTeacherPassword" placeholder="×¡×™×¡××”"><input type="text" id="newTeacherName" placeholder="×©× ××œ×"><input type="text" id="newTeacherClasses" placeholder="×›×™×ª×•×ª (××•×¤×¨×“×•×ª ×‘×¤×¡×™×§)"><button class="btn-admin btn-primary" onclick="addTeacher()">×”×•×¡×¤×”</button></div></div>
      <div class="admin-card"><h2>ğŸ“‹ ××•×¨×™×</h2><table class="admin-table"><thead><tr><th>×©× ××©×ª××©</th><th>×©× ××œ×</th><th>×›×™×ª×•×ª</th><th>×¤×¢×•×œ×•×ª</th></tr></thead><tbody id="teachersTableBody"></tbody></table></div>
    </div>
    <div id="adminOverview" class="admin-panel">
      <div class="dashboard-grid"><div class="stat-card" style="border-color:#667eea;"><span class="stat-icon">ğŸ‘¥</span><div class="stat-number" id="adminTotalStudents" style="color:#667eea;">0</div><div class="stat-label">×ª×œ××™×“×™×</div></div><div class="stat-card" style="border-color:#00b894;"><span class="stat-icon">âœ…</span><div class="stat-number" id="adminAvgProgress" style="color:#00b894;">0%</div><div class="stat-label">×××•×¦×¢</div></div><div class="stat-card" style="border-color:#fd79a8;"><span class="stat-icon">ğŸ‘©â€ğŸ«</span><div class="stat-number" id="adminTotalTeachers" style="color:#fd79a8;">0</div><div class="stat-label">××•×¨×™×</div></div></div>
      <div class="admin-card"><h2>ğŸ“Š ×œ×¤×™ ×›×™×ª×•×ª</h2><div id="classesOverview"></div></div>
      <div class="admin-card"><h2>ğŸ” ×¡×™×¡××ª ×”×“×‘×§×”</h2><p style="color:#666;margin-top:-10px;">×¡×™×¡××” ×©××•×¨×”/×× ×”×œ × ×•×ª× ×™× ×œ×ª×œ××™×“ ×›×“×™ ×œ××¤×©×¨ ×”×“×‘×§×”</p><div class="admin-form"><input type="text" id="pastePassInput" placeholder="×¡×™×¡××” ×—×“×©×”"><button class="btn-admin btn-primary" onclick="savePastePassword()">×©××•×¨ ×¡×™×¡××”</button></div><div id="currentPastePass" style="margin-top:10px;color:#888;font-size:0.9rem;"></div></div>
    </div>
  </div>
</div>

<div class="save-toast" id="saveToast"></div>

<script>
// ==================================================================
// FIREBASE INIT
// ==================================================================
const firebaseConfig={apiKey:"AIzaSyBwXy6G51oTASGZF-r3VDykyeE-nWEZqFY",authDomain:"tik-digital-2.firebaseapp.com",databaseURL:"https://tik-digital-2-default-rtdb.europe-west1.firebasedatabase.app",projectId:"tik-digital-2",storageBucket:"tik-digital-2.firebasestorage.app",messagingSenderId:"971193441076",appId:"1:971193441076:web:2ea66a30c25b5d151a6361"};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ==================================================================
// ×ª×™×§×•×Ÿ ××¡' 1: ×›×œ ×”×–×™×¨×•×ª ××•×’×“×¨×•×ª ×›-DATA â€” ×™×™×¦×•×¨ ×“×™× ××™
// ==================================================================
const ARENAS=[
  {id:'al',label:'×–×™×¨×ª ×”×¢×œ',color:'#6c5ce7',icon:'all_inclusive',css:'c-al'},
  {id:'1',label:'××¦×™××•×ª ×ª×§×©×•×¨×ª×™×ª',color:'#0984e3',icon:'visibility',css:'c-1'},
  {id:'2',label:'×’×œ×•×‘×œ×™×–×¦×™×”',color:'#00cec9',icon:'public',css:'c-2'},
  {id:'3',label:'×—×“×©×•×ª ×•×¦×™×œ×•×',color:'#d63031',icon:'tv',css:'c-3'},
  {id:'4',label:'×”×•××•×¨ ×•×¡××˜×™×¨×”',color:'#e1b12c',icon:'theater_comedy',css:'c-4'},
  {id:'5',label:'×ª×¨×‘×•×ª ×“×™×’×™×˜×œ×™×ª',color:'#00b894',icon:'smartphone',css:'c-5'},
  {id:'6',label:'×¨×™××œ×™×˜×™',color:'#e17055',icon:'star',css:'c-6'},
  {id:'7',label:'×§×œ×™×¤×™×',color:'#be2edd',icon:'music_note',css:'c-7'},
  {id:'8',label:'×¡×¤×•×¨×˜',color:'#4834d4',icon:'sports_soccer',css:'c-8'},
  {id:'9',label:'×¤×¨×¡×•×',color:'#e84393',icon:'campaign',css:'c-9'},
];
const CONCEPT_COLORS=[{bg:'#f3e5f5',bc:'#8e44ad'},{bg:'#e3f2fd',bc:'#2196f3'},{bg:'#fffde7',bc:'#fbc02d'},{bg:'#fce4ec',bc:'#e91e63'}];
const N_CONCEPTS=4;

// ==================================================================
// STATE
// ==================================================================
let currentUser=null,currentRole=null,teacherAllStudents=[],teacherClasses=[];
let _dirty=false,_saveTimer=null;

// ==================================================================
// ×ª×™×§×•×Ÿ ××¡' 2: ×¡× ×™×˜×™×–×¦×™×”
// ==================================================================
function esc(s){if(!s)return '';const d=document.createElement('div');d.textContent=s;return d.innerHTML;}

// ==================================================================
// ×ª×™×§×•×Ÿ ××¡' 3: ×™×™×¦×•×¨ ×“×™× ××™ ×©×œ ×›×œ ×”×–×™×¨×•×ª (×‘××§×•× ~1200 ×©×•×¨×•×ª ×›×¤×•×œ×•×ª)
// ==================================================================
function buildStudentPages(){
  const g=document.getElementById('studentGlass');
  let h='';

  // ×“×£ ×‘×™×ª
  h+=`<div id="home" class="page active"><h1>×ª×™×§ ×œ×"×“ ×“×™×’×™×˜×œ×™</h1>
    <div style="background:linear-gradient(135deg,#ff9ff3,#feca57);color:#fff;padding:25px;text-align:center;border-radius:15px;margin-bottom:25px;text-shadow:1px 1px 2px rgba(0,0,0,0.2);">
    <p style="font-size:1.05rem;line-height:1.5;margin-bottom:15px;">×”×©× ×” × ×¦× ×™×—×“ ×œ××¡×¢ ×‘×™×Ÿ ×–×™×¨×•×ª ×”×œ×™××•×“ â€“ ×¤×¨×§×™ ×œ×™××•×“ ××¢×•×œ× ×”×ª×§×©×•×¨×ª ×•×”×—×‘×¨×”.</p>
    <div style="font-size:1.4rem;font-weight:900;border-top:1px solid rgba(255,255,255,0.4);padding-top:15px;">ğŸš€ ×‘×”×¦×œ×—×”!</div></div>
    <div class="home-grid">
      <div class="home-card" onclick="showPage('lobby-zirot',document.querySelectorAll('.nav-btn')[2])"><span class="material-icons-round home-icon" style="background:#e3f2fd;color:#0984e3;">school</span><h3>×–×™×¨×•×ª ×”×œ×™××•×“</h3><p>×›× ×™×¡×” ×œ×–×™×¨×•×ª</p></div>
      <div class="home-card" onclick="showPage('dashboard',document.querySelectorAll('.nav-btn')[1])"><span class="material-icons-round home-icon" style="background:#e8f5e9;color:#00b894;">analytics</span><h3>×ª××•× ×ª ××¦×‘</h3><p>×¡×™×›×•× ×”×”×ª×§×“××•×ª</p></div>
    </div></div>`;

  // ×“×©×‘×•×¨×“
  h+=`<div id="dashboard" class="page"><h1>ğŸ“Š ×ª××•× ×ª ××¦×‘</h1>
    <div class="dashboard-grid">
      <div class="stat-card" style="border-color:#00b894;"><span class="stat-icon">âœ…</span><div class="stat-number" id="totalProgress" style="color:#00b894;">0%</div><div class="stat-label">×›×œ×œ×™</div><div class="progress-bar"><div class="progress-fill" id="totalProgressBar" style="width:0%"></div></div></div>
      <div class="stat-card" style="border-color:#0984e3;"><span class="stat-icon">ğŸ“š</span><div class="stat-number" id="conceptsCount" style="color:#0984e3;">0</div><div class="stat-label">××•×©×’×™×</div></div>
      <div class="stat-card" style="border-color:#6c5ce7;"><span class="stat-icon">ğŸ­</span><div class="stat-number" id="dilemmasCount" style="color:#6c5ce7;">0</div><div class="stat-label">×“×™×œ××•×ª</div></div>
      <div class="stat-card" style="border-color:#fd79a8;"><span class="stat-icon">ğŸŒ</span><div class="stat-number" id="arenasCount" style="color:#fd79a8;">0/10</div><div class="stat-label">×–×™×¨×•×ª</div></div>
    </div>
    <div style="background:white;padding:25px;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,0.08);"><h2 style="margin-top:0;">ğŸ“‹ ×¤×™×¨×•×˜</h2><div id="arenasList"></div></div></div>`;

  // ×œ×•×‘×™
  h+=`<div id="lobby-zirot" class="page"><h1>×–×™×¨×•×ª ×”×œ×™××•×“</h1><div class="grid">`;
  ARENAS.forEach(a=>{h+=`<div class="card ${a.css}" onclick="showPage('z-${a.id}')"><span class="icon material-icons-round">${a.icon}</span><span class="name">${a.label}</span></div>`;});
  h+=`</div></div>`;

  // ×›×œ 10 ×”×–×™×¨×•×ª â€” × ×•×¦×¨×•×ª ××ª×‘× ×™×ª ××—×ª!
  ARENAS.forEach(a=>{h+=arenaHTML(a);});

  // ×©××™×¨×”
  h+=`<div id="finish" class="page"><h1>â˜ï¸ ×©××™×¨×”</h1>
    <div style="background:white;padding:30px;border-radius:20px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.1);margin-bottom:25px;">
    <span class="material-icons-round" style="font-size:70px;color:#00b894;">cloud_done</span><h2>×”× ×ª×•× ×™× × ×©××¨×™× ××•×˜×•××˜×™×ª</h2>
    <button class="btn-save-all" onclick="saveToCloud()">â˜ï¸ ×©××™×¨×” ×¢×›×©×™×•</button></div>
    <div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:30px;border-radius:20px;text-align:center;">
    <h3 style="margin:0 0 10px;font-size:1.6rem;">ğŸ‰ ×›×œ ×”×›×‘×•×“!</h3><p style="opacity:0.95;">×ª×•×“×” ×¢×œ ×”××××¥!</p></div></div>`;

  g.innerHTML=h;
}

// ===== ×ª×‘× ×™×ª ×–×™×¨×” â€” ×¤×¢× ××—×ª ×‘××§×•× 10! =====
function arenaHTML(a){
  let h=`<div id="z-${a.id}" class="page"><h1 style="color:${a.color}">${a.label}</h1>`;

  // ×¤×¨×§ 1: ××•×©×’×™×
  h+=`<div class="chapter-box" style="border-right-color:${a.color}"><div class="chapter-header" onclick="toggleChapter(this)"><div class="chapter-title" style="color:${a.color}">×¤×¨×§ 1: ××•×©×’×™×</div><div class="btn-open-chapter">×¤×ª×—</div></div><div class="chapter-content">`;
  for(let c=0;c<N_CONCEPTS;c++){const cc=CONCEPT_COLORS[c];
    h+=`<div class="full-concept-card" style="background:${cc.bg};border-right:6px solid ${cc.bc}"><span class="card-num">#${c+1}</span>
      <div class="form-group"><label>×©× ×”××•×©×’:</label><input type="text" data-field="z${a.id}_c${c}_name"></div>
      <div class="form-group"><label>×”×¡×‘×¨:</label><textarea rows="2" data-field="z${a.id}_c${c}_exp"></textarea></div>
      <div class="form-group"><label>×§×™×©×•×¨:</label><input type="text" class="allow-paste" data-field="z${a.id}_c${c}_link"></div>
      <div class="form-group"><label>×”×§×©×¨:</label><textarea rows="2" data-field="z${a.id}_c${c}_ctx"></textarea></div></div>`;
  }
  h+=`</div></div>`;

  // ×¤×¨×§ 2: ×“×™×œ××•×ª
  h+=`<div class="chapter-box" style="border-right-color:${a.color}"><div class="chapter-header" onclick="toggleChapter(this)"><div class="chapter-title" style="color:${a.color}">×¤×¨×§ 2: ×“×™×œ××•×ª</div><div class="btn-open-chapter">×¤×ª×—</div></div><div class="chapter-content">`;
  [{k:'per',emoji:'ğŸ‘¤',t:'×“×™×œ××” ××™×©×™×ª',bg:'#f3e5f5',bc:'#8e44ad'},{k:'pro',emoji:'ğŸ¥',t:'×“×™×œ××” ××§×¦×•×¢×™×ª',bg:'#ede7f6',bc:'#673ab7'}].forEach(d=>{
    const p=`z${a.id}_d_${d.k}`;
    h+=`<div style="background:${d.bg};border-right:6px solid ${d.bc};padding:20px;border-radius:15px;margin-bottom:20px;">
      <h3 style="margin-top:0;">${d.emoji} ${d.t}</h3>
      <div class="form-group"><label>×ª×™××•×¨:</label><textarea rows="3" data-field="${p}_desc"></textarea></div>
      <div class="vs-grid">
        <div class="vs-box"><h4>×“×¨×š ×'</h4><input type="text" data-field="${p}_aName"><div class="gain"><label>×¨×•×•×—:</label><input type="text" data-field="${p}_aGain"></div><div class="cost"><label>××—×™×¨:</label><input type="text" data-field="${p}_aCost"></div></div>
        <div class="vs-box"><h4>×“×¨×š ×‘'</h4><input type="text" data-field="${p}_bName"><div class="gain"><label>×¨×•×•×—:</label><input type="text" data-field="${p}_bGain"></div><div class="cost"><label>××—×™×¨:</label><input type="text" data-field="${p}_bCost"></div></div>
      </div>
      <div class="form-group" style="margin-top:12px"><label>×”×›×¨×¢×”:</label><textarea rows="2" data-field="${p}_dec"></textarea></div>
      <div class="form-group"><label>×¤×ª×¨×•×Ÿ:</label><textarea rows="2" data-field="${p}_sol"></textarea></div></div>`;
  });
  h+=`</div></div>`;

  // ×¤×¨×§ 3: ××•×¨×™×™× ×•×ª
  h+=`<div class="chapter-box" style="border-right-color:${a.color}"><div class="chapter-header" onclick="toggleChapter(this)"><div class="chapter-title" style="color:${a.color}">×¤×¨×§ 3: ××•×¨×™×™× ×•×ª</div><div class="btn-open-chapter">×¤×ª×—</div></div><div class="chapter-content">
    <div class="full-concept-card" style="background:#fdf0ff;border-right:6px solid #be2edd"><div class="form-group"><label>ğŸŒ ×¢×œ ×”×—×‘×¨×”</label><textarea rows="4" data-field="z${a.id}_lit_soc"></textarea></div></div>
    <div class="full-concept-card" style="background:#f0f4ff;border-right:6px solid #4834d4"><div class="form-group"><label>ğŸ“º ×¢×œ ×”×ª×§×©×•×¨×ª</label><textarea rows="4" data-field="z${a.id}_lit_med"></textarea></div></div>
    <div class="full-concept-card" style="background:#fff9db;border-right:6px solid #f1c40f"><div class="form-group"><label>ğŸ™‹ ×¢×œ ×¢×¦××™</label><textarea rows="4" data-field="z${a.id}_lit_self"></textarea></div></div>
  </div></div>`;

  // ×”×¢×¨×•×ª ××•×¨×” + ×›×¤×ª×•×¨×™×
  h+=`<div class="teacher-notes-section"><div class="teacher-notes-title"><span class="material-icons-round">chat</span> ×”×¢×¨×•×ª ××•×¨×”</div><textarea id="notes-${a.id}" class="teacher-notes-textarea" readonly style="background:#fffde7;"></textarea></div>`;
  h+=`<div class="footer-action"><button class="btn-save-changes" onclick="saveToCloud()">â˜ï¸ ×©××™×¨×”</button><button class="btn-back-lobby" onclick="showPage('lobby-zirot')">×—×–×¨×”</button></div></div>`;
  return h;
}

// ==================================================================
// ×ª×™×§×•×Ÿ ××¡' 4: ×©××™×¨×”/×˜×¢×™× ×” ×¡×× ×˜×™×ª â€” ×œ× ×œ×¤×™ ××™× ×“×§×¡ DOM!
// ==================================================================
function getAllFields(){return document.querySelectorAll('#studentScreen [data-field]');}

function gatherData(){
  const d={};
  getAllFields().forEach(el=>{const v=el.value;if(v&&v.trim())d[el.dataset.field]=v;});
  d._ts=new Date().toISOString();
  return d;
}

function applyData(d){
  if(!d)return;
  getAllFields().forEach(el=>{const k=el.dataset.field;if(d[k]!==undefined)el.value=d[k];});
  ARENAS.forEach(a=>{const n=document.getElementById('notes-'+a.id);if(n&&d['_note_'+a.id])n.value=d['_note_'+a.id];});
}

// ==================================================================
// ×ª×™×§×•×Ÿ ××¡' 5: ×©×’×™××•×ª + ×˜×•×¡×˜
// ==================================================================
function showSaveToast(msg,isErr){
  const t=document.getElementById('saveToast');
  t.textContent=msg||'â˜ï¸ × ×©××¨!';
  t.className='save-toast'+(isErr?' error':'');
  t.style.display='block';
  setTimeout(()=>t.style.display='none',3000);
}

async function saveToCloud(){
  if(!currentUser||currentRole!=='student')return;
  try{await db.ref('studentData/'+currentUser.id).set(gatherData());_dirty=false;showSaveToast();updateDashboard();}
  catch(e){showSaveToast('âš ï¸ ×©×’×™××”: '+e.message,true);}
}

async function loadStudentData(id){
  try{
    const[snap,nSnap]=await Promise.all([db.ref('studentData/'+id).once('value'),db.ref('teacherNotes/'+id).once('value')]);
    if(snap.exists())applyData(snap.val());
    if(nSnap.exists()){const n=nSnap.val();ARENAS.forEach(a=>{const el=document.getElementById('notes-'+a.id);if(el&&n['z'+a.id])el.value=n['z'+a.id];});}
    updateDashboard();
    document.querySelectorAll('#studentScreen textarea').forEach(ta=>autoResize(ta));
  }catch(e){showSaveToast('âš ï¸ ×©×’×™××ª ×˜×¢×™× ×”',true);}
}

// ==================================================================
// ×ª×™×§×•×Ÿ ××¡' 6: Auto-save ×—×›× â€” dirty flag + debounce
// ==================================================================
function markDirty(){_dirty=true;clearTimeout(_saveTimer);_saveTimer=setTimeout(()=>{if(_dirty)saveToCloud();},3000);}
function initAutoSave(){
  document.getElementById('studentScreen').addEventListener('input',e=>{if(e.target.dataset.field)markDirty();});
  setInterval(()=>{if(_dirty&&currentRole==='student')saveToCloud();},60000);
}

// ==================================================================
// LOGIN
// ==================================================================
function switchLoginTab(tab,el){
  ['student','teacher','admin'].forEach(t=>{const e=document.getElementById('login'+t[0].toUpperCase()+t.slice(1));if(e)e.style.display=t===tab?'block':'none';});
  document.querySelectorAll('.role-card').forEach(c=>c.classList.remove('active'));
  if(el)el.classList.add('active');
  document.getElementById('loginError').style.display='none';
}

function showError(m){const e=document.getElementById('loginError');e.textContent='âŒ '+m;e.style.display='block';}

async function loginStudent(){
  const id=document.getElementById('studentId').value.trim();
  if(!id){showError('×”×›× ×¡ ×ª.×–.');return;}
  try{
    const s=await db.ref('students/'+id).once('value');
    if(!s.exists()){showError('×ª.×–. ×œ× × ××¦××”');return;}
    const v=s.val();currentUser={id,...v};currentRole='student';
    document.getElementById('studentTopbarName').textContent='ğŸ‘¤ '+v.name+' | '+v.class;
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('studentScreen').style.display='block';
    await loadStudentData(id);addMicButtons();initAutoResize();initAutoSave();
  }catch(e){showError('×©×’×™××ª ×—×™×‘×•×¨');}
}

async function loginTeacher(){
  const u=document.getElementById('teacherUsername').value.trim(),p=document.getElementById('teacherPassword').value.trim();
  if(!u||!p){showError('××œ× ×©× ××©×ª××© ×•×¡×™×¡××”');return;}
  try{
    const s=await db.ref('teachers/'+u).once('value');
    if(!s.exists()){showError('×©× ××©×ª××© ×©×’×•×™');return;}
    const t=s.val();if(t.password!==p){showError('×¡×™×¡××” ×©×’×•×™×”');return;}
    currentUser={key:u,...t};currentRole='teacher';
    teacherClasses=Array.isArray(t.classes)?t.classes:(t.classes?[t.classes]:[]);
    document.getElementById('teacherTopbarName').textContent='ğŸ‘©â€ğŸ« '+t.name;
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('teacherScreen').style.display='block';
    loadTeacherClassView();
  }catch(e){showError('×©×’×™××”');}
}

async function loginAdmin(){
  const u=document.getElementById('adminUsername').value.trim(),p=document.getElementById('adminPassword').value.trim();
  if(!u||!p){showError('××œ× ×¤×¨×˜×™×');return;}
  try{
    const s=await db.ref('admins/'+u).once('value');
    if(!s.exists()||s.val().password!==p){showError('×¤×¨×˜×™× ×©×’×•×™×™×');return;}
    currentRole='admin';document.getElementById('loginScreen').style.display='none';
    document.getElementById('adminScreen').style.display='block';loadAdminData();
  }catch(e){showError('×©×’×™××”');}
}

function logout(){if(_dirty)saveToCloud();currentUser=null;currentRole=null;_dirty=false;teacherAllStudents=[];teacherClasses=[];
  document.getElementById('loginScreen').style.display='flex';['studentScreen','teacherScreen','adminScreen'].forEach(id=>document.getElementById(id).style.display='none');
  document.getElementById('loginError').style.display='none';getAllFields().forEach(el=>el.value='');}

// ==================================================================
// NAV
// ==================================================================
function showPage(pid,btn){
  document.querySelectorAll('#studentGlass .page').forEach(p=>p.classList.remove('active'));
  const pg=document.getElementById(pid);if(pg)pg.classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');window.scrollTo(0,0);
  if(pid==='dashboard')updateDashboard();
}
function toggleChapter(h){const c=h.nextElementSibling,b=h.querySelector('.btn-open-chapter'),o=c.style.display==='block';c.style.display=o?'none':'block';b.textContent=o?'×¤×ª×—':'×¡×’×•×¨';}

// ==================================================================
// ×ª×™×§×•×Ÿ ××¡' 7: ×“×©×‘×•×¨×“ ××‘×•×¡×¡ data-field ×¡×× ×˜×™
// ==================================================================
function updateDashboard(){
  let tF=0,fF=0,cA=0,tC=0,tD=0,aHTML='';const pm={};
  ARENAS.forEach(a=>{
    const el=document.getElementById('z-'+a.id);if(!el)return;
    const flds=el.querySelectorAll('[data-field]');let tot=flds.length,fil=0;
    flds.forEach(f=>{if(f.value&&f.value.trim())fil++;});
    tF+=tot;fF+=fil;const pct=tot>0?Math.round(fil/tot*100):0;pm['z-'+a.id]=pct;if(pct===100)cA++;
    for(let c=0;c<N_CONCEPTS;c++){const cf=el.querySelectorAll(`[data-field^="z${a.id}_c${c}_"]`);let ok=true;cf.forEach(f=>{if(!f.value||!f.value.trim())ok=false;});if(ok&&cf.length>0)tC++;}
    ['per','pro'].forEach(t=>{const df=el.querySelectorAll(`[data-field^="z${a.id}_d_${t}_"]`);let ok=true;df.forEach(f=>{if(!f.value||!f.value.trim())ok=false;});if(ok&&df.length>0)tD++;});
    const bc=pct===100?'badge-complete':pct>0?'badge-partial':'badge-empty';const bt=pct===100?'×”×•×©×œ×':pct>0?'×‘×ª×”×œ×™×š':'×œ× ×”×ª×—×™×œ';
    aHTML+=`<div class="arena-status" style="border-color:${a.color}"><div class="arena-name" style="color:${a.color}">${a.label}</div><div class="arena-progress"><span class="badge ${bc}">${bt}</span><div class="mini-progress"><div class="mini-progress-fill" style="width:${pct}%;background:${a.color}"></div></div><span style="font-weight:bold;color:#555;">${pct}%</span></div></div>`;
  });
  const tot=tF>0?Math.round(fF/tF*100):0;
  const $=id=>document.getElementById(id);
  if($('totalProgress'))$('totalProgress').textContent=tot+'%';
  if($('totalProgressBar'))$('totalProgressBar').style.width=tot+'%';
  if($('conceptsCount'))$('conceptsCount').textContent=tC;
  if($('dilemmasCount'))$('dilemmasCount').textContent=tD;
  if($('arenasCount'))$('arenasCount').textContent=cA+'/10';
  if($('arenasList'))$('arenasList').innerHTML=aHTML;
  document.querySelectorAll('#lobby-zirot .card').forEach((card,i)=>{
    const aid=ARENAS[i]?'z-'+ARENAS[i].id:null;if(!aid)return;const ap=pm[aid]||0;
    let ind=card.querySelector('.progress-indicator');if(!ind){ind=document.createElement('div');ind.className='progress-indicator';card.appendChild(ind);}
    ind.style.setProperty('--progress',ap+'%');ind.innerHTML=`<span>${ap}%</span>`;
    let bg=card.querySelector('.completion-badge');if(ap===100){if(!bg){bg=document.createElement('div');bg.className='completion-badge';bg.innerHTML='âœ“';card.appendChild(bg);}}else if(bg)bg.remove();
  });
}

// ==================================================================
// ×—×™×©×•×‘ ×”×ª×§×“××•×ª ×× ×ª×•× ×™× ×©××•×¨×™× (×œ×××©×§ ××•×¨×”/×× ×”×œ)
// ==================================================================
function calcProgress(d){
  if(!d)return 0;const keys=Object.keys(d).filter(k=>!k.startsWith('_'));
  const total=ARENAS.length*(N_CONCEPTS*4+2*9+3); // 4 fields per concept, 9 per dilemma type, 3 literacy
  return total>0?Math.round(keys.length/total*100):0;
}

// ==================================================================
// TEACHER
// ==================================================================
async function loadTeacherClassView(){
  showTeacherView('classes');const gr=document.getElementById('classSelectorGrid');
  gr.innerHTML='<div style="color:#aaa;padding:20px;">×˜×•×¢×Ÿ...</div>';
  try{
    const s=await db.ref('students').once('value');teacherAllStudents=[];
    s.forEach(ch=>{const v=ch.val();if(teacherClasses.some(c=>v.class&&v.class.includes(c.trim())))teacherAllStudents.push({id:ch.key,...v});});
    if(!teacherAllStudents.length){gr.innerHTML='<p style="color:#aaa;padding:20px;">××™×Ÿ ×ª×œ××™×“×™×.</p>';return;}
    const cm={};teacherAllStudents.forEach(s=>{const c=s.class||'?';if(!cm[c])cm[c]=[];cm[c].push(s);});
    gr.innerHTML='';const cols=['#667eea','#00b894','#e17055','#e84393','#0984e3'];
    Object.keys(cm).sort().forEach((cls,ci)=>{
      const sts=cm[cls],col=cols[ci%cols.length],card=document.createElement('div');card.className='class-card';card.style.borderRightColor=col;
      card.innerHTML=`<div class="class-card-name" style="color:${col}">${cls}</div><div class="class-card-count">${sts.length} ×ª×œ××™×“×™×</div><div class="class-card-avg" id="avg-${ci}">â€¦</div><div class="class-card-avg-lbl">×××•×¦×¢</div><div class="class-card-bar"><div class="class-card-bar-fill" id="avgbar-${ci}" style="width:0%;background:${col}"></div></div>`;
      card.onclick=()=>showStudentList(cls,sts,col);gr.appendChild(card);
      Promise.all(sts.map(s=>db.ref('studentData/'+s.id).once('value').then(ds=>calcProgress(ds.val())))).then(ps=>{
        const avg=ps.length?Math.round(ps.reduce((a,b)=>a+b,0)/ps.length):0;
        const ae=document.getElementById('avg-'+ci),be=document.getElementById('avgbar-'+ci);
        if(ae)ae.textContent=avg+'%';if(be)be.style.width=avg+'%';
      });
    });
  }catch(e){gr.innerHTML='<p style="color:red;">×©×’×™××”</p>';}
}

function showTeacherView(v){document.getElementById('teacherClassView').style.display=v==='classes'?'block':'none';document.getElementById('teacherStudentListView').style.display=v==='students'?'block':'none';}

async function showStudentList(cls,students,color){
  showTeacherView('students');document.getElementById('classDetailTitle').textContent='ğŸ“š '+cls;
  const list=document.getElementById('studentListScroll');list.innerHTML='<div style="color:#aaa;padding:16px;">×˜×•×¢×Ÿ...</div>';
  try{
    const enriched=await Promise.all(students.map(async s=>{const ds=await db.ref('studentData/'+s.id).once('value');const d=ds.val()||{};return{...s,pct:calcProgress(d),lastSaved:d._ts?new Date(d._ts).toLocaleString('he-IL'):'×˜×¨× × ×©××¨',data:d};}));
    enriched.sort((a,b)=>a.name.localeCompare(b.name,'he'));list.innerHTML='';
    enriched.forEach(s=>{const it=document.createElement('div');it.className='student-list-item';it.style.borderRightColor=color;
      const sc=s.pct===100?'#00b894':s.pct>0?'#f39c12':'#e74c3c';
      it.innerHTML=`<div><div class="sli-name">ğŸ‘¤ ${esc(s.name)}</div><div class="sli-meta">${s.lastSaved}</div></div><div class="sli-right"><div class="sli-pct" style="color:${sc}">${s.pct}%</div><div class="sli-bar-wrap"><div class="sli-bar"><div class="sli-bar-fill" style="width:${s.pct}%;background:${color}"></div></div></div><span class="material-icons-round" style="color:#ccc">chevron_left</span></div>`;
      it.onclick=()=>openTikModal(s,s.data);list.appendChild(it);});
  }catch(e){list.innerHTML='<p style="color:red;">×©×’×™××”</p>';}
}

// ==================================================================
// TIK MODAL
// ==================================================================
let _tikSt=null,_tikD=null,_tikN={};

async function openTikModal(st,data){
  _tikSt=st;_tikD=data;
  document.getElementById('tikModalName').textContent='ğŸ“‚ '+st.name;
  document.getElementById('tikModalClass').textContent=st.class;
  const pct=calcProgress(data);
  document.getElementById('tikProgressTitle').textContent='×”×ª×§×“××•×ª: '+pct+'%';
  document.getElementById('tikPbFill').style.width=pct+'%';
  document.getElementById('tikPbMeta').textContent=data._ts?'×©××™×¨×”: '+new Date(data._ts).toLocaleString('he-IL'):'';
  try{const sn=await db.ref('teacherNotes/'+st.id).once('value');_tikN=sn.val()||{};}catch(e){_tikN={};}
  document.getElementById('tikModal').style.display='block';document.body.style.overflow='hidden';
  switchTikTab('summary');
}

function switchTikTab(tab){
  document.getElementById('tabSummaryBtn').className='tik-tab-btn'+(tab==='summary'?' active':'');
  document.getElementById('tabFullBtn').className='tik-tab-btn'+(tab==='full'?' active':'');
  document.getElementById('tikSummaryView').style.display=tab==='summary'?'block':'none';
  document.getElementById('tikContent').style.display=tab==='full'?'block':'none';
  if(tab==='summary')buildSummaryView();else if(!document.getElementById('tikContent').hasChildNodes())buildFullView();
}

function buildSummaryView(){
  if(!_tikSt)return;const d=_tikD;let h='';
  ARENAS.forEach(a=>{
    const pfx='z'+a.id+'_';const keys=Object.keys(d).filter(k=>k.startsWith(pfx)&&d[k]&&String(d[k]).trim());
    const total=N_CONCEPTS*4+2*9+3;const pct=Math.min(Math.round(keys.length/total*100),100);
    const note=_tikN['z'+a.id]||'';
    const FIELD_LABELS={'name':'×©×','exp':'×”×¡×‘×¨','link':'×§×™×©×•×¨','ctx':'×”×§×©×¨','desc':'×ª×™××•×¨','aName':'×“×¨×š ×','bName':'×“×¨×š ×‘','aGain':'×¨×•×•×— ×','aCost':'××—×™×¨ ×','bGain':'×¨×•×•×— ×‘','bCost':'××—×™×¨ ×‘','dec':'×”×›×¨×¢×”','sol':'×¤×ª×¨×•×Ÿ','soc':'×—×‘×¨×”','med':'×ª×§×©×•×¨×ª','self':'×¢×¦××™'};
    function fieldLabel(k){const parts=k.replace(pfx,'').split('_');const last=parts[parts.length-1];return FIELD_LABELS[last]||last;}
    h+=`<div style="background:white;border-radius:16px;margin-bottom:14px;overflow:hidden;box-shadow:0 4px 14px rgba(0,0,0,0.07);border-right:5px solid ${a.color}">
      <div onclick="toggleSummaryArena('sa-${a.id}')" style="padding:16px 20px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;">
        <div style="display:flex;align-items:center;gap:10px;"><span class="material-icons-round" style="color:${a.color};font-size:22px">${a.icon}</span><span style="font-weight:800">${a.label}</span>
          ${pct===0?'<span class="badge badge-empty">×œ× ×”×ª×—×™×œ</span>':pct>=100?'<span class="badge badge-complete">×”×•×©×œ× âœ“</span>':`<span class="badge badge-partial">${keys.length} ×©×“×•×ª</span>`}</div>
        <div style="display:flex;align-items:center;gap:10px"><div style="width:60px;background:#f0f0f0;height:7px;border-radius:7px;overflow:hidden"><div style="width:${pct}%;height:100%;background:${a.color};border-radius:7px"></div></div><span class="material-icons-round" style="color:#ccc" id="sa-arrow-${a.id}">expand_more</span></div>
      </div>
      <div id="sa-${a.id}" style="display:${pct>0?'block':'none'};border-top:1px solid #f0f0f0">
        ${keys.length>0?`<div style="padding:16px 20px 8px">${keys.map(k=>`<div style="margin-bottom:12px"><div style="font-size:0.78rem;font-weight:700;color:#aaa;margin-bottom:3px">${esc(fieldLabel(k))}</div><div style="background:#f8f9ff;border-radius:8px;padding:10px 14px;font-size:0.95rem;line-height:1.5;border-right:3px solid ${a.color}">${esc(d[k])}</div></div>`).join('')}</div>`:''}
        <div style="padding:12px 20px 16px;background:linear-gradient(135deg,#fffde7,#fff9e6)">
          <div style="font-size:0.8rem;font-weight:800;color:#f57f17;margin-bottom:6px">âœï¸ ×”×¢×¨×”</div>
          <textarea id="tknote-${_tikSt.id}-${a.id}" style="width:100%;min-height:60px;padding:9px 12px;border:2px solid #ffe082;border-radius:8px;background:white;font-family:inherit;font-size:0.9rem;resize:vertical">${esc(note)}</textarea>
          <button onclick="saveTikNote('${_tikSt.id}','${a.id}')" style="margin-top:6px;background:linear-gradient(45deg,#f1c40f,#f39c12);color:white;border:none;padding:7px 16px;border-radius:12px;cursor:pointer;font-weight:800;font-family:inherit;font-size:0.85rem">ğŸ’¾ ×©××•×¨</button>
        </div>
      </div></div>`;
  });
  document.getElementById('tikSummaryView').innerHTML=h;
}

function buildFullView(){
  if(!_tikSt)return;const d=_tikD;let h='';
  ARENAS.forEach(a=>{
    h+=`<div style="background:white;border-radius:20px;margin-bottom:20px;overflow:hidden;box-shadow:0 5px 20px rgba(0,0,0,0.08)">
      <div style="background:${a.color}15;border-right:5px solid ${a.color};padding:18px 22px"><span style="font-weight:900;font-size:1.15rem;color:${a.color}">${a.label}</span></div><div style="padding:20px">`;
    for(let c=0;c<N_CONCEPTS;c++){
      const nm=d[`z${a.id}_c${c}_name`]||'',ex=d[`z${a.id}_c${c}_exp`]||'',lk=d[`z${a.id}_c${c}_link`]||'',cx=d[`z${a.id}_c${c}_ctx`]||'';
      if(nm||ex)h+=`<div style="background:#f8f9ff;border-radius:10px;padding:14px;margin-bottom:12px;border-right:4px solid ${CONCEPT_COLORS[c].bc}"><div style="font-weight:800;color:${CONCEPT_COLORS[c].bc};margin-bottom:6px">××•×©×’ #${c+1}: ${esc(nm)}</div>${ex?`<div style="margin-bottom:4px"><span style="font-size:0.78rem;color:#aaa">×”×¡×‘×¨:</span> ${esc(ex)}</div>`:''}${lk?`<div style="margin-bottom:4px"><span style="font-size:0.78rem;color:#aaa">×§×™×©×•×¨:</span> <a href="${esc(lk)}" target="_blank" style="color:#0984e3;word-break:break-all">${esc(lk)}</a></div>`:''}${cx?`<div><span style="font-size:0.78rem;color:#aaa">×”×§×©×¨:</span> ${esc(cx)}</div>`:''}</div>`;
    }
    [{k:'per',t:'ğŸ‘¤ ×“×™×œ××” ××™×©×™×ª'},{k:'pro',t:'ğŸ¥ ×“×™×œ××” ××§×¦×•×¢×™×ª'}].forEach(dt=>{
      const desc=d[`z${a.id}_d_${dt.k}_desc`]||'';if(!desc)return;
      h+=`<div style="background:#f3e5f5;border-radius:10px;padding:14px;margin-bottom:12px"><div style="font-weight:800;margin-bottom:6px">${dt.t}</div><div>${esc(desc)}</div>`;
      const dec=d[`z${a.id}_d_${dt.k}_dec`]||'';if(dec)h+=`<div style="margin-top:8px;font-weight:700;color:#8e44ad">×”×›×¨×¢×”: ${esc(dec)}</div>`;
      h+=`</div>`;
    });
    const soc=d[`z${a.id}_lit_soc`]||'',med=d[`z${a.id}_lit_med`]||'',self=d[`z${a.id}_lit_self`]||'';
    if(soc||med||self){h+=`<div style="background:#fff9db;border-radius:10px;padding:14px;margin-bottom:12px"><div style="font-weight:800;margin-bottom:6px">××•×¨×™×™× ×•×ª</div>`;if(soc)h+=`<div>ğŸŒ ${esc(soc)}</div>`;if(med)h+=`<div>ğŸ“º ${esc(med)}</div>`;if(self)h+=`<div>ğŸ™‹ ${esc(self)}</div>`;h+=`</div>`;}
    // Note
    const note=_tikN['z'+a.id]||'';
    h+=`<div style="padding:12px;background:#fffde7;border-radius:10px;border:2px solid #ffe082"><div style="font-size:0.8rem;font-weight:800;color:#f57f17;margin-bottom:6px">âœï¸ ×”×¢×¨×”</div>
      <textarea id="tknote-full-${_tikSt.id}-${a.id}" style="width:100%;min-height:60px;padding:9px;border:2px solid #ffe082;border-radius:8px;background:white;font-family:inherit;font-size:0.9rem;resize:vertical">${esc(note)}</textarea>
      <button onclick="saveTikNote('${_tikSt.id}','${a.id}',true)" style="margin-top:6px;background:linear-gradient(45deg,#f1c40f,#f39c12);color:white;border:none;padding:7px 16px;border-radius:12px;cursor:pointer;font-weight:800;font-family:inherit">ğŸ’¾ ×©××•×¨</button></div>`;
    h+=`</div></div>`;
  });
  document.getElementById('tikContent').innerHTML=h;
}

function toggleSummaryArena(id){const el=document.getElementById(id);if(!el)return;const nid=id.replace('sa-','');const ar=document.getElementById('sa-arrow-'+nid);const o=el.style.display==='block';el.style.display=o?'none':'block';if(ar)ar.style.transform=o?'':'rotate(180deg)';}

async function saveTikNote(sid,zone,fromFull){
  const pfx=fromFull?'tknote-full-':'tknote-';const ta=document.getElementById(pfx+sid+'-'+zone);if(!ta)return;
  const val=ta.value;_tikN['z'+zone]=val;
  const other=document.getElementById((fromFull?'tknote-':'tknote-full-')+sid+'-'+zone);if(other)other.value=val;
  try{await db.ref('teacherNotes/'+sid+'/z'+zone).set(val);showSaveToast('âœ… ×”×¢×¨×” × ×©××¨×”!');}catch(e){showSaveToast('âš ï¸ ×©×’×™××”',true);}
}

function closeTikModal(){document.getElementById('tikModal').style.display='none';document.getElementById('tikContent').innerHTML='';document.getElementById('tikSummaryView').innerHTML='';_tikSt=null;_tikD=null;_tikN={};document.body.style.overflow='';}

// ==================================================================
// ADMIN
// ==================================================================
function loadAdminData(){loadStudentsTable();loadTeachersTable();loadOverview();loadPastePassword();}

async function loadPastePassword(){
  try{const s=await db.ref('settings/pastePassword').once('value');const v=s.val()||'';
    document.getElementById('pastePassInput').value=v;
    document.getElementById('currentPastePass').textContent=v?'×¡×™×¡××” × ×•×›×—×™×ª: '+v:'×œ× ×”×•×’×“×¨×” ×¡×™×¡××”';
  }catch(e){}
}

async function savePastePassword(){
  const v=document.getElementById('pastePassInput').value.trim();
  if(!v){alert('×”×›× ×¡ ×¡×™×¡××”');return;}
  try{await db.ref('settings/pastePassword').set(v);document.getElementById('currentPastePass').textContent='âœ… ×¡×™×¡××” × ×•×›×—×™×ª: '+v;showSaveToast('ğŸ” ×¡×™×¡××” × ×©××¨×”!');}
  catch(e){alert('×©×’×™××”');}
}

async function loadStudentsTable(){
  try{const s=await db.ref('students').once('value');const tb=document.getElementById('studentsTableBody');tb.innerHTML='';let cnt=0;
    const proms=[];s.forEach(ch=>{cnt++;const v=ch.val();proms.push(db.ref('studentData/'+ch.key).once('value').then(ds=>{
      const p=calcProgress(ds.val());const tr=document.createElement('tr');
      tr.innerHTML=`<td>${esc(ch.key)}</td><td>${esc(v.name)}</td><td>${esc(v.class)}</td><td><div style="display:flex;align-items:center;gap:8px"><div style="flex:1;background:#f0f0f0;height:8px;border-radius:5px;overflow:hidden"><div style="width:${p}%;height:100%;background:linear-gradient(90deg,#667eea,#764ba2);border-radius:5px"></div></div><span style="font-weight:700;font-size:0.85rem">${p}%</span></div></td><td><button class="btn-admin btn-danger" onclick="deleteStudent('${ch.key}')">××—×§</button></td>`;
      tb.appendChild(tr);}));});
    await Promise.all(proms);document.getElementById('adminTotalStudents').textContent=cnt;
  }catch(e){}}

async function loadTeachersTable(){
  try{const s=await db.ref('teachers').once('value');const tb=document.getElementById('teachersTableBody');tb.innerHTML='';let cnt=0;
    s.forEach(ch=>{cnt++;const t=ch.val();const cls=Array.isArray(t.classes)?t.classes.join(', '):t.classes||'â€”';
      const tr=document.createElement('tr');tr.innerHTML=`<td>${esc(t.username||ch.key)}</td><td>${esc(t.name)}</td><td>${esc(cls)}</td><td><button class="btn-admin btn-danger" onclick="deleteTeacher('${ch.key}')">××—×§</button></td>`;tb.appendChild(tr);});
    document.getElementById('adminTotalTeachers').textContent=cnt;
  }catch(e){}}

async function loadOverview(){
  try{const s=await db.ref('students').once('value');const cls={};const proms=[];
    s.forEach(ch=>{const v=ch.val();if(!cls[v.class])cls[v.class]={students:[],progs:[]};cls[v.class].students.push(v.name);proms.push(db.ref('studentData/'+ch.key).once('value').then(ds=>{cls[v.class].progs.push(calcProgress(ds.val()));}));});
    await Promise.all(proms);let h='';
    Object.keys(cls).sort().forEach(c=>{const avg=cls[c].progs.length?Math.round(cls[c].progs.reduce((a,b)=>a+b,0)/cls[c].progs.length):0;
      h+=`<div style="background:#f8f9ff;border-radius:12px;padding:15px;margin-bottom:12px;border-right:4px solid #667eea"><div style="display:flex;justify-content:space-between"><div><strong>${esc(c)}</strong> â€“ ${cls[c].students.length} ×ª×œ××™×“×™×</div><span style="font-weight:900;color:#667eea">${avg}%</span></div><div style="background:#e0e0e0;height:8px;border-radius:5px;overflow:hidden;margin-top:8px"><div style="width:${avg}%;height:100%;background:linear-gradient(90deg,#667eea,#764ba2);border-radius:5px"></div></div></div>`;});
    document.getElementById('classesOverview').innerHTML=h||'<p style="color:#888">××™×Ÿ × ×ª×•× ×™×</p>';
    const allP=Object.values(cls).flatMap(c=>c.progs);const avg=allP.length?Math.round(allP.reduce((a,b)=>a+b,0)/allP.length):0;
    document.getElementById('adminAvgProgress').textContent=avg+'%';
  }catch(e){}}

async function addStudent(){
  const id=document.getElementById('newStudentId').value.trim(),name=document.getElementById('newStudentName').value.trim(),cls=document.getElementById('newStudentClass').value.trim();
  if(!id||!name||!cls){alert('××œ× ××ª ×›×œ ×”×©×“×•×ª');return;}
  try{await db.ref('students/'+id).set({name,class:cls});alert('âœ… × ×•×¡×£!');['newStudentId','newStudentName','newStudentClass'].forEach(i=>document.getElementById(i).value='');loadStudentsTable();}catch(e){alert('×©×’×™××”');}
}

async function addTeacher(){
  const u=document.getElementById('newTeacherUsername').value.trim(),p=document.getElementById('newTeacherPassword').value.trim(),n=document.getElementById('newTeacherName').value.trim(),c=document.getElementById('newTeacherClasses').value.trim();
  if(!u||!p||!n||!c){alert('××œ× ×”×›×œ');return;}
  const classes=c.split(',').map(s=>s.trim()).filter(Boolean);
  try{await db.ref('teachers/'+u).set({username:u,password:p,name:n,classes});alert('âœ… × ×•×¡×£!');['newTeacherUsername','newTeacherPassword','newTeacherName','newTeacherClasses'].forEach(i=>document.getElementById(i).value='');loadTeachersTable();}catch(e){alert('×©×’×™××”');}
}

async function deleteStudent(id){if(!confirm('×œ××—×•×§?'))return;try{await db.ref('students/'+id).remove();loadStudentsTable();}catch(e){}}
async function deleteTeacher(k){if(!confirm('×œ××—×•×§?'))return;try{await db.ref('teachers/'+k).remove();loadTeachersTable();}catch(e){}}
function filterStudents(){const q=document.getElementById('searchStudent').value.toLowerCase();document.querySelectorAll('#studentsTableBody tr').forEach(tr=>{tr.style.display=tr.textContent.toLowerCase().includes(q)?'':'none';});}
function switchAdminTab(tab,btn){document.querySelectorAll('.admin-panel').forEach(p=>p.classList.remove('active'));document.querySelectorAll('.admin-tab-btn').forEach(b=>b.classList.remove('active'));document.getElementById('admin'+tab[0].toUpperCase()+tab.slice(1)).classList.add('active');if(btn)btn.classList.add('active');if(tab==='overview')loadOverview();}

// ==================================================================
// EXCEL IMPORT â€” ×ª×™×§×•×Ÿ: ×‘×“×™×§×ª ×›×¤×™×œ×•×™×•×ª
// ==================================================================
let excelData=[];
function loadSheetJS(cb){if(window.XLSX){cb();return;}const s=document.createElement('script');s.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';s.onload=cb;document.head.appendChild(s);}
function handleExcelUpload(inp){const f=inp.files[0];if(!f)return;loadSheetJS(()=>{const r=new FileReader();r.onload=function(e){const wb=XLSX.read(e.target.result,{type:'binary'});const ws=wb.Sheets[wb.SheetNames[0]];const rows=XLSX.utils.sheet_to_json(ws,{header:1});excelData=[];const hdr=rows[0]?rows[0].map(h=>String(h).trim()):[];let ic=hdr.findIndex(h=>h.includes('×ª×–')||h.includes('×–×”×•×ª')),nc=hdr.findIndex(h=>h.includes('×©×')),cc=hdr.findIndex(h=>h.includes('×›×™×ª×”'));if(ic===-1)ic=0;if(nc===-1)nc=1;if(cc===-1)cc=2;
    for(let i=1;i<rows.length;i++){const row=rows[i];if(!row||!row.length)continue;const id=String(row[ic]||'').trim(),nm=String(row[nc]||'').trim(),cl=String(row[cc]||'').trim();if(id&&nm)excelData.push({id,name:nm,class:cl});}showExcelPreview();};r.readAsBinaryString(f);});}
function showExcelPreview(){document.getElementById('excelPreview').style.display='block';document.getElementById('excelSummary').textContent=`âœ… ${excelData.length} ×ª×œ××™×“×™×`;let h='<table style="width:100%;border-collapse:collapse;font-size:0.9rem"><thead><tr style="background:#e0f0ff"><th style="padding:8px">×ª×–</th><th style="padding:8px">×©×</th><th style="padding:8px">×›×™×ª×”</th></tr></thead><tbody>';excelData.slice(0,10).forEach(s=>{h+=`<tr><td style="padding:7px">${esc(s.id)}</td><td style="padding:7px">${esc(s.name)}</td><td style="padding:7px">${esc(s.class)}</td></tr>`;});if(excelData.length>10)h+=`<tr><td colspan=3 style="padding:8px;text-align:center;color:#888">...×•×¢×•×“ ${excelData.length-10}</td></tr>`;h+='</tbody></table>';document.getElementById('excelTable').innerHTML=h;}
async function importAllStudents(){
  if(!excelData.length)return;
  // ×ª×™×§×•×Ÿ: ×‘×“×™×§×ª ×›×¤×™×œ×•×™×•×ª
  const existing=await db.ref('students').once('value');const existingIds=[];existing.forEach(ch=>existingIds.push(ch.key));
  const dupes=excelData.filter(s=>existingIds.includes(s.id));
  if(dupes.length>0&&!confirm(`âš ï¸ ${dupes.length} ×ª×œ××™×“×™× ×›×‘×¨ ×§×™×™××™× ×•×™×™×“×¨×¡×•. ×œ×”××©×™×š?`))return;
  const updates={};excelData.forEach(s=>{updates['students/'+s.id]={name:s.name,class:s.class};});
  try{await db.ref().update(updates);alert(`âœ… ×™×•×‘××• ${excelData.length} ×ª×œ××™×“×™×!`);document.getElementById('excelPreview').style.display='none';excelData=[];loadStudentsTable();}catch(e){alert('×©×’×™××”: '+e.message);}
}

// ==================================================================
// MIC (speech recognition)
// ==================================================================
function addMicButtons(){document.querySelectorAll('#studentScreen [data-field]').forEach(field=>{
  if(field.parentElement.classList.contains('input-mic-wrapper'))return;
  const w=document.createElement('div');w.className='input-mic-wrapper';field.parentNode.insertBefore(w,field);w.appendChild(field);
  const btn=document.createElement('button');btn.type='button';btn.className='mic-btn';btn.title='×”×›×ª×‘×”';btn.innerHTML='<span class="material-icons-round">mic</span>';
  btn.addEventListener('click',()=>startDictation(field,btn));w.appendChild(btn);});}

function startDictation(field,btn){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){alert('×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘×”×›×ª×‘×”.');return;}
  if(btn.classList.contains('listening')){if(btn._r)btn._r.stop();return;}
  const r=new SR();r.lang='he-IL';r.interimResults=false;btn._r=r;btn.classList.add('listening');
  r.onresult=e=>{field.value+=(field.value.trim()?' ':'')+e.results[0][0].transcript;markDirty();};
  r.onerror=()=>{};r.onend=()=>{btn.classList.remove('listening');};r.start();
}

// ==================================================================
// PASTE PROTECTION â€” ×—×¡×™××” ×¢× ××¤×©×¨×•×ª ×¤×ª×™×—×” ×‘×¡×™×¡××”
// ==================================================================
let _pasteUnlocked = false;

function initPasteProtection() {
  document.addEventListener('paste', e => {
    if (currentRole !== 'student') return;
    if (e.target.classList && e.target.classList.contains('allow-paste')) return;
    if (_pasteUnlocked) { logPasteEvent(e.target); return; }
    e.preventDefault();
    showPasteDialog();
  });
  document.addEventListener('copy', e => {
    if (currentRole !== 'student') return;
    if (!_pasteUnlocked) { e.preventDefault(); showSaveToast('ğŸ“‹ ×”×¢×ª×§×” ×—×¡×•××”', true); }
  });
}

async function showPasteDialog() {
  const pass = prompt('ğŸ” ×”×“×‘×§×” ×“×•×¨×©×ª ×¡×™×¡××ª ××•×¨×”:');
  if (pass === null) return;
  try {
    const snap = await db.ref('settings/pastePassword').once('value');
    const correctPass = snap.val();
    if (!correctPass) { showSaveToast('âš ï¸ ×¡×™×¡××” ×œ× ×”×•×’×“×¨×” ×‘××¢×¨×›×ª', true); return; }
    if (pass === correctPass) {
      _pasteUnlocked = true;
      showSaveToast('âœ… ×”×“×‘×§×” ×”×•×¤×¢×œ×” ×œ×©××¨×™×ª ×”×¡×©×Ÿ');
    } else {
      showSaveToast('âŒ ×¡×™×¡××” ×©×’×•×™×”', true);
    }
  } catch (e) {
    showSaveToast('âš ï¸ ×©×’×™××ª ×—×™×‘×•×¨', true);
  }
}

function logPasteEvent(target) {
  if (!currentUser || currentRole !== 'student') return;
  const fieldId = target.dataset ? target.dataset.field : 'unknown';
  db.ref('pasteLogs/' + currentUser.id).push({ field: fieldId, time: new Date().toISOString() }).catch(() => {});
}

// ==================================================================
// UTILS
// ==================================================================
function autoResize(el){el.style.height='auto';el.style.height=el.scrollHeight+'px';}
function initAutoResize(){document.querySelectorAll('textarea').forEach(ta=>{ta.addEventListener('input',()=>autoResize(ta));autoResize(ta);});}

// ==================================================================
// KEYBOARD SHORTCUTS
// ==================================================================
document.getElementById('studentId').addEventListener('keypress',e=>{if(e.key==='Enter')loginStudent();});
document.getElementById('teacherPassword').addEventListener('keypress',e=>{if(e.key==='Enter')loginTeacher();});
document.getElementById('adminPassword').addEventListener('keypress',e=>{if(e.key==='Enter')loginAdmin();});

// ==================================================================
// INIT â€” ×™×™×¦×•×¨ ×”×“×¤×™× ×“×™× ××™×ª
// ==================================================================
buildStudentPages();
initPasteProtection();
</script>
</body>
</html>
