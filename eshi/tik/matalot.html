<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>××¢×¨×›×ª ××˜×œ×•×ª</title>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{--primary:#5c6bc0;--primary-dark:#3949ab;--success:#00b894;--danger:#e74c3c;--warn:#f39c12;--bg:#f0f2ff;--card:#fff;--text:#2d3436;--muted:#888;}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
body{font-family:"Rubik",sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}
#loginScreen{background:linear-gradient(135deg,#0a192f,#112240,#0d1b33);min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;position:relative;overflow:hidden;}
#loginScreen::before{content:"";position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle at 30% 40%,rgba(100,255,218,.07) 0%,transparent 50%),radial-gradient(circle at 70% 60%,rgba(92,107,192,.1) 0%,transparent 40%);animation:floatBg 20s ease-in-out infinite;pointer-events:none;z-index:0;}
@keyframes floatBg{0%,100%{transform:translate(0,0)}50%{transform:translate(20px,-15px)}}
.login-header{text-align:center;margin-bottom:32px;position:relative;z-index:2;animation:cardSlideUp .5s cubic-bezier(.16,1,.3,1);}
.login-header .logo-box{width:80px;height:80px;background:linear-gradient(135deg,#5c6bc0,#9c27b0);border-radius:22px;display:flex;align-items:center;justify-content:center;margin:0 auto 18px;box-shadow:0 12px 32px rgba(92,107,192,.4);}.login-header .logo-box .material-icons-round{font-size:40px;color:white;}
.login-header h1{font-size:1.7rem;font-weight:900;color:white;margin-bottom:4px;}
.login-header p{color:rgba(255,255,255,.5);font-size:.88rem;}
.login-header .credit{color:rgba(255,255,255,.3);font-size:.72rem;margin-top:6px;letter-spacing:.3px;}
.role-cards{display:flex;gap:14px;margin-bottom:28px;position:relative;z-index:2;animation:cardSlideUp .6s cubic-bezier(.16,1,.3,1);}
.role-card{flex:1;padding:22px 16px 18px;border-radius:18px;border:none;cursor:pointer;font-family:inherit;text-align:center;transition:all .35s cubic-bezier(.16,1,.3,1);position:relative;overflow:hidden;min-width:100px;z-index:2;}
.role-card .rc-emoji{font-size:32px;display:block;margin-bottom:8px;transition:transform .3s;}
.role-card .rc-label{font-size:.88rem;font-weight:800;display:block;}
.role-card:hover .rc-emoji{transform:scale(1.15);}
.role-card:hover{transform:translateY(-4px);}
.role-card.rc-student{background:linear-gradient(135deg,#5c6bc0,#7986cb);color:white;box-shadow:0 8px 24px rgba(92,107,192,.35);}
.role-card.rc-teacher{background:linear-gradient(135deg,#00b894,#00cec9);color:white;box-shadow:0 8px 24px rgba(0,184,148,.3);}
.role-card.rc-admin{background:linear-gradient(135deg,#e74c3c,#fd7272);color:white;box-shadow:0 8px 24px rgba(231,76,60,.3);}
.role-card.active{transform:translateY(-6px) scale(1.05);box-shadow:0 12px 32px rgba(0,0,0,.3);}.role-card.active::after{content:"";position:absolute;inset:-3px;border-radius:20px;border:3px solid rgba(255,255,255,.5);pointer-events:none;}
.login-form-card{background:rgba(255,255,255,.06);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.1);border-radius:24px;padding:32px 30px 28px;width:100%;max-width:420px;position:relative;z-index:2;animation:cardSlideUp .7s cubic-bezier(.16,1,.3,1);}
@keyframes cardSlideUp{from{opacity:0;transform:translateY(25px)}to{opacity:1;transform:translateY(0)}}
.login-form-card .field{margin-bottom:16px;}.login-form-card .field label{display:block;font-weight:700;font-size:.85rem;color:rgba(255,255,255,.7);margin-bottom:6px;}
.login-form-card .field input{width:100%;padding:14px 16px;border:1.5px solid rgba(255,255,255,.15);border-radius:13px;font-family:inherit;font-size:1rem;background:rgba(255,255,255,.07);color:white;transition:all .3s;}.login-form-card .field input::placeholder{color:rgba(255,255,255,.3);}.login-form-card .field input:focus{border-color:rgba(92,107,192,.7);background:rgba(255,255,255,.1);outline:none;box-shadow:0 0 0 4px rgba(92,107,192,.15);}
.btn-main{width:100%;padding:14px;background:linear-gradient(135deg,#5c6bc0,#9c27b0);color:white;border:none;border-radius:14px;font-family:inherit;font-size:1.05rem;font-weight:700;cursor:pointer;margin-top:8px;transition:all .3s;}.btn-main:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(92,107,192,.45);}.btn-main:active{transform:translateY(0);}
.login-err{color:#ff6b6b;font-size:.88rem;text-align:center;margin-top:12px;display:none;background:rgba(231,76,60,.1);padding:8px;border-radius:10px;}

#studentScreen,#teacherScreen,#adminScreen{display:none;min-height:100vh;}
.topbar{background:linear-gradient(135deg,#5c6bc0,#9c27b0);color:white;padding:13px 20px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:200;}
.topbar-left h2{font-size:1.05rem;font-weight:900;margin:0;}.topbar-left p{font-size:.8rem;opacity:.85;margin:2px 0 0;}
.btn-logout{background:rgba(255,255,255,.18);border:none;color:white;padding:7px 15px;border-radius:20px;cursor:pointer;font-family:inherit;font-size:.82rem;font-weight:700;}
.screen-body{max-width:1000px;margin:0 auto;padding:24px 16px 60px;}
.student-welcome{background:linear-gradient(135deg,#5c6bc0,#9c27b0);color:white;border-radius:18px;padding:24px;margin-bottom:24px;}.student-welcome h3{font-size:1.3rem;font-weight:900;margin-bottom:4px;}.student-welcome p{opacity:.88;font-size:.9rem;}
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px;margin-bottom:24px;}.stat-box{background:white;border-radius:14px;padding:16px;text-align:center;box-shadow:0 4px 15px rgba(0,0,0,.06);}.stat-box .num{font-size:2rem;font-weight:900;margin-bottom:2px;}.stat-box .lbl{font-size:.78rem;color:var(--muted);font-weight:600;}
.section-title{font-size:1.05rem;font-weight:900;color:var(--text);margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.assignment-card{background:white;border-radius:16px;padding:20px;margin-bottom:14px;box-shadow:0 4px 14px rgba(0,0,0,.06);border-right:5px solid var(--primary);transition:.25s;}
.asgn-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;gap:12px;}.asgn-title{font-size:1.05rem;font-weight:800;}.asgn-desc{color:#555;font-size:.9rem;line-height:1.6;margin-bottom:12px;}
.asgn-meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:14px;}.meta-chip{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:20px;font-size:.78rem;font-weight:700;background:#f0f0f0;color:#555;}.chip-red{background:#fee2e2;color:#c0392b;}.chip-blue{background:#dbeafe;color:#1d4ed8;}.chip-purple{background:#ede9fe;color:#6d28d9;}
.status-badge{padding:5px 12px;border-radius:20px;font-size:.8rem;font-weight:800;white-space:nowrap;}.badge-submitted{background:#d4edda;color:#155724;}.badge-pending{background:#fff3cd;color:#856404;}.badge-late{background:#fee2e2;color:#721c24;}
.iframe-section{margin-bottom:16px;}.iframe-toolbar{display:flex;justify-content:space-between;align-items:center;background:#f0f2ff;border:2px solid #e0e4ff;border-radius:12px 12px 0 0;padding:10px 14px;}
.btn-open-new{display:inline-flex;align-items:center;gap:5px;background:var(--primary);color:white;border:none;padding:7px 14px;border-radius:20px;font-family:inherit;font-size:.8rem;font-weight:700;cursor:pointer;}
.iframe-wrapper{border:2px solid #e0e4ff;border-top:none;border-radius:0 0 12px 12px;overflow:hidden;position:relative;}.assignment-iframe{width:100%;border:none;display:block;min-height:450px;}
.submit-section{background:#f8f9ff;border-radius:12px;padding:16px;border:2px solid #e8ecff;margin-top:12px;}.submit-section-title{font-weight:800;font-size:.9rem;color:var(--primary);margin-bottom:12px;display:flex;align-items:center;gap:6px;}
.submit-area textarea{width:100%;min-height:80px;padding:11px;border:2px solid #e0e0e0;border-radius:9px;font-family:inherit;font-size:.95rem;resize:vertical;background:white;}
.submit-area input[type="text"]{width:100%;padding:10px 12px;border:2px solid #e0e0e0;border-radius:9px;font-family:inherit;font-size:.9rem;background:white;margin-top:8px;}
.btn-submit{background:linear-gradient(45deg,var(--success),#00cec9);color:white;border:none;padding:11px 24px;border-radius:25px;font-family:inherit;font-weight:800;font-size:.95rem;cursor:pointer;margin-top:12px;display:inline-flex;align-items:center;gap:6px;}
.btn-collect-inputs{background:linear-gradient(45deg,#9c27b0,#5c6bc0);color:white;border:none;padding:11px 24px;border-radius:25px;font-family:inherit;font-weight:800;font-size:.95rem;cursor:pointer;margin-top:12px;margin-left:10px;display:inline-flex;align-items:center;gap:6px;}
.btn-edit-sub{background:#f0f0f0;color:#555;border:none;padding:8px 16px;border-radius:20px;font-family:inherit;font-weight:700;font-size:.85rem;cursor:pointer;margin-top:8px;}
.submitted-view{background:#f0fff4;border:2px solid #b7efc5;border-radius:10px;padding:14px;margin-top:10px;}.submitted-view .sv-label{font-size:.78rem;font-weight:800;color:#1a7742;margin-bottom:5px;}
.sv-fields-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px;margin-top:8px;}.sv-field{background:white;border-radius:8px;padding:10px 12px;border:1px solid #e0f0e8;}.sv-field-label{font-size:.72rem;font-weight:800;color:#888;margin-bottom:3px;}.sv-field-value{font-size:.88rem;color:#2d3436;word-break:break-word;}
.feedback-box{background:#fff9e6;border:2px solid #ffd966;border-radius:10px;padding:14px;margin-top:10px;}.feedback-box .fb-label{font-size:.78rem;font-weight:800;color:#b7791f;}.feedback-box .fb-grade{font-size:1.6rem;font-weight:900;color:#b7791f;}.feedback-box .fb-text{font-size:.9rem;color:#555;margin-top:4px;}
.empty-state{text-align:center;padding:50px 20px;color:var(--muted);}
.teacher-tabs{display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap;}.t-tab{padding:10px 22px;border:none;border-radius:14px;font-family:inherit;font-size:.92rem;font-weight:700;cursor:pointer;background:white;color:var(--muted);box-shadow:0 3px 10px rgba(0,0,0,.07);}.t-tab.active{background:linear-gradient(45deg,#5c6bc0,#9c27b0);color:white;}
.t-panel{display:none;}.t-panel.active{display:block;}
.panel-card{background:white;border-radius:18px;padding:24px;box-shadow:0 5px 18px rgba(0,0,0,.07);margin-bottom:20px;}.panel-card h2{font-size:1.1rem;font-weight:900;color:var(--primary);margin-bottom:18px;}
.form-group{margin-bottom:14px;}.form-group label{display:block;font-weight:700;font-size:.85rem;color:#555;margin-bottom:6px;}.form-group input,.form-group textarea,.form-group select{width:100%;padding:11px 13px;border:2px solid #eee;border-radius:10px;font-family:inherit;font-size:.95rem;background:#fafafa;}
.html-code-area{font-family:monospace;font-size:.82rem;min-height:180px;background:#1e1e2e !important;color:#cdd6f4;border:2px solid #444 !important;border-radius:10px;padding:14px;}
.html-preview-box{background:#f8f9ff;border:2px solid #e0e4ff;border-radius:10px;padding:14px;margin-top:8px;}.html-preview-iframe{width:100%;height:300px;border:none;border-radius:8px;background:white;}
.btn-preview{background:#e0e4ff;color:var(--primary);border:none;padding:8px 16px;border-radius:20px;font-family:inherit;font-weight:700;font-size:.85rem;cursor:pointer;margin-top:8px;}
.btn-add{background:linear-gradient(45deg,#5c6bc0,#9c27b0);color:white;border:none;padding:12px 28px;border-radius:13px;font-family:inherit;font-weight:800;font-size:.95rem;cursor:pointer;}
.asgn-mgmt-card{background:white;border-radius:14px;padding:18px;margin-bottom:12px;box-shadow:0 3px 12px rgba(0,0,0,.06);border-right:5px solid var(--primary);}.asgn-mgmt-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:10px;}.asgn-mgmt-title{font-weight:800;font-size:1rem;}
.btn-sm{padding:6px 14px;border:none;border-radius:20px;font-family:inherit;font-weight:700;font-size:.8rem;cursor:pointer;}.btn-view{background:#dbeafe;color:#1d4ed8;}.btn-del{background:#fee2e2;color:#c0392b;}
.type-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:12px;font-size:.72rem;font-weight:700;}.type-interactive{background:#ede9fe;color:#6d28d9;}.type-text{background:#dbeafe;color:#1d4ed8;}.type-link{background:#d4edda;color:#1a7742;}.type-both{background:#fff3cd;color:#856404;}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:500;overflow-y:auto;}.modal-content{background:white;max-width:900px;margin:30px auto;border-radius:20px;overflow:hidden;}.modal-header{background:linear-gradient(135deg,#5c6bc0,#9c27b0);color:white;padding:20px 24px;display:flex;justify-content:space-between;align-items:center;}.modal-header h3{font-size:1.1rem;font-weight:900;margin:0;}.btn-close{background:rgba(255,255,255,.2);border:none;color:white;width:34px;height:34px;border-radius:50%;cursor:pointer;}.modal-body{padding:24px;}
.progress-overview{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:10px;margin-bottom:20px;}.prog-box{text-align:center;background:#f8f9ff;border-radius:12px;padding:14px 8px;}.prog-num{font-size:1.8rem;font-weight:900;}.prog-lbl{font-size:.72rem;color:var(--muted);font-weight:600;}
.submission-row{background:#f8f9ff;border-radius:12px;padding:16px;margin-bottom:12px;border-right:4px solid #ddd;}.submission-row.sub-yes{border-right-color:var(--success);}.submission-row.sub-no{border-right-color:#ddd;}.submission-row.sub-late{border-right-color:var(--danger);}
.sub-student-name{font-weight:800;font-size:.95rem;margin-bottom:8px;}.sub-fields-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px;margin-bottom:10px;}.sub-field{background:white;border-radius:8px;padding:10px 12px;border:1px solid #e0e8ff;}.sub-field-label{font-size:.7rem;font-weight:800;color:#888;}.sub-field-value{font-size:.85rem;color:#2d3436;word-break:break-word;}
.sub-text{font-size:.88rem;color:#444;background:white;padding:10px;border-radius:8px;margin-bottom:10px;white-space:pre-wrap;border:1px solid #eee;}.sub-link a{color:var(--primary);font-size:.88rem;}
.feedback-form{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px;}.feedback-form input[type="text"]{flex:1;min-width:120px;padding:8px 12px;border:2px solid #eee;border-radius:9px;font-family:inherit;font-size:.88rem;}.feedback-form input[type="number"]{width:80px;padding:8px 10px;border:2px solid #eee;border-radius:9px;font-family:inherit;font-size:.88rem;text-align:center;}
.btn-feedback{background:linear-gradient(45deg,#f1c40f,#f39c12);color:white;border:none;padding:9px 18px;border-radius:20px;font-family:inherit;font-weight:800;font-size:.82rem;cursor:pointer;}
.saved-feedback{background:#fff9e6;border-radius:8px;padding:8px 12px;margin-top:8px;font-size:.82rem;color:#856404;}
.not-sub-chip{background:#fee2e2;color:#c0392b;padding:5px 10px;border-radius:8px;font-size:.78rem;font-weight:700;}.sub-chip{background:#d4edda;color:#155724;padding:5px 10px;border-radius:8px;font-size:.78rem;font-weight:700;}
.filter-bar{display:flex;gap:8px;margin-bottom:18px;flex-wrap:wrap;align-items:center;}.filter-bar select{padding:9px 13px;border:2px solid #eee;border-radius:10px;font-family:inherit;font-size:.88rem;background:white;}
.admin-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:14px;margin-bottom:24px;}.admin-stat{background:white;border-radius:14px;padding:18px;box-shadow:0 4px 14px rgba(0,0,0,.07);border-right:5px solid var(--primary);}.admin-stat .n{font-size:2rem;font-weight:900;color:var(--primary);}.admin-stat .l{font-size:.8rem;color:var(--muted);font-weight:600;}
.admin-table{width:100%;border-collapse:collapse;font-size:.88rem;}.admin-table th{background:#f0f2ff;padding:11px 14px;text-align:right;font-weight:700;border-bottom:2px solid #ddd;}.admin-table td{padding:11px 14px;border-bottom:1px solid #f0f0f0;}
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#5c6bc0,#9c27b0);color:white;padding:12px 26px;border-radius:50px;font-weight:700;z-index:9999;display:none;}
.collecting-overlay{display:none;position:absolute;inset:0;background:rgba(92,107,192,.15);z-index:10;align-items:center;justify-content:center;}.collecting-overlay.active{display:flex;}.collecting-msg{background:white;padding:16px 28px;border-radius:14px;font-weight:800;color:var(--primary);}
.excel-import-card{background:white;border-radius:18px;padding:24px;box-shadow:0 5px 18px rgba(0,0,0,.07);margin-bottom:20px;border-right:5px solid #00b894;}
.drop-zone{border:3px dashed #c7d2fe;border-radius:14px;padding:32px 20px;text-align:center;cursor:pointer;background:#f8f9ff;position:relative;}.drop-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.col-map-wrap{background:#f8f9ff;border:2px solid #e0e4ff;border-radius:12px;padding:16px;margin:14px 0;}.col-map-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap;}.col-map-row label{font-size:.82rem;font-weight:700;color:#555;min-width:90px;}.col-map-row select{flex:1;min-width:150px;padding:8px 10px;border:2px solid #eee;border-radius:9px;font-family:inherit;font-size:.85rem;background:white;}
.preview-tbl-wrap{overflow-x:auto;border-radius:10px;border:2px solid #e0e4ff;max-height:320px;overflow-y:auto;}.preview-tbl{width:100%;border-collapse:collapse;font-size:.84rem;}.preview-tbl th{background:#f0f2ff;padding:9px 13px;text-align:right;font-weight:700;border-bottom:2px solid #ddd;position:sticky;top:0;}.preview-tbl td{padding:9px 13px;border-bottom:1px solid #f0f0f0;}
.row-status{font-size:.72rem;font-weight:700;padding:2px 8px;border-radius:10px;}.row-status.new{background:#d4edda;color:#155724;}.row-status.dup{background:#fff3cd;color:#856404;}.row-status.err{background:#fee2e2;color:#c0392b;}
.btn-import{background:linear-gradient(45deg,#00b894,#00cec9);color:white;border:none;padding:12px 28px;border-radius:13px;font-family:inherit;font-weight:800;font-size:.95rem;cursor:pointer;display:inline-flex;align-items:center;gap:7px;}.btn-import:disabled{opacity:.5;cursor:not-allowed;}
.btn-cancel-import{background:#f0f0f0;color:#555;border:none;padding:12px 20px;border-radius:13px;font-family:inherit;font-weight:700;font-size:.9rem;cursor:pointer;}
.import-result-box{background:#f0fff4;border:2px solid #b7efc5;border-radius:12px;padding:16px;margin-top:14px;display:none;}
.badge-count{display:inline-flex;align-items:center;gap:4px;background:#d4edda;color:#155724;padding:3px 10px;border-radius:20px;font-size:.78rem;font-weight:700;}.badge-dup{background:#fff3cd;color:#856404;}.badge-err{background:#fee2e2;color:#c0392b;}
.progress-bar-wrap{background:#eee;height:8px;border-radius:8px;overflow:hidden;margin:10px 0;}.progress-bar{height:100%;background:linear-gradient(90deg,#00b894,#00cec9);border-radius:8px;transition:width .3s;}
.auto-save-indicator{font-size:.72rem;color:var(--success);font-weight:700;margin-top:4px;display:none;}
.confirm-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:600;align-items:center;justify-content:center;backdrop-filter:blur(2px);}.confirm-overlay.active{display:flex;}.confirm-box{background:white;border-radius:18px;padding:28px;max-width:380px;width:90%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.3);}.confirm-box h3{font-size:1.1rem;font-weight:900;margin-bottom:8px;}.confirm-box p{color:#555;font-size:.9rem;margin-bottom:20px;}.confirm-btns{display:flex;gap:10px;justify-content:center;}.confirm-btns button{padding:10px 24px;border:none;border-radius:12px;font-family:inherit;font-weight:700;font-size:.9rem;cursor:pointer;}.btn-confirm-yes{background:linear-gradient(45deg,var(--success),#00cec9);color:white;}.btn-confirm-no{background:#f0f0f0;color:#555;}

@media(max-width:600px){.feedback-form{flex-direction:column;align-items:stretch;}.feedback-form input[type="number"]{width:100%;}.asgn-mgmt-header{flex-direction:column;align-items:flex-start;}.col-map-row{flex-direction:column;align-items:flex-start;}.col-map-row select{width:100%;}}
</style>
</head>
<body>
<!-- LOGIN --><div id="loginScreen">
<div class="login-header">
  <div class="logo-box"><span class="material-icons-round">assignment</span></div>
  <h1>××¢×¨×›×ª ××˜×œ×•×ª</h1>
  <p>×”×’×©×ª ×¢×‘×•×“×•×ª ×“×™×’×™×˜×œ×™×ª</p>
  <div class="credit">×¤×™×ª×•×— ××¢×¨×›×ª ××˜×œ×•×ª â€¢ ×¨× ×™ ×‘×Ÿ ×–××‘</div>
</div>
<div class="role-cards">
  <button class="role-card rc-student active" onclick="switchRole('student')"><span class="rc-emoji">ğŸ“</span><span class="rc-label">×ª×œ××™×“</span></button>
  <button class="role-card rc-teacher" onclick="switchRole('teacher')"><span class="rc-emoji">ğŸ‘©â€ğŸ«</span><span class="rc-label">××•×¨×”</span></button>
  <button class="role-card rc-admin" onclick="switchRole('admin')"><span class="rc-emoji">âš™ï¸</span><span class="rc-label">×× ×”×œ</span></button>
</div>
<div class="login-form-card">
  <div id="roleStudent">
    <div class="field"><label>×ª×¢×•×“×ª ×–×”×•×ª</label><input type="text" id="sId" placeholder="×”×–×Ÿ ×ª.×–." maxlength="9"></div>
    <button class="btn-main" onclick="loginStudent()">×›× ×™×¡×” â†</button>
  </div>
  <div id="roleTeacher" style="display:none;">
    <div class="field"><label>×©× ××©×ª××©</label><input type="text" id="tUser" placeholder="×©× ××©×ª××©"></div>
    <div class="field"><label>×¡×™×¡××”</label><input type="password" id="tPass" placeholder="×¡×™×¡××”"></div>
    <button class="btn-main" onclick="loginTeacher()">×›× ×™×¡×” â†</button>
  </div>
  <div id="roleAdmin" style="display:none;">
    <div class="field"><label>×©× ××©×ª××©</label><input type="text" id="aUser" placeholder="×©× ××©×ª××©"></div>
    <div class="field"><label>×¡×™×¡××”</label><input type="password" id="aPass" placeholder="×¡×™×¡××”"></div>
    <button class="btn-main" onclick="loginAdmin()">×›× ×™×¡×” â†</button>
  </div>
  <div class="login-err" id="loginErr">âŒ ×¤×¨×˜×™ ×›× ×™×¡×” ×©×’×•×™×™×</div>
</div>
</div>
<!-- STUDENT --><div id="studentScreen"><div class="topbar"><div class="topbar-left"><h2>××¢×¨×›×ª ××˜×œ×•×ª</h2><p id="sTpName"></p></div><button class="btn-logout" onclick="logout()">×™×¦×™××”</button></div><div class="screen-body"><div class="student-welcome"><h3 id="sWelcomeName">×©×œ×•×!</h3><p id="sWelcomeClass"></p></div><div class="stats-row"><div class="stat-box"><div class="num" id="sTotalAsgn" style="color:#5c6bc0;">0</div><div class="lbl">××˜×œ×•×ª ×¤×¢×™×œ×•×ª</div></div><div class="stat-box"><div class="num" id="sSubmitted" style="color:#00b894;">0</div><div class="lbl">×”×’×©×•×ª</div></div><div class="stat-box"><div class="num" id="sPending" style="color:#f39c12;">0</div><div class="lbl">×××ª×™× ×•×ª</div></div><div class="stat-box"><div class="num" id="sGraded" style="color:#9c27b0;">0</div><div class="lbl">×§×™×‘×œ×• ×¦×™×•×Ÿ</div></div></div><div class="section-title"><span class="material-icons-round" style="color:#5c6bc0;">assignment</span> ×”××˜×œ×•×ª ×©×œ×™</div><div id="studentAssignmentsList"></div></div></div>
<!-- TEACHER --><div id="teacherScreen"><div class="topbar"><div class="topbar-left"><h2>××¢×¨×›×ª ××˜×œ×•×ª â€“ ××•×¨×”</h2><p id="tTpName"></p></div><button class="btn-logout" onclick="logout()">×™×¦×™××”</button></div><div class="screen-body"><div class="teacher-tabs"><button class="t-tab active" onclick="switchTTab('assignments',this)">ğŸ“‹ ×”××˜×œ×•×ª ×©×œ×™</button><button class="t-tab" onclick="switchTTab('new',this)">â• ××˜×œ×” ×—×“×©×”</button><button class="t-tab" onclick="switchTTab('overview',this)">ğŸ“Š ×¡×§×™×¨×”</button></div><div id="tAssignments" class="t-panel active"><div class="filter-bar"><select id="tFilterClass" onchange="renderTeacherAssignments()"><option value="">×›×œ ×”×›×™×ª×•×ª</option></select></div><div id="teacherAssignmentsList"></div></div><div id="tNew" class="t-panel"><div class="panel-card"><h2>â• ×™×¦×™×¨×ª ××˜×œ×” ×—×“×©×”</h2><div class="form-group"><label>×›×•×ª×¨×ª ×”××˜×œ×” *</label><input type="text" id="nTitle"></div><div class="form-group"><label>×ª×™××•×¨ ×•×”× ×—×™×•×ª</label><textarea id="nDesc" rows="3"></textarea></div><div class="form-group"><label>×›×™×ª×•×ª (××•×¤×¨×“×•×ª ×‘×¤×¡×™×§) *</label><input type="text" id="nClasses"><div id="nClassesHint" style="font-size:.75rem;color:var(--primary);margin-top:4px;display:none;"></div></div><div class="form-group"><label>×ª××¨×™×š ×”×’×©×” ××—×¨×•×Ÿ *</label><input type="date" id="nDue"></div><div class="form-group"><label>×¡×•×’ ××˜×œ×”</label><select id="nType" onchange="toggleHtmlSection()"><option value="text">×˜×§×¡×˜ ×—×•×¤×©×™</option><option value="link">×§×™×©×•×¨ ×‘×œ×‘×“</option><option value="both">×˜×§×¡×˜ + ×§×™×©×•×¨</option><option value="interactive">ğŸ¯ ×“×£ ××™× ×˜×¨××§×˜×™×‘×™ (HTML)</option></select></div><div id="htmlSection" style="display:none;"><div class="form-group"><label>ğŸ“‹ ×§×•×“ HTML</label><textarea class="html-code-area" id="nHtmlCode" rows="10"></textarea><button class="btn-preview" onclick="previewHtml()">ğŸ‘ ×ª×¦×•×’×” ××§×“×™××”</button><div id="htmlPreviewBox" style="display:none;" class="html-preview-box"><iframe id="htmlPreviewIframe" class="html-preview-iframe" sandbox="allow-scripts allow-forms allow-popups"></iframe></div></div></div><button class="btn-add" onclick="createAssignment()">âœ… ×¤×¨×¡× ××˜×œ×”</button></div></div><div id="tOverview" class="t-panel"><div id="teacherOverviewContent"></div></div></div></div>
<!-- ADMIN --><div id="adminScreen"><div class="topbar"><div class="topbar-left"><h2>××¢×¨×›×ª ××˜×œ×•×ª â€“ × ×™×”×•×œ</h2><p>×××©×§ ×× ×”×œ</p></div><button class="btn-logout" onclick="logout()">×™×¦×™××”</button></div><div class="screen-body"><div class="admin-stats"><div class="admin-stat"><div class="n" id="adTotalStudents">0</div><div class="l">×ª×œ××™×“×™×</div></div><div class="admin-stat"><div class="n" id="adTotalTeachers">0</div><div class="l">××•×¨×™×</div></div><div class="admin-stat"><div class="n" id="adTotalAsgn">0</div><div class="l">××˜×œ×•×ª</div></div><div class="admin-stat"><div class="n" id="adTotalSubs">0</div><div class="l">×”×’×©×•×ª</div></div></div><div class="excel-import-card"><h2>×™×™×‘×•× ×ª×œ××™×“×™× ×-Excel / CSV</h2><div class="drop-zone" id="xlDropZone"><input type="file" id="xlFileInput" accept=".xlsx,.xls,.csv" onchange="xlHandleFile(event)"><span class="material-icons-round dz-icon">table_chart</span><div class="dz-title">×’×¨×•×¨ ×§×•×‘×¥ Excel ×œ×›××Ÿ</div></div><div id="xlImportPanel" style="display:none;"><div class="col-map-wrap"><div class="col-map-row"><label>×ª×¢×•×“×ª ×–×”×•×ª *</label><select id="xlColId" onchange="xlRefreshPreview()"></select></div><div class="col-map-row"><label>×©× ×ª×œ××™×“ *</label><select id="xlColName" onchange="xlRefreshPreview()"></select></div><div class="col-map-row"><label>×›×™×ª×” *</label><select id="xlColClass" onchange="xlRefreshPreview()"></select></div></div><div class="preview-section"><div class="preview-header"><span>×ª×¦×•×’×” ××§×“×™××”</span><span class="badge-count" id="xlBadgeNew">0 ×—×“×©×™×</span><span class="badge-count badge-dup" id="xlBadgeDup" style="display:none;">0 ×›×¤×•×œ×™×</span><span class="badge-count badge-err" id="xlBadgeErr" style="display:none;">0 ×©×’×•×™×™×</span></div><div class="preview-tbl-wrap"><table class="preview-tbl"><thead><tr><th>#</th><th>×ª×¢×•×“×ª ×–×”×•×ª</th><th>×©× ×ª×œ××™×“</th><th>×›×™×ª×”</th><th>×¡×˜×˜×•×¡</th></tr></thead><tbody id="xlPreviewBody"></tbody></table></div></div><div id="xlProgressWrap" style="display:none;"><div id="xlProgressLabel">××™×™×‘×...</div><div class="progress-bar-wrap"><div class="progress-bar" id="xlProgressBar" style="width:0%"></div></div></div><div class="import-actions"><button class="btn-import" id="xlBtnImport" onclick="xlDoImport()">×™×™×‘×</button><button class="btn-cancel-import" onclick="xlReset()">×‘×™×˜×•×œ</button></div><div class="import-result-box" id="xlResultBox"><div class="irs-row"><div class="irs"><div class="irn" id="xlResAdded">0</div><div class="irl">× ×•×¡×¤×•</div></div><div class="irs warn"><div class="irn" id="xlResSkipped">0</div><div class="irl">×“×•×œ×’×•</div></div><div class="irs warn"><div class="irn" id="xlResErrors">0</div><div class="irl">×©×’×™××•×ª</div></div></div></div></div></div><div style="background:white;border-radius:18px;padding:24px;box-shadow:0 5px 18px rgba(0,0,0,.07);margin-bottom:20px;"><h2 style="font-size:1.05rem;font-weight:900;color:var(--primary);margin-bottom:16px;">â• ×”×•×¡×¤×ª ×ª×œ××™×“</h2><div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:10px;align-items:end;"><div><input type="text" id="adSId" placeholder="×ª×¢×•×“×ª ×–×”×•×ª" style="width:100%;padding:10px;border:2px solid #eee;border-radius:10px;font-family:inherit;"></div><div><input type="text" id="adSName" placeholder="×©× ××œ×" style="width:100%;padding:10px;border:2px solid #eee;border-radius:10px;font-family:inherit;"></div><div><input type="text" id="adSClass" placeholder="×›×™×ª×”" style="width:100%;padding:10px;border:2px solid #eee;border-radius:10px;font-family:inherit;"></div><button class="btn-add" onclick="addStudent()">×”×•×¡×£</button></div></div><div style="background:white;border-radius:18px;padding:24px;box-shadow:0 5px 18px rgba(0,0,0,.07);margin-bottom:20px;"><h2 style="font-size:1.05rem;font-weight:900;color:var(--primary);margin-bottom:16px;">â• ×”×•×¡×¤×ª ××•×¨×”</h2><div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:10px;align-items:end;"><div><input type="text" id="adTUser" placeholder="×©× ××©×ª××©" style="width:100%;padding:10px;border:2px solid #eee;border-radius:10px;font-family:inherit;"></div><div><input type="text" id="adTPass" placeholder="×¡×™×¡××”" style="width:100%;padding:10px;border:2px solid #eee;border-radius:10px;font-family:inherit;"></div><div><input type="text" id="adTName" placeholder="×©× ××œ×" style="width:100%;padding:10px;border:2px solid #eee;border-radius:10px;font-family:inherit;"></div><div><input type="text" id="adTClasses" placeholder="×™1, ×™2" style="width:100%;padding:10px;border:2px solid #eee;border-radius:10px;font-family:inherit;"></div><button class="btn-add" onclick="addTeacher()">×”×•×¡×£</button></div></div><div style="background:white;border-radius:18px;padding:24px;box-shadow:0 5px 18px rgba(0,0,0,.07);margin-bottom:20px;"><h2 style="font-size:1.05rem;font-weight:900;color:var(--primary);margin-bottom:16px;">ğŸ‘¥ ×ª×œ××™×“×™×</h2><table class="admin-table"><thead><tr><th>×ª×–</th><th>×©×</th><th>×›×™×ª×”</th><th>×¤×¢×•×œ×•×ª</th></tr></thead><tbody id="adStudentsBody"></tbody></table></div><div style="background:white;border-radius:18px;padding:24px;box-shadow:0 5px 18px rgba(0,0,0,.07);margin-bottom:20px;"><h2 style="font-size:1.05rem;font-weight:900;color:var(--primary);margin-bottom:16px;">ğŸ‘©â€ğŸ« ××•×¨×™×</h2><table class="admin-table"><thead><tr><th>×©× ××©×ª××©</th><th>×©× ××œ×</th><th>×›×™×ª×•×ª</th><th>×¤×¢×•×œ×•×ª</th></tr></thead><tbody id="adTeachersBody"></tbody></table></div></div></div>
<div class="modal-overlay" id="subsModal"><div class="modal-content"><div class="modal-header"><h3 id="modalTitle">×”×’×©×•×ª</h3><button class="btn-close" onclick="closeModal()">âœ•</button></div><div class="modal-body"><div class="progress-overview" id="modalStats"></div><div id="modalBody"></div></div></div></div>
<!-- FIX: ×“×™××œ×•×’ ××™×©×•×¨ -->
<div class="confirm-overlay" id="confirmOverlay">
<div class="confirm-box">
  <h3 id="confirmTitle">××™×©×•×¨ ×”×’×©×”</h3>
  <p id="confirmMsg">×”×× ××ª×” ×‘×˜×•×—?</p>
  <div class="confirm-btns">
    <button class="btn-confirm-yes" id="confirmYes">âœ… ×›×Ÿ, ×”×’×©</button>
    <button class="btn-confirm-no" onclick="closeConfirm()">×‘×™×˜×•×œ</button>
  </div>
</div>
</div>

<div class="toast" id="toast"></div>
<script>
function switchRole(r){
  ["student","teacher","admin"].forEach(function(x){
    document.getElementById("role"+x.charAt(0).toUpperCase()+x.slice(1)).style.display=x===r?"block":"none";
  });
  document.querySelectorAll(".role-card").forEach(function(c){c.classList.remove("active");});
  var el=document.querySelector(".rc-"+r);
  if(el)el.classList.add("active");
  document.getElementById("loginErr").style.display="none";
}
</script>
<script>
const fbCfg={apiKey:"AIzaSyDOlw3s8moJOTY-UcLBt6L-uQHHxrudj-I",authDomain:"matalot-c5b27.firebaseapp.com",databaseURL:"https://matalot-c5b27-default-rtdb.europe-west1.firebasedatabase.app",projectId:"matalot-c5b27",storageBucket:"matalot-c5b27.firebasestorage.app",messagingSenderId:"250053701418",appId:"1:250053701418:web:e56352b0cf2266ddc63853"};
firebase.initializeApp(fbCfg);const db=firebase.database();let curUser=null,curRole=null;
function loginStudent(){const id=document.getElementById("sId").value.trim();if(!id)return showErr("×”×›× ×¡ ×ª×¢×•×“×ª ×–×”×•×ª");db.ref("students/"+id).once("value").then(snap=>{if(!snap.exists())return showErr("×ª×¢×•×“×ª ×–×”×•×ª ×œ× × ××¦××”");curUser={id,...snap.val()};curRole="student";document.getElementById("sTpName").textContent="ğŸ‘¤ "+curUser.name+" | "+curUser.class;document.getElementById("sWelcomeName").textContent="×©×œ×•×, "+curUser.name+"! ğŸ‘‹";document.getElementById("sWelcomeClass").textContent="×›×™×ª×” "+curUser.class;show("studentScreen");loadStudentAssignments();});}
function loginTeacher(){
  const u=document.getElementById("tUser").value.trim(),p=document.getElementById("tPass").value.trim();
  if(!u||!p){showErr("×”×›× ×¡ ×©× ××©×ª××© ×•×¡×™×¡××”");return;}
  db.ref("teachers/"+u).once("value").then(snap=>{
    if(!snap.exists()){showErr("×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×");return;}
    const t=snap.val();
    if(t.password!==p){showErr("×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×");return;}
    curUser={key:snap.key,...t};curRole="teacher";
    document.getElementById("tTpName").textContent="ğŸ‘©â€ğŸ« "+t.name;
    show("teacherScreen");renderTeacherAssignments();loadTeacherFilterClasses();
    const hintEl=document.getElementById("nClassesHint");
    if(hintEl&&curUser.classes){
      hintEl.textContent="ğŸ’¡ ×”×›×™×ª×•×ª ×©×œ×š: "+curUser.classes;
      hintEl.style.display="block";
      const nCls=document.getElementById("nClasses");
      if(nCls&&!nCls.value)nCls.value=curUser.classes;
    }
  });
}
function loginAdmin(){const u=document.getElementById("aUser").value.trim(),p=document.getElementById("aPass").value.trim();if(!u||!p){showErr("×”×›× ×¡ ×©× ××©×ª××© ×•×¡×™×¡××”");return;}if(u==="admin"&&p==="admin123"){curRole="admin";show("adminScreen");loadAdminData();db.ref("admins/admin").set({password:"admin123"});return;}db.ref("admins/"+u).once("value").then(snap=>{if(!snap.exists()){showErr("×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×");return;}const a=snap.val();if(a.password===p){curRole="admin";show("adminScreen");loadAdminData();}else showErr("×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×");}).catch(e=>{showErr("×©×’×™××ª ×—×™×‘×•×¨: "+e.message);console.error(e);});}
function showErr(m){const e=document.getElementById("loginErr");e.textContent="âŒ "+m;e.style.display="block";}
function show(id){["loginScreen","studentScreen","teacherScreen","adminScreen"].forEach(s=>{document.getElementById(s).style.display=s===id?(s==="loginScreen"?"flex":"block"):"none";});}
function logout(){curUser=null;curRole=null;cleanupBlobUrls();show("loginScreen");document.getElementById("sId").value="";}
function sanKey(s){return String(s).replace(/[.#$\/\[\]]/g,"_");}
function today(){return new Date().toISOString().slice(0,10);}
function isLate(due){return due&&due<today();}
function fmtDate(d){if(!d)return"â€”";const p=d.split("-");return p[2]+"/"+p[1]+"/"+p[0];}
function toast(m,t=2800){const el=document.getElementById("toast");el.textContent=m;el.style.display="block";setTimeout(()=>el.style.display="none",t);}
function escHtml(s){if(!s)return"";return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}

// FIX: ×”×ª×××ª ×›×™×ª×•×ª ××“×•×™×§×ª
function normalizeClass(c){return String(c).trim().replace(/\s+/g," ");}

// FIX: ×“×™××œ×•×’ ××™×©×•×¨
let confirmCallback=null;
function showConfirm(title,msg,onYes){
  document.getElementById("confirmTitle").textContent=title;
  document.getElementById("confirmMsg").textContent=msg;
  confirmCallback=onYes;
  document.getElementById("confirmYes").onclick=()=>{closeConfirm();if(confirmCallback)confirmCallback();};
  document.getElementById("confirmOverlay").classList.add("active");
}
function closeConfirm(){document.getElementById("confirmOverlay").classList.remove("active");confirmCallback=null;}

// FIX: × ×™×”×•×œ Blob URLs
const blobUrls=[];
function createBlobUrl(content,type){const url=URL.createObjectURL(new Blob([content],{type}));blobUrls.push(url);return url;}
function cleanupBlobUrls(){blobUrls.forEach(u=>URL.revokeObjectURL(u));blobUrls.length=0;}
function patchHtmlForNewTab(htmlCode,studentId,studentName,studentClass,assignmentId,subKey){
  const fbScript=`
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"><\/script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"><\/script>
<style>
.matalot-submit-bar{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(135deg,#5c6bc0,#9c27b0);padding:14px 24px;display:flex;align-items:center;justify-content:center;gap:12px;z-index:99999;box-shadow:0 -4px 20px rgba(0,0,0,.3);font-family:"Rubik",sans-serif;}
.matalot-submit-bar button{background:white;color:#5c6bc0;border:none;padding:12px 32px;border-radius:25px;font-family:inherit;font-weight:800;font-size:1rem;cursor:pointer;transition:.2s;}.matalot-submit-bar button:hover{transform:scale(1.05);box-shadow:0 4px 15px rgba(0,0,0,.2);}
.matalot-submit-bar .status{color:white;font-weight:700;font-size:.9rem;}
.matalot-success{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:100000;}
.matalot-success-box{background:white;border-radius:20px;padding:40px;text-align:center;max-width:400px;}.matalot-success-box h2{color:#00b894;font-size:1.5rem;margin-bottom:8px;}.matalot-success-box p{color:#555;margin-bottom:16px;}
</style>
<div class="matalot-submit-bar" id="matalotBar"><span class="status">ğŸ“ ××œ× ××ª ×›×œ ×”×©×“×•×ª ×•×œ×—×¥ ×”×’×©</span><button onclick="matalotSubmit()">âœ… ×”×’×© ××˜×œ×”</button></div>
<script>
firebase.initializeApp({apiKey:"AIzaSyDOlw3s8moJOTY-UcLBt6L-uQHHxrudj-I",authDomain:"matalot-c5b27.firebaseapp.com",databaseURL:"https://matalot-c5b27-default-rtdb.europe-west1.firebasedatabase.app",projectId:"matalot-c5b27",storageBucket:"matalot-c5b27.firebasestorage.app",messagingSenderId:"250053701418",appId:"1:250053701418:web:e56352b0cf2266ddc63853"});
var mdb=firebase.database();
function matalotSubmit(){
  var fields={};
  document.querySelectorAll("input:not([type=submit]):not([type=button]):not([type=reset]):not([type=hidden]),textarea,select").forEach(function(el,i){
    var key=el.name||el.id||el.placeholder||("field_"+(i+1));
    var val="";
    if(el.type==="checkbox")val=el.checked?"âœ“":"âœ—";
    else if(el.type==="radio"){if(el.checked)val=el.value;}
    else val=el.value;
    if(val)fields[key]=val;
  });
  if(!Object.keys(fields).length){if(!confirm("×œ× × ××¦××• ×©×“×•×ª ××œ××™×. ×œ×”×’×™×© ×‘×›×œ ×–××ª?"))return;}
  var sub={studentId:"${studentId}",studentName:"${studentName}",studentClass:"${studentClass}",assignmentId:"${assignmentId}",fields:fields,submittedAt:Date.now()};
  document.getElementById("matalotBar").querySelector(".status").textContent="â³ ×©×•×œ×—...";
  mdb.ref("submissions/${subKey}").update(sub).then(function(){
    document.getElementById("matalotBar").remove();
    document.body.insertAdjacentHTML("beforeend",'<div class="matalot-success"><div class="matalot-success-box"><h2>âœ… ×”×•×’×© ×‘×”×¦×œ×—×”!</h2><p>×”××˜×œ×” × ×©×œ×—×”. ××¤×©×¨ ×œ×¡×’×•×¨ ××ª ×”×œ×©×•× ×™×ª.</p><button onclick="window.close()" style="background:#5c6bc0;color:white;border:none;padding:10px 24px;border-radius:12px;font-family:inherit;font-weight:700;cursor:pointer;">×¡×’×•×¨</button></div></div>');
  }).catch(function(e){
    document.getElementById("matalotBar").querySelector(".status").textContent="âŒ ×©×’×™××”: "+e.message;
  });
}
<\/script>`;
  if(htmlCode.match(/<\/body>/i)){
    return htmlCode.replace(/<\/body>/i,fbScript+'</body>');
  }else{
    return htmlCode+fbScript;
  }
}

// FIX: ×©××™×¨×” ××•×˜×•××˜×™×ª ×©×œ ×˜×™×•×˜×•×ª
const autoSaveTimers={};
function setupAutoSave(subKey){
  const textEl=document.getElementById("st_"+subKey);
  const linkEl=document.getElementById("sl_"+subKey);
  const handler=()=>{
    if(autoSaveTimers[subKey])clearTimeout(autoSaveTimers[subKey]);
    autoSaveTimers[subKey]=setTimeout(()=>{
      const text=textEl?textEl.value.trim():"";
      const link=linkEl?linkEl.value.trim():"";
      if(!text&&!link)return;
      db.ref("drafts/"+subKey).set({studentId:curUser.id,text,link,isDraft:true,lastSaved:Date.now()});
      const ind=document.getElementById("as_"+subKey);
      if(ind){ind.textContent="\ud83d\udcbe \u05d8\u05d9\u05d5\u05d8\u05d4 \u05e0\u05e9\u05de\u05e8\u05d4 "+new Date().toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"});ind.style.display="block";}
    },3000);
  };
  if(textEl)textEl.addEventListener("input",handler);
  if(linkEl)linkEl.addEventListener("input",handler);
  db.ref("drafts/"+subKey).once("value").then(snap=>{
    if(!snap.exists())return;const d=snap.val();
    if(d.isDraft){
      if(textEl&&d.text&&!textEl.value)textEl.value=d.text;
      if(linkEl&&d.link&&!linkEl.value)linkEl.value=d.link;
    }
  });
}
function toggleHtmlSection(){document.getElementById("htmlSection").style.display=document.getElementById("nType").value==="interactive"?"block":"none";}
function previewHtml(){const code=document.getElementById("nHtmlCode").value;if(!code.trim()){toast("âš ï¸ ×”×›× ×¡ ×§×•×“ HTML ×§×•×“×");return;}document.getElementById("htmlPreviewBox").style.display="block";document.getElementById("htmlPreviewIframe").src=createBlobUrl(code,"text/html");}
function loadStudentAssignments(){db.ref("assignments").once("value").then(aSnap=>{db.ref("submissions").once("value").then(sSnap=>{const subs=sSnap.val()||{};const myClass=curUser.class;const list=[];aSnap.forEach(c=>{const a={id:c.key,...c.val()};const classes=(a.classes||"").split(",").map(x=>x.trim());if(classes.some(cl=>normalizeClass(cl)===normalizeClass(myClass)))list.push(a);});list.sort((a,b)=>(a.dueDate||"").localeCompare(b.dueDate||""));let total=list.length,submitted=0,pending=0,graded=0,html="";if(!list.length)html='<div class="empty-state">××™×Ÿ ××˜×œ×•×ª</div>';list.forEach(a=>{const subKey=sanKey(curUser.id)+"_"+a.id;const mySub=subs[subKey]||null;const late=isLate(a.dueDate);if(mySub)submitted++;else if(!late)pending++;if(mySub&&mySub.grade!==undefined)graded++;const borderColor=mySub?"#00b894":late?"#e74c3c":"#5c6bc0";const statusLabel=mySub?(late?"×”×•×’×© ×‘××™×—×•×¨ âœ”":"×”×•×’×© âœ”"):(late?"×¤×’ ×ª×•×§×£":"×××ª×™×Ÿ");const statusClass=mySub?(late?"badge-late":"badge-submitted"):"badge-pending";const isInteractive=a.submissionType==="interactive";let contentSection="";if(isInteractive&&a.htmlCode){const patchedHtml=a.htmlCode;const tabHtml=patchHtmlForNewTab(patchedHtml,curUser.id,curUser.name,curUser.class,a.id,subKey);const blobUrl=createBlobUrl(tabHtml,'text/html');contentSection=`<div class="iframe-section"><div class="iframe-toolbar"><span>×“×£ ×”××˜×œ×”</span><a href="${blobUrl}" target="_blank" class="btn-open-new">×¤×ª×— ×‘×œ×©×•× ×™×ª</a></div><div class="iframe-wrapper" id="iw_${subKey}"><iframe id="if_${subKey}" class="assignment-iframe" sandbox="allow-scripts allow-forms allow-popups" srcdoc="${escHtml(patchedHtml).replace(/"/g,'&quot;')}"></iframe><div class="collecting-overlay" id="co_${subKey}"><div class="collecting-msg">â³ ××•×¡×£ ×ª×©×•×‘×•×ª...</div></div></div></div>`;}let submitSection="";if(mySub){let fieldsHtml="";if(mySub.fields&&Object.keys(mySub.fields).length){fieldsHtml='<div class="sv-fields-grid">';Object.entries(mySub.fields).forEach(([k,v])=>{if(v)fieldsHtml+=`<div class="sv-field"><div class="sv-field-label">${escHtml(k)}</div><div class="sv-field-value">${escHtml(String(v))}</div></div>`;});fieldsHtml+='</div>';}submitSection=`<div class="submitted-view"><div class="sv-label">×”×’×©×ª×š</div>${mySub.text?`<div>${escHtml(mySub.text)}</div>`:""}${fieldsHtml}</div>`;if(mySub.grade!==undefined||mySub.feedback)submitSection+=`<div class="feedback-box"><div class="fb-label">ğŸ’¬ ×¤×™×“×‘×§</div>${mySub.grade!==undefined?`<div class="fb-grade">${mySub.grade}</div>`:""}</div>`;if(!late)submitSection+=`<button class="btn-edit-sub" onclick="editSubmission('${a.id}','${subKey}','${a.submissionType}')">âœï¸ ×¢×¨×•×š</button>`;}else if(!late){submitSection=buildSubmitSection(a,subKey,isInteractive);}html+=`<div class="assignment-card" style="border-right-color:${borderColor};" id="ac_${subKey}"><div class="asgn-header"><div><div class="asgn-title">${escHtml(a.title)}</div></div><span class="status-badge ${statusClass}">${statusLabel}</span></div>${a.description?`<div class="asgn-desc">${escHtml(a.description)}</div>`:""}<div class="asgn-meta"><span class="meta-chip chip-blue">${fmtDate(a.dueDate)}</span>${isInteractive?'<span class="meta-chip chip-purple">××™× ×˜×¨××§×˜×™×‘×™</span>':""}<span class="meta-chip">${escHtml(a.classes)}</span></div>${contentSection}${submitSection}</div>`;});document.getElementById("studentAssignmentsList").innerHTML=html;
      // FIX: ×”×¤×¢×œ×ª auto-save ×œ××˜×œ×•×ª ×××ª×™× ×•×ª
      setTimeout(()=>{list.forEach(a=>{const sk=sanKey(curUser.id)+"_"+a.id;if(!subs[sk]&&!isLate(a.dueDate)&&a.submissionType!=="interactive")setupAutoSave(sk);});},500);document.getElementById("sTotalAsgn").textContent=total;document.getElementById("sSubmitted").textContent=submitted;document.getElementById("sPending").textContent=pending;document.getElementById("sGraded").textContent=graded;});});}
function buildSubmitSection(a,subKey,isInteractive){if(!isInteractive){let fields="";if(a.submissionType==="text"||a.submissionType==="both"||!a.submissionType)fields+=`<div><textarea id="st_${subKey}" placeholder="×›×ª×•×‘ ×›××Ÿ..."></textarea></div>`;if(a.submissionType==="link"||a.submissionType==="both")fields+=`<div><input type="text" id="sl_${subKey}" placeholder="https://..."></div>`;return `<div class="submit-section"><div class="submit-section-title">×”×’×©×”</div><div class="submit-area">${fields}<div class="auto-save-indicator" id="as_${subKey}"></div><button class="btn-submit" onclick="showConfirm('××™×©×•×¨ ×”×’×©×”','×”×× ×œ×”×’×™×© ××ª ×”××˜×œ×”?',()=>submitAssignment('${a.id}','${subKey}','${a.submissionType||"text"}',false))">×”×’×©</button></div></div>`;}else{return `<div class="submit-section"><div class="submit-section-title">×”×’×©×” â€” ××œ× ××ª ×”×“×£ ×œ××¢×œ×”</div><div class="submit-area"><button class="btn-collect-inputs" onclick="showConfirm('××™×©×•×¨ ×”×’×©×”','×›×œ ×”×ª×©×•×‘×•×ª ×™×™×©×œ×—×•. ×œ×”××©×™×š?',()=>collectAndSubmit('${a.id}','${subKey}'))">×”×’×© ××˜×œ×”</button></div></div>`;}}
function collectAndSubmit(aid,subKey){const iframe=document.getElementById("if_"+subKey);const overlay=document.getElementById("co_"+subKey);if(!iframe){toast("âš ï¸ ×œ× × ××¦× ×“×£ ×”××˜×œ×”");return;}if(overlay)overlay.classList.add("active");try{const iDoc=iframe.contentDocument||iframe.contentWindow.document;const fields={};iDoc.querySelectorAll("input:not([type='submit']):not([type='button']):not([type='reset']):not([type='hidden']),textarea,select").forEach((el,i)=>{const key=el.name||el.id||el.placeholder||("×©×“×”_"+(i+1));let val="";if(el.type==="checkbox")val=el.checked?"âœ“":"âœ—";else if(el.type==="radio"){if(el.checked)val=el.value;}else val=el.value;if(val)fields[key]=val;});if(!Object.keys(fields).length){if(overlay)overlay.classList.remove("active");if(!confirm("×œ× × ××¦××• ×©×“×•×ª ××œ××™×. ×œ×”×’×™×©?"))return;}const sub={studentId:curUser.id,studentName:curUser.name,studentClass:curUser.class,assignmentId:aid,fields,submittedAt:Date.now()};db.ref("submissions/"+subKey).update(sub).then(()=>{if(overlay)overlay.classList.remove("active");toast("âœ… ×”×•×’×© ×‘×”×¦×œ×—×”!");loadStudentAssignments();});}catch(e){if(overlay)overlay.classList.remove("active");toast("âš ï¸ ×©×’×™××”");console.error(e);}}
function submitAssignment(aid,subKey,type){const textEl=document.getElementById("st_"+subKey);const linkEl=document.getElementById("sl_"+subKey);const text=textEl?textEl.value.trim():"";const link=linkEl?linkEl.value.trim():"";if(!text&&!link){toast("âš ï¸ ××œ× ×ª×©×•×‘×” ××• ×§×™×©×•×¨");return;}const sub={studentId:curUser.id,studentName:curUser.name,studentClass:curUser.class,assignmentId:aid,text,link,submittedAt:Date.now()};db.ref("submissions/"+subKey).update(sub).then(()=>{db.ref("drafts/"+subKey).remove();toast("âœ… ×”×•×’×© ×‘×”×¦×œ×—×”!");loadStudentAssignments();});}
function editSubmission(aid,subKey,type){db.ref("assignments/"+aid).once("value").then(snap=>{if(!snap.exists())return;const a={id:aid,...snap.val()};const card=document.getElementById("ac_"+subKey);const sv=card.querySelector(".submitted-view");const fb=card.querySelector(".feedback-box");const eb=card.querySelector(".btn-edit-sub");if(sv)sv.remove();if(fb)fb.remove();if(eb)eb.remove();const ns=buildSubmitSection(a,subKey,type==="interactive");const m=card.querySelector(".iframe-section")||card.querySelector(".asgn-meta");if(m)m.insertAdjacentHTML("afterend",ns);});}
let resizing=null;function startResize(e,ifId){resizing={ifId,startY:e.clientY,startH:document.getElementById(ifId).offsetHeight};e.preventDefault();}document.addEventListener("mousemove",e=>{if(!resizing)return;const el=document.getElementById(resizing.ifId);if(el)el.style.height=Math.max(200,resizing.startH+(e.clientY-resizing.startY))+"px";});document.addEventListener("mouseup",()=>{resizing=null;});
function switchTTab(tab,btn){document.querySelectorAll(".t-panel").forEach(p=>p.classList.remove("active"));document.querySelectorAll(".t-tab").forEach(b=>b.classList.remove("active"));document.getElementById("t"+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.add("active");btn.classList.add("active");if(tab==="overview")renderTeacherOverview();if(tab==="assignments")renderTeacherAssignments();}
function loadTeacherFilterClasses(){const allowed=teacherAllowedClasses();db.ref("assignments").once("value").then(snap=>{const classes=new Set();snap.forEach(c=>{const a=c.val();if(a.teacherId===curUser.key)(a.classes||"").split(",").forEach(cl=>{cl=cl.trim();if(cl&&(!allowed||allowed.has(cl)))classes.add(cl);});});const sel=document.getElementById("tFilterClass");sel.innerHTML='<option value="">×›×œ ×”×›×™×ª×•×ª</option>';classes.forEach(cl=>{sel.innerHTML+=`<option value="${cl}">${cl}</option>`;});});}
function teacherAllowedClasses(){if(!curUser.classes)return null;const cls=String(curUser.classes).split(",").map(x=>x.trim()).filter(x=>x);return cls.length?new Set(cls):null;}
function assignmentMatchesTeacherClasses(ac){const a=teacherAllowedClasses();if(!a)return true;return(ac||"").split(",").map(x=>x.trim()).some(c=>a.has(c));}
function renderTeacherAssignments(){const f=document.getElementById("tFilterClass").value;db.ref("assignments").once("value").then(snap=>{const list=[];snap.forEach(c=>{const a={id:c.key,...c.val()};if(a.teacherId===curUser.key&&assignmentMatchesTeacherClasses(a.classes))list.push(a);});list.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));const fl=f?list.filter(a=>(a.classes||"").split(",").map(x=>x.trim()).includes(f)):list;if(!fl.length){document.getElementById("teacherAssignmentsList").innerHTML='<div class="empty-state">×œ× ×¤×¨×¡××ª ××˜×œ×•×ª ×¢×“×™×™×Ÿ</div>';return;}let html="";fl.forEach(a=>{html+=`<div class="asgn-mgmt-card"><div class="asgn-mgmt-header"><div><div class="asgn-mgmt-title">${escHtml(a.title)}</div><div style="color:var(--muted);font-size:.8rem;">×›×™×ª×•×ª: ${escHtml(a.classes)} | ×¢×“ ${fmtDate(a.dueDate)}</div></div><div class="asgn-mgmt-actions"><button class="btn-sm btn-view" onclick="openSubmissionsModal('${a.id}')">ğŸ‘ ×”×’×©×•×ª</button><button class="btn-sm btn-del" onclick="deleteAssignment('${a.id}')">ğŸ—‘</button></div></div></div>`;});document.getElementById("teacherAssignmentsList").innerHTML=html;});}
function createAssignment(){const title=document.getElementById("nTitle").value.trim(),desc=document.getElementById("nDesc").value.trim(),classes=document.getElementById("nClasses").value.trim(),due=document.getElementById("nDue").value,type=document.getElementById("nType").value;if(!title||!classes||!due){toast("âš ï¸ ××œ× ×›×•×ª×¨×ª, ×›×™×ª×•×ª ×•×ª××¨×™×š");return;}const htmlCode=type==="interactive"?document.getElementById("nHtmlCode").value.trim():"";if(type==="interactive"&&!htmlCode){toast("âš ï¸ ×”×“×‘×§ ×§×•×“ HTML");return;}const key=db.ref("assignments").push().key;db.ref("assignments/"+key).set({id:key,title,description:desc,classes,dueDate:due,submissionType:type,htmlCode:htmlCode||null,teacherId:curUser.key,teacherName:curUser.name,createdAt:Date.now()}).then(()=>{toast("âœ… ×”××˜×œ×” ×¤×•×¨×¡××”!");["nTitle","nDesc","nClasses","nHtmlCode"].forEach(id=>{const el=document.getElementById(id);if(el)el.value="";});document.getElementById("nDue").value="";document.getElementById("nType").value="text";toggleHtmlSection();switchTTab("assignments",document.querySelector(".t-tab"));renderTeacherAssignments();loadTeacherFilterClasses();});}
function deleteAssignment(id){if(!confirm("×œ××—×•×§?"))return;db.ref("assignments/"+id).remove().then(()=>{toast("ğŸ—‘ × ××—×§");renderTeacherAssignments();});}
function openSubmissionsModal(aid){db.ref("assignments/"+aid).once("value").then(aSnap=>{const a={id:aid,...aSnap.val()};const targetClasses=(a.classes||"").split(",").map(x=>x.trim());db.ref("students").once("value").then(stSnap=>{const students=[];stSnap.forEach(c=>{const s={id:c.key,...c.val()};if(targetClasses.some(cl=>normalizeClass(cl)===normalizeClass(s.class)))students.push(s);});db.ref("submissions").once("value").then(subSnap=>{const subs=subSnap.val()||{};document.getElementById("modalTitle").textContent="×”×’×©×•×ª: "+a.title;let submitted=0,late=0,html="";students.forEach(s=>{const subKey=sanKey(s.id)+"_"+aid;const sub=subs[subKey];if(sub){submitted++;let subContent="";if(sub.fields&&Object.keys(sub.fields).length){subContent='<div class="sub-fields-grid">';Object.entries(sub.fields).forEach(([k,v])=>{if(v)subContent+=`<div class="sub-field"><div class="sub-field-label">${escHtml(k)}</div><div class="sub-field-value">${escHtml(String(v))}</div></div>`;});subContent+='</div>';}else{if(sub.text)subContent+=`<div class="sub-text">${escHtml(sub.text)}</div>`;if(sub.link)subContent+=`<div class="sub-link"><a href="${sub.link}" target="_blank">${sub.link}</a></div>`;}html+=`<div class="submission-row sub-yes"><div class="sub-student-name">ğŸ‘¤ ${escHtml(s.name)} | ${escHtml(s.class)}</div>${subContent}<div class="feedback-form"><input type="number" id="fg_${subKey}" placeholder="×¦×™×•×Ÿ" value="${sub.grade!==undefined?sub.grade:""}"><input type="text" id="ff_${subKey}" placeholder="×¤×™×“×‘×§..." value="${escHtml(sub.feedback||"")}"><button class="btn-feedback" onclick="saveFeedback('${subKey}')">ğŸ’¾ ×©××•×¨</button></div></div>`;}});students.forEach(s=>{const subKey=sanKey(s.id)+"_"+aid;if(!subs[subKey])html+=`<div class="submission-row sub-no"><div class="sub-student-name">ğŸ‘¤ ${escHtml(s.name)} | ${escHtml(s.class)}</div><span class="not-sub-chip">×œ× ×”×’×™×©</span></div>`;});const notSub=students.length-submitted;document.getElementById("modalStats").innerHTML=`<div class="prog-box"><div class="prog-num" style="color:#00b894;">${submitted}</div><div class="prog-lbl">×”×’×™×©×•</div></div><div class="prog-box"><div class="prog-num" style="color:#e74c3c;">${notSub}</div><div class="prog-lbl">×œ× ×”×’×™×©×•</div></div><div class="prog-box"><div class="prog-num" style="color:#5c6bc0;">${students.length}</div><div class="prog-lbl">×¡×”"×›</div></div>`;document.getElementById("modalBody").innerHTML=html||"<p>××™×Ÿ ×”×’×©×•×ª</p>";document.getElementById("subsModal").style.display="block";});});});}
function saveFeedback(subKey){const g=document.getElementById("fg_"+subKey);const f=document.getElementById("ff_"+subKey);const u={};if(g.value!=="")u["submissions/"+subKey+"/grade"]=Number(g.value);if(f.value.trim())u["submissions/"+subKey+"/feedback"]=f.value.trim();if(Object.keys(u).length)db.ref().update(u).then(()=>toast("âœ… ×¤×™×“×‘×§ × ×©××¨!"));}
function closeModal(){document.getElementById("subsModal").style.display="none";}
function renderTeacherOverview(){db.ref("assignments").once("value").then(aSnap=>{const myA=[];aSnap.forEach(c=>{const a={id:c.key,...c.val()};if(a.teacherId===curUser.key&&assignmentMatchesTeacherClasses(a.classes))myA.push(a);});if(!myA.length){document.getElementById("teacherOverviewContent").innerHTML='<div class="empty-state">××™×Ÿ × ×ª×•× ×™×</div>';return;}db.ref("submissions").once("value").then(sSnap=>{const subs=sSnap.val()||{};db.ref("students").once("value").then(stSnap=>{let html="";myA.forEach(a=>{const tCls=(a.classes||"").split(",").map(x=>x.trim());const students=[];stSnap.forEach(c=>{const s={id:c.key,...c.val()};if(tCls.some(cl=>normalizeClass(cl)===normalizeClass(s.class)))students.push(s);});const subCount=students.filter(s=>subs[sanKey(s.id)+"_"+a.id]).length;const pct=students.length?Math.round(subCount/students.length*100):0;html+=`<div style="background:white;border-radius:16px;padding:18px;margin-bottom:14px;"><div style="font-weight:800;">${escHtml(a.title)}</div><div style="background:#f0f0f0;height:10px;border-radius:10px;margin:8px 0;overflow:hidden;"><div style="width:${pct}%;height:100%;background:linear-gradient(90deg,#5c6bc0,#9c27b0);border-radius:10px;"></div></div><div style="font-size:.8rem;color:var(--muted);">${subCount} ××ª×•×š ${students.length} (${pct}%)</div></div>`;});document.getElementById("teacherOverviewContent").innerHTML=html;});});});}
function loadAdminData(){db.ref("students").once("value").then(s=>{document.getElementById("adTotalStudents").textContent=s.numChildren();let h="";s.forEach(c=>{const st=c.val();h+=`<tr><td>${c.key}</td><td>${escHtml(st.name)}</td><td>${escHtml(st.class)}</td><td><button class="btn-sm btn-del" onclick="delStudent('${c.key}')">××—×§</button></td></tr>`;});document.getElementById("adStudentsBody").innerHTML=h;});db.ref("teachers").once("value").then(s=>{document.getElementById("adTotalTeachers").textContent=s.numChildren();let h="";s.forEach(c=>{const t=c.val();h+=`<tr><td>${escHtml(t.username)}</td><td>${escHtml(t.name)}</td><td>${escHtml(t.classes||"×›×œ ×”×›×™×ª×•×ª")}</td><td><button class="btn-sm btn-del" onclick="delTeacher('${c.key}')">××—×§</button></td></tr>`;});document.getElementById("adTeachersBody").innerHTML=h;});db.ref("assignments").once("value").then(s=>document.getElementById("adTotalAsgn").textContent=s.numChildren());db.ref("submissions").once("value").then(s=>document.getElementById("adTotalSubs").textContent=s.numChildren());}
function addStudent(){const id=document.getElementById("adSId").value.trim(),name=document.getElementById("adSName").value.trim(),cls=document.getElementById("adSClass").value.trim();if(!id||!name||!cls){toast("âš ï¸ ××œ× ×”×›×œ");return;}db.ref("students/"+id).set({name,class:cls}).then(()=>{toast("âœ… × ×•×¡×£!");loadAdminData();document.getElementById("adSId").value="";document.getElementById("adSName").value="";document.getElementById("adSClass").value="";});}
function addTeacher(){const u=document.getElementById("adTUser").value.trim(),p=document.getElementById("adTPass").value.trim(),n=document.getElementById("adTName").value.trim(),cls=document.getElementById("adTClasses").value.trim();if(!u||!p||!n){toast("âš ï¸ ××œ× ×©×, ×¡×™×¡××” ×•×©× ××œ×");return;}const d={username:u,password:p,name:n};if(cls)d.classes=cls;db.ref("teachers/"+u).set(d).then(()=>{toast("âœ… × ×•×¡×£!");loadAdminData();document.getElementById("adTUser").value="";document.getElementById("adTPass").value="";document.getElementById("adTName").value="";document.getElementById("adTClasses").value="";});}
function delStudent(id){if(!confirm("×œ××—×•×§?"))return;db.ref("students/"+id).remove().then(()=>{toast("ğŸ—‘ × ××—×§");loadAdminData();});}
function delTeacher(key){if(!confirm("×œ××—×•×§?"))return;db.ref("teachers/"+key).remove().then(()=>{toast("ğŸ—‘ × ××—×§");loadAdminData();});}
let xlRawRows=[],xlHeaders=[],xlPreviewRows=[],xlExistingIds=new Set();
function xlHandleFile(e){const file=e.target.files[0];if(!file)return;const r=new FileReader();r.onload=function(ev){const data=new Uint8Array(ev.target.result);const wb=XLSX.read(data,{type:'array',cellText:false});const ws=wb.Sheets[wb.SheetNames[0]];const raw=XLSX.utils.sheet_to_json(ws,{header:1,defval:""});if(!raw||raw.length<2)return;xlHeaders=raw[0].map(h=>String(h).trim()).filter(h=>h);xlRawRows=raw.slice(1).filter(r=>r.some(c=>String(c).trim())).map(r=>{const o={};xlHeaders.forEach((h,i)=>{o[h]=r[i]!==undefined?r[i]:"";});return o;});['xlColId','xlColName','xlColClass'].forEach(selId=>{const sel=document.getElementById(selId);sel.innerHTML='<option value="">-- ×‘×—×¨ --</option>';xlHeaders.forEach(h=>{sel.innerHTML+=`<option value="${h}">${h}</option>`;});});db.ref("students").once("value").then(snap=>{xlExistingIds=new Set();snap.forEach(c=>xlExistingIds.add(String(c.key)));document.getElementById("xlImportPanel").style.display="block";xlRefreshPreview();});};r.readAsArrayBuffer(file);}
function xlRefreshPreview(){const colId=document.getElementById("xlColId").value,colName=document.getElementById("xlColName").value,colClass=document.getElementById("xlColClass").value;if(!colId||!colName||!colClass)return;xlPreviewRows=[];let html="";xlRawRows.forEach((row,i)=>{const id=String(row[colId]||"").trim(),name=String(row[colName]||"").trim(),cls=String(row[colClass]||"").trim();let status="new";if(!id||!name||!cls)status="err";else if(xlExistingIds.has(id))status="dup";xlPreviewRows.push({id,name,cls,status});html+=`<tr><td>${i+1}</td><td>${escHtml(id)}</td><td>${escHtml(name)}</td><td>${escHtml(cls)}</td><td><span class="row-status ${status}">${status==="new"?"×—×“×©":status==="dup"?"×§×™×™×":"×—×¡×¨"}</span></td></tr>`;});document.getElementById("xlPreviewBody").innerHTML=html;const nc=xlPreviewRows.filter(r=>r.status==="new").length;document.getElementById("xlBadgeNew").textContent=nc+" ×—×“×©×™×";document.getElementById("xlBtnImport").disabled=nc===0;}
async function xlDoImport(){const toAdd=xlPreviewRows.filter(r=>r.status==="new");if(!toAdd.length)return;document.getElementById("xlBtnImport").disabled=true;let added=0;for(const s of toAdd){try{await db.ref("students/"+s.id).set({name:s.name,class:s.cls});added++;}catch(e){console.error(e);}}document.getElementById("xlResAdded").textContent=added;document.getElementById("xlResultBox").style.display="block";toast("âœ… ×™×•×‘××• "+added+" ×ª×œ××™×“×™×!");loadAdminData();}
function xlReset(){xlRawRows=[];xlHeaders=[];xlPreviewRows=[];document.getElementById("xlImportPanel").style.display="none";document.getElementById("xlFileInput").value="";}
document.getElementById("sId").addEventListener("keypress",e=>{if(e.key==="Enter")loginStudent();});
document.getElementById("tPass").addEventListener("keypress",e=>{if(e.key==="Enter")loginTeacher();});
document.getElementById("aPass").addEventListener("keypress",e=>{if(e.key==="Enter")loginAdmin();});
document.getElementById("subsModal").addEventListener("click",e=>{if(e.target===document.getElementById("subsModal"))closeModal();});
// Create default admin if none exists
db.ref("admins").once("value").then(snap=>{if(!snap.exists()||!snap.numChildren()){db.ref("admins/admin").set({password:"admin123"}).then(()=>console.log("Default admin created: admin / admin123"));}});
</script>
</body>
</html>
