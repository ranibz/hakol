<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>××¢×¨×›×ª ×—×™×¨×•× ×•× ×•×›×—×•×ª - ×‘×™×ª ×—×™× ×•×š ×’×œ×™×œ ××¢×¨×‘×™</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --success: #27ae60;
            --danger: #c0392b;
            --warning: #f39c12;
            --bg: #ecf0f1;
            --white: #ffffff;
        }
        
        * { box-sizing: border-box; font-family: 'Rubik', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background-color: var(--bg); color: #333; }
        
        .header { background: var(--primary); color: var(--white); padding: 15px 20px; display: flex; justify-content: center; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .header-titles { display: flex; flex-direction: column; align-items: center; text-align: center; }
        .header h1 { margin: 0; font-size: 1.4rem; font-weight: 900; }
        .header-credit { font-size: 1.05rem; font-weight: 700; color: #00cec9; margin-top: 5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        
        #userInfo { position: absolute; left: 15px; display: flex; align-items: center; gap: 10px; }
        .btn-logout { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-logout:hover { background: rgba(255,255,255,0.35); }

        @media (max-width: 600px) {
            .header h1 { font-size: 1.15rem; }
            .header-credit { font-size: 0.9rem; }
            #userName { display: none; }
            #userInfo { left: 10px; }
        }

        .container { padding: 20px; max-width: 800px; margin: 0 auto; }
        
        .screen { display: none; animation: fadeIn 0.3s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .login-box { background: var(--white); padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-top: 50px; }
        .role-btn { width: 100%; padding: 18px; margin: 10px 0; border: none; border-radius: 10px; font-size: 1.2rem; font-weight: 700; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; transition: transform 0.2s; }
        .role-btn:active { transform: scale(0.98); }
        .btn-teacher { background: #3498db; }
        .btn-admin { background: #9b59b6; }
        .role-note { font-size: 0.9rem; color: #7f8c8d; margin: 0 0 10px 0; text-align: right; padding: 0 5px; line-height: 1.5; }

        .class-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 15px; }
        .class-card { background: var(--white); padding: 25px 10px; border-radius: 12px; text-align: center; cursor: pointer; font-weight: 900; font-size: 1.4rem; box-shadow: 0 3px 6px rgba(0,0,0,0.05); transition: 0.2s; color: var(--primary); border: 2px solid transparent; border-right-width: 8px;}
        .class-card:hover, .class-card:active { background: #f8f9fa; transform: translateY(-3px); }

        .student-row { display: flex; justify-content: space-between; align-items: center; background: var(--white); padding: 15px; border-radius: 10px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); border-right: 5px solid #bdc3c7; transition: background 0.3s; cursor: pointer; }
        .student-row.present { border-right-color: var(--success); background: #e8f8f5; }
        .student-info { display: flex; flex-direction: column; gap: 4px;}
        .student-name { font-weight: 700; font-size: 1.15rem; }
        .student-class { font-size: 0.85rem; color: #7f8c8d; }
        
        .btn-mark { padding: 12px 25px; border: none; border-radius: 25px; font-weight: 700; cursor: pointer; font-size: 1rem; transition: 0.3s; min-width: 120px; }
        .btn-mark.missing { background: #f0f3f4; color: #7f8c8d; border: 1px solid #bdc3c7; }
        .btn-mark.present { background: var(--success); color: white; box-shadow: 0 4px 15px rgba(39,174,96,0.4); }

        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat-box { background: white; padding: 15px 10px; border-radius: 12px; text-align: center; box-shadow: 0 3px 10px rgba(0,0,0,0.05); }
        .stat-num { font-size: 2.2rem; font-weight: 900; margin-bottom: 5px; }
        
        .admin-class-group { margin-bottom: 10px; }
        .admin-class-header { background: white; padding: 18px 20px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-right: 8px solid; transition: background 0.2s;}
        .admin-class-header:active { background: #f0f3f4; }
        .admin-class-body { display: none; padding: 15px 5px 5px 5px; animation: fadeIn 0.3s ease; }
        .admin-class-body.active { display: block; }
        
        .status-light { display: flex; align-items: center; gap: 8px; font-weight: bold; font-size: 1rem; background: #f8f9fa; padding: 5px 12px; border-radius: 20px;}
        .light-red { color: var(--danger); border: 1px solid #f2d7d5; }
        .light-green { color: var(--success); border: 1px solid #d4efdf; }
        .dot { height: 14px; width: 14px; border-radius: 50%; display: inline-block; }
        .dot.red { background-color: var(--danger); animation: pulseRed 1.2s infinite; }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.7); } 70% { box-shadow: 0 0 0 8px rgba(192, 57, 43, 0); } 100% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0); } }

        .admin-student-row { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-right: 5px solid var(--danger); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);}
        .admin-student-row.handled { border-right-color: var(--warning); opacity: 0.6; background: #fdfefe; }
        select.status-select { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; font-family: inherit; font-size: 0.95rem; background: #f9f9f9; font-weight: 600; width: 100%; max-width: 250px; }
        .status-select.handled { background: #fef9e7; color: #b9770e; border-color: #f1c40f; }

        .admin-actions { display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; }
        .btn-reset { background: var(--danger); color: white; border: none; padding: 12px 10px; border-radius: 10px; cursor: pointer; font-weight: bold; flex: 1; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s;}
        .btn-demo-scenario { background: #e67e22; color: white; border: none; padding: 12px 10px; border-radius: 10px; cursor: pointer; font-weight: bold; flex: 1; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s;}
        .btn-reset:hover, .btn-demo-scenario:hover, .btn-export:hover { transform: scale(0.98); }
        .btn-export { background: #2980b9; color: white; border: none; padding: 12px 10px; border-radius: 10px; cursor: pointer; font-weight: bold; flex: 1; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s;}

        .phone-link { color: #2980b9; text-decoration: none; font-weight: bold; background: #eaf2f8; padding: 5px 10px; border-radius: 5px; font-size: 1rem; display: inline-block;}
        .phone-link:hover { background: #3498db; color: white;}
        .btn-back { background: none; border: none; color: #3498db; font-weight: bold; font-size: 1.1rem; cursor: pointer; margin-bottom: 20px; display: flex; align-items: center; padding: 0; }
        
        .toggle-excel-btn { display: inline-block; margin-top: 25px; font-size: 0.9rem; color: #7f8c8d; text-decoration: underline; cursor: pointer; }
        .excel-upload-zone { display: none; margin-top: 15px; padding: 20px; background: #f8f9fa; border: 2px dashed #bdc3c7; border-radius: 10px; text-align: center; }
        .excel-upload-zone input[type="file"] { display: none; }
        .btn-excel { background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; display: inline-flex; align-items: center; gap: 8px; }

        .class-attendance-info { font-size: 0.85rem; font-weight: 500; color: #7f8c8d; margin-top: 4px; }
        .search-badge { background: #c0392b; color: white; font-size: 0.75rem; padding: 2px 8px; border-radius: 10px; margin-right: 5px; }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-titles">
            <h1>ğŸš¨ ×—×™×¨×•× - ×‘×™×ª ×—×™× ×•×š ×’×œ×™×œ ××¢×¨×‘×™</h1>
            <span class="header-credit">×¤×™×ª×•×— ××¤×œ×™×§×¦×™×” - ×¨× ×™ ×‘×Ÿ ×–××‘</span>
        </div>
        <div id="userInfo" style="display:none;">
            <span id="userName" style="font-size:0.95rem; font-weight: 500;"></span>
            <button class="btn-logout" onclick="logout()">×™×¦×™××”</button>
        </div>
    </div>

    <div class="container">
        
        <div id="screen-login" class="screen active">
            <div class="login-box">
                <span class="material-icons-round" style="font-size: 60px; color: var(--danger); margin-bottom: 15px;">campaign</span>
                <h2 style="margin-top: 0; font-size: 1.8rem; color: var(--primary);">××¢×¨×›×ª ×“×™×•×•×— × ×•×›×—×•×ª</h2>
                <p style="color: #7f8c8d; margin-bottom: 30px; font-size: 1.1rem;">×‘×—×¨ ××ª ×ª×¤×§×™×“×š ×‘×›×•×—:</p>
                
                <button class="role-btn btn-teacher" onclick="login('teacher')">
                    <span class="material-icons-round">groups</span> ×›× ×™×¡×ª ××—× ×š/×ª ×›×™×ª×”
                </button>
                <p class="role-note">×¢×œ ××—× ×š ×”×›×™×ª×” ×œ×”×™×›× ×¡ ×•×œ×“×•×•×— ××™ ××”×ª×œ××™×“×™× × ×•×›×— ×‘××§×•× ×”×›×™× ×•×¡</p>
                
                <button class="role-btn btn-admin" onclick="login('admin')">
                    <span class="material-icons-round">admin_panel_settings</span> ×¢×“×›×•×Ÿ ××¦×‘ ×”× ×¢×“×¨×™×
                </button>
                <p class="role-note">×œ××—×¨ ×¡×™××•×Ÿ ×”× ×•×›×—×•×ª ×œ×”×™×›× ×¡ ×œ×›××Ÿ ×¢×œ ×× ×ª ×œ×ª×ª ×¤×¨×˜×™× × ×•×¡×¤×™× ×¢×œ ×”×ª×œ××™×“×™× ×”× ×¢×“×¨×™×</p>
                
                <div class="toggle-excel-btn" onclick="document.getElementById('excelZone').style.display='block'; this.style.display='none';">
                    âš™ï¸ ×”×’×“×¨×•×ª: ×¢×“×›×•×Ÿ ××¦×‘×ª ×ª×œ××™×“×™× (Excel)
                </div>

                <div class="excel-upload-zone" id="excelZone">
                    <h3 style="margin-top:0; font-size: 1.1rem; color: #555;">×”×¢×œ××ª × ×ª×•× ×™ ×‘×™×ª ×¡×¤×¨</h3>
                    <p style="font-size: 0.85rem; color: #777;">×”×¢×œ×” ×§×•×‘×¥ Excel. ×”××¢×¨×›×ª ×ª×¡×¨×•×§ ××•×˜×•××˜×™×ª ×œ××¦×™××ª ×”×¢××•×“×•×ª: ×ª.×–, ×©× ×”×ª×œ××™×“, ×©×›×‘×”, ××§×‘×™×œ×”, ×˜×œ×¤×•×Ÿ/×¡×œ×•×œ×¨×™.</p>
                    <input type="file" id="excelFile" accept=".xlsx, .xls" onchange="handleExcelUpload(event)">
                    <button class="btn-excel" onclick="document.getElementById('excelFile').click()">
                        <span class="material-icons-round">upload_file</span> ×‘×—×¨ ×§×•×‘×¥ ××§×¡×œ
                    </button>
                    <div id="uploadStatus" style="margin-top: 10px; font-weight: bold; font-size: 0.9rem;"></div>
                </div>
            </div>
        </div>

        <div id="screen-teacher-lobby" class="screen">
            <h2 style="margin-bottom: 5px; color: var(--primary); font-size: 1.5rem;">×‘×—×¨ ×›×™×ª×” ×œ×“×™×•×•×—:</h2>
            <p style="color: #7f8c8d; font-size: 1rem; margin-bottom: 25px;">×™×© ×œ×•×•×“× ×©×›×œ ×ª×œ××™×“ ×©× ××¦× ×¤×™×–×™×ª ×‘× ×§×•×“×ª ×”×›×™× ×•×¡ ××¡×•××Ÿ ×›× ×•×›×—.</p>
            <div class="class-grid" id="classGrid"></div>
        </div>

        <div id="screen-teacher-class" class="screen">
            <button class="btn-back" onclick="showScreen('screen-teacher-lobby')">
                <span class="material-icons-round">arrow_forward</span> ×—×–×•×¨ ×œ×¨×©×™××ª ×”×›×™×ª×•×ª
            </button>
            
            <div style="background: white; padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; border-right: 8px solid var(--primary);" id="classHeaderColor">
                <h2 id="currentClassTitle" style="margin: 0; color: var(--primary);">×›×™×ª×”</h2>
                <div style="background: #e8f8f5; color: var(--success); padding: 5px 12px; border-radius: 20px; font-weight: bold;" id="classProgress">0/0 × ×•×›×—×™×</div>
            </div>

            <div id="classStudentsList"></div>
        </div>

        <div id="screen-admin" class="screen">
            
            <div class="admin-actions">
                <button class="btn-reset" onclick="resetDrill()">
                    <span class="material-icons-round">restart_alt</span> ××™×¤×•×¡ ×ª×¨×’×™×œ
                </button>
                <button class="btn-demo-scenario" onclick="generateDemoScenario()">
                    <span class="material-icons-round">shuffle</span> ×¡×™××•×œ×¦×™×™×ª ××¦×‘ (×“××•)
                </button>
                <button class="btn-export" onclick="exportMissing()">
                    <span class="material-icons-round">download</span> ×™×™×¦×•× × ×¢×“×¨×™×
                </button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-box" style="border-bottom: 5px solid var(--primary);">
                    <div class="stat-num" id="statTotal" style="color: var(--primary);">0</div>
                    <div style="font-size: 0.9rem; font-weight: 500;">×¡×”"×› ×ª×œ××™×“×™×</div>
                </div>
                <div class="stat-box" style="border-bottom: 5px solid var(--success);">
                    <div class="stat-num" id="statPresent" style="color: var(--success);">0</div>
                    <div style="font-size: 0.9rem; font-weight: 500;">×“×•×•×—×• ×‘× ×§×•×“×”</div>
                </div>
                <div class="stat-box" style="border-bottom: 5px solid var(--danger); background: #fdedec;">
                    <div class="stat-num" id="statMissing" style="color: var(--danger);">0</div>
                    <div style="font-size: 0.9rem; font-weight: 900;">× ×¢×“×¨×™× - ×œ×—×¤×©!</div>
                </div>
            </div>

            <h3 style="color: var(--primary); margin-top: 30px; border-bottom: 2px solid #ccc; padding-bottom: 10px;">
                <span class="material-icons-round" style="vertical-align: middle;">format_list_bulleted</span> ×¤×™×¨×•×˜ ×œ×¤×™ ×›×™×ª×•×ª
            </h3>
            
            <div id="adminMissingList"></div>
        </div>

    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD5YP8y_eZxqcZWnqHEC5jjsZvzLNK_MdQ",
            authDomain: "reida-6aeb8.firebaseapp.com",
            databaseURL: "https://reida-6aeb8-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "reida-6aeb8",
            storageBucket: "reida-6aeb8.firebasestorage.app",
            messagingSenderId: "1052491880659",
            appId: "1:1052491880659:web:8310165bace19520161c26"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentRole = null;
        let allStudents = {};
        let drillStatus = {};
        let activeClass = null;
        let openAdminClasses = new Set(); 

        function getShichvaColor(clsName) {
            const name = (clsName || '').trim();
            if (name.startsWith('×–')) return '#3498db';
            if (name.startsWith('×—')) return '#9b59b6';
            if (name.startsWith('×˜')) return '#e67e22';
            if (name.startsWith('×™×')) return '#27ae60';
            if (name.startsWith('×™×‘')) return '#f1c40f';
            if (name.startsWith('×™')) return '#e74c3c';
            return '#7f8c8d';
        }

        function generateDemoScenario() {
            if (Object.keys(allStudents).length === 0) {
                alert("××™×Ÿ ×ª×œ××™×“×™× ×‘××¢×¨×›×ª! ×× × ×”×¢×œ×” ×§×•×‘×¥ ××§×¡×œ ×§×•×“× ×‘××¡×š ×”×¨××©×™.");
                return;
            }
            const pass = prompt("×”×–×Ÿ ×¡×™×¡××” ×œ×‘×™×¦×•×¢ ×¤×¢×•×œ×”:");
            if (pass !== '1234') { alert("âŒ ×¡×™×¡××” ×©×’×•×™×”!"); return; }
            if(!confirm("âš ï¸ ×¤×¢×•×œ×” ×–×• ×ª×“×¨×•×¡ ××ª × ×ª×•× ×™ ×”× ×•×›×—×•×ª ×”× ×•×›×—×™×™× ×•×ª×™×™×¦×¨ ××¦×‘ ××§×¨××™ ×œ×—×œ×•×˜×™×Ÿ. ×œ×”××©×™×š?")) return;

            let updates = {};
            Object.keys(allStudents).forEach(id => {
                const rand = Math.random();
                if (rand < 0.75) updates[id] = 'present';
                else if (rand < 0.95) { /* × ×¢×“×¨ - ×œ× ××•×¡×™×¤×™× */ }
                else if (rand < 0.98) updates[id] = 'absent_today';
                else updates[id] = 'left_early';
            });
            db.ref('emergency_drill').set(updates).then(() => {
                alert("âœ… ×”×“××• ×”×•×¤×¢×œ! ×ª××•× ×ª ××¦×‘ ××§×¨××™×ª × ×•×¦×¨×”.");
            }).catch(err => alert("×©×’×™××”: " + err.message));
        }

        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.style.color = 'var(--primary)';
            statusDiv.textContent = 'â³ ×¡×•×¨×§ ××ª ×”×§×•×‘×¥ ×•×××ª×¨ × ×ª×•× ×™×...';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    let headerRowIndex = -1;
                    let colIndices = { id: -1, name: -1, shihva: -1, classNum: -1, phone: -1 };

                    const phoneKeywords = ['×¡×•×œ×œ×¨','×¡×œ×•×œ×¨','×¡×œ×•×œ×¨×™','×˜×œ×¤×•×Ÿ','× ×™×™×“','×¤×œ××¤×•×Ÿ','×¤×œ×¤×•×Ÿ','×˜×œ','phone','mobile','cel','cell','×¤×•×Ÿ','×˜×œ×¤×•×Ÿ× ×™×™×“','×˜×œ×¤×•×Ÿ×”×•×¨×”','×˜×œ×¤×•×Ÿ××','×˜×œ×¤×•×Ÿ××‘','× ×™×™×“1','× ×™×™×“2','×˜×œ× ×™×™×“'];

                    for (let i = 0; i < Math.min(rows.length, 15); i++) {
                        const row = rows[i];
                        if (!row || row.length === 0) continue;
                        let tempId = -1, tempName = -1, tempShihva = -1, tempClassNum = -1, tempPhone = -1;
                        for (let j = 0; j < row.length; j++) {
                            let cellValue = String(row[j] || '').replace(/\s+/g, '').replace(/[\u200B-\u200D\uFEFF]/g, '').replace(/['"`.,:;]/g, '');
                            let cellLower = cellValue.toLowerCase();
                            if (cellLower.includes('×ª×–') || cellLower.includes('×ª.×–') || cellLower === 'id') tempId = j;
                            else if (cellLower.includes('×©××”×ª×œ××™×“') || cellLower === '×©×' || cellLower.includes('×©×××œ×') || cellLower.includes('×©××¤×¨×˜×™') || cellLower.includes('×©××ª×œ××™×“')) tempName = j;
                            else if (cellLower.includes('×©×›×‘×”')) tempShihva = j;
                            else if (cellLower.includes('××§×‘×™×œ×”') || cellLower.includes('×›×™×ª×”')) tempClassNum = j;
                            else if (tempPhone === -1 && phoneKeywords.some(kw => cellLower.includes(kw))) tempPhone = j;
                        }
                        if (tempId !== -1 && tempName !== -1) {
                            headerRowIndex = i;
                            colIndices = { id: tempId, name: tempName, shihva: tempShihva, classNum: tempClassNum, phone: tempPhone };
                            break;
                        }
                    }

                    if (headerRowIndex === -1) {
                        statusDiv.style.color = 'var(--danger)';
                        statusDiv.textContent = 'âŒ ×©×’×™××”: ×œ× ××¦×× ×• ××ª ×¢××•×“×•×ª ×”-×ª.×– ×•×”×©×.';
                        return;
                    }

                    let phoneColName = colIndices.phone !== -1 ? String(rows[headerRowIndex][colIndices.phone] || '') : '';
                    let updates = {};
                    let count = 0, phoneCount = 0;

                    for (let i = headerRowIndex + 1; i < rows.length; i++) {
                        const row = rows[i];
                        if (!row || row.length === 0) continue;
                        const idVal = row[colIndices.id];
                        const nameVal = row[colIndices.name];
                        if (idVal && nameVal) {
                            const shihvaVal = colIndices.shihva !== -1 ? (row[colIndices.shihva] || '') : '';
                            const classNumVal = colIndices.classNum !== -1 ? (row[colIndices.classNum] || '') : '';
                            let phoneVal = colIndices.phone !== -1 ? (row[colIndices.phone] || '') : '';
                            const cls = (String(shihvaVal).trim() + ' ' + String(classNumVal).trim()).trim() || '×œ×œ× ×›×™×ª×”';
                            let finalPhone = String(phoneVal).trim().replace(/[-\s()]/g, '');
                            if (finalPhone.startsWith('+972')) finalPhone = '0' + finalPhone.substring(4);
                            else if (finalPhone.startsWith('972')) finalPhone = '0' + finalPhone.substring(3);
                            else if (finalPhone.length === 9 && !finalPhone.startsWith('0')) finalPhone = '0' + finalPhone;
                            if (finalPhone.length >= 9) phoneCount++;
                            updates[String(idVal).trim()] = { name: String(nameVal).trim(), class: cls, phone: finalPhone };
                            count++;
                        }
                    }

                    if (count > 0) {
                        db.ref('students').set(updates).then(() => {
                            let phoneMsg = colIndices.phone !== -1 
                                ? ` | ×¢××•×“×ª ×˜×œ×¤×•×Ÿ: "${phoneColName}" (${phoneCount} ××¡×¤×¨×™× × ××¦××•)`
                                : ' | âš ï¸ ×œ× × ××¦××” ×¢××•×“×ª ×˜×œ×¤×•×Ÿ ×‘×§×•×‘×¥!';
                            statusDiv.style.color = colIndices.phone !== -1 ? 'var(--success)' : 'var(--warning)';
                            statusDiv.innerHTML = `âœ… × ×•×¡×¤×•/×¢×•×“×›× ×• ${count} ×ª×œ××™×“×™×!${phoneMsg}`;
                            setTimeout(() => { document.getElementById('excelZone').style.display='none'; document.querySelector('.toggle-excel-btn').style.display='inline-block'; }, 5000);
                        }).catch(err => {
                            statusDiv.style.color = 'var(--danger)';
                            statusDiv.textContent = 'âŒ ×©×’×™××” ×‘×©××™×¨×”: ' + err.message;
                        });
                    }
                } catch (error) {
                    statusDiv.style.color = 'var(--danger)';
                    statusDiv.textContent = 'âŒ ×©×’×™××” ×¤× ×™××™×ª ×‘×§×¨×™××ª ×”×§×•×‘×¥.';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function login(role) {
            currentRole = role;
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('userName').textContent = role === 'teacher' ? 'ğŸ‘©â€ğŸ« ×××©×§ ××—× ×š' : 'âš™ï¸ ×¢×“×›×•×Ÿ ××¦×‘ × ×¢×“×¨×™×';
            if (role === 'teacher') showScreen('screen-teacher-lobby');
            if (role === 'admin') showScreen('screen-admin');
            listenToDatabase();
        }

        function logout() {
            currentRole = null;
            activeClass = null;
            document.getElementById('userInfo').style.display = 'none';
            showScreen('screen-login');
        }

        function listenToDatabase() {
            db.ref('students').on('value', snap => {
                allStudents = snap.val() || {};
                db.ref('emergency_drill').on('value', drillSnap => {
                    drillStatus = drillSnap.val() || {};
                    routeDataToUI();
                });
            });
        }

        function routeDataToUI() {
            if (currentRole === 'teacher') {
                if (activeClass) openClass(activeClass);
                else renderClassLobby();
            } else if (currentRole === 'admin') {
                renderAdminList();
            }
        }

        // ==========================================
        // ×××©×§ ××—× ×š - ×œ×•×‘×™ ×›×™×ª×•×ª
        // ==========================================
        function renderClassLobby() {
            const grid = document.getElementById('classGrid');
            grid.innerHTML = '';
            const classesSet = new Set();
            Object.values(allStudents).forEach(s => {
                if (s.class && s.class.trim() !== '×œ×œ× ×›×™×ª×”') classesSet.add(s.class.trim());
            });
            const sortedClasses = Array.from(classesSet).sort();
            if (sortedClasses.length === 0) {
                grid.innerHTML = '<p>×¢×“×™×™×Ÿ ×œ× ×”×•×¢×œ×• ×ª×œ××™×“×™×. ×”×¢×œ×” ×§×•×‘×¥ ××§×¡×œ ×‘××¡×š ×”×¨××©×™.</p>';
                return;
            }
            sortedClasses.forEach(cls => {
                const card = document.createElement('div');
                card.className = 'class-card';
                card.style.borderRightColor = getShichvaColor(cls);
                card.addEventListener('click', () => { activeClass = cls; openClass(cls); });

                const classStudents = Object.entries(allStudents).filter(([id, s]) => s.class && s.class.trim() === cls);
                const totalInClass = classStudents.length;
                const presentInClass = classStudents.filter(([id]) => drillStatus[id] === 'present').length;

                const nameDiv = document.createElement('div');
                nameDiv.textContent = cls;
                const infoDiv = document.createElement('div');
                infoDiv.className = 'class-attendance-info';
                infoDiv.textContent = presentInClass + '/' + totalInClass + ' × ×•×›×—×™×';

                card.appendChild(nameDiv);
                card.appendChild(infoDiv);
                grid.appendChild(card);
            });
        }

        // ==========================================
        // ×××©×§ ××—× ×š - ×¨×©×™××ª ×ª×œ××™×“×™×
        // ×ª×™×§×•×Ÿ ×§×¨×™×˜×™: ×©×™××•×© ×‘-addEventListener ×‘××§×•× onclick inline
        // ×–×” ×¤×•×ª×¨ ××ª ×”×‘×¢×™×” ×¢× ×©××•×ª ×©××›×™×œ×™× ×’×¨×© (') ×›××• ×× ×’'×œ, ×§×•×¦'×¨×•
        // ==========================================
        function togglePresence(studentId, currentStatus) {
            const newStatus = currentStatus === 'present' ? null : 'present';
            db.ref('emergency_drill/' + studentId).set(newStatus);
        }

        function openClass(className) {
            document.getElementById('currentClassTitle').textContent = '×›×™×ª×”: ' + className;
            document.getElementById('currentClassTitle').style.color = getShichvaColor(className);
            document.getElementById('classHeaderColor').style.borderRightColor = getShichvaColor(className);
            
            const list = document.getElementById('classStudentsList');
            list.innerHTML = '';

            const classStudents = Object.entries(allStudents)
                .filter(([id, s]) => s.class && s.class.trim() === className)
                .sort((a, b) => a[1].name.localeCompare(b[1].name));

            let presentInClass = 0;

            classStudents.forEach(([id, student]) => {
                const status = drillStatus[id] || 'missing'; 
                const isPresent = status === 'present';
                if (isPresent) presentInClass++;
                
                // ×‘× ×™×™×ª ×©×•×¨×” ×¢× DOM API - ×‘×˜×•×— ×œ×’××¨×™ ××ª×•×•×™× ××™×•×—×“×™×
                const row = document.createElement('div');
                row.className = 'student-row' + (isPresent ? ' present' : '');

                const infoDiv = document.createElement('div');
                infoDiv.className = 'student-info';
                const nameSpan = document.createElement('span');
                nameSpan.className = 'student-name';
                nameSpan.textContent = student.name;
                const idSpan = document.createElement('span');
                idSpan.className = 'student-class';
                idSpan.textContent = '×ª"×–: ' + id;
                infoDiv.appendChild(nameSpan);
                infoDiv.appendChild(idSpan);

                const btn = document.createElement('button');
                btn.className = 'btn-mark ' + (isPresent ? 'present' : 'missing');
                btn.textContent = isPresent ? 'âœ“ × ×•×›×—' : '×¡××Ÿ × ×•×›×—×•×ª';
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    togglePresence(id, status);
                });

                // ×œ×—×™×¦×” ×¢×œ ×›×œ ×”×©×•×¨×” ×’× ×ª×¡××Ÿ
                row.addEventListener('click', function() {
                    togglePresence(id, status);
                });

                row.appendChild(infoDiv);
                row.appendChild(btn);
                list.appendChild(row);
            });

            document.getElementById('classProgress').textContent = presentInClass + '/' + classStudents.length + ' × ×•×›×—×™×';
            showScreen('screen-teacher-class');
        }

        // ==========================================
        // ×××©×§ ×× ×”×œ×ª - ×’× ×›××Ÿ DOM API ×‘×˜×•×—
        // ==========================================
        function toggleAdminClass(cls) {
            if (openAdminClasses.has(cls)) openAdminClasses.delete(cls);
            else openAdminClasses.add(cls);
            renderAdminList(); 
        }

        function updateException(studentId, reason) {
            db.ref('emergency_drill/' + studentId).set(reason ? reason : null);
        }

        function renderAdminList() {
            const list = document.getElementById('adminMissingList');
            list.innerHTML = '';

            let total = 0, presentCount = 0, unaccountedCount = 0;
            const classesMap = {};

            Object.entries(allStudents).forEach(([id, student]) => {
                total++;
                const status = drillStatus[id];
                const cls = student.class || '×œ×œ× ×›×™×ª×”';
                if (!classesMap[cls]) classesMap[cls] = { total: 0, present: 0, unaccounted: 0, items: [] };
                classesMap[cls].total++;
                
                if (status === 'present') {
                    presentCount++;
                    classesMap[cls].present++;
                } else {
                    const isExcused = (status === 'absent_today' || status === 'left_early' || status === 'found');
                    if (!isExcused) { unaccountedCount++; classesMap[cls].unaccounted++; }
                    classesMap[cls].items.push({ id, student, status, isExcused });
                }
            });

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statPresent').textContent = presentCount;
            document.getElementById('statMissing').textContent = unaccountedCount;

            const sortedClasses = Object.keys(classesMap).sort();
            
            sortedClasses.forEach(cls => {
                const data = classesMap[cls];
                const color = getShichvaColor(cls);
                const isAllAccounted = data.unaccounted === 0;
                
                const groupDiv = document.createElement('div');
                groupDiv.className = 'admin-class-group';

                // Header
                const headerDiv = document.createElement('div');
                headerDiv.className = 'admin-class-header';
                headerDiv.style.borderRightColor = color;
                headerDiv.addEventListener('click', function() { toggleAdminClass(cls); });

                const titleArea = document.createElement('div');
                titleArea.style.cssText = 'display:flex;flex-direction:column;gap:2px;';
                const titleSpan = document.createElement('span');
                titleSpan.style.cssText = 'font-weight:900;font-size:1.3rem;color:' + color;
                titleSpan.textContent = cls;
                const countSpan = document.createElement('span');
                countSpan.style.cssText = 'font-size:0.85rem;font-weight:500;color:#7f8c8d;';
                countSpan.textContent = '× ×•×›×—×™×: ' + data.present + '/' + data.total;
                titleArea.appendChild(titleSpan);
                titleArea.appendChild(countSpan);

                const lightDiv = document.createElement('div');
                if (isAllAccounted) {
                    lightDiv.className = 'status-light light-green';
                    lightDiv.textContent = 'ğŸŸ¢ ×”×›×œ ×ª×§×™×Ÿ';
                } else {
                    lightDiv.className = 'status-light light-red';
                    lightDiv.innerHTML = '<div class="dot red"></div> âš ï¸ ×—×¡×¨×™×: ' + data.unaccounted;
                }

                headerDiv.appendChild(titleArea);
                headerDiv.appendChild(lightDiv);
                groupDiv.appendChild(headerDiv);

                // Body
                const bodyDiv = document.createElement('div');
                bodyDiv.className = 'admin-class-body' + (openAdminClasses.has(cls) ? ' active' : '');

                const sortedItems = [...data.items].sort((a, b) => {
                    if (a.isExcused !== b.isExcused) return a.isExcused ? 1 : -1;
                    return a.student.name.localeCompare(b.student.name);
                });

                if (sortedItems.length === 0) {
                    const allOk = document.createElement('div');
                    allOk.style.cssText = 'text-align:center;padding:15px;background:white;border-radius:10px;color:var(--success);font-weight:bold;';
                    allOk.textContent = '×›×œ ×ª×œ××™×“×™ ×”×›×™×ª×” × ×•×›×—×™× ×‘× ×§×•×“×ª ×”×›×™× ×•×¡ ğŸ‘';
                    bodyDiv.appendChild(allOk);
                } else {
                    sortedItems.forEach(item => {
                        const { id, student, status, isExcused } = item;

                        const rowDiv = document.createElement('div');
                        rowDiv.className = 'admin-student-row' + (isExcused ? ' handled' : '');

                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'student-info';
                        
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'student-name';
                        nameSpan.textContent = student.name + ' ';
                        if (!isExcused) {
                            const badge = document.createElement('span');
                            badge.className = 'search-badge';
                            badge.textContent = '×œ×—×¤×©!';
                            nameSpan.appendChild(badge);
                        }

                        const phoneDiv = document.createElement('div');
                        phoneDiv.style.marginTop = '6px';
                        const hasPhone = student.phone && student.phone !== 'undefined' && student.phone.trim() !== '' && student.phone.trim() !== '0';
                        if (hasPhone) {
                            const phoneLink = document.createElement('a');
                            phoneLink.href = 'tel:' + student.phone;
                            phoneLink.className = 'phone-link';
                            phoneLink.textContent = 'ğŸ“ ' + student.phone;
                            phoneDiv.appendChild(phoneLink);
                        } else {
                            const noPhone = document.createElement('span');
                            noPhone.style.cssText = 'color:#aaa;font-size:0.8rem;';
                            noPhone.textContent = '××™×Ÿ ×˜×œ×¤×•×Ÿ ×‘××¡×“ ×”× ×ª×•× ×™×';
                            phoneDiv.appendChild(noPhone);
                        }

                        infoDiv.appendChild(nameSpan);
                        infoDiv.appendChild(phoneDiv);

                        const selectDiv = document.createElement('div');
                        selectDiv.style.textAlign = 'left';
                        const select = document.createElement('select');
                        select.className = 'status-select' + (isExcused ? ' handled' : '');
                        
                        const opt1 = document.createElement('option');
                        opt1.value = ''; opt1.textContent = '-- ×˜×¨× ××•×ª×¨ ×‘×©×˜×— --';
                        if (!status) opt1.selected = true;
                        
                        const opt2 = document.createElement('option');
                        opt2.value = 'found'; opt2.textContent = 'ğŸŸ¢ ×ª×œ××™×“ ××•×ª×¨';
                        if (status === 'found') opt2.selected = true;
                        
                        const opt3 = document.createElement('option');
                        opt3.value = 'absent_today'; opt3.textContent = '×œ× ×”×’×™×¢ ×œ×‘×™×”"×¡';
                        if (status === 'absent_today') opt3.selected = true;
                        
                        const opt4 = document.createElement('option');
                        opt4.value = 'left_early'; opt4.textContent = '×™×¦× ××•×§×“× / ×¨×¤×•××™';
                        if (status === 'left_early') opt4.selected = true;

                        select.appendChild(opt1);
                        select.appendChild(opt2);
                        select.appendChild(opt3);
                        select.appendChild(opt4);

                        select.addEventListener('change', function() {
                            updateException(id, this.value);
                        });

                        selectDiv.appendChild(select);
                        rowDiv.appendChild(infoDiv);
                        rowDiv.appendChild(selectDiv);
                        bodyDiv.appendChild(rowDiv);
                    });
                }

                groupDiv.appendChild(bodyDiv);
                list.appendChild(groupDiv);
            });
        }

        // ==========================================
        // ×™×™×¦×•× × ×¢×“×¨×™× ×œ××§×¡×œ
        // ==========================================
        function exportMissing() {
            const classesMap = {};
            Object.entries(allStudents).forEach(([id, student]) => {
                const status = drillStatus[id];
                const cls = student.class || '×œ×œ× ×›×™×ª×”';
                if (status !== 'present') {
                    if (!classesMap[cls]) classesMap[cls] = [];
                    let statusText = '×˜×¨× ××•×ª×¨';
                    if (status === 'found') statusText = '×ª×œ××™×“ ××•×ª×¨';
                    else if (status === 'absent_today') statusText = '×œ× ×”×’×™×¢ ×œ×‘×™×”"×¡';
                    else if (status === 'left_early') statusText = '×™×¦× ××•×§×“× / ×¨×¤×•××™';
                    classesMap[cls].push({ name: student.name, id: id, phone: student.phone || '', status: statusText });
                }
            });
            const sortedClasses = Object.keys(classesMap).sort();
            if (sortedClasses.length === 0) { alert("××™×Ÿ × ×¢×“×¨×™× ×œ×™×™×¦×•× - ×›×œ ×”×ª×œ××™×“×™× × ×•×›×—×™×! ğŸ‰"); return; }

            const wsData = [['×›×™×ª×”', '×©× ×”×ª×œ××™×“', '×ª.×–', '×˜×œ×¤×•×Ÿ', '×¡×˜×˜×•×¡']];
            sortedClasses.forEach(cls => {
                classesMap[cls].sort((a, b) => a.name.localeCompare(b.name));
                classesMap[cls].forEach(s => wsData.push([cls, s.name, s.id, s.phone, s.status]));
            });
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            ws['!cols'] = [{ wch: 10 }, { wch: 25 }, { wch: 12 }, { wch: 15 }, { wch: 20 }];
            XLSX.utils.book_append_sheet(wb, ws, '× ×¢×“×¨×™×');
            const now = new Date();
            const dateStr = now.toLocaleDateString('he-IL').replace(/\./g, '-');
            const timeStr = now.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }).replace(':', '-');
            XLSX.writeFile(wb, '× ×¢×“×¨×™×_' + dateStr + '_' + timeStr + '.xlsx');
        }

        function resetDrill() {
            const pass = prompt("×”×–×Ÿ ×¡×™×¡××” ×œ×‘×™×¦×•×¢ ×¤×¢×•×œ×”:");
            if (pass !== '1234') { alert("âŒ ×¡×™×¡××” ×©×’×•×™×”!"); return; }
            if (confirm("ğŸ’¾ ×”×× ×œ×™×™×¦× ××ª ×¨×©×™××ª ×”× ×¢×“×¨×™× ×œ×¤× ×™ ×”××™×¤×•×¡?")) exportMissing();
            if(confirm("âš ï¸ ××–×”×¨×”: ×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª ×›×œ × ×ª×•× ×™ ×”× ×•×›×—×•×ª ×•×ª××¤×¡ ××ª ×”××¢×¨×›×ª. ×”×× ×œ×”××©×™×š?")) {
                db.ref('emergency_drill').remove()
                .then(() => alert('×”×ª×¨×’×™×œ ××•×¤×¡. ×›×œ ×”×ª×œ××™×“×™× ××•×’×“×¨×™× ×›×¢×ª ×›× ×¢×“×¨×™×.'))
                .catch(err => alert('×©×’×™××” ×‘××™×¤×•×¡: ' + err.message));
            }
        }
        
        document.querySelector('.btn-back').addEventListener('click', () => { activeClass = null; });
    </script>
</body>
</html>
