<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>×¡×“×¨ ×”×™×•× â€” ×¡×™××•×œ×¦×™×™×ª ×¡×“×¨ ×™×•× ×ª×§×©×•×¨×ª×™</title>
<link href="https://fonts.googleapis.com/css2?family=David+Libre:wght@400;500;700&family=Frank+Ruhl+Libre:wght@300;400;500;700;900&family=Noto+Sans+Hebrew:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<style>
:root{--ink:#1a1410;--paper:#f8f5ef;--pbr:#fefcf7;--accent:#dc2626;--accent-dk:#b91c1c;--slate:#2c3e50;--muted:#8a8070;--border:#d4cfc5;--bl:#e8e4dc;--pol:#8b5cf6;--med:#2563eb;--pub:#16a34a;--fd:'Frank Ruhl Libre','David Libre',serif;--fb:'David Libre','Noto Sans Hebrew',serif;--fu:'Noto Sans Hebrew','David Libre',sans-serif;--r:8px;--rl:12px}
*{margin:0;padding:0;box-sizing:border-box}html{scroll-behavior:smooth}body{font-family:var(--fb);background:var(--paper);color:var(--ink);min-height:100vh;line-height:1.6}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}

.landing{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;text-align:center;background:linear-gradient(180deg,#f8f5ef,#ece6db)}
.landing-logo{font-size:4rem;margin-bottom:10px}
.landing h1{font-family:var(--fd);font-size:2.2rem;font-weight:900;margin-bottom:2px}
.landing .tagline{font-size:1rem;color:var(--muted);margin-bottom:4px}
.landing .credit{font-size:.78rem;color:#b0a898;margin-bottom:28px}
.landing-card{background:#fff;border-radius:16px;padding:26px 24px;max-width:480px;width:92%;border:2px solid var(--bl);box-shadow:0 4px 20px rgba(0,0,0,.08);text-align:right}
.landing-card .ci{font-size:2rem;margin-bottom:5px;text-align:center}
.landing-card h2{font-family:var(--fd);font-size:1.1rem;margin-bottom:5px;text-align:center}
.landing-card p{font-size:.81rem;color:var(--muted);line-height:1.7;margin-bottom:10px}
.landing-card ol{font-size:.78rem;color:#666;line-height:1.8;padding-right:18px;margin-bottom:10px}
.lbtn{display:block;width:100%;padding:11px;font-size:.93rem;font-family:var(--fu);font-weight:700;border:none;border-radius:var(--r);cursor:pointer;text-align:center;background:var(--slate);color:#fff;transition:all .25s}.lbtn:hover{background:#1a2a3a}
.landing-hint{font-size:.76rem;color:#aaa;margin-top:7px;text-align:center}
.landing-footer{margin-top:28px;font-size:.72rem;color:#c0b8a8}

.modal-overlay{position:fixed;inset:0;background:rgba(20,16,10,.75);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;z-index:1000;animation:fadeIn .3s}
.modal-card{background:var(--pbr);border-radius:16px;padding:28px 30px;box-shadow:0 24px 80px rgba(0,0,0,.35);max-width:540px;width:92%;animation:slideUp .4s;text-align:right}
.modal-card h2{font-family:var(--fd);font-size:1.25rem;font-weight:900;margin-bottom:3px;text-align:center}
.modal-sub{color:var(--muted);font-size:.82rem;margin-bottom:14px;text-align:center;line-height:1.6}
.modal-input{width:100%;padding:9px 12px;font-size:.9rem;border:2px solid var(--border);border-radius:var(--r);font-family:var(--fb);outline:none;background:#fff}.modal-input:focus{border-color:var(--accent)}
.modal-btn{width:100%;padding:10px;font-size:.92rem;font-family:var(--fu);font-weight:700;border:none;border-radius:var(--r);cursor:pointer;margin-top:9px}.modal-btn.primary{background:var(--accent);color:#fff}.modal-btn.primary:hover{background:var(--accent-dk)}.modal-btn:disabled{background:var(--border);color:#999;cursor:default}
.credit-bar{background:linear-gradient(135deg,#dc262608,#2563eb08);border:1px solid #fecaca;border-radius:20px;padding:4px 16px;font-size:.72rem;color:var(--accent);font-family:var(--fu);font-weight:500;text-align:center;margin-bottom:10px}

.app-header{background:var(--ink);color:var(--pbr);padding:0 18px;height:50px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;box-shadow:0 2px 16px rgba(0,0,0,.25)}
.header-brand{display:flex;align-items:center;gap:9px}
.header-brand .logo{font-size:1.15rem}.header-brand h1{font-family:var(--fd);font-size:.98rem;font-weight:700}.header-brand .meta{font-size:.64rem;opacity:.5}
.phase-indicators{display:flex;gap:3px}
.phase-pill{padding:3px 9px;border-radius:20px;font-size:.67rem;font-weight:600;font-family:var(--fu);background:rgba(255,255,255,.08);color:rgba(255,255,255,.3);transition:all .3s;white-space:nowrap}
.phase-pill.active{background:var(--accent);color:#fff}.phase-pill.done{background:rgba(255,255,255,.15);color:rgba(255,255,255,.6)}

.container{max-width:960px;margin:0 auto;padding:20px 18px}
.info-box{background:#fff;border-radius:var(--rl);padding:15px 20px;margin-bottom:14px;border:1px solid var(--bl)}
.info-box h2{font-family:var(--fd);font-size:1.12rem;margin-bottom:3px}.info-box p{color:var(--muted);font-size:.82rem;line-height:1.7}
.btn{display:inline-flex;align-items:center;gap:5px;padding:9px 20px;border-radius:var(--r);font-size:.85rem;font-weight:700;font-family:var(--fu);border:none;cursor:pointer;transition:all .25s}.btn:active{transform:scale(.97)}
.btn-accent{background:var(--accent);color:#fff}.btn-accent:hover{background:var(--accent-dk)}
.btn-dark{background:var(--slate);color:#fff}.btn-dark:hover{background:#1a2a3a}
.btn-muted{background:#b0a898;color:#fff}.btn-muted:hover{background:#9a9080}
.btn-center{display:flex;justify-content:center;gap:12px;margin-top:20px;flex-wrap:wrap}

/* Theory accordion */
.theory-accordion{background:#fff;border:1px solid var(--bl);border-radius:var(--rl);margin-bottom:14px;overflow:hidden}
.theory-toggle{width:100%;display:flex;justify-content:space-between;align-items:center;padding:12px 18px;cursor:pointer;background:#fff;border:none;font-family:var(--fu);font-size:.88rem;font-weight:700;color:var(--accent);transition:background .2s}
.theory-toggle:hover{background:#fef2f2}
.theory-toggle .chevron{transition:transform .3s;font-size:.8rem}
.theory-accordion.open .theory-toggle .chevron{transform:rotate(180deg)}
.theory-body{max-height:0;overflow:hidden;transition:max-height .4s ease,padding .3s;padding:0 18px}
.theory-accordion.open .theory-body{max-height:2000px;padding:0 18px 16px}
.theory-body h4{font-family:var(--fd);font-size:.92rem;margin:10px 0 4px}
.theory-body p,.theory-body li{font-size:.8rem;color:#555;line-height:1.7}
.theory-body ul{padding-right:18px;margin-bottom:6px}
.theory-body .highlight{background:#fef2f2;border-right:3px solid var(--accent);padding:6px 12px;border-radius:0 6px 6px 0;margin:6px 0;font-size:.8rem;font-weight:600;color:var(--accent-dk)}

/* Link */
.link-result{margin-top:12px;padding:12px;background:#fef2f2;border:2px solid var(--accent);border-radius:var(--r);animation:slideUp .3s}
.link-result h3{font-size:.86rem;color:var(--accent-dk);margin-bottom:4px;font-family:var(--fu);text-align:center}
.link-url{width:100%;padding:7px;background:#fff;border:1px solid #fecaca;border-radius:6px;font-family:monospace;font-size:.66rem;direction:ltr;text-align:left;word-break:break-all;margin-bottom:5px;resize:none;min-height:40px;outline:none}
.link-actions{display:flex;gap:7px}
.link-actions button{flex:1;padding:7px;font-family:var(--fu);font-weight:600;font-size:.8rem;border:none;border-radius:6px;cursor:pointer}
.copy-btn{background:var(--accent);color:#fff}.copy-btn:hover{background:var(--accent-dk)}
.new-btn{background:#3498db;color:#fff}.new-btn:hover{background:#2980b9}
.np-item{padding:5px;border-bottom:1px solid #f0f0f0;font-size:.76rem}.np-item:last-child{border:none}

/* 3 Inbox columns */
.inbox-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:14px}
.inbox-col{border-radius:var(--rl);padding:14px;border:2px solid;min-height:200px}
.inbox-col.pol{background:#f5f3ff;border-color:#c4b5fd}.inbox-col.med{background:#eff6ff;border-color:#bfdbfe}.inbox-col.pub{background:#f0fdf4;border-color:#bbf7d0}
.inbox-header{display:flex;align-items:center;gap:6px;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid rgba(0,0,0,.06)}
.inbox-header .ih-icon{font-size:1.3rem}
.inbox-header .ih-title{font-family:var(--fu);font-size:.85rem;font-weight:700}
.inbox-header .ih-count{background:rgba(0,0,0,.06);padding:1px 8px;border-radius:10px;font-size:.66rem;font-family:var(--fu);font-weight:600}
.inbox-header.pol .ih-title{color:var(--pol)}.inbox-header.med .ih-title{color:var(--med)}.inbox-header.pub .ih-title{color:var(--pub)}

.inbox-item{background:#fff;border-radius:6px;padding:8px 10px;margin-bottom:6px;cursor:pointer;border:2px solid transparent;transition:all .2s;position:relative}
.inbox-item:hover{box-shadow:0 2px 8px rgba(0,0,0,.08);transform:translateY(-1px)}
.inbox-item.selected{border-color:var(--accent);background:#fef8f8}
.inbox-item.disabled{opacity:.3;cursor:not-allowed;pointer-events:none}
.inbox-item .ii-from{font-size:.68rem;font-weight:600;font-family:var(--fu);margin-bottom:2px}
.inbox-item .ii-from.pol{color:var(--pol)}.inbox-item .ii-from.med{color:var(--med)}.inbox-item .ii-from.pub{color:var(--pub)}
.inbox-item h4{font-family:var(--fd);font-size:.84rem;font-weight:700;line-height:1.3}
.inbox-item .ii-sub{font-size:.72rem;color:#666;line-height:1.35;margin-top:1px}
.inbox-item .ii-pressure{font-size:.66rem;font-style:italic;color:#999;margin-top:3px;padding-top:3px;border-top:1px dashed #eee}
.inbox-item .ni-rank{position:absolute;top:5px;left:5px;background:var(--accent);color:#fff;border-radius:50%;width:20px;height:20px;font-size:.62rem;font-weight:700;display:flex;align-items:center;justify-content:center;font-family:var(--fu)}

.counter-badge{display:inline-block;margin-top:10px;padding:5px 15px;border-radius:20px;font-size:.82rem;font-weight:700;font-family:var(--fu)}
.counter-badge.inc{background:#fff8e8;color:#d4950a}.counter-badge.ok{background:#e8f8e8;color:#1e8a3e}

/* Homepage slots */
.hp-frame{background:#fff;border:2px solid var(--ink);border-radius:3px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.12);margin-bottom:14px}
.hp-header{text-align:center;border-bottom:3px double var(--ink);padding-bottom:8px;margin-bottom:12px}
.hp-header h2{font-family:var(--fd);font-size:1.5rem;font-weight:900}
.hp-header .hp-date{font-size:.64rem;color:var(--muted);font-family:var(--fu)}
.hp-slot{border:2px dashed var(--border);border-radius:4px;padding:8px;min-height:40px;transition:all .25s;position:relative;margin-bottom:6px;cursor:pointer}
.hp-slot.drag-over{border-color:var(--accent);background:#fef8f8}
.hp-slot.filled{border:1px solid #ddd;background:#fafaf5;cursor:default}
.hp-slot .slot-label{text-align:center;color:#ccc;font-size:.76rem;font-family:var(--fu);font-weight:600}
.hp-slot .remove-btn{position:absolute;top:3px;left:3px;background:var(--accent);color:#fff;border:none;border-radius:50%;width:18px;height:18px;font-size:.55rem;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s}
.hp-slot:hover .remove-btn{opacity:1}
.hp-slot .filled-origin{font-size:.6rem;font-weight:600;font-family:var(--fu);padding:1px 6px;border-radius:8px;color:#fff;display:inline-block;margin-bottom:2px}
.hp-slot .filled-headline{font-family:var(--fd);font-weight:800;line-height:1.2;margin-bottom:1px}
.hp-slot .filled-sub{font-size:.72rem;color:#555;line-height:1.3}
.hp-slot.main-slot .filled-headline{font-size:1.25rem}
.hp-slot.sec-slot .filled-headline{font-size:.92rem}
.hp-slot.small-slot .filled-headline{font-size:.78rem}

/* Justify */
.justify-card{background:#fff;border-radius:var(--rl);padding:14px 18px;margin-bottom:9px;border:1px solid var(--bl)}
.justify-card h4{font-family:var(--fd);font-size:.88rem;margin-bottom:4px}
.justify-textarea{width:100%;padding:8px 11px;border:1px solid var(--border);border-radius:var(--r);font-family:var(--fb);font-size:.84rem;line-height:1.7;resize:vertical;outline:none;min-height:55px}.justify-textarea:focus{border-color:var(--accent)}

/* Reveal */
.impact-box{background:#fff;border:2px solid var(--med);border-radius:var(--rl);padding:18px;margin-bottom:14px;position:relative}
.impact-box::before{content:'ğŸ’¡ ×”×ª×•×‘× ×”';position:absolute;top:-11px;right:14px;background:var(--med);color:#fff;padding:2px 12px;border-radius:20px;font-size:.74rem;font-weight:700;font-family:var(--fu)}
.impact-box h3{font-family:var(--fd);font-size:1rem;margin:6px 0 8px}
.origin-bar{display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap}
.origin-chip{padding:5px 14px;border-radius:20px;font-size:.82rem;font-weight:700;font-family:var(--fu);color:#fff}
.origin-chip.pol{background:var(--pol)}.origin-chip.med{background:var(--med)}.origin-chip.pub{background:var(--pub)}

/* Teacher */
.sub-card{background:#fff;border:1px solid var(--bl);border-radius:var(--rl);padding:16px;margin-bottom:14px}
.sub-card h4{font-family:var(--fd);font-size:1.02rem;margin-bottom:4px}
.sub-meta{font-size:.74rem;color:var(--muted);margin-bottom:8px}
.mini-hp{background:var(--pbr);border:1.5px solid var(--ink);border-radius:3px;padding:8px;margin-bottom:8px}
.mini-hp .mh-item{padding:3px 6px;margin-bottom:2px;border-radius:3px;font-size:.76rem}
.mini-hp .mh-main{background:#fef2f2;font-family:var(--fd);font-weight:700;font-size:.85rem}
.mini-hp .mh-sec{background:#f5f5f0;font-family:var(--fd);font-weight:600}
.mini-hp .mh-small{background:#fafaf8;font-size:.72rem}

.instructions-box{background:#fef2f2;border:1px solid #fecaca;border-radius:var(--rl);padding:13px 18px;margin-bottom:14px}
.instructions-box h3{font-size:.9rem;color:var(--accent);margin-bottom:3px;font-family:var(--fu)}
.instructions-box ol{font-size:.79rem;color:#666;line-height:1.8;padding-right:18px}

@media print{.app-header,.info-box,.instructions-box,.btn,.btn-center,.credit-bar,.theory-accordion{display:none!important}body{background:#fff}}
@media(max-width:768px){.inbox-grid{grid-template-columns:1fr}.container{padding:12px 10px}.phase-indicators{display:none}}
</style>
</head>
<body>
<div id="app"></div>
<script>
// ============ FIREBASE ============
const firebaseConfig={apiKey:"AIzaSyCh8TMjXeatpegwaJGOiT64VU0cXeWMwLA",authDomain:"newspaper-editor.firebaseapp.com",databaseURL:"https://newspaper-editor-default-rtdb.europe-west1.firebasedatabase.app",projectId:"newspaper-editor",storageBucket:"newspaper-editor.firebasestorage.app",messagingSenderId:"1056483646622",appId:"1:1056483646622:web:1afdb41dbcfacff9106f8f"};
let db;try{firebase.initializeApp(firebaseConfig);db=firebase.database()}catch(e){console.warn(e)}

const THEORY_HTML=`
<h4>××”×• ×¡×“×¨ ×™×•× ×ª×§×©×•×¨×ª×™?</h4>
<p>×ª×™××•×¨×™×” ×”×˜×•×¢× ×ª ×©×œ×ª×§×©×•×¨×ª ×”×”××•× ×™× ×”×©×¤×¢×” ×¨×‘×” ×•×”×™× ×§×•×‘×¢×ª ××”×Ÿ ×”×¡×•×’×™×•×ª ×”×—×©×•×‘×•×ª ×©××¢×¡×™×§×•×ª ××ª ×”×¦×™×‘×•×¨. ×›×›×œ ×©×”×ª×§×©×•×¨×ª ×ª×‘×œ×™×˜ × ×•×©× ××¡×•×™×, ×›×š ×”×•× ×™×™×ª×¤×¡ ×›×—×©×•×‘ ×™×•×ª×¨.</p>
<div class="highlight">ğŸ’¡ ×”×ª×§×©×•×¨×ª ×œ× ××•××¨×ª ×œ× ×• <strong>××”</strong> ×œ×—×©×•×‘ â€” ××œ× <strong>×¢×œ ××”</strong> ×œ×—×©×•×‘.</div>
<h4>×©×œ×•×©×ª ×¡×“×¨×™ ×”×™×•× ××©×¤×™×¢×™× ×–×” ×¢×œ ×–×”:</h4>
<ul>
  <li><strong>ğŸ›ï¸ ×¡×“×¨ ×™×•× ×¤×•×œ×™×˜×™:</strong> ×¤×•×œ×™×˜×™×§××™×, ××¤×œ×’×•×ª, ×’×•×¨××™× ×××¡×“×™×™×, ×‘×¢×œ×™ ×”×•×Ÿ, ×™×•×¢×¦×™ ×ª×§×©×•×¨×ª ×•×™×—"×¦× ×™× â€” ×©××ª××¨× ×™× ××ª ×”×ª×§×©×•×¨×ª ×œ××˜×¨×•×ª×™×”×</li>
  <li><strong>ğŸ“º ×¡×“×¨ ×™×•× ×ª×§×©×•×¨×ª×™:</strong> ×”×ª×§×©×•×¨×ª ×¢×œ ×©×œ×œ ×¡×•×’×™×” â€” ×—×•×©×¤×ª ××™×“×¢, ××¤×¨×¡××ª ×¤×¢×•×œ×•×ª ×©×œ×˜×•×Ÿ, × ×•×ª× ×ª ×‘××”, ××“×’×™×©×” ××• ××¡×ª×™×¨×” × ×•×©××™× ××ª×•×š ××’'× ×“×” ×•×ª×¤×™×¡×ª ×¢×•×œ×</li>
  <li><strong>ğŸ‘¥ ×¡×“×¨ ×™×•× ×¦×™×‘×•×¨×™:</strong> ×”×¦×™×‘×•×¨ â€” ×¨×©×ª×•×ª ×—×‘×¨×ª×™×•×ª, ×”×¤×’× ×•×ª, ××¨×’×•× ×™×, ×¢×¦×•××•×ª, ×‘×™×§×•×¨×ª ×¢×œ ×”×©×œ×˜×•×Ÿ</li>
</ul>
<h4>×¨×¢×™×•× ×•×ª ××¨×›×–×™×™×:</h4>
<ul>
  <li>×”× ×•×©××™× ×”×—×©×•×‘×™× ××•×¤×™×¢×™× <strong>×‘×©×¢×¨ ×”×¢×™×ª×•×Ÿ ×•×‘×ª×—×™×œ×ª ×”×—×“×©×•×ª</strong>, ×–×•×›×™× ×œ×›×•×ª×¨×•×ª ×’×“×•×œ×•×ª, ×”×¨×‘×” ×¦×‘×¢, ×•×ª×•×¤×¡×™× ×”×¨×‘×” ××§×•×</li>
  <li>×ª×©×•××ª ×”×œ×‘ ×”×¦×™×‘×•×¨×™×ª ×× ×™×¢×” ××•×¡×“×•×ª ×¤×•×œ×™×˜×™×™× <strong>×œ×˜×¤×œ</strong> ×‘× ×•×©××™× ×©×¢×•×œ×™× ×œ×¡×“×¨ ×”×™×•×</li>
  <li>× ×•×©××™× ×©×œ× ××¡×•×§×¨×™× â€” <strong>×›××™×œ×• ×œ× ×§×¨×•</strong></li>
  <li>××•×¤×™ ×”×“×™×•×Ÿ ×‘×ª×§×©×•×¨×ª ××©×¤×™×¢ ×¢×œ ×”×œ×š ×”×¨×•×— ×•×¢××“×•×ª ×”×¦×™×‘×•×¨</li>
  <li>×‘×‘×—×™×¨×•×ª â€” ×¤×•×œ×™×˜×™×§××™× ×©××•×¤×™×¢×™× ×‘×ª×§×©×•×¨×ª ×–×•×›×™× ×‘×—×©×™×¤×” ×•××”×“×”</li>
</ul>`;

const OC={political:{icon:"ğŸ›ï¸",label:"×¡×“×¨ ×™×•× ×¤×•×œ×™×˜×™",color:"#8b5cf6",cls:"pol"},media:{icon:"ğŸ“º",label:"×¡×“×¨ ×™×•× ×ª×§×©×•×¨×ª×™",color:"#2563eb",cls:"med"},public:{icon:"ğŸ‘¥",label:"×¡×“×¨ ×™×•× ×¦×™×‘×•×¨×™",color:"#16a34a",cls:"pub"}};

// ============ NEWS POOLS ============
const ALL_POOLS=[
{
  id:1,name:"×‘×•×§×¨ ×—×“×©×•×ª×™ ×'",
  news:[
    // === POLITICAL INBOX ===
    {id:1,origin:"political",from:"×“×•×‘×¨ ×¨××© ×”×××©×œ×”",headline:"×¨××© ×”×××©×œ×” ×™×›×¨×™×– ×”×¢×¨×‘ ×¢×œ ×¨×¤×•×¨××” ×‘×©×•×§ ×”×“×™×•×¨",subtitle:"×”×•×“×¢×” ×¨×©××™×ª ×¦×¤×•×™×” ×‘-20:00",pressure:"\"×—×©×•×‘ ×××•×“ ×©×–×” ×™×”×™×” ×›×•×ª×¨×ª ×¨××©×™×ª. ×¨××© ×”×××©×œ×” ××¦×¤×” ×œ×›×™×¡×•×™ × ×¨×—×‘.\""},
    {id:2,origin:"political",from:"×“×•×‘×¨×ª ××©×¨×“ ×”×‘×™×˜×—×•×Ÿ",headline:"×¦×”\"×œ ×—×©×£ ×× ×”×¨×ª ×˜×¨×•×¨ ×—×“×©×” ×‘×’×‘×•×œ ×”×¦×¤×•×Ÿ",subtitle:"×”×× ×”×¨×” ×—×¦×ª×” ××ª×—×ª ×œ×§×• ×”×’×‘×•×œ",pressure:"\"× ×•×©× ×‘×™×˜×—×•×Ÿ ×œ××•××™ ×‘×¨××” ×”×’×‘×•×”×” ×‘×™×•×ª×¨. ××¦×¤×™× ×œ×¡×™×§×•×¨ ××œ×.\""},
    {id:3,origin:"political",from:"×™×•×¢×¥ ×ª×§×©×•×¨×ª â€” ××¤×œ×’×ª ×”××•×¤×•×–×™×¦×™×”",headline:"×—\"×› ××”××•×¤×•×–×™×¦×™×”: '×©×¨ ×”××•×¦×¨ ×—×™×™×‘ ×œ×”×ª×¤×˜×¨'",subtitle:"×‘×¢×§×‘×•×ª ×—×©×“ ×œ× ×™×’×•×“ ×¢× ×™×™× ×™×",pressure:"\"××’×™×¢ ×œ× ×• ×›×•×ª×¨×ª. ×”×¦×™×‘×•×¨ ×—×™×™×‘ ×œ×“×¢×ª ×¢×œ ×”×©×—×™×ª×•×ª.\""},
    {id:4,origin:"political",from:"×“×•×‘×¨×ª ××©×¨×“ ×”×—×™× ×•×š",headline:"×©×¨×ª ×”×—×™× ×•×š ××¦×™×’×” ×ª×•×›× ×™×ª ×—×“×©×” × ×’×“ ××œ×™××•×ª ×‘×‘×ª×™ ×¡×¤×¨",subtitle:"×ª×§×¦×™×‘ ×©×œ 200 ××™×œ×™×•×Ÿ â‚ª",pressure:"\"×”×©×¨×” ×”×©×§×™×¢×” ×‘×–×” ×—×•×“×©×™×. × ×•×“×” ×œ×›× ×¢×œ ×¡×™×§×•×¨ ×‘×•×œ×˜.\""},
    {id:5,origin:"political",from:"×™×—\"×¦×Ÿ ×©×œ ×‘×¢×œ ×”×•×Ÿ",headline:"×˜×™×™×§×•×Ÿ ×™×©×¨××œ×™ ×ª×•×¨× 50 ××™×œ×™×•×Ÿ â‚ª ×œ×‘×™×ª ×—×•×œ×™× ×‘×¤×¨×™×¤×¨×™×”",subtitle:"'×× ×™ ××—×–×™×¨ ×œ×—×‘×¨×”', ×××¨",pressure:"\"×”×ª×•×¨× ××‘×§×© ×¨××™×•×Ÿ ×¨××©×™ ×•×ª××•× ×” ×’×“×•×œ×”. ×™×© ×œ× ×• ××•×“×¢×•×ª ××¦×œ×›×.\""},
    {id:6,origin:"political",from:"×“×•×‘×¨ ×‘×™×˜×•×— ×œ××•××™",headline:"×‘×™×˜×•×— ×œ××•××™: ×§×¦×‘×ª ×”×–×§× ×” ×ª×¢×œ×” ×‘-5% ××™× ×•××¨",subtitle:"×¢×œ×™×™×” ×©×œ 300 â‚ª ×œ×—×•×“×©",pressure:"\"×¤×¨×¡×•× ×—×©×•×‘. 800,000 ××–×¨×—×™× ×™×™×”× ×• ××–×”.\""},
    // === MEDIA INBOX ===
    {id:7,origin:"media",from:"×›×ª×‘ ×—×§×™×¨×•×ª",headline:"×—×§×™×¨×”: ×—×‘×¨×ª ×ª×¨×•×¤×•×ª ××›×¨×” ×ª×¨×•×¤×•×ª ×¤×’×•×ª ×ª×•×§×£ ×œ×§×©×™×©×™×",subtitle:"××¡××›×™× ×—×•×©×¤×™×: 3 ×©× ×™× ×©×œ ×”×•× ××”",pressure:"×—×§×™×¨×” ×©×œ 6 ×—×•×“×©×™×. ×¨××™×•×ª ××•×¦×§×•×ª."},
    {id:8,origin:"media",from:"×›×ª×‘ ×©×˜×— â€” ×¦×¤×•×Ÿ",headline:"×©×¨×™×¤×” ×’×“×•×œ×” ×‘×’×œ×™×œ: 3 ×™×™×©×•×‘×™× ×¤×•× ×•",subtitle:"12 ×¦×•×•×ª×™ ×›×™×‘×•×™ ×‘×–×™×¨×”, 2 ×¤×¦×•×¢×™×",pressure:"××™×¨×•×¢ ×©×•×˜×£ â€” ×—×™×™×‘×™× ×œ×“×•×•×—."},
    {id:9,origin:"media",from:"×›×ª×‘×ª ×›×œ×›×œ×”",headline:"×”×‘×•×¨×¡×” ×§×¨×¡×”: ×™×¨×™×“×•×ª ×©×œ 7% ×‘××“×“ ×ª\"× 35",subtitle:"×”×¡×™×‘×”: ×—×©×© ×××™×ª×•×Ÿ ×¢×•×œ××™",pressure:"××¨×•×¢ ×›×œ×›×œ×™ ×—×¨×™×’, ××©×¤×™×¢ ×¢×œ ×›×•×œ×."},
    {id:10,origin:"media",from:"×›×ª×‘ ××©×¤×˜",headline:"×‘×™×ª ×”××©×¤×˜ ×–×™×›×” ×—×©×•×“ ×‘×¨×¦×— ××—×¨×™ 12 ×©× ×” ×‘×›×œ×",subtitle:"'×—×™×™ × ×”×¨×¡×•', ×××¨ ×‘×‘×›×™",pressure:"×¡×™×¤×•×¨ ×× ×•×©×™ ××˜×œ×˜×œ, ×¨××™×•×ª DNA ×—×“×©×•×ª."},
    {id:11,origin:"media",from:"×›×ª×‘×ª ×—×™× ×•×š",headline:"××—×§×¨: 40% ××ª×œ××™×“×™ ×™×©×¨××œ ×œ× ××‘×™× ×™× ×˜×§×¡×˜ ×‘×¡×™×¡×™",subtitle:"×™×©×¨××œ ×‘××§×•× 35 ×-40 ×‘××“×™× ×•×ª OECD",pressure:"×“×•\"×— ×—×©×•×‘ ×©××¦×‘×™×¢ ×¢×œ ×›×©×œ ×—×™× ×•×›×™."},
    {id:12,origin:"media",from:"×¢×•×¨×š ×—×“×©×•×ª ×—×•×¥",headline:"×¨×¢×™×“×ª ××“××” ×§×˜×œ× ×™×ª ×‘×™×¤×Ÿ: ×××•×ª ×”×¨×•×’×™×",subtitle:"××’× ×™×˜×•×“×” 7.8, ×¦×•× ×××™ ×¤×’×¢ ×‘×—×•×¤×™×",pressure:"××™×¨×•×¢ ×‘×™× ×œ××•××™ ×—××•×¨."},
    // === PUBLIC INBOX ===
    {id:13,origin:"public",from:"×˜×¨× ×“ ×‘×˜×•×•×™×˜×¨ (#×™×•×§×¨_×”××—×™×”)",headline:"×”×¤×’× ×ª ×¢× ×§ ×‘×ª\"×: 80,000 × ×’×“ ×™×•×§×¨ ×”××—×™×”",subtitle:"'×× ×—× ×• ×œ× ××’×™×¢×™× ×œ×¡×•×£ ×”×—×•×“×©'",pressure:"100,000 ×©×™×ª×•×¤×™× ×‘×©×¢×”. ×›×œ ×”×¨×©×ª×•×ª ××“×‘×¨×•×ª ×¢×œ ×–×”."},
    {id:14,origin:"public",from:"×¢×¦×•××” â€” 50,000 ×—×ª×™××•×ª",headline:"×”×•×¨×™× ×“×•×¨×©×™×: ×—×™× ×•×š ×—×™× × ××’×™×œ 0",subtitle:"×¢×¦×•××” ×©×”×’×™×¢×” ×œ-50,000 ×—×ª×™××•×ª ×‘×™×•××™×™×",pressure:"50,000 ×—×ª×™××•×ª. ×”× ×•×©× ×¨×•×ª×— ×‘×¨×©×ª×•×ª."},
    {id:15,origin:"public",from:"×¡×¨×˜×•×Ÿ ×•×™×¨××œ×™ â€” 2M ×¦×¤×™×•×ª",headline:"×¡×¨×˜×•×Ÿ: ×©×•×˜×¨ ××›×” ×¦×¢×™×¨ ×‘×”×¤×’× ×” â€” 2 ××™×œ×™×•×Ÿ ×¦×¤×™×•×ª",subtitle:"×”××©×˜×¨×” ×¤×ª×—×” ×‘×—×§×™×¨×” ×¤× ×™××™×ª",pressure:"×”×¡×¨×˜×•×Ÿ ×‘×›×œ ××§×•×. ××™ ××¤×©×¨ ×œ×”×ª×¢×œ×."},
    {id:16,origin:"public",from:"××¨×’×•×Ÿ '××“× ×˜×‘×¢ ×•×“×™×Ÿ'",headline:"×“×•\"×—: ××¤×¨×¥ ×—×™×¤×” â€” ×¨×™×›×•×– ××–×”××™× 10 ×¤×¢××™× ××”××•×ª×¨",subtitle:"×ª×•×©×‘×™×: '×™×œ×“×™× ×• ×—×•×œ×™×'",pressure:"×”××¨×’×•×Ÿ ×¤×¨×¡× ××¡×™×‘×ª ×¢×™×ª×•× ××™×. ×ª×•×©×‘×™× ×××™×™××™× ×‘×ª×‘×™×¢×”."},
    {id:17,origin:"public",from:"×§×‘×•×¦×ª ×¤×™×™×¡×‘×•×§ â€” 200K ×—×‘×¨×™×",headline:"××—××ª × ×›×™×: '×”×§×¦×‘×” ×œ× ××¡×¤×™×§×” ×œ×—×™×•×ª ×‘×›×‘×•×“'",subtitle:"×—×¡××• ×¦××ª×™× ×‘×¨×—×‘×™ ×”××¨×¥",pressure:"×§×‘×•×¦×” ×©×œ 200,000 ×—×‘×¨×™×. ×”× ×•×©× ×œ× ×™×•×¨×“ ××”×¨×©×ª×•×ª."},
    {id:18,origin:"public",from:"×¦×™×•×¥ ×•×™×¨××œ×™",headline:"× ×¢×¨×” ×‘×ª 14 ×¤×¨×¡××” ××›×ª×‘: '×”××•×¨×” ×”×¦×™×œ×” ×œ×™ ××ª ×”×—×™×™×'",subtitle:"×¡×™×¤×•×¨ ××¨×’×© ×©×”×¤×š ×•×™×¨××œ×™",pressure:"500K ×œ×™×™×§×™×. ×× ×©×™× ×‘×•×›×™× ×•××©×ª×¤×™×."},
  ]
}
];

function pickRandomPool(){return ALL_POOLS[Math.floor(Math.random()*ALL_POOLS.length)]}
// ============ STATE ============
const S={mode:"landing",studentName:"",teacherName:"",sessionId:"",pool:null,selectedIds:[],slotAssignments:{},justifications:{},rejectedReason:"",awarenessAnswer:"",submissions:[]};
const SLOTS=[{id:"main",label:"×›×•×ª×¨×ª ×¨××©×™×ª",cls:"main-slot"},{id:"sec1",label:"××©× ×™×ª ×¢×œ×™×•× ×”",cls:"sec-slot"},{id:"sec2",label:"××©× ×™×ª ×ª×—×ª×•× ×”",cls:"sec-slot"},{id:"small1",label:"×™×“×™×¢×” ×§×˜× ×” 1",cls:"small-slot"},{id:"small2",label:"×™×“×™×¢×” ×§×˜× ×” 2",cls:"small-slot"}];
const esc=s=>{const d=document.createElement('div');d.textContent=s;return d.innerHTML};
const hDate=()=>new Date().toLocaleDateString("he-IL",{weekday:"long",year:"numeric",month:"long",day:"numeric"});
const getN=id=>S.pool?.news?.find(n=>n.id===id);
const selNews=()=>S.selectedIds.map(id=>getN(id)).filter(Boolean);
const assIds=()=>new Set(Object.values(S.slotAssignments));
const allFilled=()=>SLOTS.every(s=>S.slotAssignments[s.id]);
function encodeToHash(d){try{return btoa(unescape(encodeURIComponent(JSON.stringify(d))))}catch(e){return""}}
function decodeFromHash(h){try{return JSON.parse(decodeURIComponent(escape(atob(h))))}catch(e){return null}}
function getBaseUrl(){return window.location.href.split('#')[0]}
function checkUrl(){const h=window.location.hash.substring(1);if(h&&h.length>10){const d=decodeFromHash(h);if(d&&d.pool&&d.session)return d}return null}
function saveToFirebase(data){if(!db||!S.sessionId)return Promise.resolve();const key=S.studentName.replace(/[.#$/[\]]/g,'_');return db.ref(`agenda2/${S.sessionId}/submissions/${key}`).set(data).catch(e=>console.warn(e))}
function loadSubmissions(){if(!db||!S.sessionId)return Promise.resolve([]);return db.ref(`agenda2/${S.sessionId}/submissions`).once('value').then(snap=>{const v=snap.val();return v?Object.values(v):[]}).catch(()=>[])}

function render(){document.getElementById("app").innerHTML=S.mode==="landing"?renderLanding():S.mode==="teacher"?renderTeacher():S.mode==="teacher-view"?renderTeacherView():S.mode==="student-name"?renderStudentName():renderApp();attachEvents()}

function renderTheory(){return`<div class="theory-accordion" id="theoryAcc"><button class="theory-toggle" onclick="document.getElementById('theoryAcc').classList.toggle('open')"><span>ğŸ“– ××”×• ×¡×“×¨ ×™×•× ×ª×§×©×•×¨×ª×™? (×”×’×“×¨×” ××ª×›× ×™×ª ×”×œ×™××•×“×™×)</span><span class="chevron">â–¼</span></button><div class="theory-body">${THEORY_HTML}</div></div>`}

function renderLanding(){return`<div class="landing"><div class="landing-logo">ğŸ“‹</div><h1>×¡×“×¨ ×”×™×•×</h1><div class="tagline">××™ ×§×•×‘×¢ ×¢×œ ××” × ×—×©×•×‘? ×¡×™××•×œ×¦×™×™×ª ×¡×“×¨ ×™×•× ×ª×§×©×•×¨×ª×™</div><div class="credit">×¤×™×ª×•×— ×”×¡×™××•×œ×¦×™×”: ×¨× ×™ ×‘×Ÿ ×–××‘</div><div class="landing-card"><div class="ci">ğŸ‘¨â€ğŸ«</div><h2>××–×•×¨ ××•×¨×”</h2><p>×›×œ ×ª×œ××™×“ ×™×§×‘×œ 18 ×™×“×™×¢×•×ª ×-3 ×ª×™×‘×•×ª ×œ×—×¥: ×¤×•×œ×™×˜×™, ×ª×§×©×•×¨×ª×™, ×¦×™×‘×•×¨×™. ×”×•× ×™×‘×—×¨ 5 ×•×™×¡×“×¨ ××•×ª×Ÿ ×‘×“×£ ×”×‘×™×ª â€” ×”×”×©×•×•××” ×”×›×™×ª×ª×™×ª ×ª×—×©×•×£ ×œ××™ "× ×›× ×¢×ª×".</p><ol><li>×”×–×Ÿ ×©× â†’ ×¦×•×¨ ×ª×¨×’×™×œ</li><li>×©×œ×— ×§×™×©×•×¨ ×œ×ª×œ××™×“×™×</li><li>×¦×¤×” ×‘×”×’×©×•×ª ×•×”×©×•×•×”</li></ol><button class="lbtn" data-action="goto-teacher">×™×¦×™×¨×ª ×ª×¨×’×™×œ ×œ×›×™×ª×” â†’</button><p class="landing-hint">ğŸ’¡ ×”×ª×œ××™×“×™× ××§×‘×œ×™× ×§×™×©×•×¨ ×™×©×™×¨</p></div><div class="landing-footer">×¡×™××•×œ×¦×™×™×ª ×¡×“×¨ ×™×•× ×ª×§×©×•×¨×ª×™ â€¢ ×ª×§×©×•×¨×ª ×•×—×‘×¨×”</div></div>`}

function renderTeacher(){const has=!!S.pool;
  const prev=has?`<div style="margin-top:10px;background:#fff;border-radius:var(--rl);padding:10px;border:1px solid var(--bl);max-height:180px;overflow-y:auto">${S.pool.news.map(n=>`<div class="np-item"><span style="color:${OC[n.origin].color};font-weight:600;font-size:.68rem">${OC[n.origin].icon}</span> <strong style="font-size:.78rem">${esc(n.headline)}</strong></div>`).join("")}</div>`:"";
  const sL=S.sessionId?getBaseUrl()+"#"+encodeToHash({pool:S.pool,teacher:S.teacherName,session:S.sessionId}):"";
  const tL=S.sessionId?getBaseUrl()+"#"+encodeToHash({teacherView:true,teacher:S.teacherName,session:S.sessionId,pool:S.pool}):"";
  const lH=S.sessionId?`<div class="link-result"><h3>âœ… ××•×›×Ÿ!</h3><p style="font-size:.76rem;color:#555;text-align:center;margin-bottom:4px"><strong>×œ×ª×œ××™×“×™×:</strong></p><textarea class="link-url" id="studentLink" readonly>${sL}</textarea><div class="link-actions"><button class="copy-btn" data-action="copy-student-link">ğŸ“‹ ×”×¢×ª×§</button></div><p style="font-size:.76rem;color:#555;text-align:center;margin:6px 0 3px"><strong>×œ××•×¨×”:</strong></p><textarea class="link-url" id="teacherLink" readonly>${tL}</textarea><div class="link-actions"><button class="copy-btn" data-action="copy-teacher-link">ğŸ“‹ ×”×¢×ª×§</button><button class="new-btn" data-action="regenerate">ğŸ”„ ×™×•× ××—×¨</button></div></div>`:"";
  return`<div class="container" style="max-width:620px;margin-top:22px"><div class="credit-bar">×¤×™×ª×•×— ×”×¡×™××•×œ×¦×™×”: ×¨× ×™ ×‘×Ÿ ×–××‘</div><button class="btn btn-muted" data-action="goto-landing" style="margin-bottom:10px;font-size:.78rem">â†’ ×—×–×¨×”</button><div class="info-box"><h2>ğŸ‘¨â€ğŸ« ×™×¦×™×¨×ª ×ª×¨×’×™×œ ×¡×“×¨ ×™×•×</h2><p>18 ×™×“×™×¢×•×ª ×-3 ×ª×™×‘×•×ª ×œ×—×¥. ×›×œ ×ª×œ××™×“ ×™×‘×—×¨ 5 ×•×™×¡×“×¨ ×‘×“×£ ×”×‘×™×ª.</p></div><div style="background:#fff;border-radius:var(--rl);padding:14px 18px;border:1px solid var(--bl)"><label style="font-size:.81rem;font-weight:700;font-family:var(--fu);display:block;margin-bottom:3px">×©× ×”××•×¨×”</label><input type="text" class="modal-input" id="teacherNameInput" value="${esc(S.teacherName)}" style="text-align:center;font-family:var(--fd);font-weight:700;margin-bottom:7px"><button class="modal-btn primary" data-action="generate-pool">ğŸ² ×¦×•×¨ ×‘×•×§×¨ ×—×“×©×•×ª×™</button></div>${prev}${lH}</div>`}

function renderStudentName(){return`<div class="modal-overlay"><div class="modal-card" style="text-align:center"><div style="font-size:2.6rem;margin-bottom:4px">ğŸ“‹</div><h2>×¡×“×¨ ×”×™×•×</h2><div class="modal-sub">××™ ×§×•×‘×¢ ×¢×œ ××” × ×—×©×•×‘?<br><span style="font-size:.72rem;color:#b0a898">×¤×™×ª×•×— ×”×¡×™××•×œ×¦×™×”: ×¨× ×™ ×‘×Ÿ ×–××‘${S.teacherName?' â€¢ ××•×¨×”: '+esc(S.teacherName):''}</span></div><div class="instructions-box" style="text-align:right;margin-bottom:10px"><h3>ğŸ“‹ ××” ×¢×•×©×™×?</h3><ol><li>×ª×§×‘×œ×• 3 "×ª×™×‘×•×ª ×“×•××¨" ×¢× ×™×“×™×¢×•×ª â€” ×›×œ ×ª×™×‘×” ×××§×•×¨ ××—×¨</li><li>×ª×‘×—×¨×• 5 ×™×“×™×¢×•×ª ×œ×“×£ ×”×‘×™×ª ×©×œ ××ª×¨ ×”×—×“×©×•×ª ×©×œ×›×</li><li>×ª×¡×“×¨×•: ××” ×¨××©×™, ××” ×§×˜×Ÿ</li><li>×ª×¡×‘×™×¨×• ××ª ×”×”×—×œ×˜×•×ª ×©×œ×›×</li><li>×ª×’×œ×•: ×œ××™ "× ×›× ×¢×ª×"?</li></ol></div><label style="text-align:right;font-size:.81rem;font-weight:700;font-family:var(--fu);display:block">×”×©× ×©×œ×š</label><input type="text" class="modal-input" id="nameInput" placeholder="×©× ××œ×..." style="text-align:center;font-family:var(--fd);font-weight:700" autofocus><button class="modal-btn primary" id="startBtn" disabled data-action="start-exercise">×”×ª×—×œ/×™ â†</button></div></div>`}

function renderApp(){return renderHeader()+renderPhase()}
function renderHeader(){const phases=[{id:"inbox",l:"â‘  ×ª×™×‘×•×ª"},{id:"select",l:"â‘¡ ×‘×—×™×¨×”"},{id:"arrange",l:"â‘¢ ×¡×™×“×•×¨"},{id:"justify",l:"â‘£ × ×™××•×§×™×"},{id:"reveal",l:"â‘¤ ×—×©×™×¤×”"}];const order=["inbox","select","arrange","justify","reveal"];const ci=order.indexOf(S.mode);const pills=phases.map(p=>{const i=order.indexOf(p.id);let c="phase-pill";if(p.id===S.mode)c+=" active";else if(i<ci)c+=" done";return`<div class="${c}">${p.l}</div>`}).join("");return`<div class="app-header"><div class="header-brand"><span class="logo">ğŸ“‹</span><div><h1>×¡×“×¨ ×”×™×•×</h1><div class="meta">${esc(S.studentName)}</div></div></div><div class="phase-indicators">${pills}</div></div><div class="container"><div class="credit-bar">×¤×™×ª×•×— ×”×¡×™××•×œ×¦×™×”: ×¨× ×™ ×‘×Ÿ ×–××‘</div></div>`}
function renderPhase(){switch(S.mode){case"inbox":return renderInbox();case"select":return renderSelect();case"arrange":return renderArrange();case"justify":return renderJustify();case"reveal":return renderReveal();default:return""}}

function renderInbox(){
  const groups={political:[],media:[],public:[]};S.pool.news.forEach(n=>groups[n.origin]?.push(n));
  const renderCol=(key)=>{const o=OC[key];const items=groups[key]||[];return`<div class="inbox-col ${o.cls}"><div class="inbox-header ${o.cls}"><span class="ih-icon">${o.icon}</span><span class="ih-title">${o.label}</span><span class="ih-count">${items.length}</span></div>${items.map(n=>`<div class="inbox-item"><div class="ii-from ${o.cls}">${esc(n.from)}</div><h4>${esc(n.headline)}</h4><div class="ii-sub">${esc(n.subtitle)}</div><div class="ii-pressure">"${esc(n.pressure)}"</div></div>`).join("")}</div>`};
  return`<div class="container">${renderTheory()}<div class="info-box"><h2>×©×œ×‘ 1: ×”×›×™×¨×• ××ª ×”×ª×™×‘×•×ª</h2><p>××ª× ×¢×•×¨×›×™ ××ª×¨ ×—×“×©×•×ª. ×”×’×¢×ª× ×œ×¢×‘×•×“×” ×‘×‘×•×§×¨ ×•××—×›×•×ª ×œ×›× <strong>3 ×ª×™×‘×•×ª ×“×•××¨</strong> ×¢× ×™×“×™×¢×•×ª. ×©×™××• ×œ×‘: <strong>×›×œ ×ª×™×‘×” ××™×™×¦×’×ª ×¡×“×¨ ×™×•× ××—×¨</strong> â€” ×•×œ×›×œ ×©×•×œ×— ×™×© ××™× ×˜×¨×¡ ×©×”×™×“×™×¢×” ×©×œ×• ×ª×•×¤×™×¢.</p><p style="margin-top:4px">ğŸ›ï¸ <strong style="color:var(--pol)">×¤×•×œ×™×˜×™</strong> â€” ×¤×•×œ×™×˜×™×§××™× ×•×™×—"×¦× ×™× ×“×•×—×¤×™× × ×•×©××™× &nbsp; ğŸ“º <strong style="color:var(--med)">×ª×§×©×•×¨×ª×™</strong> â€” ×”×›×ª×‘×™× ×©×œ×›× ×”×‘×™××• ××”×©×˜×— &nbsp; ğŸ‘¥ <strong style="color:var(--pub)">×¦×™×‘×•×¨×™</strong> â€” ××” ×©×”×¦×™×‘×•×¨ ××“×‘×¨ ×¢×œ×™×•</p></div><div class="inbox-grid">${renderCol("political")}${renderCol("media")}${renderCol("public")}</div><div class="btn-center"><button class="btn btn-accent" data-action="goto-select">×§×¨××ª×™ ×”×›×œ, ×××©×™×š ×œ×‘×—×™×¨×” â†</button></div></div>`}

function renderSelect(){
  const cnt=S.selectedIds.length;
  const groups={political:[],media:[],public:[]};S.pool.news.forEach(n=>groups[n.origin]?.push(n));
  const renderCol=(key)=>{const o=OC[key];const items=groups[key]||[];return`<div class="inbox-col ${o.cls}"><div class="inbox-header ${o.cls}"><span class="ih-icon">${o.icon}</span><span class="ih-title">${o.label}</span></div>${items.map(n=>{const sel=S.selectedIds.includes(n.id);const dis=cnt>=5&&!sel;const rank=sel?S.selectedIds.indexOf(n.id)+1:0;return`<div class="inbox-item ${sel?'selected':''} ${dis?'disabled':''}" data-action="toggle-select" data-id="${n.id}">${rank?`<div class="ni-rank">${rank}</div>`:''}<div class="ii-from ${o.cls}">${esc(n.from)}</div><h4>${esc(n.headline)}</h4><div class="ii-sub">${esc(n.subtitle)}</div></div>`}).join("")}</div>`};
  return`<div class="container">${renderTheory()}<div class="info-box"><h2>×©×œ×‘ 2: ×‘×—×¨×• 5 ×™×“×™×¢×•×ª ×œ×“×£ ×”×‘×™×ª</h2><p>××ª×•×š 18 ×™×“×™×¢×•×ª ×-3 ×ª×™×‘×•×ª â€” ×¨×§ 5 ×™×™×›× ×¡×•. <strong>××” ×©×ª×‘×—×¨×• = ××” ×©×”×¦×™×‘×•×¨ ×™×“×¢. ××” ×©×œ× = ×œ× ×§×¨×”.</strong></p><p style="margin-top:3px">×—×©×‘×•: ××ª× ×‘×•×—×¨×™× ×›×™ ×–×” <strong>×‘×××ª ×—×©×•×‘</strong>, ××• ×›×™ ××™×©×”×• <strong>×œ×—×¥ ×¢×œ×™×›×</strong>?</p><div class="counter-badge ${cnt===5?'ok':'inc'}">× ×‘×—×¨×• ${cnt} ××ª×•×š 5</div></div><div class="inbox-grid">${renderCol("political")}${renderCol("media")}${renderCol("public")}</div>${cnt===5?'<div class="btn-center"><button class="btn btn-accent" data-action="goto-arrange">×”××©×š ×œ×¡×™×“×•×¨ â†</button></div>':''}<div class="btn-center"><button class="btn btn-muted" data-action="goto-inbox">â†’ ×—×–×¨×”</button></div></div>`}

function renderArrange(){
  const unass=selNews().filter(n=>!assIds().has(n.id));
  const sidebar=unass.map(n=>{const o=OC[n.origin];return`<div class="drag-item" draggable="true" data-news-id="${n.id}" style="border-right-color:${o.color}"><div style="font-size:.64rem;font-weight:600;color:${o.color};font-family:var(--fu)">${o.icon} ${o.label}</div><h4 style="font-family:var(--fd);font-size:.78rem;font-weight:700;line-height:1.25">${esc(n.headline)}</h4></div>`}).join("");
  const placed=selNews().filter(n=>assIds().has(n.id));
  const placedSidebar=placed.map(n=>`<div class="drag-item placed" style="border-right-color:#ccc"><h4 style="font-family:var(--fd);font-size:.72rem;color:#aaa;font-weight:400">${esc(n.headline)}</h4></div>`).join("");
  const slotsHtml=SLOTS.map(slot=>{const nid=S.slotAssignments[slot.id];const news=nid?getN(nid):null;
    if(news){const o=OC[news.origin];return`<div class="hp-slot filled ${slot.cls}" data-slot-id="${slot.id}"><button class="remove-btn" data-action="remove-slot" data-slot="${slot.id}">âœ•</button><div class="filled-origin" style="background:${o.color}">${o.icon} ${o.label}</div><div class="filled-headline">${esc(news.headline)}</div><div class="filled-sub">${esc(news.subtitle)}</div></div>`}
    return`<div class="hp-slot ${slot.cls}" data-slot-id="${slot.id}" data-action="drop-zone"><div class="slot-label">${slot.label}</div></div>`}).join("");
  return`<div class="container"><div class="info-box"><h2>×©×œ×‘ 3: ×¡×“×¨×• ××ª ×“×£ ×”×‘×™×ª</h2><p>×’×¨×¨×• ×™×“×™×¢×•×ª ×œ××©×‘×¦×•×ª. <strong>×›×›×œ ×©×”×™×“×™×¢×” ×‘×•×œ×˜×ª ×™×•×ª×¨ â€” ×”×™× × ×ª×¤×¡×ª ×›×—×©×•×‘×” ×™×•×ª×¨.</strong></p></div><div style="display:flex;gap:14px;flex-wrap:wrap"><div style="flex:0 0 220px"><div style="background:#fff;border-radius:10px;padding:8px;border:1px solid var(--bl)"><label style="font-size:.78rem;font-weight:700;font-family:var(--fu);display:block;margin-bottom:4px">×™×“×™×¢×•×ª (${unass.length} ×œ×©×™×‘×•×¥)</label>${sidebar||'<div style="text-align:center;color:#aaa;font-size:.74rem;padding:6px">âœ… ×”×›×œ ×©×•×‘×¥</div>'}${placedSidebar}</div></div><div style="flex:1;min-width:0"><div class="hp-frame"><div class="hp-header"><div class="hp-date">${hDate()}</div><h2>×“×£ ×”×‘×™×ª</h2></div>${slotsHtml}</div></div></div>${allFilled()?'<div class="btn-center"><button class="btn btn-accent" data-action="goto-justify">×”××©×š ×œ× ×™××•×§×™× â†</button></div>':''}<div class="btn-center"><button class="btn btn-muted" data-action="goto-select">â†’ ×—×–×¨×”</button></div></div>`}

function renderJustify(){
  const mainN=getN(S.slotAssignments.main);
  const cards=SLOTS.map(slot=>{const news=getN(S.slotAssignments[slot.id]);if(!news)return'';const o=OC[news.origin];return`<div class="justify-card"><div style="display:flex;gap:5px;align-items:center;margin-bottom:3px"><span style="background:${o.color};color:#fff;padding:1px 8px;border-radius:10px;font-size:.68rem;font-family:var(--fu)">${slot.label}</span><span style="font-size:.68rem;color:${o.color};font-weight:600">${o.icon} ${o.label}</span></div><h4>${esc(news.headline)}</h4><div style="font-size:.72rem;color:#999;font-style:italic;margin-bottom:4px">×©×•×œ×—: ${esc(news.from)}${news.pressure?' â€” "'+esc(news.pressure)+'"':''}</div><textarea class="justify-textarea" data-jk="${slot.id}" placeholder="${slot.id==='main'?'×œ××” ×–×• ×”×›×•×ª×¨×ª ×”×¨××©×™×ª? ×”×× ×‘×—×¨×ª ×›×™ ×–×” ×—×©×•×‘ ××• ×›×™ ××™×©×”×• ×œ×—×¥?':'×œ××” ×”×™×“×™×¢×” ×”×–×• ×‘×“×£ ×”×‘×™×ª?'}">${esc(S.justifications[slot.id]||'')}</textarea></div>`}).join("");
  const rejCount=S.pool.news.length-5;
  return`<div class="container">${renderTheory()}<div class="info-box"><h2>×©×œ×‘ 4: × ××§×• ××ª ×”×”×—×œ×˜×•×ª</h2><p>×¢×›×©×™×• ×”×¡×‘×™×¨×• â€” <strong>×œ××” ×‘×—×¨×ª× ××” ×©×‘×—×¨×ª×?</strong> ×©×™××• ×œ×‘ ×œ×©××œ×”: ×‘×—×¨×ª× ×›×™ ×–×” ×‘×××ª ×—×©×•×‘, ××• ×›×™ ××™×©×”×• ×“×—×£?</p></div>${cards}<div style="background:#fffaf0;border:1px solid #f0e0c0;border-radius:var(--rl);padding:14px 18px;margin-bottom:14px"><h3 style="font-size:.9rem;color:#c07000;font-family:var(--fu);margin-bottom:6px">ğŸ¤” ${rejCount} ×™×“×™×¢×•×ª × ×©××¨×• ×‘×—×•×¥ â€” ×”×¦×™×‘×•×¨ ×œ× ×™×™×“×¢ ×¢×œ×™×”×Ÿ</h3><textarea class="justify-textarea" id="rejectedReasonInput" placeholder="×”×¡×‘×™×¨×•: ××” × ×©××¨ ×‘×—×•×¥ ×•×œ××”? ××™ ×™×™×¤×’×¢ ××›×š ×©×”×¦×™×‘×•×¨ ×œ× ×™×“×¢?">${esc(S.rejectedReason)}</textarea></div><div class="btn-center"><button class="btn btn-muted" data-action="goto-arrange">â†’ ×—×–×¨×”</button><button class="btn btn-accent" data-action="goto-reveal">×—×©×™×¤×” ×•×©×œ×™×—×” â†</button></div></div>`}

function renderReveal(){
  const originCount={political:0,media:0,public:0};selNews().forEach(n=>{originCount[n.origin]++});
  const mainN=getN(S.slotAssignments.main);const mainO=mainN?OC[mainN.origin]:null;
  const chips=Object.entries(originCount).map(([k,c])=>{const o=OC[k];return`<div class="origin-chip ${o.cls}">${o.icon} ${o.label}: ${c}</div>`}).join("");
  const dominant=Object.entries(originCount).sort((a,b)=>b[1]-a[1])[0];const domO=OC[dominant[0]];
  const hpPreview=SLOTS.map(slot=>{const news=getN(S.slotAssignments[slot.id]);if(!news)return'';const o=OC[news.origin];return`<div class="hp-slot filled ${slot.cls}"><div class="filled-origin" style="background:${o.color}">${o.icon} ${o.label}</div><div class="filled-headline">${esc(news.headline)}</div><div class="filled-sub">${esc(news.subtitle)}</div></div>`}).join("");
  return`<div class="container"><div style="background:#fff;border-radius:var(--rl);padding:12px 18px;margin-bottom:14px;border:1px solid var(--bl);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px"><div><h2 style="font-family:var(--fd);font-size:1.08rem">ğŸ“‹ ×“×£ ×”×‘×™×ª ×©×œ×™</h2><p style="font-size:.78rem;color:var(--muted)">${esc(S.studentName)}</p></div><div style="display:flex;gap:6px"><button class="btn btn-muted" data-action="goto-justify" style="padding:6px 11px;font-size:.78rem">â†’ ×—×–×¨×”</button><button class="btn btn-dark" data-action="submit-work" style="padding:6px 11px;font-size:.78rem">ğŸ“¤ ×©×œ×—</button><button class="btn btn-accent" data-action="print" style="padding:6px 11px;font-size:.78rem">ğŸ–¨ï¸</button></div></div>
    <div class="hp-frame"><div class="hp-header"><div class="hp-date">${hDate()}</div><h2>×“×£ ×”×‘×™×ª</h2></div>${hpPreview}</div>
    <div class="impact-box"><h3>××™ ×§×‘×¢ ××ª ×¡×“×¨ ×”×™×•× ×©×œ×š?</h3><p style="font-size:.82rem;color:#555;margin-bottom:8px">××ª×•×š 5 ×™×“×™×¢×•×ª ×©×‘×—×¨×ª:</p><div class="origin-bar">${chips}</div>
    ${mainO?`<p style="font-size:.84rem;margin-top:8px"><strong>×”×›×•×ª×¨×ª ×”×¨××©×™×ª ×©×œ×š ×”×’×™×¢×” ×:</strong> <span style="color:${mainO.color};font-weight:700">${mainO.icon} ${mainO.label}</span></p>`:''}
    <p style="font-size:.84rem;margin-top:6px"><strong>×¡×“×¨ ×”×™×•× ×”×“×•××™× × ×˜×™:</strong> <span style="color:${domO.color};font-weight:700">${domO.icon} ${domO.label} (${dominant[1]} ××ª×•×š 5)</span></p>
    <div style="margin-top:10px;padding:10px 14px;background:#fef2f2;border-radius:8px;font-size:.84rem"><strong>ğŸ¤” ×©××œ×” ×œ×—×©×™×‘×”:</strong> ×”×× ×‘×—×¨×ª ××ª ×”×™×“×™×¢×•×ª ×›×™ ×”×Ÿ <strong>×‘×××ª ×—×©×•×‘×•×ª</strong>, ××• ×›×™ ××™×©×”×• <strong>×¨×¦×” ×©×ª×‘×—×¨ ××•×ª×Ÿ</strong>? ×”×× ×”×œ×—×¥ ×©×œ ×”×©×•×œ×— ×”×©×¤×™×¢ ×¢×œ×™×š?</div></div>
    <div class="info-box"><h3 style="font-family:var(--fd);margin-bottom:6px">ğŸ“ ×”× ×™××•×§×™× ×©×œ×™</h3>${SLOTS.map(slot=>{const news=getN(S.slotAssignments[slot.id]);const j=S.justifications[slot.id];if(!news||!j)return'';const o=OC[news.origin];return`<div style="margin-bottom:5px;padding:5px 10px;background:#faf9f5;border-radius:5px;border-right:3px solid ${o.color}"><strong style="font-size:.82rem">${slot.label}: ${esc(news.headline)}</strong><p style="font-size:.8rem;color:#666;margin-top:1px">${esc(j)}</p></div>`}).join("")}${S.rejectedReason?`<div style="margin-top:6px;padding:5px 10px;background:#fffaf0;border-radius:5px;border-right:3px solid #f59e0b"><strong style="font-size:.82rem">××” × ×©××¨ ×‘×—×•×¥:</strong><p style="font-size:.8rem;color:#666;margin-top:1px">${esc(S.rejectedReason)}</p></div>`:''}</div></div>`}

// ============ TEACHER VIEW ============
function renderTeacherView(){
  if(!S.submissions.length)return`<div class="container" style="max-width:900px;margin-top:22px"><div class="credit-bar">×¤×™×ª×•×— ×”×¡×™××•×œ×¦×™×”: ×¨× ×™ ×‘×Ÿ ×–××‘</div><button class="btn btn-muted" data-action="goto-landing" style="margin-bottom:10px;font-size:.78rem">â†’ ×—×–×¨×”</button><div class="info-box"><h2>ğŸ“Š ×”×’×©×•×ª â€” ${esc(S.teacherName)}</h2><p>0 ×”×’×©×•×ª â€¢ <button class="btn btn-dark" data-action="refresh-subs" style="padding:4px 9px;font-size:.74rem">ğŸ”„ ×¨×¢× ×Ÿ</button></p></div><div style="text-align:center;padding:30px;color:var(--muted)">ğŸ“­ <h3>×¢×“×™×™×Ÿ ××™×Ÿ ×”×’×©×•×ª</h3></div></div>`;

  // Origin distribution across class
  const classOrigins={political:0,media:0,public:0};let totalPicks=0;
  S.submissions.forEach(sub=>{(sub.selectedIds||[]).forEach(id=>{const n=S.pool.news.find(x=>x.id===id);if(n){classOrigins[n.origin]++;totalPicks++}})});
  const originBars=Object.entries(OC).map(([k,o])=>{const cnt=classOrigins[k];const pct=totalPicks?Math.round(cnt/totalPicks*100):0;return`<div style="margin-bottom:6px"><div style="display:flex;justify-content:space-between;font-size:.8rem"><span style="color:${o.color};font-weight:600">${o.icon} ${o.label}</span><span>${cnt} ×‘×—×™×¨×•×ª (${pct}%)</span></div><div style="height:5px;background:#f0f0f0;border-radius:3px"><div style="height:100%;width:${pct}%;background:${o.color};border-radius:3px"></div></div></div>`}).join("");

  // News popularity
  const newsPop={};S.pool.news.forEach(n=>{newsPop[n.id]={news:n,count:0,mainCount:0}});
  S.submissions.forEach(sub=>{(sub.selectedIds||[]).forEach(id=>{if(newsPop[id])newsPop[id].count++});if((sub.slotAssignments||{}).main&&newsPop[(sub.slotAssignments||{}).main])newsPop[(sub.slotAssignments||{}).main].mainCount++});
  const sorted=Object.values(newsPop).sort((a,b)=>b.count-a.count);
  const popHtml=sorted.filter(p=>p.count>0).map(p=>{const pct=Math.round(p.count/S.submissions.length*100);const o=OC[p.news.origin];return`<div style="margin-bottom:4px"><div style="display:flex;justify-content:space-between;font-size:.76rem"><span>${o.icon} <span style="color:${o.color}">${esc(p.news.headline.substring(0,40))}${p.news.headline.length>40?'...':''}</span></span><span style="color:#888">${p.mainCount>0?`<span style="color:var(--accent);font-weight:700">${p.mainCount}Ã— ×¨××©×™×ª</span> â€¢ `:''}${p.count}/${S.submissions.length}</span></div><div style="height:3px;background:#f0f0f0;border-radius:3px"><div style="height:100%;width:${pct}%;background:${o.color};border-radius:3px"></div></div></div>`}).join("");
  const invisible=sorted.filter(p=>p.count===0);
  const invisHtml=invisible.length?`<div class="info-box" style="background:#fffaf0;border-color:#f0e0c0"><h3 style="font-family:var(--fd);color:#c07000;margin-bottom:4px">ğŸ‘» ×™×“×™×¢×•×ª ×©××£ ××—×“ ×œ× ×‘×—×¨</h3>${invisible.map(p=>{const o=OC[p.news.origin];return`<div style="font-size:.78rem;margin-bottom:2px;color:#888">${o.icon} ${esc(p.news.headline)}</div>`}).join("")}</div>`:'';

  const subCards=S.submissions.map(sub=>{
    const sa=sub.slotAssignments||{};const oc={political:0,media:0,public:0};
    (sub.selectedIds||[]).forEach(id=>{const n=S.pool.news.find(x=>x.id===id);if(n)oc[n.origin]++});
    const miniHp=SLOTS.map(slot=>{const nid=sa[slot.id];const news=nid?S.pool.news.find(n=>n.id===nid):null;if(!news)return'';const o=OC[news.origin];return`<div class="mh-item ${slot.id==='main'?'mh-main':slot.cls==='sec-slot'?'mh-sec':'mh-small'}"><span style="color:${o.color};font-size:.62rem;font-weight:600">${o.icon}</span> ${esc(news.headline)}</div>`}).join("");
    const justHtml=SLOTS.map(slot=>{const nid=sa[slot.id];const news=nid?S.pool.news.find(n=>n.id===nid):null;const j=(sub.justifications||{})[slot.id];if(!news||!j)return'';const o=OC[news.origin];return`<div style="font-size:.76rem;padding:3px 8px;background:#faf9f5;border-radius:4px;margin-bottom:2px;border-right:2px solid ${o.color}"><strong>${slot.label}:</strong> ${esc(j)}</div>`}).join("");
    const dom=Object.entries(oc).sort((a,b)=>b[1]-a[1])[0];const domO=OC[dom[0]];
    return`<div class="sub-card"><div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:4px"><h4>ğŸ‘¤ ${esc(sub.studentName)}</h4><span style="background:${domO.color};color:#fff;padding:1px 8px;border-radius:10px;font-size:.68rem;font-family:var(--fu)">×“×•××™× × ×˜×™: ${domO.icon} ${domO.label}</span></div><div class="sub-meta">${sub.timestamp?new Date(sub.timestamp).toLocaleString("he-IL"):''} â€¢ ğŸ›ï¸${oc.political} ğŸ“º${oc.media} ğŸ‘¥${oc.public}</div><div class="mini-hp">${miniHp}</div>${justHtml}${sub.rejectedReason?`<div style="font-size:.74rem;padding:3px 8px;background:#fffaf0;border-radius:4px;border-right:2px solid #f59e0b"><strong>×‘×—×•×¥:</strong> ${esc(sub.rejectedReason)}</div>`:''}</div>`}).join("");

  return`<div class="container" style="max-width:900px;margin-top:22px"><div class="credit-bar">×¤×™×ª×•×— ×”×¡×™××•×œ×¦×™×”: ×¨× ×™ ×‘×Ÿ ×–××‘</div><button class="btn btn-muted" data-action="goto-landing" style="margin-bottom:10px;font-size:.78rem">â†’ ×—×–×¨×”</button><div class="info-box"><h2>ğŸ“Š ×”×’×©×•×ª â€” ${esc(S.teacherName)}</h2><p>${S.submissions.length} ×”×’×©×•×ª â€¢ <button class="btn btn-dark" data-action="refresh-subs" style="padding:4px 9px;font-size:.74rem">ğŸ”„ ×¨×¢× ×Ÿ</button></p></div>
    <div class="info-box"><h3 style="font-family:var(--fd);margin-bottom:6px">ğŸ›ï¸ğŸ“ºğŸ‘¥ ××™ ×§×‘×¢ ××ª ×¡×“×¨ ×”×™×•× ×©×œ ×”×›×™×ª×”?</h3>${originBars}</div>
    <div class="info-box"><h3 style="font-family:var(--fd);margin-bottom:6px">ğŸ“Š ×¤×•×¤×•×œ×¨×™×•×ª ×”×™×“×™×¢×•×ª</h3>${popHtml}</div>${invisHtml}${subCards}</div>`}

// ============ EVENTS ============
function attachEvents(){
  const ni=document.getElementById("nameInput"),sb=document.getElementById("startBtn");
  if(ni&&sb){ni.addEventListener("input",()=>{sb.disabled=!ni.value.trim()});ni.addEventListener("keydown",e=>{if(e.key==="Enter"&&ni.value.trim()){S.studentName=ni.value.trim();S.mode="inbox";render()}});sb.addEventListener("click",()=>{if(ni.value.trim()){S.studentName=ni.value.trim();S.mode="inbox";render()}});ni.focus()}
  const ti=document.getElementById("teacherNameInput");if(ti)ti.addEventListener("input",()=>{S.teacherName=ti.value});
  const ri=document.getElementById("rejectedReasonInput");if(ri)ri.addEventListener("input",()=>{S.rejectedReason=ri.value});
  document.querySelectorAll(".justify-textarea[data-jk]").forEach(t=>t.addEventListener("input",()=>{S.justifications[t.dataset.jk]=t.value}));
  // Drag
  document.querySelectorAll(".drag-item:not(.placed)").forEach(item=>{item.addEventListener("dragstart",e=>{e.dataTransfer.setData("text/plain",item.dataset.newsId);item.style.opacity=".5"});item.addEventListener("dragend",()=>{item.style.opacity=""})});
  document.querySelectorAll("[data-action='drop-zone']").forEach(zone=>{zone.addEventListener("dragover",e=>{e.preventDefault();zone.classList.add("drag-over")});zone.addEventListener("dragleave",()=>zone.classList.remove("drag-over"));zone.addEventListener("drop",e=>{e.preventDefault();zone.classList.remove("drag-over");const nid=parseInt(e.dataTransfer.getData("text/plain"));const sid=zone.dataset.slotId;if(nid&&sid){Object.keys(S.slotAssignments).forEach(k=>{if(S.slotAssignments[k]===nid)delete S.slotAssignments[k]});S.slotAssignments[sid]=nid;render()}})});
  document.removeEventListener("click",handleAction);document.addEventListener("click",handleAction);
}

async function handleAction(e){
  const el=e.target.closest("[data-action]");if(!el)return;const a=el.dataset.action;
  if(a==="toggle-select"){const id=parseInt(el.dataset.id);const idx=S.selectedIds.indexOf(id);if(idx>=0){S.selectedIds.splice(idx,1);Object.keys(S.slotAssignments).forEach(k=>{if(S.slotAssignments[k]===id)delete S.slotAssignments[k]})}else if(S.selectedIds.length<5)S.selectedIds.push(id);render();return}
  if(a==="remove-slot"){e.stopPropagation();delete S.slotAssignments[el.dataset.slot];render();return}
  if(a==="goto-landing"){S.mode="landing";render();return}
  if(a==="goto-teacher"){S.mode="teacher";render();return}
  if(a==="generate-pool"){if(!S.teacherName.trim()){alert("×”×–×Ÿ ×©×");return}S.pool=pickRandomPool();S.sessionId='ag2_'+Date.now().toString(36)+Math.random().toString(36).substr(2,4);render();return}
  if(a==="regenerate"){S.pool=pickRandomPool();S.sessionId='ag2_'+Date.now().toString(36)+Math.random().toString(36).substr(2,4);render();return}
  if(a==="copy-student-link"||a==="copy-teacher-link"){const id=a.includes("student")?"studentLink":"teacherLink";const ta=document.getElementById(id);if(ta){ta.select();try{await navigator.clipboard.writeText(ta.value)}catch(x){document.execCommand("copy")}el.textContent="âœ… ×”×•×¢×ª×§!";setTimeout(()=>{el.textContent="ğŸ“‹ ×”×¢×ª×§"},1800)}return}
  if(a==="submit-work"){const data={studentName:S.studentName,timestamp:new Date().toISOString(),selectedIds:[...S.selectedIds],slotAssignments:{...S.slotAssignments},justifications:{...S.justifications},rejectedReason:S.rejectedReason};await saveToFirebase(data);el.textContent="âœ… × ×©×œ×—!";el.style.background="#22c55e";setTimeout(()=>{el.textContent="ğŸ“¤ ×©×œ×—";el.style.background=""},2500);return}
  if(a==="refresh-subs"){S.submissions=await loadSubmissions();render();return}
  if(a==="print"){window.print();return}
  const nav={"goto-inbox":"inbox","goto-select":"select","goto-arrange":"arrange","goto-justify":"justify","goto-reveal":"reveal","start-exercise":"inbox"};
  if(nav[a]){S.mode=nav[a];render();window.scrollTo(0,0)}
}

const urlData=checkUrl();
if(urlData){if(urlData.teacherView){S.teacherName=urlData.teacher;S.sessionId=urlData.session;S.pool=urlData.pool;S.mode="teacher-view";loadSubmissions().then(subs=>{S.submissions=subs;render()})}else{S.pool=urlData.pool;S.teacherName=urlData.teacher;S.sessionId=urlData.session;S.mode="student-name"}}
render();
</script></body></html>
