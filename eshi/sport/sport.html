<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <title>Race Master Pro - 2000m</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --accent: #38bdf8;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --border: rgba(255, 255, 255, 0.1);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
      margin: 0; background: var(--bg); color: var(--text-main); 
      font-family: system-ui, -apple-system, sans-serif;
      padding-bottom: 120px;
    }

    /* Header & Navigation */
    header {
      padding: 20px; background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(12px); border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 50; text-align: center;
    }
    header h1 { margin: 0; font-size: 1.2rem; letter-spacing: 1px; color: var(--accent); }
    header span { font-size: 0.8rem; color: var(--text-muted); }

    main { padding: 15px; max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }

    /* Timer Section */
    .timer-card {
      background: linear-gradient(145deg, #1e293b, #0f172a);
      border: 1px solid var(--border); border-radius: 24px; padding: 30px 20px;
      text-align: center; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3);
    }
    .bigTimer {
      font-size: 4.5rem; font-weight: 900; font-family: 'Courier New', monospace;
      color: var(--text-main); text-shadow: 0 0 20px rgba(56, 189, 248, 0.2);
      line-height: 1; margin-bottom: 20px;
    }

    /* KPI Grid */
    .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .kpi-box {
      background: var(--card); border: 1px solid var(--border);
      padding: 12px; border-radius: 16px; text-align: center;
    }
    .kpi-num { font-size: 1.4rem; font-weight: bold; color: var(--accent); display: block; }
    .kpi-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; }

    /* Buttons */
    .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    button {
      border: 1px solid var(--border); background: rgba(255,255,255,0.05); color: var(--text-main);
      padding: 14px; border-radius: 14px; font-weight: 600; cursor: pointer;
      transition: all 0.2s ease; font-size: 0.9rem;
    }
    button:active { transform: scale(0.95); opacity: 0.8; }
    .btn-primary { background: var(--accent); color: #000; border: none; }
    .btn-danger { color: var(--danger); border-color: rgba(239, 68, 68, 0.2); }

    /* Results Table */
    .results-card { background: var(--card); border-radius: 20px; padding: 15px; border: 1px solid var(--border); }
    .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    
    .result-row {
      display: flex; align-items: center; padding: 15px 10px;
      border-bottom: 1px solid var(--border); animation: slideIn 0.3s ease-out;
    }
    .result-row:last-child { border-bottom: none; }
    .res-place { width: 40px; font-weight: bold; color: var(--text-muted); font-size: 0.8rem; }
    .res-info { flex: 1; }
    .res-name { display: block; font-weight: 600; font-size: 1rem; }
    .res-time { font-family: monospace; color: var(--accent); font-size: 1.1rem; font-weight: bold; }
    
    .input-pending {
      background: var(--warning); color: #000; border: none; border-radius: 8px;
      width: 80px; padding: 8px; font-weight: 900; text-align: center;
      box-shadow: 0 0 10px rgba(245, 158, 11, 0.4); animation: pulse 1.5s infinite;
    }

    /* Fixed Bottom Action Bar */
    .action-bar {
      position: fixed; bottom: 0; left: 0; right: 0; padding: 20px;
      background: linear-gradient(to top, var(--bg) 80%, transparent);
      z-index: 100;
    }
    .btn-finish-main {
      width: 100%; padding: 22px; border-radius: 20px; border: none;
      background: var(--success); color: #000; font-size: 1.4rem; font-weight: 800;
      box-shadow: 0 10px 30px rgba(34, 197, 94, 0.4);
      display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .btn-finish-main:disabled { background: #334155; color: #64748b; box-shadow: none; }

    /* Utilities */
    details { background: rgba(255,255,255,0.02); border-radius: 12px; padding: 10px; }
    summary { color: var(--text-muted); font-size: 0.8rem; cursor: pointer; }
    textarea { 
      width: 100%; background: #0f172a; border: 1px solid var(--border); 
      color: var(--text-main); border-radius: 12px; padding: 10px; margin: 10px 0;
    }

    @keyframes pulse {
      0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; }
    }
    @keyframes slideIn {
      from { transform: translateY(-10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  </style>
</head>
<body>

  <header>
    <h1>RACE MASTER PRO</h1>
    <span>注专转   专爪转 2000</span>
  </header>

  <main>
    <section class="timer-card">
      <div class="bigTimer" id="timer">00:00.0</div>
      <div class="btn-group">
        <button class="btn-primary" id="btnStart">拽</button>
        <button id="btnPause" disabled>注爪专/砖</button>
        <button class="btn-danger" id="btnReset" disabled>驻住 专抓</button>
        <button id="btnUndo" disabled> 爪</button>
      </div>
    </section>

    <div class="kpi-grid">
      <div class="kpi-box"><span class="kpi-num" id="kpiLoaded">0</span><span class="kpi-label">专砖</span></div>
      <div class="kpi-box"><span class="kpi-num" id="kpiFinished">0</span><span class="kpi-label">住</span></div>
      <div class="kpi-box"><span class="kpi-num" id="kpiUnknown">0</span><span class="kpi-label">转</span></div>
    </div>

    <section class="results-card">
      <div class="table-header">
        <h2 style="font-size: 1rem; margin: 0;">转爪转 转</h2>
        <button id="btnExport" style="font-size: 0.7rem; padding: 6px 12px;">爪 CSV</button>
      </div>
      <div id="resultsList">
        <div style="text-align: center; color: var(--text-muted); padding: 20px; font-size: 0.9rem;"> 转爪转 爪</div>
      </div>
    </section>

    <details>
      <summary>专转 注转 转</summary>
      <textarea id="csvText" rows="4" placeholder="住驻专,砖,转..."></textarea>
      <div class="btn-group">
        <button id="btnLoadCsv">注 专砖</button>
        <button id="btnSample">注 </button>
      </div>
    </details>
  </main>

  <div class="action-bar">
    <button class="btn-finish-main" id="btnLockTime" disabled>
        爪 拽 住 
    </button>
  </div>

<script>
(() => {
  const state = {
    students: new Map(),
    results: [], 
    race: { running: false, t0: null, pauseAt: null, pausedTotal: 0 }
  };

  const $ = (id) => document.getElementById(id);
  const pad2 = (n) => String(n).padStart(2,'0');

  function formatTime(ms){
    const tenths = Math.floor(ms / 100) % 10;
    const totalSec = Math.floor(ms / 1000);
    const m = Math.floor(totalSec / 60);
    const s = totalSec % 60;
    return `${pad2(m)}:${pad2(s)}.${tenths}`;
  }

  function nowRaceMs(){
    if(!state.race.t0) return 0;
    const now = performance.now();
    const base = (state.race.running ? now : state.race.pauseAt) - state.race.t0 - state.race.pausedTotal;
    return Math.max(0, base);
  }

  function addFinish() {
    if(!state.race.t0 || !state.race.running) return;
    if(navigator.vibrate) navigator.vibrate(60);

    const tms = nowRaceMs();
    const rec = {
      place: state.results.length + 1,
      number: "",
      name: "",
      class: "",
      timeStr: formatTime(tms)
    };

    state.results.push(rec);
    renderResults();

    setTimeout(() => {
        const inputs = document.querySelectorAll('.input-pending');
        if(inputs.length > 0) {
          inputs[0].focus();
          inputs[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }, 150);
  }

  window.updateNum = function(index, val) {
    const num = val.trim();
    const st = state.students.get(num);
    state.results[index].number = num;
    state.results[index].name = st ? st.name : (num ? " 爪" : "");
    state.results[index].class = st ? st.class : "";
    renderResults();
  };

  function renderResults() {
    const container = $("resultsList");
    if(state.results.length === 0) {
      container.innerHTML = `<div style="text-align: center; color: var(--text-muted); padding: 20px;"> 转爪转 爪</div>`;
      updateKPIs(); updateButtons(); return;
    }

    container.innerHTML = "";
    // 爪 砖 砖
    [...state.results].reverse().forEach((r, revIdx) => {
      const realIdx = state.results.length - 1 - revIdx;
      const div = document.createElement("div");
      div.className = "result-row";
      
      const content = r.name && r.name !== " 爪" 
        ? `<div class="res-info"><span class="res-name">${r.name} (${r.number})</span><small style="color:var(--text-muted)">${r.class}</small></div>`
        : `<div class="res-info"><input type="number" inputmode="numeric" class="input-pending" value="${r.number}" onchange="updateNum(${realIdx}, this.value)" placeholder="住驻专?"></div>`;
      
      div.innerHTML = `
        <div class="res-place">#${r.place}</div>
        ${content}
        <div class="res-time">${r.timeStr}</div>
      `;
      container.appendChild(div);
    });
    updateKPIs();
    updateButtons();
  }

  let rafId = null;
  function tick(){ $("timer").textContent = formatTime(nowRaceMs()); rafId = requestAnimationFrame(tick); }

  $("btnStart").addEventListener("click", () => {
    state.race = { running: true, t0: performance.now(), pauseAt: null, pausedTotal: 0 };
    tick(); updateButtons();
  });

  $("btnLockTime").addEventListener("click", addFinish);

  $("btnPause").addEventListener("click", () => {
    if(state.race.running) {
        state.race.running = false;
        state.race.pauseAt = performance.now();
        cancelAnimationFrame(rafId);
    } else {
        state.race.pausedTotal += performance.now() - state.race.pauseAt;
        state.race.running = true;
        tick();
    }
    updateButtons();
  });

  $("btnReset").addEventListener("click", () => {
    if(confirm("驻住 转  转爪转?")){
        state.race = { running: false, t0: null, pauseAt: null, pausedTotal: 0 };
        state.results = [];
        cancelAnimationFrame(rafId);
        $("timer").textContent = "00:00.0";
        renderResults();
    }
  });

  $("btnUndo").addEventListener("click", () => { state.results.pop(); renderResults(); });

  function updateKPIs(){
    $("kpiLoaded").textContent = state.students.size;
    $("kpiFinished").textContent = state.results.length;
    $("kpiUnknown").textContent = state.results.filter(r => !r.number || r.name === " 爪").length;
  }

  function updateButtons(){
    $("btnStart").disabled = state.race.running;
    $("btnLockTime").disabled = !state.race.running;
    $("btnPause").disabled = !state.race.t0;
    $("btnReset").disabled = !state.race.t0;
    $("btnUndo").disabled = state.results.length === 0;
    $("btnPause").textContent = state.race.running ? "注爪专" : "砖";
  }

  $("btnLoadCsv").addEventListener("click", () => {
    const text = $("csvText").value.trim();
    if(!text) return;
    const map = new Map();
    text.split("\n").forEach(line => {
        const [num, name, cls] = line.split(",").map(s => s?.trim());
        if(num && !isNaN(num)) map.set(num, {number: num, name: name||"?", class: cls||""});
    });
    state.students = map;
    updateKPIs();
    alert(`注 ${map.size} 转`);
  });

  $("btnSample").addEventListener("click", () => {
    $("csvText").value = "101, ,'3\n102,注专 ,'1\n103,专注 专,'2\n147, ,\"1";
  });

  $("btnExport").addEventListener("click", () => {
    let csv = "\uFEFFPlace,Number,Name,Class,Time\n";
    state.results.forEach(r => { csv += `${r.place},${r.number},"${r.name}","${r.class}",${r.timeStr}\n`; });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(new Blob([csv], {type: "text/csv"}));
    link.download = "results.csv"; link.click();
  });

})();
</script>
</body>
</html>