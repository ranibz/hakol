<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <title>Race Master Pro - 驻转 专  </title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --accent: #38bdf8;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --border: rgba(255, 255, 255, 0.1);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    body { 
      margin: 0; background: var(--bg); color: var(--text-main); 
      font-family: system-ui, -apple-system, sans-serif;
      padding-bottom: 130px;
    }

    header {
      padding: 20px 15px; background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(12px); border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 50; text-align: center;
    }
    header h1 { margin: 0; font-size: 1.3rem; color: var(--accent); letter-spacing: 1px; }
    .credit { font-size: 0.9rem; color: var(--text-main); margin-top: 5px; font-weight: 600; opacity: 0.9; }

    main { padding: 15px; max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; gap: 15px; }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 15px; }

    /* 住驻专 */
    .timer-card { text-align: center; background: linear-gradient(145deg, #1e293b, #0f172a); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .bigTimer {
      font-size: 4.2rem; font-weight: 900; font-family: monospace;
      color: var(--text-main); margin-bottom: 15px; text-shadow: 0 0 15px rgba(56, 189, 248, 0.3);
    }

    /* 驻转专 */
    .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    button {
      border: 1px solid var(--border); background: rgba(255,255,255,0.05); color: var(--text-main);
      padding: 14px; border-radius: 14px; font-weight: 600; cursor: pointer; transition: 0.2s;
    }
    button:active { transform: scale(0.96); }
    .btn-primary { background: var(--accent); color: #000; border: none; }
    .btn-success { background: var(--success); color: #000; border: none; }
    .btn-danger { color: var(--danger); border-color: rgba(239, 68, 68, 0.2); }
    .btn-full { grid-column: span 2; margin-top: 5px; }

    /* KPI */
    .kpi-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .kpi-box { background: var(--card); border: 1px solid var(--border); border-radius: 15px; padding: 10px; text-align: center; }
    .kpi-num { font-size: 1.3rem; font-weight: bold; color: var(--accent); display: block; }
    .kpi-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; }

    /* 专砖转 转爪转 */
    .result-item {
      display: flex; align-items: center; padding: 12px; margin-bottom: 10px;
      background: rgba(255,255,255,0.02); border-radius: 14px; border-right: 4px solid var(--accent);
      animation: fadeIn 0.3s ease;
    }
    .result-item.duplicate { border-right-color: var(--danger); background: rgba(239, 68, 68, 0.05); }
    .res-place { width: 35px; color: var(--text-muted); font-weight: bold; }
    .res-content { flex: 1; }
    .res-time { font-family: monospace; font-weight: bold; font-size: 1.1rem; color: var(--accent); }

    .input-num {
      width: 80px; background: var(--warning); color: #000; border: none;
      padding: 8px; border-radius: 8px; font-weight: 900; text-align: center; font-size: 1rem;
    }
    .input-num.error { background: var(--danger); color: #fff; animation: shake 0.4s; }

    /* 驻转专 拽 住 */
    .action-bar {
      position: fixed; bottom: 0; left: 0; right: 0; padding: 20px;
      background: linear-gradient(to top, var(--bg) 80%, transparent); z-index: 100;
    }
    .btn-finish {
      width: 100%; padding: 22px; border-radius: 20px; border: none;
      background: var(--success); color: #000; font-size: 1.5rem; font-weight: 800;
      box-shadow: 0 8px 30px rgba(34, 197, 94, 0.4);
    }
    .btn-finish:disabled { background: #334155; color: #64748b; box-shadow: none; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
  </style>
</head>
<body>

  <header>
    <h1>RACE MASTER PRO</h1>
    <div class="credit">驻转: 专  </div>
  </header>

  <main>
    <section class="card timer-card">
      <div class="bigTimer" id="timer">00:00.0</div>
      <div class="btn-grid">
        <button class="btn-primary" id="btnStart">拽</button>
        <button id="btnPause" disabled>注爪专</button>
        <button id="btnUndo" disabled> 爪</button>
        <button class="btn-danger" id="btnReset" disabled>驻住 </button>
        <button class="btn-success btn-full" id="btnNewHeat"> 拽爪 砖 (驻住 )</button>
      </div>
    </section>

    <div class="kpi-row">
      <div class="kpi-box"><span class="kpi-num" id="kpiLoaded">0</span><span class="kpi-label">专砖</span></div>
      <div class="kpi-box"><span class="kpi-num" id="kpiFinished">0</span><span class="kpi-label">住</span></div>
      <div class="kpi-box"><span class="kpi-num" id="kpiUnknown">0</span><span class="kpi-label">转</span></div>
    </div>

    <section class="card">
      <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
        <h2 style="margin:0; font-size:1rem;">转爪转 拽爪</h2>
        <button id="btnExport" style="font-size:0.75rem; padding:6px 12px; background: var(--accent); color:#000; border:none;">爪 拽住</button>
      </div>
      <div id="resultsList">
        <div style="text-align:center; color:var(--text-muted); padding:20px;"> 转爪转 拽爪 </div>
      </div>
    </section>

    <details style="color:var(--text-muted); font-size:0.8rem;">
      <summary style="cursor:pointer">注转 专砖转 转 / 注专</summary>
      <textarea id="csvText" rows="4" style="width:100%; margin-top:10px; background:#000; color:#fff; border:1px solid var(--border); border-radius:8px; padding:10px;" placeholder="住驻专,砖,转..."></textarea>
      <div class="btn-grid" style="margin-top:10px;">
        <button id="btnLoadCsv">注 专砖</button>
        <button id="btnSample">注 </button>
      </div>
    </details>
  </main>

  <div class="action-bar">
    <button class="btn-finish" id="btnLockTime" disabled> 拽砖 拽 住 </button>
  </div>

<script>
(() => {
  const state = {
    students: new Map(),
    results: [], 
    race: { running: false, t0: null, pauseAt: null, pausedTotal: 0 }
  };

  const $ = (id) => document.getElementById(id);

  // --- 拽爪 砖 ---
  function initNewHeat() {
    if (state.results.length > 0 || state.race.t0) {
      if (!confirm(" 转 拽爪 砖?  转爪转 转 拽 (专砖转 转 转砖专).")) return;
    }
    
    // 驻住 转
    state.results = [];
    state.race = { running: false, t0: null, pauseAt: null, pausedTotal: 0 };
    
    // 注爪专转 砖注
    cancelAnimationFrame(rafId);
    
    // 驻住 UI
    $("timer").textContent = "00:00.0";
    localStorage.removeItem('race_results');
    renderResults();
    updateButtons();
    
    if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
  }

  // --- 拽 ---
  function addFinish() {
    if(!state.race.t0 || !state.race.running) return;
    if(navigator.vibrate) navigator.vibrate(60);

    const tms = nowRaceMs();
    state.results.push({
      place: state.results.length + 1,
      number: "", name: "", class: "",
      timeStr: formatTime(tms),
      isDuplicate: false
    });
    
    renderResults();
    saveToLocal();
    
    // 驻拽住  拽转 住驻专
    setTimeout(() => {
      const inputs = document.querySelectorAll('.input-num');
      if(inputs.length > 0) { inputs[0].focus(); inputs[0].scrollIntoView({behavior:'smooth', block:'center'}); }
    }, 150);
  }

  window.updateNum = function(index, val) {
    const num = val.trim();
    if (num === "") return;

    const isDuplicate = state.results.some((r, i) => r.number === num && i !== index);
    const st = state.students.get(num);
    
    state.results[index].number = num;
    state.results[index].name = st ? st.name : " 爪";
    state.results[index].class = st ? st.class : "";
    state.results[index].isDuplicate = isDuplicate;

    renderResults();
    saveToLocal();
  };

  function renderResults() {
    const container = $("resultsList");
    if(state.results.length === 0) {
      container.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding:20px;"> 转爪转 拽爪 </div>`;
    } else {
      container.innerHTML = "";
      [...state.results].reverse().forEach((r, revIdx) => {
        const realIdx = state.results.length - 1 - revIdx;
        const div = document.createElement("div");
        div.className = `result-item ${r.isDuplicate ? 'duplicate' : ''}`;
        
        const content = (r.name && r.name !== " 爪") 
          ? `<div class="res-content">
               <div style="font-weight:bold;">${r.name} ${r.isDuplicate ? '锔' : ''}</div>
               <div style="font-size:0.75rem; color:var(--text-muted)">${r.class} | 住' ${r.number}</div>
             </div>`
          : `<div class="res-content">
               <input type="number" inputmode="numeric" class="input-num ${r.isDuplicate ? 'error' : ''}" 
                      value="${r.number}" onchange="updateNum(${realIdx}, this.value)" placeholder="住驻专?">
             </div>`;

        div.innerHTML = `<div class="res-place">#${r.place}</div>${content}<div class="res-time">${r.timeStr}</div>`;
        container.appendChild(div);
      });
    }
    updateKPIs();
    updateButtons();
  }

  // ---   拽爪 ---
  function formatTime(ms){
    const tenths = Math.floor(ms / 100) % 10;
    const totalSec = Math.floor(ms / 1000);
    const m = Math.floor(totalSec / 60);
    const s = totalSec % 60;
    return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${tenths}`;
  }

  function nowRaceMs(){
    if(!state.race.t0) return 0;
    const now = performance.now();
    return Math.max(0, (state.race.running ? now : state.race.pauseAt) - state.race.t0 - state.race.pausedTotal);
  }

  function saveToLocal() { localStorage.setItem('race_results', JSON.stringify(state.results)); }

  $("btnExport").addEventListener("click", () => {
    if (state.results.length === 0) return;
    let csv = "\uFEFF拽,住驻专 转,砖,转, 住\n";
    state.results.forEach(r => { csv += `${r.place},${r.number},"${r.name}","${r.class}",${r.timeStr}\n`; });
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `转爪转_拽爪_${new Date().getHours()}_${new Date().getMinutes()}.csv`;
    link.click();
  });

  // --- 专注 ---
  let rafId = null;
  function tick(){ $("timer").textContent = formatTime(nowRaceMs()); rafId = requestAnimationFrame(tick); }

  $("btnStart").addEventListener("click", () => {
    state.race = { running: true, t0: performance.now(), pauseAt: null, pausedTotal: 0 };
    tick(); updateButtons();
  });

  $("btnLockTime").addEventListener("click", addFinish);
  $("btnNewHeat").addEventListener("click", initNewHeat);

  $("btnPause").addEventListener("click", () => {
    if(state.race.running) {
      state.race.running = false; state.race.pauseAt = performance.now(); cancelAnimationFrame(rafId);
    } else {
      state.race.pausedTotal += performance.now() - state.race.pauseAt;
      state.race.running = true; tick();
    }
    updateButtons();
  });

  $("btnReset").addEventListener("click", () => {
    if(confirm("驻住 专拽 转 住驻专? (转爪转 砖专 专砖 砖专)")) {
      state.race = { running: false, t0: null, pauseAt: null, pausedTotal: 0 };
      cancelAnimationFrame(rafId); $("timer").textContent = "00:00.0"; updateButtons();
    }
  });

  $("btnUndo").addEventListener("click", () => { state.results.pop(); renderResults(); saveToLocal(); });

  $("btnLoadCsv").addEventListener("click", () => {
    const text = $("csvText").value.trim();
    if(!text) return;
    text.split("\n").forEach(line => {
      const [num, name, cls] = line.split(",").map(s => s?.trim());
      if(num && !isNaN(num)) state.students.set(num, {number: num, name: name||"?", class: cls||""});
    });
    updateKPIs(); alert(`注 ${state.students.size} 转 注专转.`);
  });

  $("btnSample").addEventListener("click", () => {
    $("csvText").value = "101, ,'3\n102,注专 ,'1\n103,专注 专,'2\n147, ,\"1";
  });

  function updateKPIs(){
    $("kpiLoaded").textContent = state.students.size;
    $("kpiFinished").textContent = state.results.length;
    $("kpiUnknown").textContent = state.results.filter(r => !r.number || r.name === " 爪").length;
  }

  function updateButtons(){
    $("btnStart").disabled = state.race.running;
    $("btnLockTime").disabled = !state.race.running;
    $("btnPause").disabled = !state.race.t0;
    $("btnReset").disabled = !state.race.t0;
    $("btnUndo").disabled = state.results.length === 0;
    $("btnPause").textContent = state.race.running ? "注爪专" : "砖";
  }

  // 注 专砖转 专
  const saved = localStorage.getItem('race_results');
  if (saved) { state.results = JSON.parse(saved); renderResults(); }
})();
</script>
</body>
</html>