<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×©×¢×¨ ×‘×™×ª ×”×¡×¤×¨ â€” ××¡×š ×©×•××¨</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700;800&family=Secular+One&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#f1f5f9;--card:#ffffff;--border:#e2e8f0;
      --green:#059669;--orange:#d97706;--blue:#0284c7;
      --t1:#1e293b;--t2:#64748b;--t3:#94a3b8;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Rubik',sans-serif;background:var(--bg);color:var(--t1);min-height:100vh;direction:rtl}

    .header{background:#ffffff;border-bottom:1px solid var(--border);padding:14px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
    .header-logo{display:flex;align-items:center;gap:12px}
    .logo-icon{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--green),var(--blue));display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 4px 16px rgba(5,150,105,0.25)}
    .header h1{font-family:'Secular One',sans-serif;font-size:17px;color:var(--green)}
    .header p{color:var(--t3);font-size:11px}
    .header-controls{display:flex;align-items:center;gap:16px}
    .connection{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--t3)}
    .connection-dot{width:7px;height:7px;border-radius:50%;background:var(--t3);transition:all .3s}
    .connection-dot.online{background:var(--green);box-shadow:0 0 10px rgba(52,211,153,0.6)}
    .pending-counter{border-radius:12px;padding:8px 16px;display:flex;align-items:center;gap:8px}
    .pending-counter.active{background:rgba(5,150,105,0.1);border:1px solid rgba(5,150,105,0.25)}
    .pending-counter.inactive{background:var(--card);border:1px solid var(--border)}
    .pending-dot{width:8px;height:8px;border-radius:50%}
    .pending-dot.active{background:var(--green);box-shadow:0 0 12px rgba(52,211,153,0.5);animation:pulse 2s infinite}
    .pending-dot.inactive{background:var(--t3)}
    .pending-text{font-size:13px;font-weight:600}
    .pending-text.active{color:var(--green)}
    .pending-text.inactive{color:var(--t3)}

    .split-content{display:grid;grid-template-columns:1fr 1fr;gap:20px;max-width:1200px;margin:0 auto;padding:24px 16px 80px;position:relative;z-index:1;pointer-events:auto}
    @media(max-width:768px){.split-content{grid-template-columns:1fr}}

    .panel{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;min-height:300px;pointer-events:auto}
    .panel-header{font-size:17px;font-weight:700;margin-bottom:16px;padding-bottom:14px}
    .panel-header.green-h{color:var(--green);border-bottom:2px solid rgba(5,150,105,0.25)}
    .panel-header.orange-h{color:var(--orange);border-bottom:2px solid rgba(217,119,6,0.25)}

    .search-input{width:100%;padding:12px 16px;border-radius:12px;border:1px solid var(--border);background:var(--bg);color:var(--t1);font-size:14px;font-family:'Rubik',sans-serif;margin-bottom:14px;outline:none}
    .search-input:focus{border-color:var(--green)}
    .search-input::placeholder{color:var(--t3)}

    .section-label{font-size:12px;font-weight:600;margin-bottom:10px;letter-spacing:1px;text-transform:uppercase}
    .section-label.green{color:var(--green)}
    .section-label.muted{color:var(--t3);margin-top:16px}

    .release-card{padding:16px 18px;border-radius:14px;background:rgba(5,150,105,0.08);border:1.5px solid rgba(5,150,105,0.2);display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;animation:slideIn .4s ease;position:relative}
    .release-info{display:flex;align-items:center;gap:12px;flex:1;min-width:0}
    .release-avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#059669,#047857);display:flex;align-items:center;justify-content:center;font-size:18px;color:#fff;font-weight:700;box-shadow:0 4px 12px rgba(5,150,105,0.3);flex-shrink:0}
    .release-name{font-size:16px;font-weight:700}
    .release-details{color:var(--t2);font-size:13px;margin-top:3px}
    .release-time{color:var(--t3);font-size:11px;margin-top:2px}
    .exit-btn{background:linear-gradient(135deg,#059669,#047857);border:none;border-radius:12px;padding:11px 20px;color:#fff;cursor:pointer;font-size:14px;font-weight:700;font-family:'Rubik',sans-serif;transition:all .2s;white-space:nowrap;flex-shrink:0;position:relative;z-index:10;box-shadow:0 4px 12px rgba(5,150,105,0.4);pointer-events:auto;-webkit-tap-highlight-color:rgba(0,0,0,0.1)}
    .exit-btn:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(5,150,105,0.5)}
    .exit-btn:active{transform:scale(0.97);background:#047857}

    .guest-enter-btn{background:linear-gradient(135deg,#d97706,#b45309);border:none;border-radius:12px;padding:9px 16px;color:#fff;cursor:pointer;font-size:13px;font-weight:700;font-family:'Rubik',sans-serif;transition:all .2s;white-space:nowrap;flex-shrink:0;box-shadow:0 4px 12px rgba(217,119,6,0.3);pointer-events:auto;-webkit-tap-highlight-color:rgba(0,0,0,0.1);position:relative;z-index:10}
    .guest-enter-btn:hover{transform:translateY(-2px)}
    .guest-enter-btn:active{transform:scale(0.97);background:#b45309}
    .guest-entered{background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:9px 16px;color:var(--green);font-size:13px;font-weight:600;font-family:'Rubik',sans-serif}

    .exited-item{padding:10px 14px;border-radius:10px;background:var(--bg);border:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;font-size:13px;color:var(--t2)}

    .guest-card{padding:16px 18px;border-radius:14px;background:rgba(217,119,6,0.06);border:1.5px solid rgba(217,119,6,0.2);margin-bottom:10px;border-right:5px solid var(--orange)}
    .guest-name{font-size:16px;font-weight:700;color:var(--orange)}
    .guest-meta{color:var(--t2);font-size:13px;margin-top:6px;line-height:1.7}

    .empty-state{text-align:center;padding:40px 20px;background:var(--bg);border-radius:14px;border:1px solid var(--border)}
    .empty-state .icon{font-size:40px;margin-bottom:12px}
    .empty-state p{color:var(--t2);font-size:14px}

    .toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);border-radius:14px;padding:12px 28px;font-size:14px;font-weight:600;font-family:'Rubik',sans-serif;z-index:9999;pointer-events:none;animation:ti .35s ease}
    .toast-info{background:#dbeafe;border:1px solid #0284c7;color:var(--blue)}
    .toast-success{background:#d1fae5;border:1px solid #059669;color:var(--green)}

    .credit{position:fixed;bottom:0;left:0;right:0;text-align:center;padding:10px;background:#ffffff;border-top:1px solid var(--border);font-size:11px;color:var(--t3);z-index:100}
    .credit span{color:var(--green);font-weight:600}

    .hidden{display:none}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
    @keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
    @keyframes ti{from{opacity:0;transform:translateX(-50%) translateY(-16px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}

    .history-btn{background:rgba(2,132,199,0.08);border:1px solid rgba(2,132,199,0.2);border-radius:10px;padding:10px 18px;color:var(--blue);cursor:pointer;font-size:13px;font-weight:600;font-family:'Rubik',sans-serif;margin-top:16px}
    .history-btn:hover{background:rgba(56,189,248,0.2)}

    .modal-box{background:var(--card);border:1px solid #e2e8f0;box-shadow:0 20px 60px rgba(0,0,0,0.3);border-radius:18px;width:100%;max-width:600px;max-height:85vh;display:flex;flex-direction:column;overflow:hidden}
    .modal-header{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .modal-header h3{font-size:17px;font-weight:700}
    .modal-close{background:#fee2e2;border:1px solid #fca5a5;color:#ef4444;border-radius:10px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;font-family:'Rubik',sans-serif}
    .modal-body{padding:16px 20px;overflow-y:auto;flex:1}
    .date-input{padding:10px 16px;border-radius:12px;border:1px solid var(--border);background:var(--bg);color:var(--t1);font-size:14px;font-family:'Rubik',sans-serif;outline:none;direction:ltr}
    .export-btn{padding:10px 18px;border-radius:12px;border:none;background:rgba(5,150,105,0.1);color:var(--green);font-size:13px;font-weight:600;cursor:pointer;font-family:'Rubik',sans-serif}
  </style>
</head>
<body>
  <div id="toast" class="toast hidden"></div>

  <div class="header">
    <div class="header-logo"><div class="logo-icon">ğŸ›¡ï¸</div><div><h1>×©×¢×¨ ×‘×™×ª ×”×¡×¤×¨</h1><p>××¡×š ×©×•××¨</p></div></div>
    <div class="header-controls">
      <div class="connection"><div id="connectionDot" class="connection-dot"></div><span id="connectionText">××ª×—×‘×¨...</span></div>
      <div class="pending-counter inactive" id="pendingCounter"><div class="pending-dot inactive" id="pendingDot"></div><span class="pending-text inactive" id="pendingText">0 ×××ª×™× ×™×</span></div>
    </div>
  </div>

  <div class="split-content">
    <div class="panel">
      <div class="panel-header green-h">ğŸ“ ×ª×œ××™×“×™× ××©×•×—×¨×¨×™×</div>
      <input type="text" class="search-input" placeholder="ğŸ” ×—×™×¤×•×© ×ª×œ××™×“..." id="guardSearch" oninput="renderGuard()">
      <div class="section-label green">×××•×©×¨×™× ×œ×™×¦×™××”</div>
      <div id="pendingList"></div>
      <div id="exitedSection" class="hidden">
        <div class="section-label muted" id="exitedLabel">×™×¦××• ×”×™×•×</div>
        <div id="exitedList"></div>
      </div>
      <button class="history-btn" onclick="openHistoryModal()">ğŸ“œ ×”×™×¡×˜×•×¨×™×™×ª ×©×—×¨×•×¨×™×</button>
    </div>

    <div class="panel">
      <div class="panel-header orange-h">ğŸ‘¤ ××•×¨×—×™× ××•×–×× ×™× ×œ×”×™×•×</div>
      <div id="guestPanel"></div>
      <button class="history-btn" style="border-color:rgba(217,119,6,0.3);color:#d97706;background:rgba(217,119,6,0.08)" onclick="openGuestHistoryModal()">ğŸ“œ ×”×™×¡×˜×•×¨×™×™×ª ××•×–×× ×™×</button>
    </div>
  </div>

  <div id="historyModal" style="display:none"></div>
  <div id="guestHistoryModal" style="display:none"></div>
  <div class="credit">×¤×™×ª×•×— ×”××¤×œ×™×§×¦×™×” â€” <span>×¨× ×™ ×‘×Ÿ ×–××‘</span></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    var firebaseConfig={apiKey:"AIzaSyCSmwys1pNEEMu8oq4r_Q6sMtHEiba33pw",authDomain:"gmarlamed.firebaseapp.com",databaseURL:"https://gmarlamed-default-rtdb.firebaseio.com",projectId:"gmarlamed",storageBucket:"gmarlamed.firebasestorage.app",messagingSenderId:"287104553740",appId:"1:287104553740:web:ab36b987cf86f913c76f29"};
    firebase.initializeApp(firebaseConfig);
    var db=firebase.database(),releasesRef=db.ref('releases'),guestsRef=db.ref('guests');
    var releases={},guests={},previousPendingCount=0;

    db.ref('.info/connected').on('value',function(s){
      var d=document.getElementById('connectionDot'),t=document.getElementById('connectionText');
      if(s.val()===true){d.classList.add('online');t.textContent='××—×•×‘×¨ â€” ×–××Ÿ ×××ª';}
      else{d.classList.remove('online');t.textContent='×œ× ××—×•×‘×¨';}
    });

    releasesRef.on('value',function(s){
      releases=s.val()||{};
      var pc=getPending().length;
      if(pc>previousPendingCount&&previousPendingCount>=0){playAlert();var n=getPending()[0];if(n)showToast('ğŸ”” ×©×—×¨×•×¨ ×—×“×©: '+n[1].studentName,'success');}
      previousPendingCount=pc;renderGuard();
    });
    guestsRef.on('value',function(s){guests=s.val()||{};renderGuestPanel();});

    function getToday(){return new Date().toDateString();}
    function getTodayStr(){return new Date().toISOString().split('T')[0];}
    function getPending(){return Object.entries(releases).filter(function(e){return e[1].status==='pending'&&new Date(e[1].time).toDateString()===getToday();}).sort(function(a,b){return new Date(b[1].time)-new Date(a[1].time);});}
    function getExited(){return Object.entries(releases).filter(function(e){return e[1].status==='exited'&&new Date(e[1].time).toDateString()===getToday();}).sort(function(a,b){return new Date(b[1].exitTime||b[1].time)-new Date(a[1].exitTime||a[1].time);});}

    function renderGuard(){
      var search=document.getElementById('guardSearch').value;
      var pending=getPending().filter(function(e){return e[1].studentName.includes(search)||e[1].className.includes(search);});
      var exited=getExited();
      var allP=getPending();
      var counter=document.getElementById('pendingCounter'),dot=document.getElementById('pendingDot'),text=document.getElementById('pendingText');
      if(allP.length>0){counter.className='pending-counter active';dot.className='pending-dot active';text.className='pending-text active';text.textContent=allP.length+' ×××ª×™× ×™×';}
      else{counter.className='pending-counter inactive';dot.className='pending-dot inactive';text.className='pending-text inactive';text.textContent='0 ×××ª×™× ×™×';}

      var pl=document.getElementById('pendingList');
      if(pending.length===0){pl.innerHTML='<div class="empty-state"><div class="icon">âœ…</div><p>××™×Ÿ ×ª×œ××™×“×™× ×”×××ª×™× ×™× ×œ×™×¦×™××”</p></div>';}
      else{
        pl.innerHTML='';
        pending.forEach(function(entry){
          var id=entry[0],r=entry[1];
          var card=document.createElement('div');card.className='release-card';
          var info=document.createElement('div');info.className='release-info';
          info.innerHTML='<div class="release-avatar">'+r.studentName[0]+'</div><div><div class="release-name">'+r.studentName+'</div><div class="release-details">×›×™×ª×” '+r.className+' Â· '+r.reason+'</div><div class="release-time">×©×•×—×¨×¨ ×‘-'+formatTime(r.time)+'</div></div>';
          var btn=document.createElement('button');btn.className='exit-btn';btn.textContent='××™×©×•×¨ ×™×¦×™××” âœ“';
          btn.addEventListener('click',function(){markExited(id);});
          card.appendChild(info);card.appendChild(btn);pl.appendChild(card);
        });
      }

      var es=document.getElementById('exitedSection');
      if(exited.length>0){
        es.classList.remove('hidden');document.getElementById('exitedLabel').textContent='×™×¦××• ×”×™×•× ('+exited.length+')';
        var el=document.getElementById('exitedList');el.innerHTML='';
        exited.forEach(function(entry){var r=entry[1];var item=document.createElement('div');item.className='exited-item';
          item.innerHTML='<div style="display:flex;align-items:center;gap:8px"><span>âœ“</span><span>'+r.studentName+'</span><span style="color:var(--t3);font-size:11px">×›×™×ª×” '+r.className+'</span></div><span style="color:var(--t3);font-size:11px">×™×¦×/×” ×‘-'+(r.exitTime?formatTime(r.exitTime):'â€”')+'</span>';
          el.appendChild(item);});
      }else{es.classList.add('hidden');}
    }

    function markExited(id){var s=releases[id];releasesRef.child(id).update({status:'exited',exitTime:new Date().toISOString()}).then(function(){if(s)showToast(s.studentName+' ×™×¦×/×” ××”×©×¢×¨','info');});}

    function renderGuestPanel(){
      var panel=document.getElementById('guestPanel');var todayStr=getTodayStr();
      var todayGuests=Object.entries(guests).filter(function(e){return e[1].date===todayStr;}).sort(function(a,b){return(a[1].time||'').localeCompare(b[1].time||'');});
      if(todayGuests.length===0){panel.innerHTML='<div class="empty-state"><div class="icon">ğŸ‘¤</div><p>××™×Ÿ ××•×¨×—×™× ××•×–×× ×™× ×œ×”×™×•×</p></div>';return;}
      panel.innerHTML='';
      todayGuests.forEach(function(entry){
        var id=entry[0],g=entry[1];
        var card=document.createElement('div');
        card.className='guest-card';
        if(g.entered)card.style.opacity='0.6';
        var row=document.createElement('div');
        row.style.cssText='display:flex;align-items:center;justify-content:space-between;gap:12px';
        var info=document.createElement('div');
        info.style.flex='1';
        info.innerHTML='<div class="guest-name">ğŸ‘¤ '+g.name+'</div><div class="guest-meta">××–××™×Ÿ: '+g.inviter+' Â· ××˜×¨×”: '+g.purpose+'<br>ğŸ• '+g.time+'</div>';
        row.appendChild(info);
        if(g.entered){
          var badge=document.createElement('span');
          badge.className='guest-entered';
          badge.textContent='âœ“ × ×›× ×¡/×”';
          row.appendChild(badge);
        } else {
          var btn=document.createElement('button');
          btn.className='guest-enter-btn';
          btn.textContent='××™×©×•×¨ ×›× ×™×¡×” âœ“';
          btn.addEventListener('click',function(){markGuestEntered(id);});
          row.appendChild(btn);
        }
        card.appendChild(row);
        panel.appendChild(card);
      });
    }

    function markGuestEntered(id){
      guestsRef.child(id).update({entered:true,enteredTime:new Date().toISOString()}).then(function(){
        showToast('××•×¨×—/×ª × ×›× ×¡/×”','success');
      });
    }

    function openHistoryModal(){
      var modal=document.getElementById('historyModal');
      modal.style.cssText='display:flex;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:500;align-items:center;justify-content:center;padding:16px';
      modal.innerHTML='<div class="modal-box"><div class="modal-header"><h3>ğŸ“œ ×”×™×¡×˜×•×¨×™×™×ª ×©×—×¨×•×¨×™×</h3><button class="modal-close" onclick="closeHistoryModal()">âœ•</button></div><div class="modal-body"><div style="display:flex;gap:10px;align-items:center;margin-bottom:16px;flex-wrap:wrap"><span style="font-size:13px;color:var(--t2)">×ª××¨×™×š:</span><input type="date" class="date-input" id="histDate" value="'+getTodayStr()+'" onchange="renderHistoryModal()"><button class="export-btn" onclick="exportHistoryModal()">ğŸ“¥ ××§×¡×œ</button></div><div id="histList"></div></div></div>';
      renderHistoryModal();
    }
    function closeHistoryModal(){document.getElementById('historyModal').style.display='none';}

    function renderHistoryModal(){
      var dateStr=document.getElementById('histDate').value;var target=new Date(dateStr).toDateString();
      var items=Object.entries(releases).filter(function(e){return new Date(e[1].time).toDateString()===target;}).sort(function(a,b){return new Date(b[1].time)-new Date(a[1].time);});
      var list=document.getElementById('histList');
      if(items.length===0){list.innerHTML='<div class="empty-state"><div class="icon">ğŸ“­</div><p>××™×Ÿ ×©×—×¨×•×¨×™× ×œ×ª××¨×™×š ×–×”</p></div>';return;}
      list.innerHTML='<div style="margin-bottom:10px;font-size:14px;font-weight:600">'+items.length+' ×©×—×¨×•×¨×™×</div>'+items.map(function(e){var r=e[1];return'<div style="padding:12px 14px;border-radius:10px;background:var(--bg);border:1px solid var(--border);margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;font-size:13px"><div><span style="font-weight:600">'+r.studentName+'</span> <span style="color:var(--t3)">'+r.className+' Â· '+r.reason+'</span></div><div style="color:var(--t2);font-size:11px">'+formatTime(r.time)+(r.exitTime?' â†’ '+formatTime(r.exitTime):'')+'</div></div>';}).join('');
    }

    function exportHistoryModal(){
      var dateStr=document.getElementById('histDate').value;var target=new Date(dateStr).toDateString();
      var items=Object.entries(releases).filter(function(e){return new Date(e[1].time).toDateString()===target;}).sort(function(a,b){return new Date(b[1].time)-new Date(a[1].time);});
      if(items.length===0)return showToast('××™×Ÿ × ×ª×•× ×™×','info');
      var rows=[['×©×','×›×™×ª×”','×¡×™×‘×”','×©×¢×ª ×©×—×¨×•×¨','×©×¢×ª ×™×¦×™××”','×¡×˜×˜×•×¡']];
      items.forEach(function(e){var r=e[1];rows.push([r.studentName,r.className,r.reason,formatTime(r.time),r.exitTime?formatTime(r.exitTime):'â€”',r.status==='exited'?'×™×¦×/×”':'×××ª×™×Ÿ']);});
      var ws=XLSX.utils.aoa_to_sheet(rows);ws['!cols']=[{wch:20},{wch:10},{wch:16},{wch:10},{wch:10},{wch:10}];
      var wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'×©×—×¨×•×¨×™×');XLSX.writeFile(wb,'×©×—×¨×•×¨×™×_'+dateStr+'.xlsx');
    }

    // â”€â”€â”€ Guest History Modal â”€â”€â”€
    function openGuestHistoryModal(){
      var modal=document.getElementById('guestHistoryModal');
      modal.style.cssText='display:flex;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:500;align-items:center;justify-content:center;padding:16px';
      modal.innerHTML='<div class="modal-box"><div class="modal-header"><h3>ğŸ“œ ×”×™×¡×˜×•×¨×™×™×ª ××•×–×× ×™×</h3><button class="modal-close" onclick="closeGuestHistoryModal()">âœ•</button></div><div class="modal-body"><div style="display:flex;gap:10px;align-items:center;margin-bottom:16px;flex-wrap:wrap"><span style="font-size:13px;color:var(--t2)">×ª××¨×™×š:</span><input type="date" class="date-input" id="guestHistDate" value="'+getTodayStr()+'" onchange="renderGuestHistoryModal()"><button class="export-btn" onclick="exportGuestHistoryModal()">ğŸ“¥ ××§×¡×œ</button></div><div id="guestHistList"></div></div></div>';
      renderGuestHistoryModal();
    }
    function closeGuestHistoryModal(){document.getElementById('guestHistoryModal').style.display='none';}

    function renderGuestHistoryModal(){
      var dateStr=document.getElementById('guestHistDate').value;
      var items=Object.entries(guests).filter(function(e){return e[1].date===dateStr;}).sort(function(a,b){return(a[1].time||'').localeCompare(b[1].time||'');});
      var list=document.getElementById('guestHistList');
      if(items.length===0){list.innerHTML='<div class="empty-state"><div class="icon">ğŸ“­</div><p>××™×Ÿ ××•×–×× ×™× ×œ×ª××¨×™×š ×–×”</p></div>';return;}
      list.innerHTML='<div style="margin-bottom:10px;font-size:14px;font-weight:600">'+items.length+' ××•×–×× ×™×</div>'+items.map(function(e){
        var g=e[1];
        var status=g.entered?'<span style="color:var(--green);font-weight:600">âœ“ × ×›× ×¡/×”</span>':'<span style="color:var(--orange);font-weight:600">×××ª×™×Ÿ</span>';
        return'<div style="padding:12px 14px;border-radius:10px;background:var(--bg);border:1px solid var(--border);margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;font-size:13px"><div><span style="font-weight:600">'+g.name+'</span> <span style="color:var(--t3)">××–××™×Ÿ: '+g.inviter+' Â· '+g.purpose+'</span></div><div style="display:flex;align-items:center;gap:10px">'+status+'<span style="color:var(--t2);font-size:11px">ğŸ• '+g.time+'</span></div></div>';
      }).join('');
    }

    function exportGuestHistoryModal(){
      var dateStr=document.getElementById('guestHistDate').value;
      var items=Object.entries(guests).filter(function(e){return e[1].date===dateStr;}).sort(function(a,b){return(a[1].time||'').localeCompare(b[1].time||'');});
      if(items.length===0)return showToast('××™×Ÿ × ×ª×•× ×™×','info');
      var rows=[['×©× ××•×¨×—','××–××™×Ÿ','××˜×¨×”','×©×¢×”','× ×›× ×¡/×”','×©×¢×ª ×›× ×™×¡×”']];
      items.forEach(function(e){var g=e[1];rows.push([g.name,g.inviter,g.purpose,g.time,g.entered?'×›×Ÿ':'×œ×',g.enteredTime?formatTime(g.enteredTime):'â€”']);});
      var ws=XLSX.utils.aoa_to_sheet(rows);ws['!cols']=[{wch:20},{wch:16},{wch:16},{wch:8},{wch:8},{wch:10}];
      var wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'××•×–×× ×™×');XLSX.writeFile(wb,'××•×–×× ×™×_'+dateStr+'.xlsx');
    }

    function playAlert(){
      try{var c=new(window.AudioContext||window.webkitAudioContext)(),o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.frequency.value=800;o.type='sine';g.gain.setValueAtTime(.3,c.currentTime);g.gain.exponentialRampToValueAtTime(.01,c.currentTime+.5);o.start(c.currentTime);o.stop(c.currentTime+.5);setTimeout(function(){var o2=c.createOscillator(),g2=c.createGain();o2.connect(g2);g2.connect(c.destination);o2.frequency.value=1000;o2.type='sine';g2.gain.setValueAtTime(.3,c.currentTime);g2.gain.exponentialRampToValueAtTime(.01,c.currentTime+.3);o2.start(c.currentTime);o2.stop(c.currentTime+.3);},200);}catch(e){}
      document.body.style.transition='background .3s';document.body.style.background='#d1fae5';setTimeout(function(){document.body.style.background='var(--bg)';},600);
    }

    function formatTime(i){return new Date(i).toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'});}
    function showToast(m,t){var e=document.getElementById('toast');e.className='toast toast-'+t;e.textContent=m;e.classList.remove('hidden');setTimeout(function(){e.classList.add('hidden');},3500);}
    renderGuard();
  </script>
</body>
</html>
