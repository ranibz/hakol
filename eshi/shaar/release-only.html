<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×©×—×¨×•×¨ ×ª×œ××™×“×™×</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700;800&family=Secular+One&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0e1a; --card: rgba(22,28,45,0.7); --card-h: rgba(30,38,60,0.8);
      --blue: #00d4ff; --purple: #b44dff; --pink: #ff6bb5; --green: #00e676; --orange: #ffab40; --yellow: #ffe040; --red: #ff5252; --teal: #1de9b6;
      --t1: #eef2ff; --t2: #8892b0; --t3: #4a5578; --border: rgba(136,146,176,0.08);
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Rubik',sans-serif;background:var(--bg);color:var(--t1);min-height:100vh;direction:rtl;overflow-x:hidden}
    body::before{content:'';position:fixed;top:-50%;right:-30%;width:80vw;height:80vw;border-radius:50%;background:radial-gradient(circle,rgba(0,212,255,0.12) 0%,transparent 60%);animation:bgF 20s ease-in-out infinite;pointer-events:none}
    body::after{content:'';position:fixed;bottom:-40%;left:-20%;width:60vw;height:60vw;border-radius:50%;background:radial-gradient(circle,rgba(180,77,255,0.1) 0%,transparent 60%);animation:bgF 25s ease-in-out infinite reverse;pointer-events:none}
    @keyframes bgF{0%,100%{transform:translate(0,0) scale(1)}33%{transform:translate(5%,8%) scale(1.05)}66%{transform:translate(-3%,-5%) scale(0.95)}}

    .header{background:rgba(10,14,26,0.85);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:14px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
    .header-logo{display:flex;align-items:center;gap:12px}
    .logo-icon{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--blue),var(--purple));display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 4px 20px rgba(0,212,255,0.25)}
    .header h1{font-family:'Secular One',sans-serif;font-size:17px;background:linear-gradient(135deg,var(--blue),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .header p{color:var(--t3);font-size:11px}
    .header-controls{display:flex;align-items:center;gap:12px}
    .connection{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--t3)}
    .connection-dot{width:7px;height:7px;border-radius:50%;background:var(--t3);transition:all .3s}
    .connection-dot.online{background:var(--green);box-shadow:0 0 10px rgba(0,230,118,0.6)}
    .tab-buttons{display:flex;gap:4px}
    .tab-btn{background:transparent;border:1px solid transparent;border-radius:10px;padding:8px 14px;color:var(--t3);cursor:pointer;font-size:12px;font-weight:500;font-family:'Rubik',sans-serif;position:relative;transition:all .25s}
    .tab-btn.active{background:linear-gradient(135deg,rgba(0,212,255,0.1),rgba(180,77,255,0.08));border-color:rgba(0,212,255,0.2);color:var(--blue)}
    .tab-btn .badge{position:absolute;top:-5px;left:-5px;background:linear-gradient(135deg,var(--pink),var(--purple));color:#fff;border-radius:10px;font-size:10px;font-weight:700;padding:2px 7px}

    .content{max-width:620px;margin:0 auto;padding:24px 16px 80px;position:relative;z-index:1}
    .section-label{font-size:12px;font-weight:600;color:var(--t2);margin-bottom:12px;letter-spacing:.5px;text-transform:uppercase}

    /* Accordion */
    .accordion{margin-bottom:20px}
    .accordion-section{margin-bottom:10px;border-radius:16px;overflow:hidden;border:1.5px solid var(--border);backdrop-filter:blur(8px);transition:border-color .3s}
    .accordion-section.open{border-color:rgba(136,146,176,0.15)}
    .accordion-header{padding:14px 20px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;user-select:none;transition:all .25s}
    .accordion-header:hover{filter:brightness(1.1)}
    .accordion-header.junior{background:linear-gradient(135deg,rgba(0,212,255,0.08),rgba(29,233,182,0.06))}
    .accordion-header.senior{background:linear-gradient(135deg,rgba(180,77,255,0.08),rgba(255,107,181,0.06))}
    .accordion-title{display:flex;align-items:center;gap:10px;font-weight:700;font-size:15px}
    .accordion-title .emoji{font-size:20px}
    .accordion-title.junior-text{color:var(--teal)}
    .accordion-title.senior-text{color:var(--pink)}
    .accordion-count{font-size:12px;padding:4px 10px;border-radius:8px;font-weight:600}
    .accordion-count.junior-count{background:rgba(29,233,182,0.1);color:var(--teal)}
    .accordion-count.senior-count{background:rgba(255,107,181,0.1);color:var(--pink)}
    .accordion-arrow{font-size:14px;transition:transform .3s;color:var(--t3)}
    .accordion-section.open .accordion-arrow{transform:rotate(180deg)}
    .accordion-body{max-height:0;overflow:hidden;transition:max-height .4s cubic-bezier(.16,1,.3,1),padding .3s;padding:0 16px;background:rgba(10,14,26,0.3)}
    .accordion-section.open .accordion-body{max-height:800px;padding:16px}

    .layer-group{margin-bottom:14px}.layer-group:last-child{margin-bottom:0}
    .layer-label{font-size:13px;font-weight:700;margin-bottom:8px;padding:6px 12px;border-radius:10px;display:inline-flex;align-items:center;gap:6px}
    .layer-z{background:rgba(0,212,255,0.1);color:#00d4ff}
    .layer-ch{background:rgba(29,233,182,0.1);color:#1de9b6}
    .layer-t{background:rgba(0,230,118,0.1);color:#00e676}
    .layer-y{background:rgba(180,77,255,0.1);color:#b44dff}
    .layer-ya{background:rgba(255,107,181,0.1);color:#ff6bb5}
    .layer-yb{background:rgba(255,171,64,0.1);color:#ffab40}
    .class-chips{display:flex;flex-wrap:wrap;gap:6px}
    .class-chip{padding:10px 18px;border-radius:12px;border:1.5px solid var(--border);background:var(--card);color:var(--t2);cursor:pointer;font-size:14px;font-weight:500;font-family:'Rubik',sans-serif;transition:all .2s;min-width:60px;text-align:center}
    .class-chip:hover{border-color:rgba(136,146,176,0.2);color:var(--t1);transform:translateY(-1px)}
    .class-chip.sel-z{border-color:#00d4ff;background:rgba(0,212,255,0.12);color:#00d4ff;font-weight:700;box-shadow:0 0 16px rgba(0,212,255,0.15)}
    .class-chip.sel-ch{border-color:#1de9b6;background:rgba(29,233,182,0.12);color:#1de9b6;font-weight:700;box-shadow:0 0 16px rgba(29,233,182,0.15)}
    .class-chip.sel-t{border-color:#00e676;background:rgba(0,230,118,0.12);color:#00e676;font-weight:700;box-shadow:0 0 16px rgba(0,230,118,0.15)}
    .class-chip.sel-y{border-color:#b44dff;background:rgba(180,77,255,0.12);color:#b44dff;font-weight:700;box-shadow:0 0 16px rgba(180,77,255,0.15)}
    .class-chip.sel-ya{border-color:#ff6bb5;background:rgba(255,107,181,0.12);color:#ff6bb5;font-weight:700;box-shadow:0 0 16px rgba(255,107,181,0.15)}
    .class-chip.sel-yb{border-color:#ffab40;background:rgba(255,171,64,0.12);color:#ffab40;font-weight:700;box-shadow:0 0 16px rgba(255,171,64,0.15)}

    /* Modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);z-index:500;display:flex;align-items:center;justify-content:center;padding:16px;animation:fadeIn .2s ease}
    .modal-box{background:#0f172a;border:1.5px solid rgba(136,146,176,0.12);border-radius:20px;width:100%;max-width:500px;max-height:85vh;display:flex;flex-direction:column;overflow:hidden}
    .modal-header{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .modal-header h3{font-size:17px;font-weight:700}
    .modal-close{background:rgba(255,82,82,0.1);border:1px solid rgba(255,82,82,0.2);color:var(--red);border-radius:10px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;font-family:'Rubik',sans-serif}
    .modal-body{padding:16px 20px;overflow-y:auto;flex:1}

    .search-input{width:100%;padding:12px 18px;border-radius:14px;border:1.5px solid var(--border);background:var(--card);color:var(--t1);font-size:14px;font-family:'Rubik',sans-serif;margin-bottom:12px;outline:none;direction:rtl;backdrop-filter:blur(8px);transition:border-color .2s}
    .search-input:focus{border-color:rgba(0,212,255,0.3)}
    .search-input::placeholder{color:var(--t3)}

    .student-list{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
    .student-btn{padding:13px 16px;border-radius:12px;border:1.5px solid var(--border);background:var(--card);color:var(--t1);cursor:pointer;font-size:14px;font-family:'Rubik',sans-serif;text-align:right;display:flex;align-items:center;gap:10px;transition:all .2s}
    .student-btn:hover{background:var(--card-h)}
    .student-btn.selected{border-color:var(--blue);background:linear-gradient(135deg,rgba(0,212,255,0.1),rgba(180,77,255,0.05));color:var(--blue);font-weight:600}
    .student-avatar{width:34px;height:34px;border-radius:50%;background:rgba(136,146,176,0.08);display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;color:var(--t3)}
    .student-btn.selected .student-avatar{background:linear-gradient(135deg,var(--blue),var(--purple));color:#fff;box-shadow:0 4px 14px rgba(0,212,255,0.3)}

    .reason-chips{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
    .reason-chip{padding:10px 20px;border-radius:22px;border:1.5px solid var(--border);background:var(--card);color:var(--t2);cursor:pointer;font-size:13px;font-family:'Rubik',sans-serif;transition:all .2s}
    .reason-chip.selected{border-color:var(--purple);background:linear-gradient(135deg,rgba(180,77,255,0.12),rgba(255,107,181,0.06));color:var(--purple);font-weight:600}

    .submit-btn{width:100%;padding:16px;border-radius:16px;border:none;background:linear-gradient(135deg,var(--blue),var(--purple),var(--pink));background-size:200% 200%;animation:gs 4s ease infinite;color:#fff;font-size:16px;font-weight:700;font-family:'Rubik',sans-serif;cursor:pointer;margin-top:8px;box-shadow:0 8px 32px rgba(0,212,255,0.2),0 4px 16px rgba(180,77,255,0.15);transition:all .25s}
    .submit-btn:hover{transform:translateY(-2px)}
    @keyframes gs{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}

    .history-item{padding:14px 16px;border-radius:14px;background:var(--card);border:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .history-info{display:flex;align-items:center;gap:10px}
    .status-badge{padding:4px 10px;border-radius:8px;font-size:11px;font-weight:600}
    .status-pending{background:rgba(255,171,64,0.1);border:1px solid rgba(255,171,64,0.2);color:var(--orange)}
    .status-exited{background:rgba(0,230,118,0.1);border:1px solid rgba(0,230,118,0.2);color:var(--green)}
    .cancel-btn{background:rgba(255,82,82,0.1);border:1px solid rgba(255,82,82,0.15);border-radius:8px;padding:6px 14px;color:#ff5252;cursor:pointer;font-size:12px;font-family:'Rubik',sans-serif}

    .toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);border-radius:14px;padding:12px 28px;font-size:14px;font-weight:600;font-family:'Rubik',sans-serif;z-index:9999;backdrop-filter:blur(16px);animation:ti .35s cubic-bezier(.16,1,.3,1);pointer-events:none}
    .toast-success{background:rgba(0,230,118,0.15);border:1px solid rgba(0,230,118,0.3);color:var(--green)}
    .toast-warning{background:rgba(255,171,64,0.15);border:1px solid rgba(255,171,64,0.3);color:var(--orange)}
    .empty-state{text-align:center;padding:48px 20px;color:var(--t3)}
    .empty-state .icon{font-size:40px;opacity:.4;margin-bottom:12px}
    .credit{position:fixed;bottom:0;left:0;right:0;text-align:center;padding:10px;background:rgba(10,14,26,0.9);backdrop-filter:blur(12px);border-top:1px solid var(--border);font-size:11px;color:var(--t3);z-index:100}
    .credit span{background:linear-gradient(135deg,var(--blue),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-weight:600}
    .hidden{display:none}
    @keyframes ti{from{opacity:0;transform:translateX(-50%) translateY(-16px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .fade-in{animation:fadeIn .3s ease}

    /* Guest form */
    .guest-form{display:flex;flex-direction:column;gap:12px}
    .form-row{display:flex;gap:10px;flex-wrap:wrap}
    .form-input{flex:1;min-width:140px;padding:12px 16px;border-radius:12px;border:1.5px solid var(--border);background:var(--card);color:var(--t1);font-size:14px;font-family:'Rubik',sans-serif;outline:none;direction:rtl}
    .form-input:focus{border-color:rgba(255,171,64,0.3)}
    .form-input::placeholder{color:var(--t3)}
    .guest-card{padding:14px 16px;border-radius:14px;background:var(--card);border:1px solid rgba(255,171,64,0.15);margin-bottom:8px;border-right:4px solid var(--orange)}
    .guest-card .guest-name{font-weight:700;font-size:15px}
    .guest-card .guest-meta{color:var(--t2);font-size:12px;margin-top:4px;line-height:1.6}

    /* History date picker */
    .date-row{display:flex;gap:10px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
    .date-input{padding:10px 16px;border-radius:12px;border:1.5px solid var(--border);background:var(--card);color:var(--t1);font-size:14px;font-family:'Rubik',sans-serif;outline:none;direction:ltr}
    .date-input:focus{border-color:rgba(0,212,255,0.3)}
    .export-btn{padding:10px 18px;border-radius:12px;border:none;background:rgba(0,230,118,0.12);color:var(--green);font-size:13px;font-weight:600;cursor:pointer;font-family:'Rubik',sans-serif;display:flex;align-items:center;gap:6px}
    .export-btn:hover{background:rgba(0,230,118,0.2)}
  </style>
</head>
<body>
  <div id="toast" class="toast hidden"></div>
  <div id="studentModal" class="modal-overlay hidden"></div>

  <div id="mainContent" class="hidden">
  <div class="header">
    <div class="header-logo"><div class="logo-icon">ğŸ“‹</div><div><h1>×©×—×¨×•×¨ ×ª×œ××™×“×™×</h1><p>××—× ×š / ××–×›×™×¨×•×ª</p></div></div>
    <div class="header-controls">
      <div class="connection"><div id="connectionDot" class="connection-dot"></div><span id="connectionText">××ª×—×‘×¨...</span></div>
      <div class="tab-buttons">
        <button class="tab-btn active" id="tabForm" onclick="showTab('form')">×©×—×¨×•×¨</button>
        <button class="tab-btn" id="tabGuest" onclick="showTab('guest')" style="display:none">××•×¨×—×™× ğŸ‘¤</button>
        <button class="tab-btn" id="tabHistory" onclick="showTab('history')">×”×™×¡×˜×•×¨×™×”<span class="badge hidden" id="historyBadge">0</span></button>
      </div>
    </div>
  </div>

  <div class="content">
    <!-- â•â•â• RELEASE TAB â•â•â• -->
    <div id="formView">
      <div class="section-label">×‘×—×™×¨×ª ×›×™×ª×”</div>
      <div id="accordionContainer" class="accordion"></div>
    </div>

    <!-- â•â•â• GUEST TAB â•â•â• -->
    <div id="guestView" class="hidden">
      <div class="section-label">×¨×™×©×•× ××•×¨×—/×ª ×—×“×©/×”</div>
      <div class="guest-form">
        <div class="form-row">
          <input type="text" class="form-input" id="guestName" placeholder="×©× ××œ× ×©×œ ×”××•×¨×—/×ª">
          <input type="text" class="form-input" id="guestInviter" placeholder="×©× ×”××–××™×Ÿ/×”">
        </div>
        <div class="form-row">
          <input type="text" class="form-input" id="guestPurpose" placeholder="××˜×¨×ª ×”×‘×™×§×•×¨">
        </div>
        <div class="form-row">
          <input type="date" class="form-input" id="guestDate" style="direction:ltr">
          <input type="time" class="form-input" id="guestTime" style="direction:ltr">
        </div>
        <button class="submit-btn" onclick="submitGuest()">âœ“ ×¨×©×•× ××•×¨×—/×ª</button>
      </div>

      <div style="margin-top:28px">
        <div class="section-label">××•×¨×—×™× ×©× ×¨×©××•</div>
        <div id="guestList"></div>
      </div>
    </div>

    <!-- â•â•â• HISTORY TAB â•â•â• -->
    <div id="historyView" class="hidden">
      <div class="date-row">
        <span style="font-size:13px;color:var(--t2)">×ª××¨×™×š:</span>
        <input type="date" class="date-input" id="historyDate" onchange="renderHistory()">
        <button class="export-btn" onclick="exportHistory()">ğŸ“¥ ×™×™×¦×•× ××§×¡×œ</button>
      </div>
      <div class="section-label" id="historyLabel">×©×—×¨×•×¨×™×</div>
      <div id="historyList"></div>
    </div>
  </div>
  </div><!-- end mainContent -->

  <div class="credit">×¤×™×ª×•×— ×”××¤×œ×™×§×¦×™×” â€” <span>×¨× ×™ ×‘×Ÿ ×–××‘</span></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig={apiKey:"AIzaSyCSmwys1pNEEMu8oq4r_Q6sMtHEiba33pw",authDomain:"gmarlamed.firebaseapp.com",databaseURL:"https://gmarlamed-default-rtdb.firebaseio.com",projectId:"gmarlamed",storageBucket:"gmarlamed.firebasestorage.app",messagingSenderId:"287104553740",appId:"1:287104553740:web:ab36b987cf86f913c76f29"};
    firebase.initializeApp(firebaseConfig);
    const db=firebase.database(),releasesRef=db.ref('releases'),classMapRef=db.ref('school_gate/classMap'),guestsRef=db.ref('guests');

    let CLASSES=[],STUDENTS={};
    const REASONS=["×¡×™×‘×” ×¨×¤×•××™×ª","×¡×™×‘×” ××™×©×™×ª","×ª×•×¨ ×¨×•×¤×","××™×¨×•×¢ ××©×¤×—×ª×™","××—×¨"];

    const LAYER_CONFIG={
      '×–':{colorClass:'z',emoji:'ğŸ”µ',label:'×©×›×‘×” ×–×³'},
      '×—':{colorClass:'ch',emoji:'ğŸŸ¢',label:'×©×›×‘×” ×—×³'},
      '×˜':{colorClass:'t',emoji:'ğŸŸ©',label:'×©×›×‘×” ×˜×³'},
      '×™':{colorClass:'y',emoji:'ğŸŸ£',label:'×©×›×‘×” ×™×³'},
      '×™×':{colorClass:'ya',emoji:'ğŸ©·',label:'×©×›×‘×” ×™×´×'},
      '×™×‘':{colorClass:'yb',emoji:'ğŸŸ ',label:'×©×›×‘×” ×™×´×‘'},
    };
    const JUNIOR=['×–','×—','×˜'],SENIOR=['×™','×™×','×™×‘'];

    let selectedClass="",selectedStudent="",selectedReason="",releases={},guests={},currentTab="form";
    let openAccordions={junior:true,senior:true};

    // Set default date for guest form and history
    document.addEventListener('DOMContentLoaded',function(){
      var today=new Date().toISOString().split('T')[0];
      document.getElementById('guestDate').value=today;
      document.getElementById('guestTime').value=new Date().toTimeString().slice(0,5);
      document.getElementById('historyDate').value=today;
      var u=localStorage.getItem('gate_user');
      if(u){var inv=document.getElementById('guestInviter');if(inv)inv.value=u;}
    });

    classMapRef.on('value',s=>{
      const d=s.val();
      if(d&&Object.keys(d).length>0){STUDENTS=d;CLASSES=Object.keys(d).sort((a,b)=>a.localeCompare(b,'he'));}
      else{CLASSES=[];STUDENTS={};}
      buildAccordion();
    });

    db.ref('.info/connected').on('value',s=>{
      const d=document.getElementById('connectionDot'),t=document.getElementById('connectionText');
      if(s.val()===true){d.classList.add('online');t.textContent='××—×•×‘×¨';}
      else{d.classList.remove('online');t.textContent='×œ× ××—×•×‘×¨';}
    });

    releasesRef.on('value',s=>{releases=s.val()||{};updateHistoryBadge();if(currentTab==='history')renderHistory();});
    guestsRef.on('value',s=>{guests=s.val()||{};if(currentTab==='guest')renderGuests();});

    // â”€â”€â”€ Accordion â”€â”€â”€
    function buildAccordion(){
      var layers={};
      CLASSES.forEach(function(cls){var parts=cls.split('×³');var layer=parts[0];if(!layers[layer])layers[layer]=[];layers[layer].push(cls);});

      var container=document.getElementById('accordionContainer');
      container.innerHTML='';

      function buildSection(id,title,emoji,type,layerKeys){
        var rel=layerKeys.filter(function(k){return !!layers[k];});
        var tc=rel.reduce(function(s,k){return s+(layers[k]||[]).length;},0);
        if(tc===0)return;
        var isOpen=openAccordions[id];

        var section=document.createElement('div');
        section.className='accordion-section'+(isOpen?' open':'');
        section.id='acc-'+id;

        var header=document.createElement('div');
        header.className='accordion-header '+type;
        header.innerHTML='<div class="accordion-title '+type+'-text"><span class="emoji">'+emoji+'</span>'+title+'</div><div style="display:flex;align-items:center;gap:10px"><span class="accordion-count '+type+'-count">'+tc+' ×›×™×ª×•×ª</span><span class="accordion-arrow">â–¼</span></div>';
        header.addEventListener('click',function(){toggleAccordion(id);});
        section.appendChild(header);

        var body=document.createElement('div');
        body.className='accordion-body';

        rel.forEach(function(layer){
          var cfg=LAYER_CONFIG[layer]||{colorClass:'z',emoji:'ğŸ“˜',label:layer};
          var group=document.createElement('div');
          group.className='layer-group';

          var label=document.createElement('div');
          label.className='layer-label layer-'+cfg.colorClass;
          label.textContent=cfg.emoji+' '+cfg.label;
          group.appendChild(label);

          var chips=document.createElement('div');
          chips.className='class-chips';

          (layers[layer]||[]).forEach(function(cls){
            var chip=document.createElement('button');
            chip.className='class-chip'+(selectedClass===cls?' sel-'+cfg.colorClass:'');
            chip.textContent=cls;
            chip.addEventListener('click',function(){selectClass(cls);});
            chips.appendChild(chip);
          });

          group.appendChild(chips);
          body.appendChild(group);
        });

        section.appendChild(body);
        container.appendChild(section);
      }

      buildSection('junior','×—×˜×™×‘×ª ×‘×™× ×™×™×','ğŸ«','junior',JUNIOR);
      buildSection('senior','×—×˜×™×‘×” ×¢×œ×™×•× ×”','ğŸ“','senior',SENIOR);
    }

    function toggleAccordion(id){openAccordions[id]=!openAccordions[id];document.getElementById('acc-'+id).classList.toggle('open');}

    // â”€â”€â”€ Class â†’ open MODAL â”€â”€â”€
    function selectClass(cls){
      selectedClass=cls;selectedStudent="";selectedReason="";
      buildAccordion();
      openStudentModal(cls);
    }

    function openStudentModal(cls){
      var modal=document.getElementById('studentModal');
      modal.innerHTML='<div class="modal-box">'+
        '<div class="modal-header"><h3>ğŸ“‹ ×›×™×ª×” '+cls+'</h3><button class="modal-close" onclick="closeStudentModal()">âœ•</button></div>'+
        '<div class="modal-body" id="modalBody">'+
          '<div id="modalStep1">'+
            '<div class="section-label">×‘×—×¨×• ×ª×œ××™×“/×”</div>'+
            '<input type="text" class="search-input" placeholder="ğŸ” ×—×™×¤×•×©..." id="modalSearch" oninput="filterModalStudents()">'+
            '<div class="student-list" id="modalStudentList"></div>'+
          '</div>'+
          '<div id="modalStep2" class="hidden">'+
            '<div style="padding:14px 16px;border-radius:12px;background:rgba(0,212,255,0.08);border:1.5px solid rgba(0,212,255,0.2);margin-bottom:16px;display:flex;align-items:center;justify-content:space-between">'+
              '<div style="font-weight:700;font-size:15px" id="modalSelectedName"></div>'+
              '<button style="background:none;border:1px solid var(--t3);border-radius:8px;padding:4px 12px;color:var(--t2);cursor:pointer;font-size:12px;font-family:Rubik,sans-serif" onclick="backToStudentList()">â† ×©×™× ×•×™</button>'+
            '</div>'+
            '<div class="section-label">×¡×™×‘×ª ×”×©×—×¨×•×¨</div>'+
            '<div class="reason-chips" id="modalReasonChips"></div>'+
            '<input type="text" class="search-input hidden" placeholder="×¤×¨×˜/×™ ××ª ×”×¡×™×‘×”..." id="modalCustomReason" style="margin-top:8px">'+
            '<button class="submit-btn" id="modalSubmitBtn" style="margin-top:12px;display:none" onclick="submitRelease()">âœ“ ×©×—×¨×¨</button>'+
          '</div>'+
        '</div></div>';
      modal.classList.remove('hidden');
      renderModalStudents(STUDENTS[cls]||[],'');
    }

    function renderModalStudents(allStudents,search){
      var list=document.getElementById('modalStudentList');
      if(!list)return;
      var filtered=allStudents.filter(function(x){return x.includes(search);});
      list.innerHTML='';
      if(filtered.length===0){list.innerHTML='<div class="empty-state"><div class="icon">ğŸ”</div><p>×œ× × ××¦××• ×ª×œ××™×“×™×</p></div>';return;}
      filtered.forEach(function(name){
        var btn=document.createElement('div');
        btn.className='student-btn';
        btn.innerHTML='<span class="student-avatar">'+name[0]+'</span>'+name;
        btn.addEventListener('click',function(){
          selectedStudent=name;
          selectedReason='';
          document.getElementById('modalStep1').classList.add('hidden');
          document.getElementById('modalStep2').classList.remove('hidden');
          document.getElementById('modalSelectedName').textContent='ğŸ“‹ '+name;
          renderModalReasons();
          updateModalSubmitBtn();
        });
        list.appendChild(btn);
      });
    }

    function backToStudentList(){
      selectedStudent='';selectedReason='';
      document.getElementById('modalStep1').classList.remove('hidden');
      document.getElementById('modalStep2').classList.add('hidden');
    }

    function filterModalStudents(){
      var s=document.getElementById('modalSearch').value;
      renderModalStudents(STUDENTS[selectedClass]||[],s);
    }

    function renderModalReasons(){
      var container=document.getElementById('modalReasonChips');
      if(!container)return;
      container.innerHTML='';
      REASONS.forEach(function(r){
        var btn=document.createElement('button');
        btn.className='reason-chip'+(selectedReason===r?' selected':'');
        btn.textContent=r;
        btn.addEventListener('click',function(){
          selectedReason=r;
          renderModalReasons();
          var custom=document.getElementById('modalCustomReason');
          if(custom)custom.classList.toggle('hidden',r!=='××—×¨');
          updateModalSubmitBtn();
        });
        container.appendChild(btn);
      });
    }

    function updateModalSubmitBtn(){
      var btn=document.getElementById('modalSubmitBtn');
      if(!btn)return;
      if(selectedStudent&&selectedReason){btn.style.display='block';btn.textContent='âœ“ ×©×—×¨×¨ ××ª '+selectedStudent;}
      else{btn.style.display='none';}
    }

    function closeStudentModal(){document.getElementById('studentModal').classList.add('hidden');}

    function submitRelease(){
      if(!selectedStudent||!selectedReason)return;
      var customEl=document.getElementById('modalCustomReason');
      var r=selectedReason==='××—×¨'?((customEl&&customEl.value)||'××—×¨'):selectedReason;
      releasesRef.push().set({studentName:selectedStudent,className:selectedClass,reason:r,releasedBy:currentUser||"×¦×•×•×ª",time:new Date().toISOString(),status:"pending"})
      .then(function(){
        showToast('âœ“ '+selectedStudent+' ×©×•×—×¨×¨/×”','success');
        selectedStudent='';selectedReason='';
        closeStudentModal();
      }).catch(function(){showToast('×©×’×™××” â€” ×‘×“×•×§ ×—×™×‘×•×¨','warning');});
    }

    // â”€â”€â”€ Guest Registration â”€â”€â”€
    function submitGuest(){
      const name=document.getElementById('guestName').value.trim();
      const inviter=document.getElementById('guestInviter').value.trim();
      const purpose=document.getElementById('guestPurpose').value.trim();
      const date=document.getElementById('guestDate').value;
      const time=document.getElementById('guestTime').value;
      if(!name||!inviter||!purpose||!date||!time)return showToast('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª','warning');
      guestsRef.push().set({name,inviter,purpose,date,time,createdAt:new Date().toISOString()})
      .then(()=>{
        showToast(`âœ“ ${name} × ×¨×©×/×” ×›××•×¨×—/×ª`,'success');
        document.getElementById('guestName').value='';
        document.getElementById('guestInviter').value='';
        document.getElementById('guestPurpose').value='';
      });
    }

    function renderGuests(){
      var list=document.getElementById('guestList');
      var entries=Object.entries(guests).sort(function(a,b){return new Date(b[1].createdAt)-new Date(a[1].createdAt);});
      if(entries.length===0){list.innerHTML='<div class="empty-state"><div class="icon">ğŸ‘¤</div><p>××™×Ÿ ××•×¨×—×™× ×¨×©×•××™×</p></div>';return;}
      list.innerHTML='';
      entries.slice(0,20).forEach(function(entry){
        var id=entry[0],g=entry[1];
        var card=document.createElement('div');
        card.className='guest-card';
        var inner=document.createElement('div');
        inner.style.cssText='display:flex;justify-content:space-between;align-items:start';
        inner.innerHTML='<div><div class="guest-name">ğŸ‘¤ '+g.name+'</div><div class="guest-meta">××–××™×Ÿ: '+g.inviter+' Â· ××˜×¨×”: '+g.purpose+'<br>ğŸ“… '+g.date+' Â· ğŸ• '+g.time+'</div></div>';
        var btn=document.createElement('button');
        btn.className='cancel-btn';
        btn.textContent='××—×§';
        btn.addEventListener('click',function(){deleteGuest(id);});
        inner.appendChild(btn);
        card.appendChild(inner);
        list.appendChild(card);
      });
    }

    function deleteGuest(id){if(confirm('×œ××—×•×§ ××•×¨×—/×ª?'))guestsRef.child(id).remove();}

    // â”€â”€â”€ History with Date â”€â”€â”€
    function getHistoryDate(){return document.getElementById('historyDate').value;}

    function getReleasesByDate(dateStr){
      const target=new Date(dateStr).toDateString();
      return Object.entries(releases).filter(([_,r])=>new Date(r.time).toDateString()===target).sort((a,b)=>new Date(b[1].time)-new Date(a[1].time));
    }

    function updateHistoryBadge(){
      const c=getReleasesByDate(new Date().toISOString().split('T')[0]).length;
      const b=document.getElementById('historyBadge');
      if(c>0){b.classList.remove('hidden');b.textContent=c;}else b.classList.add('hidden');
    }

    function renderHistory(){
      var dateStr=getHistoryDate();
      var t=getReleasesByDate(dateStr);
      var l=document.getElementById('historyList');
      document.getElementById('historyLabel').textContent='×©×—×¨×•×¨×™× â€” '+t.length+' ('+dateStr+')';
      if(t.length===0){l.innerHTML='<div class="empty-state"><div class="icon">ğŸ“­</div><p>××™×Ÿ ×©×—×¨×•×¨×™× ×œ×ª××¨×™×š ×–×”</p></div>';return;}
      l.innerHTML='';
      t.forEach(function(entry){
        var id=entry[0],r=entry[1];
        var item=document.createElement('div');
        item.className='history-item';
        var info=document.createElement('div');
        info.className='history-info';
        info.innerHTML='<span class="status-badge '+(r.status==='exited'?'status-exited':'status-pending')+'">'+(r.status==='exited'?'×™×¦×/×”':'×××ª×™×Ÿ')+'</span><div><div style="font-weight:600;font-size:14px">'+r.studentName+'</div><div style="color:var(--t3);font-size:12px">'+r.className+' Â· '+r.reason+' Â· '+formatTime(r.time)+(r.exitTime?' â†’ '+formatTime(r.exitTime):'')+'</div></div>';
        item.appendChild(info);
        if(r.status==='pending'){
          var btn=document.createElement('button');
          btn.className='cancel-btn';
          btn.textContent='×‘×™×˜×•×œ';
          btn.addEventListener('click',function(){cancelRelease(id);});
          item.appendChild(btn);
        }
        l.appendChild(item);
      });
    }

    function cancelRelease(id){releasesRef.child(id).remove().then(()=>showToast('×”×©×—×¨×•×¨ ×‘×•×˜×œ','warning'));}

    function exportHistory(){
      const dateStr=getHistoryDate();
      const t=getReleasesByDate(dateStr);
      if(t.length===0)return showToast('××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•×','warning');
      const rows=[['×©×','×›×™×ª×”','×¡×™×‘×”','×©×¢×ª ×©×—×¨×•×¨','×©×¢×ª ×™×¦×™××”','×¡×˜×˜×•×¡']];
      t.forEach(([_,r])=>{rows.push([r.studentName,r.className,r.reason,formatTime(r.time),r.exitTime?formatTime(r.exitTime):'â€”',r.status==='exited'?'×™×¦×/×”':'×××ª×™×Ÿ']);});
      const ws=XLSX.utils.aoa_to_sheet(rows);
      ws['!cols']=[{wch:20},{wch:10},{wch:16},{wch:10},{wch:10},{wch:10}];
      const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws,'×©×—×¨×•×¨×™×');
      XLSX.writeFile(wb,`×©×—×¨×•×¨×™×_${dateStr}.xlsx`);
    }

    // â”€â”€â”€ Tabs â”€â”€â”€
    function showTab(t){
      currentTab=t;
      ['form','guest','history'].forEach(x=>{
        document.getElementById('tab'+x[0].toUpperCase()+x.slice(1)).classList.toggle('active',x===t);
      });
      document.getElementById('tabForm').classList.toggle('active',t==='form');
      document.getElementById('tabGuest').classList.toggle('active',t==='guest');
      document.getElementById('tabHistory').classList.toggle('active',t==='history');
      document.getElementById('formView').classList.toggle('hidden',t!=='form');
      document.getElementById('guestView').classList.toggle('hidden',t!=='guest');
      document.getElementById('historyView').classList.toggle('hidden',t!=='history');
      if(t==='history')renderHistory();
      if(t==='guest')renderGuests();
    }

    function formatTime(i){return new Date(i).toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'});}
    function showToast(m,t){var e=document.getElementById('toast');e.className='toast toast-'+t;e.textContent=m;e.classList.remove('hidden');setTimeout(function(){e.classList.add('hidden');},3000);}

    // â”€â”€â”€ Device Auth: verify device is approved â”€â”€â”€
    var currentUser=localStorage.getItem('gate_user')||'';
    var startTab=localStorage.getItem('gate_tab')||'form';
    var deviceId=localStorage.getItem('gate_device_id')||'';
    var guestOpen=localStorage.getItem('gate_guest_open')==='true';

    function verifyAndInit(){
      // Guest tab is open to everyone â€” no auth needed
      if(guestOpen&&startTab==='guest'){
        localStorage.removeItem('gate_guest_open');
        currentUser=currentUser||'××•×¨×—';
        document.getElementById('mainContent').classList.remove('hidden');
        showTab('guest');
        // Hide release and history tabs â€” guest-only mode
        document.getElementById('tabForm').style.display='none';
        document.getElementById('tabHistory').style.display='none';
        return;
      }

      if(!deviceId||!currentUser){window.location.href='index.html';return;}
      db.ref('school_gate/devices/'+deviceId).once('value',function(snap){
        var device=snap.val();
        if(!device||device.status!=='approved'){
          localStorage.removeItem('gate_user');
          alert('××›×©×™×¨ ×œ× ×××•×©×¨. ×¤× ×” ×œ×× ×”×œ.');
          window.location.href='index.html';
          return;
        }
        var userBadge=document.createElement('div');
        userBadge.style.cssText='display:flex;align-items:center;gap:8px;padding:6px 14px;border-radius:10px;background:rgba(0,212,255,0.08);border:1px solid rgba(0,212,255,0.15);font-size:12px;color:var(--blue)';
        userBadge.innerHTML='ğŸ‘¤ '+currentUser+'<button style="background:none;border:none;color:var(--t3);cursor:pointer;font-size:11px;margin-right:6px" onclick="logoutUser()">×™×¦×™××”</button>';
        document.querySelector('.header-controls').insertBefore(userBadge,document.querySelector('.connection'));
        document.getElementById('mainContent').classList.remove('hidden');
        if(startTab==='guest')showTab('guest');
        db.ref('school_gate/devices/'+deviceId+'/lastSeen').set(new Date().toISOString());
      });
    }

    function logoutUser(){
      localStorage.removeItem('gate_user');
      localStorage.removeItem('gate_tab');
      window.location.href='index.html';
    }

    verifyAndInit();
  </script>
</body>
</html>
