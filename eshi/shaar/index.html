<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×©×¢×¨ ×‘×™×ª ×”×¡×¤×¨</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700;800&family=Secular+One&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Rubik',sans-serif;background:#f1f5f9;color:#1e293b;min-height:100vh;direction:rtl;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px}
    .logo-section{text-align:center;margin-bottom:40px}
    .logo-icon{width:80px;height:80px;border-radius:20px;background:linear-gradient(135deg,#059669,#0284c7);display:flex;align-items:center;justify-content:center;font-size:40px;margin:0 auto 16px;box-shadow:0 8px 30px rgba(5,150,105,0.3)}
    .logo-title{font-family:'Secular One',sans-serif;font-size:28px;color:#0f172a}
    .logo-sub{color:#64748b;font-size:14px;margin-top:4px}
    .cards{display:flex;gap:20px;flex-wrap:wrap;justify-content:center;max-width:800px}
    .card{background:#fff;border:1px solid #e2e8f0;border-radius:20px;padding:32px 28px;width:230px;text-align:center;cursor:pointer;transition:all .25s;position:relative;overflow:hidden}
    .card:hover{transform:translateY(-4px);box-shadow:0 12px 32px rgba(0,0,0,0.1)}
    .card-icon{font-size:44px;margin-bottom:16px}
    .card-title{font-size:18px;font-weight:700;margin-bottom:6px}
    .card-desc{color:#64748b;font-size:13px;line-height:1.5}
    .card-badge{position:absolute;top:12px;left:12px;font-size:10px;font-weight:600;padding:3px 8px;border-radius:6px}
    .badge-open{background:#d1fae5;color:#059669}
    .badge-auth{background:#fef3c7;color:#d97706}
    .card.green{border-bottom:4px solid #059669}
    .card.green:hover{box-shadow:0 12px 32px rgba(5,150,105,0.15)}
    .card.orange{border-bottom:4px solid #d97706}
    .card.orange:hover{box-shadow:0 12px 32px rgba(217,119,6,0.15)}
    .card.blue{border-bottom:4px solid #0284c7}
    .card.blue:hover{box-shadow:0 12px 32px rgba(2,132,199,0.15)}
    .modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:500;align-items:center;justify-content:center;padding:16px}
    .modal-bg.show{display:flex}
    .modal{background:#fff;border-radius:20px;padding:32px 28px;width:100%;max-width:420px;text-align:center}
    .modal h3{font-size:20px;font-weight:700;margin-bottom:6px}
    .modal p{color:#64748b;font-size:13px;margin-bottom:20px}
    .name-list{display:flex;flex-direction:column;gap:8px;max-height:300px;overflow-y:auto;margin-bottom:16px}
    .name-btn{padding:14px 16px;border-radius:12px;border:1.5px solid #e2e8f0;background:#f8fafc;color:#1e293b;cursor:pointer;font-size:15px;font-weight:500;font-family:'Rubik',sans-serif;text-align:right;display:flex;align-items:center;gap:10px;transition:all .2s}
    .name-btn:hover{background:#f1f5f9;border-color:#94a3b8}
    .name-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:#fff;flex-shrink:0;background:linear-gradient(135deg,#059669,#047857)}
    .modal-close{margin-top:8px;padding:10px 24px;border-radius:10px;border:1px solid #e2e8f0;background:#fff;color:#64748b;cursor:pointer;font-size:13px;font-family:'Rubik',sans-serif}
    .search-input{width:100%;padding:12px 16px;border-radius:12px;border:1px solid #e2e8f0;background:#f8fafc;color:#1e293b;font-size:14px;font-family:'Rubik',sans-serif;margin-bottom:12px;outline:none}
    .search-input::placeholder{color:#94a3b8}
    .status-box{background:#fff;border:1px solid #e2e8f0;border-radius:20px;padding:40px 28px;max-width:420px;text-align:center}
    .status-icon{font-size:48px;margin-bottom:16px}
    .status-title{font-size:18px;font-weight:700;margin-bottom:8px}
    .status-desc{color:#64748b;font-size:14px;line-height:1.6;margin-bottom:20px}
    .status-user{display:inline-block;background:#f1f5f9;border-radius:10px;padding:8px 16px;font-weight:600;font-size:14px;margin-bottom:16px}
    .reset-btn{padding:10px 20px;border-radius:10px;border:1px solid #e2e8f0;background:#fff;color:#ef4444;cursor:pointer;font-size:13px;font-family:'Rubik',sans-serif}
    .reset-btn:hover{background:#fef2f2}
    .credit{position:fixed;bottom:0;left:0;right:0;text-align:center;padding:10px;background:#fff;border-top:1px solid #e2e8f0;font-size:11px;color:#94a3b8}
    .credit span{color:#059669;font-weight:600}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="logo-section">
    <div class="logo-icon">ğŸ›¡ï¸</div>
    <div class="logo-title">×©×¢×¨ ×‘×™×ª ×”×¡×¤×¨</div>
    <div class="logo-sub">××¢×¨×›×ª ×©×—×¨×•×¨ ×ª×œ××™×“×™× ×•× ×™×”×•×œ ××•×¨×—×™×</div>
  </div>

  <!-- Approved device -->
  <div id="approvedView" class="hidden">
    <div style="text-align:center;margin-bottom:24px">
      <div class="status-user" id="approvedName"></div>
    </div>
    <div class="cards">
      <div class="card green" onclick="goStaff('form')">
        <div class="card-icon">ğŸ“</div>
        <div class="card-title">×©×—×¨×•×¨ ×ª×œ××™×“×™×</div>
        <div class="card-desc">×©×—×¨×•×¨ ×ª×œ××™×“ ××‘×™×ª ×”×¡×¤×¨</div>
      </div>
      <div class="card orange" onclick="goStaff('guest')">
        <div class="card-icon">ğŸ‘¤</div>
        <div class="card-title">×”×–×× ×ª ××•×¨×—×™×</div>
        <div class="card-desc">×¨×™×©×•× ××•×¨×—/×ª ×œ×‘×™×§×•×¨</div>
      </div>
      <div class="card blue" onclick="goGuard()">
        <span class="card-badge badge-open">ğŸ”“ ×¤×ª×•×—</span>
        <div class="card-icon">ğŸ›¡ï¸</div>
        <div class="card-title">××¡×š ×©×•××¨</div>
        <div class="card-desc">×¦×¤×™×™×” ×‘×©×—×¨×•×¨×™× ×•××•×¨×—×™×</div>
      </div>
    </div>
    <div style="text-align:center;margin-top:24px">
      <button class="reset-btn" onclick="resetDevice()">ğŸ”„ ×©×™× ×•×™ ××©×ª××© / ××™×¤×•×¡ ××›×©×™×¨</button>
    </div>
  </div>

  <!-- Pending approval -->
  <div id="pendingView" class="hidden">
    <div class="status-box">
      <div class="status-icon">â³</div>
      <div class="status-title">×××ª×™×Ÿ ×œ××™×©×•×¨ ×× ×”×œ</div>
      <div class="status-user" id="pendingName"></div>
      <div class="status-desc">×”××›×©×™×¨ × ×¨×©× ×‘×”×¦×œ×—×”.<br>×¤× ×” ×œ×× ×”×œ ×”××¢×¨×›×ª ×›×“×™ ×œ××©×¨ ××›×©×™×¨ ×–×”.<br><br>×”×“×£ ×™×ª×¢×“×›×Ÿ ××•×˜×•××˜×™×ª ×œ××—×¨ ×”××™×©×•×¨.</div>
      <button class="reset-btn" onclick="resetDevice()">ğŸ”„ ×‘×™×˜×•×œ ×•×¨×™×©×•× ××—×“×©</button>
    </div>
  </div>

  <!-- New device -->
  <div id="registerView" class="hidden">
    <div class="cards">
      <div class="card green lockable-card" onclick="startRegister('release')">
        <span class="card-badge badge-auth">ğŸ”’ ××•×¨×©×™×</span>
        <div class="card-icon">ğŸ“</div>
        <div class="card-title">×©×—×¨×•×¨ ×ª×œ××™×“×™×</div>
        <div class="card-desc">×©×—×¨×•×¨ ×ª×œ××™×“ â€” ×œ××—× ×›×™× ×•××–×›×™×¨×•×ª</div>
      </div>
      <div class="card orange" onclick="goGuest()">
        <span class="card-badge badge-open">ğŸ”“ ×¤×ª×•×—</span>
        <div class="card-icon">ğŸ‘¤</div>
        <div class="card-title">×”×–×× ×ª ××•×¨×—×™×</div>
        <div class="card-desc">×¨×™×©×•× ××•×¨×—/×ª ×œ×‘×™×§×•×¨</div>
      </div>
      <div class="card blue" onclick="goGuard()">
        <span class="card-badge badge-open">ğŸ”“ ×¤×ª×•×—</span>
        <div class="card-icon">ğŸ›¡ï¸</div>
        <div class="card-title">××¡×š ×©×•××¨</div>
        <div class="card-desc">×¦×¤×™×™×” ×‘×©×—×¨×•×¨×™× ×•××•×¨×—×™×</div>
      </div>
    </div>
  </div>

  <!-- Name selection modal -->
  <div class="modal-bg" id="authModal">
    <div class="modal">
      <h3 id="modalTitle">×¨×™×©×•× ××›×©×™×¨</h3>
      <p>×‘×—×¨/×™ ××ª ×©××š â€” ×”××›×©×™×¨ ×™×§×•×©×¨ ×œ×©× ×–×”</p>
      <input type="text" class="search-input" id="nameSearch" placeholder="ğŸ” ×—×™×¤×•×© ×©×..." oninput="filterNames()">
      <div class="name-list" id="nameList"></div>
      <button class="modal-close" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>
  </div>

  <div class="credit">×¤×™×ª×•×— ×”××¤×œ×™×§×¦×™×” â€” <span>×¨× ×™ ×‘×Ÿ ×–××‘</span></div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    var firebaseConfig={apiKey:"AIzaSyCSmwys1pNEEMu8oq4r_Q6sMtHEiba33pw",authDomain:"gmarlamed.firebaseapp.com",databaseURL:"https://gmarlamed-default-rtdb.firebaseio.com",projectId:"gmarlamed",storageBucket:"gmarlamed.firebasestorage.app",messagingSenderId:"287104553740",appId:"1:287104553740:web:ab36b987cf86f913c76f29"};
    firebase.initializeApp(firebaseConfig);
    var db=firebase.database();
    var devicesRef=db.ref('school_gate/devices');
    var authUsersRef=db.ref('school_gate/authorized_users');
    var authorizedNames=[];

    // Device ID - unique per browser
    function getDeviceId(){
      var id=localStorage.getItem('gate_device_id');
      if(!id){id='dev_'+Date.now()+'_'+Math.random().toString(36).substr(2,8);localStorage.setItem('gate_device_id',id);}
      return id;
    }
    var deviceId=getDeviceId();

    authUsersRef.on('value',function(s){
      var data=s.val();
      authorizedNames=data?Object.values(data).sort(function(a,b){return a.localeCompare(b,'he');}):[];
    });

    // Listen for device status changes (real-time!)
    devicesRef.child(deviceId).on('value',function(snap){
      var device=snap.val();
      document.getElementById('approvedView').classList.add('hidden');
      document.getElementById('pendingView').classList.add('hidden');
      document.getElementById('registerView').classList.add('hidden');

      if(!device){
        document.getElementById('registerView').classList.remove('hidden');
      } else if(device.status==='approved'){
        document.getElementById('approvedName').textContent='ğŸ‘¤ ×©×œ×•×, '+device.userName;
        document.getElementById('approvedView').classList.remove('hidden');
        localStorage.setItem('gate_user',device.userName);
      } else if(device.status==='pending'){
        document.getElementById('pendingName').textContent='ğŸ‘¤ '+device.userName;
        document.getElementById('pendingView').classList.remove('hidden');
      }
    });

    function startRegister(mode){
      document.getElementById('modalTitle').textContent=mode==='release'?'ğŸ“ ×¨×™×©×•× ××›×©×™×¨ â€” ×©×—×¨×•×¨':'ğŸ‘¤ ×¨×™×©×•× ××›×©×™×¨ â€” ××•×¨×—×™×';
      document.getElementById('nameSearch').value='';
      document.getElementById('authModal').classList.add('show');
      renderNames('');
    }

    function closeModal(){document.getElementById('authModal').classList.remove('show');}
    function filterNames(){renderNames(document.getElementById('nameSearch').value);}

    // Listen for devices to filter taken names
    var allDevices={};
    devicesRef.on('value',function(s){allDevices=s.val()||{};updateCardStates();});

    function getTakenNames(){
      var taken=[];
      Object.values(allDevices).forEach(function(d){
        if(d.status==='approved'||d.status==='pending'){taken.push(d.userName);}
      });
      return taken;
    }

    function getAvailableNames(){
      var taken=getTakenNames();
      return authorizedNames.filter(function(n){return taken.indexOf(n)<0;});
    }

    function updateCardStates(){
      var available=getAvailableNames();
      var lockCards=document.querySelectorAll('.lockable-card');
      lockCards.forEach(function(card){
        if(available.length===0){
          card.style.opacity='0.5';
          card.style.pointerEvents='none';
          card.querySelector('.card-desc').textContent='×›×œ ×”××•×¨×©×™× ×›×‘×¨ ×¨×©×•××™×';
        } else {
          card.style.opacity='1';
          card.style.pointerEvents='auto';
        }
      });
    }

    // Load authorized users with role info
    var authUsersFull={};
    authUsersRef.on('value',function(s){
      var data=s.val()||{};
      authUsersFull=data;
      authorizedNames=[];
      Object.values(data).forEach(function(u){
        var name=typeof u==='string'?u:u.name;
        if(name)authorizedNames.push(name);
      });
      authorizedNames.sort(function(a,b){return a.localeCompare(b,'he');});
      updateCardStates();
    });

    function getUserRole(name){
      var entries=Object.values(authUsersFull);
      for(var i=0;i<entries.length;i++){
        var u=entries[i];
        if(typeof u==='object'&&u.name===name)return u.role||'';
        if(typeof u==='string'&&u===name)return '';
      }
      return '';
    }

    var isMobile=navigator.userAgent.indexOf('Mobile')>=0;

    function renderNames(search){
      var list=document.getElementById('nameList');
      var taken=getTakenNames();
      var filtered=authorizedNames.filter(function(n){return n.includes(search)&&taken.indexOf(n)<0;});
      list.innerHTML='';
      if(filtered.length===0){list.innerHTML='<div style="color:#94a3b8;padding:24px;font-size:14px">××™×Ÿ ×©××•×ª ×–××™× ×™×. ×›×œ ×”××•×¨×©×™× ×›×‘×¨ ×¨×©×•××™×.</div>';return;}
      filtered.forEach(function(name){
        var role=getUserRole(name);
        var isSecretary=role==='secretary';
        var blocked=isSecretary&&isMobile;

        var btn=document.createElement('div');
        btn.className='name-btn';
        if(blocked){
          btn.style.opacity='0.4';
          btn.style.cursor='not-allowed';
          btn.innerHTML='<span class="name-avatar" style="background:#94a3b8">'+name[0]+'</span>'+name+'<span style="font-size:11px;color:#ef4444;margin-right:auto">ğŸ’» ××—×©×‘ ×‘×œ×‘×“</span>';
        } else {
          btn.innerHTML='<span class="name-avatar">'+name[0]+'</span>'+name+(isSecretary?'<span style="font-size:10px;color:#64748b;margin-right:auto">××–×›×™×¨×”</span>':'');
          btn.addEventListener('click',function(){registerDevice(name);});
        }
        list.appendChild(btn);
      });
    }

    function registerDevice(name){
      closeModal();
      var ua=navigator.userAgent||'';
      devicesRef.child(deviceId).set({
        userName:name,
        status:'pending',
        deviceType:ua.indexOf('Mobile')>=0?'ğŸ“± × ×™×™×“':'ğŸ’» ××—×©×‘',
        registeredAt:new Date().toISOString(),
        lastSeen:new Date().toISOString()
      });
    }

    function resetDevice(){
      if(!confirm('×œ××¤×¡ ××ª ×¨×™×©×•× ×”××›×©×™×¨?'))return;
      devicesRef.child(deviceId).remove();
      localStorage.removeItem('gate_user');
      localStorage.removeItem('gate_tab');
    }

    function goStaff(tab){
      localStorage.setItem('gate_tab',tab);
      devicesRef.child(deviceId).child('lastSeen').set(new Date().toISOString());
      window.location.href='staff.html';
    }

    function goGuard(){window.location.href='guard.html';}

    function goGuest(){
      localStorage.setItem('gate_tab','guest');
      localStorage.setItem('gate_guest_open','true');
      window.location.href='staff.html';
    }

    document.getElementById('authModal').addEventListener('click',function(e){if(e.target===this)closeModal();});
  </script>
</body>
</html>
