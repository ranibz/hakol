<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×©×—×¨×•×¨ ×ª×œ××™×“×™× â€” ××—× ×š / ××–×›×™×¨×•×ª</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700;800&family=Secular+One&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0e1a; --card: rgba(22,28,45,0.7); --card-h: rgba(30,38,60,0.8);
      --blue: #00d4ff; --purple: #b44dff; --pink: #ff6bb5; --green: #00e676; --orange: #ffab40; --yellow: #ffe040; --red: #ff5252; --teal: #1de9b6;
      --t1: #eef2ff; --t2: #8892b0; --t3: #4a5578; --border: rgba(136,146,176,0.08);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Rubik',sans-serif; background:var(--bg); color:var(--t1); min-height:100vh; direction:rtl; overflow-x:hidden; }
    body::before { content:''; position:fixed; top:-50%; right:-30%; width:80vw; height:80vw; border-radius:50%; background:radial-gradient(circle,rgba(0,212,255,0.12) 0%,transparent 60%); animation:bgF 20s ease-in-out infinite; pointer-events:none; }
    body::after { content:''; position:fixed; bottom:-40%; left:-20%; width:60vw; height:60vw; border-radius:50%; background:radial-gradient(circle,rgba(180,77,255,0.1) 0%,transparent 60%); animation:bgF 25s ease-in-out infinite reverse; pointer-events:none; }
    @keyframes bgF { 0%,100%{transform:translate(0,0) scale(1)} 33%{transform:translate(5%,8%) scale(1.05)} 66%{transform:translate(-3%,-5%) scale(0.95)} }

    .header { background:rgba(10,14,26,0.85); backdrop-filter:blur(20px); border-bottom:1px solid var(--border); padding:14px 20px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:100; }
    .header-logo { display:flex; align-items:center; gap:12px; }
    .logo-icon { width:42px; height:42px; border-radius:12px; background:linear-gradient(135deg,var(--blue),var(--purple)); display:flex; align-items:center; justify-content:center; font-size:20px; box-shadow:0 4px 20px rgba(0,212,255,0.25); }
    .header h1 { font-family:'Secular One',sans-serif; font-size:17px; background:linear-gradient(135deg,var(--blue),var(--purple)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
    .header p { color:var(--t3); font-size:11px; }
    .header-controls { display:flex; align-items:center; gap:12px; }
    .connection { display:flex; align-items:center; gap:6px; font-size:11px; color:var(--t3); }
    .connection-dot { width:7px; height:7px; border-radius:50%; background:var(--t3); transition:all .3s; }
    .connection-dot.online { background:var(--green); box-shadow:0 0 10px rgba(0,230,118,0.6); }
    .tab-buttons { display:flex; gap:4px; }
    .tab-btn { background:transparent; border:1px solid transparent; border-radius:10px; padding:8px 16px; color:var(--t3); cursor:pointer; font-size:13px; font-weight:500; font-family:'Rubik',sans-serif; position:relative; transition:all .25s; }
    .tab-btn.active { background:linear-gradient(135deg,rgba(0,212,255,0.1),rgba(180,77,255,0.08)); border-color:rgba(0,212,255,0.2); color:var(--blue); }
    .tab-btn .badge { position:absolute; top:-5px; left:-5px; background:linear-gradient(135deg,var(--pink),var(--purple)); color:#fff; border-radius:10px; font-size:10px; font-weight:700; padding:2px 7px; }

    .content { max-width:620px; margin:0 auto; padding:24px 16px 80px; position:relative; z-index:1; }
    .section-label { font-size:12px; font-weight:600; color:var(--t2); margin-bottom:12px; letter-spacing:.5px; text-transform:uppercase; }

    /* â”€â”€â”€ Accordion â”€â”€â”€ */
    .accordion { margin-bottom:20px; }
    .accordion-section { margin-bottom:10px; border-radius:16px; overflow:hidden; border:1.5px solid var(--border); backdrop-filter:blur(8px); transition:border-color .3s; }
    .accordion-section.open { border-color:rgba(136,146,176,0.15); }

    .accordion-header {
      padding:14px 20px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      user-select:none;
      transition:all .25s;
    }

    .accordion-header:hover { filter:brightness(1.1); }

    .accordion-header.junior {
      background:linear-gradient(135deg,rgba(0,212,255,0.08),rgba(29,233,182,0.06));
    }
    .accordion-header.senior {
      background:linear-gradient(135deg,rgba(180,77,255,0.08),rgba(255,107,181,0.06));
    }

    .accordion-title {
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:700;
      font-size:15px;
    }

    .accordion-title .emoji { font-size:20px; }
    .accordion-title.junior-text { color:var(--teal); }
    .accordion-title.senior-text { color:var(--pink); }

    .accordion-count {
      font-size:12px;
      padding:4px 10px;
      border-radius:8px;
      font-weight:600;
    }
    .accordion-count.junior-count { background:rgba(29,233,182,0.1); color:var(--teal); }
    .accordion-count.senior-count { background:rgba(255,107,181,0.1); color:var(--pink); }

    .accordion-arrow {
      font-size:14px;
      transition:transform .3s;
      color:var(--t3);
    }
    .accordion-section.open .accordion-arrow { transform:rotate(180deg); }

    .accordion-body {
      max-height:0;
      overflow:hidden;
      transition:max-height .4s cubic-bezier(.16,1,.3,1), padding .3s;
      padding:0 16px;
      background:rgba(10,14,26,0.3);
    }
    .accordion-section.open .accordion-body {
      max-height:800px;
      padding:16px;
    }

    /* â”€â”€â”€ Layer (×©×›×‘×”) inside accordion â”€â”€â”€ */
    .layer-group { margin-bottom:14px; }
    .layer-group:last-child { margin-bottom:0; }

    .layer-label {
      font-size:13px;
      font-weight:700;
      margin-bottom:8px;
      padding:6px 12px;
      border-radius:10px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    /* Each layer gets a unique color */
    .layer-z  { background:rgba(0,212,255,0.1); color:#00d4ff; }
    .layer-ch { background:rgba(29,233,182,0.1); color:#1de9b6; }
    .layer-t  { background:rgba(0,230,118,0.1); color:#00e676; }
    .layer-y  { background:rgba(180,77,255,0.1); color:#b44dff; }
    .layer-ya { background:rgba(255,107,181,0.1); color:#ff6bb5; }
    .layer-yb { background:rgba(255,171,64,0.1); color:#ffab40; }

    .class-chips { display:flex; flex-wrap:wrap; gap:6px; }

    .class-chip {
      padding:10px 18px;
      border-radius:12px;
      border:1.5px solid var(--border);
      background:var(--card);
      color:var(--t2);
      cursor:pointer;
      font-size:14px;
      font-weight:500;
      font-family:'Rubik',sans-serif;
      transition:all .2s;
      min-width:60px;
      text-align:center;
    }
    .class-chip:hover { border-color:rgba(136,146,176,0.2); color:var(--t1); transform:translateY(-1px); }

    /* Selected chip colors per layer */
    .class-chip.sel-z  { border-color:#00d4ff; background:rgba(0,212,255,0.12); color:#00d4ff; font-weight:700; box-shadow:0 0 16px rgba(0,212,255,0.15); }
    .class-chip.sel-ch { border-color:#1de9b6; background:rgba(29,233,182,0.12); color:#1de9b6; font-weight:700; box-shadow:0 0 16px rgba(29,233,182,0.15); }
    .class-chip.sel-t  { border-color:#00e676; background:rgba(0,230,118,0.12); color:#00e676; font-weight:700; box-shadow:0 0 16px rgba(0,230,118,0.15); }
    .class-chip.sel-y  { border-color:#b44dff; background:rgba(180,77,255,0.12); color:#b44dff; font-weight:700; box-shadow:0 0 16px rgba(180,77,255,0.15); }
    .class-chip.sel-ya { border-color:#ff6bb5; background:rgba(255,107,181,0.12); color:#ff6bb5; font-weight:700; box-shadow:0 0 16px rgba(255,107,181,0.15); }
    .class-chip.sel-yb { border-color:#ffab40; background:rgba(255,171,64,0.12); color:#ffab40; font-weight:700; box-shadow:0 0 16px rgba(255,171,64,0.15); }

    /* â”€â”€â”€ Rest of UI â”€â”€â”€ */
    .search-input { width:100%; padding:12px 18px; border-radius:14px; border:1.5px solid var(--border); background:var(--card); color:var(--t1); font-size:14px; font-family:'Rubik',sans-serif; margin-bottom:12px; outline:none; direction:rtl; backdrop-filter:blur(8px); transition:border-color .2s; }
    .search-input:focus { border-color:rgba(0,212,255,0.3); }
    .search-input::placeholder { color:var(--t3); }

    .student-list { display:flex; flex-direction:column; gap:6px; margin-bottom:24px; max-height:350px; overflow-y:auto; }
    .student-list::-webkit-scrollbar { width:4px; }
    .student-list::-webkit-scrollbar-thumb { background:var(--t3); border-radius:4px; }

    .student-btn { padding:13px 16px; border-radius:12px; border:1.5px solid var(--border); background:var(--card); color:var(--t1); cursor:pointer; font-size:14px; font-family:'Rubik',sans-serif; text-align:right; display:flex; align-items:center; gap:10px; transition:all .2s; }
    .student-btn:hover { background:var(--card-h); }
    .student-btn.selected { border-color:var(--blue); background:linear-gradient(135deg,rgba(0,212,255,0.1),rgba(180,77,255,0.05)); color:var(--blue); font-weight:600; }
    .student-avatar { width:34px; height:34px; border-radius:50%; background:rgba(136,146,176,0.08); display:flex; align-items:center; justify-content:center; font-size:13px; flex-shrink:0; color:var(--t3); }
    .student-btn.selected .student-avatar { background:linear-gradient(135deg,var(--blue),var(--purple)); color:#fff; box-shadow:0 4px 14px rgba(0,212,255,0.3); }

    .reason-chips { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px; }
    .reason-chip { padding:10px 20px; border-radius:22px; border:1.5px solid var(--border); background:var(--card); color:var(--t2); cursor:pointer; font-size:13px; font-family:'Rubik',sans-serif; transition:all .2s; }
    .reason-chip.selected { border-color:var(--purple); background:linear-gradient(135deg,rgba(180,77,255,0.12),rgba(255,107,181,0.06)); color:var(--purple); font-weight:600; }

    .submit-btn { width:100%; padding:16px; border-radius:16px; border:none; background:linear-gradient(135deg,var(--blue),var(--purple),var(--pink)); background-size:200% 200%; animation:gs 4s ease infinite; color:#fff; font-size:16px; font-weight:700; font-family:'Rubik',sans-serif; cursor:pointer; margin-top:8px; box-shadow:0 8px 32px rgba(0,212,255,0.2),0 4px 16px rgba(180,77,255,0.15); transition:all .25s; }
    .submit-btn:hover { transform:translateY(-2px); }
    @keyframes gs { 0%,100%{background-position:0% 50%} 50%{background-position:100% 50%} }

    .history-item { padding:14px 16px; border-radius:14px; background:var(--card); border:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .history-info { display:flex; align-items:center; gap:10px; }
    .status-badge { padding:4px 10px; border-radius:8px; font-size:11px; font-weight:600; }
    .status-pending { background:rgba(255,171,64,0.1); border:1px solid rgba(255,171,64,0.2); color:var(--orange); }
    .status-exited { background:rgba(0,230,118,0.1); border:1px solid rgba(0,230,118,0.2); color:var(--green); }
    .cancel-btn { background:rgba(255,82,82,0.1); border:1px solid rgba(255,82,82,0.15); border-radius:8px; padding:6px 14px; color:#ff5252; cursor:pointer; font-size:12px; font-family:'Rubik',sans-serif; }
    .toast { position:fixed; top:20px; left:50%; transform:translateX(-50%); border-radius:14px; padding:12px 28px; font-size:14px; font-weight:600; font-family:'Rubik',sans-serif; z-index:9999; backdrop-filter:blur(16px); animation:ti .35s cubic-bezier(.16,1,.3,1); pointer-events:none; }
    .toast-success { background:rgba(0,230,118,0.15); border:1px solid rgba(0,230,118,0.3); color:var(--green); }
    .toast-warning { background:rgba(255,171,64,0.15); border:1px solid rgba(255,171,64,0.3); color:var(--orange); }
    .empty-state { text-align:center; padding:48px 20px; color:var(--t3); }
    .empty-state .icon { font-size:40px; opacity:.4; margin-bottom:12px; }
    .credit { position:fixed; bottom:0; left:0; right:0; text-align:center; padding:10px; background:rgba(10,14,26,0.9); backdrop-filter:blur(12px); border-top:1px solid var(--border); font-size:11px; color:var(--t3); z-index:100; }
    .credit span { background:linear-gradient(135deg,var(--blue),var(--purple)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; font-weight:600; }
    .hidden { display:none; }
    @keyframes ti { from{opacity:0;transform:translateX(-50%) translateY(-16px)} to{opacity:1;transform:translateX(-50%) translateY(0)} }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
    .fade-in { animation:fadeIn .3s ease; }
  </style>
</head>
<body>
  <div id="toast" class="toast hidden"></div>
  <div class="header">
    <div class="header-logo"><div class="logo-icon">ğŸ“‹</div><div><h1>×©×—×¨×•×¨ ×ª×œ××™×“×™×</h1><p>××—× ×š / ××–×›×™×¨×•×ª</p></div></div>
    <div class="header-controls">
      <div class="connection"><div id="connectionDot" class="connection-dot"></div><span id="connectionText">××ª×—×‘×¨...</span></div>
      <div class="tab-buttons">
        <button class="tab-btn active" id="tabForm" onclick="showTab('form')">×©×—×¨×•×¨ ×—×“×©</button>
        <button class="tab-btn" id="tabHistory" onclick="showTab('history')">×”×™×¡×˜×•×¨×™×”<span class="badge hidden" id="historyBadge">0</span></button>
      </div>
    </div>
  </div>
  <div class="content">
    <div id="formView">
      <div class="section-label">×‘×—×™×¨×ª ×›×™×ª×”</div>
      <div id="accordionContainer" class="accordion"></div>

      <div id="studentSection" class="hidden fade-in">
        <div class="section-label" id="studentLabel">×‘×—×™×¨×ª ×ª×œ××™×“/×”</div>
        <input type="text" class="search-input" placeholder="ğŸ” ×—×™×¤×•×© ×œ×¤×™ ×©×..." id="studentSearch" oninput="filterStudents()">
        <div class="student-list" id="studentList"></div>
      </div>
      <div id="reasonSection" class="hidden fade-in">
        <div class="section-label">×¡×™×‘×ª ×”×©×—×¨×•×¨</div>
        <div class="reason-chips" id="reasonChips"></div>
        <input type="text" class="search-input hidden" placeholder="×¤×¨×˜/×™ ××ª ×”×¡×™×‘×”..." id="customReason">
      </div>
      <button class="submit-btn hidden" id="submitBtn" onclick="submitRelease()">âœ“ ×©×—×¨×¨</button>
    </div>
    <div id="historyView" class="hidden">
      <div class="section-label" id="historyLabel">×©×—×¨×•×¨×™× ×”×™×•×</div>
      <div id="historyList"></div>
    </div>
  </div>
  <div class="credit">×¤×™×ª×•×— ×”××¤×œ×™×§×¦×™×” â€” <span>×¨× ×™ ×‘×Ÿ ×–××‘</span></div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig={apiKey:"AIzaSyCSmwys1pNEEMu8oq4r_Q6sMtHEiba33pw",authDomain:"gmarlamed.firebaseapp.com",databaseURL:"https://gmarlamed-default-rtdb.firebaseio.com",projectId:"gmarlamed",storageBucket:"gmarlamed.firebasestorage.app",messagingSenderId:"287104553740",appId:"1:287104553740:web:ab36b987cf86f913c76f29"};
    firebase.initializeApp(firebaseConfig);
    const db=firebase.database(), releasesRef=db.ref('releases'), classMapRef=db.ref('school_gate/classMap');

    let CLASSES=[], STUDENTS={};
    const REASONS=["×¡×™×‘×” ×¨×¤×•××™×ª","×¡×™×‘×” ××™×©×™×ª","×ª×•×¨ ×¨×•×¤×","××™×¨×•×¢ ××©×¤×—×ª×™","××—×¨"];

    // Layer config: color classes and grouping
    const LAYER_CONFIG = {
      '×–': { colorClass:'z', emoji:'ğŸ”µ', label:'×©×›×‘×” ×–×³' },
      '×—': { colorClass:'ch', emoji:'ğŸŸ¢', label:'×©×›×‘×” ×—×³' },
      '×˜': { colorClass:'t', emoji:'ğŸŸ©', label:'×©×›×‘×” ×˜×³' },
      '×™': { colorClass:'y', emoji:'ğŸŸ£', label:'×©×›×‘×” ×™×³' },
      '×™×':{ colorClass:'ya', emoji:'ğŸ©·', label:'×©×›×‘×” ×™×´×' },
      '×™×‘':{ colorClass:'yb', emoji:'ğŸŸ ', label:'×©×›×‘×” ×™×´×‘' },
    };

    const JUNIOR = ['×–','×—','×˜'];
    const SENIOR = ['×™','×™×','×™×‘'];

    classMapRef.on('value',s=>{
      const d=s.val();
      if(d&&Object.keys(d).length>0){
        STUDENTS=d;
        CLASSES=Object.keys(d).sort((a,b)=>a.localeCompare(b,'he'));
      } else {
        CLASSES=[];
        STUDENTS={};
      }
      buildAccordion();
    });

    let selectedClass="",selectedStudent="",selectedReason="",releases={},currentTab="form";
    let openAccordions = { junior:true, senior:true };

    db.ref('.info/connected').on('value',s=>{
      const d=document.getElementById('connectionDot'),t=document.getElementById('connectionText');
      if(s.val()===true){d.classList.add('online');t.textContent='××—×•×‘×¨';}
      else{d.classList.remove('online');t.textContent='×œ× ××—×•×‘×¨';}
    });

    releasesRef.on('value',s=>{releases=s.val()||{};updateHistoryBadge();if(currentTab==='history')renderHistory();});

    // â”€â”€â”€ Build Accordion â”€â”€â”€
    function buildAccordion() {
      // Group classes by layer
      const layers = {};
      CLASSES.forEach(cls => {
        // Extract layer: "×—×³2" â†’ "×—", "×™××³3" â†’ "×™×"
        const parts = cls.split('×³');
        const layer = parts[0];
        if (!layers[layer]) layers[layer] = [];
        layers[layer].push(cls);
      });

      function buildSection(id, title, emoji, type, layerKeys) {
        const relevantLayers = layerKeys.filter(k => layers[k]);
        const totalClasses = relevantLayers.reduce((sum, k) => sum + (layers[k]||[]).length, 0);
        if (totalClasses === 0) return '';

        const isOpen = openAccordions[id];
        return `
          <div class="accordion-section ${isOpen?'open':''}" id="acc-${id}">
            <div class="accordion-header ${type}" onclick="toggleAccordion('${id}')">
              <div class="accordion-title ${type}-text">
                <span class="emoji">${emoji}</span>
                ${title}
              </div>
              <div style="display:flex;align-items:center;gap:10px;">
                <span class="accordion-count ${type}-count">${totalClasses} ×›×™×ª×•×ª</span>
                <span class="accordion-arrow">â–¼</span>
              </div>
            </div>
            <div class="accordion-body">
              ${relevantLayers.map(layer => {
                const cfg = LAYER_CONFIG[layer] || { colorClass:'z', emoji:'ğŸ“˜', label:layer };
                const classes = layers[layer] || [];
                return `
                  <div class="layer-group">
                    <div class="layer-label layer-${cfg.colorClass}">${cfg.emoji} ${cfg.label}</div>
                    <div class="class-chips">
                      ${classes.map(cls => {
                        const selClass = selectedClass===cls ? `sel-${cfg.colorClass}` : '';
                        return `<button class="class-chip ${selClass}" onclick="selectClass('${cls}')">${cls}</button>`;
                      }).join('')}
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }

      const container = document.getElementById('accordionContainer');
      container.innerHTML =
        buildSection('junior', '×—×˜×™×‘×ª ×‘×™× ×™×™×', 'ğŸ«', 'junior', JUNIOR) +
        buildSection('senior', '×—×˜×™×‘×” ×¢×œ×™×•× ×”', 'ğŸ“', 'senior', SENIOR);
    }

    function toggleAccordion(id) {
      openAccordions[id] = !openAccordions[id];
      const section = document.getElementById('acc-'+id);
      section.classList.toggle('open');
    }

    function selectClass(cls) {
      selectedClass=cls; selectedStudent=""; selectedReason="";
      document.getElementById('studentSearch').value="";
      buildAccordion();
      renderStudents();
      document.getElementById('studentSection').classList.remove('hidden');
      document.getElementById('studentLabel').textContent=`×‘×—×™×¨×ª ×ª×œ××™×“/×” â€” ×›×™×ª×” ${cls}`;
      document.getElementById('reasonSection').classList.add('hidden');
      document.getElementById('submitBtn').classList.add('hidden');
    }

    function renderStudents(){
      const s=document.getElementById('studentSearch').value;
      const st=(STUDENTS[selectedClass]||[]).filter(x=>x.includes(s));
      document.getElementById('studentList').innerHTML=st.map(x=>
        `<button class="student-btn ${selectedStudent===x?'selected':''}" onclick="selectStudent(this.dataset.n)" data-n="${x}"><span class="student-avatar">${selectedStudent===x?'âœ“':x[0]}</span>${x}</button>`
      ).join('');
    }
    function filterStudents(){renderStudents();}

    function selectStudent(n){
      selectedStudent=n;selectedReason="";renderStudents();renderReasons();
      document.getElementById('reasonSection').classList.remove('hidden');
      document.getElementById('customReason').classList.add('hidden');
      updateSubmitBtn();
    }

    function renderReasons(){
      document.getElementById('reasonChips').innerHTML=REASONS.map(r=>
        `<button class="reason-chip ${selectedReason===r?'selected':''}" onclick="selectReason('${r}')">${r}</button>`
      ).join('');
    }

    function selectReason(r){
      selectedReason=r;renderReasons();
      document.getElementById('customReason').classList.toggle('hidden',r!=='××—×¨');
      updateSubmitBtn();
    }

    function updateSubmitBtn(){
      const b=document.getElementById('submitBtn');
      if(selectedStudent&&selectedReason){b.classList.remove('hidden');b.textContent=`âœ“ ×©×—×¨×¨ ××ª ${selectedStudent}`;}
      else b.classList.add('hidden');
    }

    function submitRelease(){
      if(!selectedStudent||!selectedReason)return;
      const r=selectedReason==='××—×¨'?(document.getElementById('customReason').value||'××—×¨'):selectedReason;
      releasesRef.push().set({studentName:selectedStudent,className:selectedClass,reason:r,releasedBy:"×¦×•×•×ª",time:new Date().toISOString(),status:"pending"})
      .then(()=>{
        showToast(`âœ“ ${selectedStudent} ×©×•×—×¨×¨/×”`,'success');
        selectedStudent="";selectedReason="";
        document.getElementById('studentSearch').value="";
        document.getElementById('customReason').value="";
        renderStudents();
        document.getElementById('reasonSection').classList.add('hidden');
        document.getElementById('submitBtn').classList.add('hidden');
      }).catch(()=>showToast('×©×’×™××” â€” ×‘×“×•×§ ×—×™×‘×•×¨','warning'));
    }

    function cancelRelease(id){releasesRef.child(id).remove().then(()=>showToast('×”×©×—×¨×•×¨ ×‘×•×˜×œ','warning'));}

    function getTodayReleases(){
      const t=new Date().toDateString();
      return Object.entries(releases).filter(([_,r])=>new Date(r.time).toDateString()===t).sort((a,b)=>new Date(b[1].time)-new Date(a[1].time));
    }
    function updateHistoryBadge(){
      const c=getTodayReleases().length,b=document.getElementById('historyBadge');
      if(c>0){b.classList.remove('hidden');b.textContent=c;}else b.classList.add('hidden');
    }

    function renderHistory(){
      const l=document.getElementById('historyList'),t=getTodayReleases();
      document.getElementById('historyLabel').textContent=`×©×—×¨×•×¨×™× ×”×™×•× â€” ${t.length}`;
      if(t.length===0){l.innerHTML='<div class="empty-state"><div class="icon">ğŸ“­</div><p>××™×Ÿ ×©×—×¨×•×¨×™× ×œ×”×™×•×</p></div>';return;}
      l.innerHTML=t.map(([id,r])=>`<div class="history-item"><div class="history-info"><span class="status-badge ${r.status==='exited'?'status-exited':'status-pending'}">${r.status==='exited'?'×™×¦×/×”':'×××ª×™×Ÿ'}</span><div><div style="font-weight:600;font-size:14px">${r.studentName}</div><div style="color:var(--t3);font-size:12px">${r.className} Â· ${r.reason} Â· ${formatTime(r.time)}</div></div></div>${r.status==='pending'?`<button class="cancel-btn" onclick="cancelRelease('${id}')">×‘×™×˜×•×œ</button>`:''}</div>`).join('');
    }

    function showTab(t){
      currentTab=t;
      document.getElementById('tabForm').classList.toggle('active',t==='form');
      document.getElementById('tabHistory').classList.toggle('active',t==='history');
      document.getElementById('formView').classList.toggle('hidden',t!=='form');
      document.getElementById('historyView').classList.toggle('hidden',t!=='history');
      if(t==='history')renderHistory();
    }

    function formatTime(i){return new Date(i).toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'});}
    function showToast(m,t){const e=document.getElementById('toast');e.className=`toast toast-${t}`;e.textContent=m;e.classList.remove('hidden');setTimeout(()=>e.classList.add('hidden'),3000);}
  </script>
</body>
</html>
